<!--
//====================================================================\\
||                                                                   ||
||   CARD√ÅPIO SHEETS - V4.0.1  - 09/08/2025 - 21h30                 ||
||                                                                   ||
||    Desenvolvido com ‚ù§Ô∏è por Dante Testa                            ||
||    www.dantetesta.com.br | WhatsApp: (19) 99802-9156              ||
||                                                                   ||
||    [!] AVISO IMPORTANTE                                           ||
||    Este c√≥digo √© propriedade intelectual de Dante Testa.          ||
||    N√£o utilize de forma pirata. Valorize o trabalho do            ||
||    desenvolvedor adquirindo uma licen√ßa leg√≠tima.                 ||
||                                                                   ||
||    [$] APOIE O DESENVOLVEDOR                                      ||
||    Ao comprar o original voc√™ apoia um profissional que           ||
||    tamb√©m tem fam√≠lia e luta todo dia para pagar as contas.       ||
||    N√£o pegue atalhos - um dia a vida manda a conta das            ||
||    pequenas coisas erradas que fazemos.                           ||
||                                                                   ||
||    [$] Se este script te ajudou a ficar rico e quiser me          ||
||    enviar um presente financeiro: PIX dante.testa@gmail.com       ||
||                                                                   ||
||    [*] SUPORTE T√âCNICO [n√£o gratuito]                             ||
||    Dispon√≠vel via WhatsApp. Entre em contato para consultar       ||
||    valores e planos de suporte personalizados.                    ||
||                                                                   ||
||    "C√≥digo √© poesia. Respeite o poeta."                           ||
||                                                                   ||
\\====================================================================//
-->
<!-- Vers√£o 5.0.0 - Cache Buster -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Card√°pio Sheets</title>

<!--   INSIRA ABAIXO AS TAGS DE SEO -->
<!--   INSIRA ACIMA AS TAGS DE SEO -->

    <script>
        // Cache-busting agressivo para garantir que o config.js mais recente seja sempre carregado
        document.write('<script src="config.js?' + new Date().getTime() + '"><\/script>');
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        // Teste de carregamento do sistema localStorage
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                debugLog('üß™ Testando sistema localStorage...');
                debugLog('‚úÖ initializeStorageSystem:', typeof initializeStorageSystem);
                debugLog('‚úÖ saveCartToStorage:', typeof saveCartToStorage);
                debugLog('‚úÖ loadCartFromStorage:', typeof loadCartFromStorage);
                debugLog('‚úÖ saveCouponToStorage:', typeof saveCouponToStorage);
                debugLog('‚úÖ Sistema localStorage carregado com sucesso!');
            }, 500);
        });
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body style="background-color: var(--cor-fundo) !important;">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 cursor-pointer hover:opacity-80 transition-opacity" onclick="window.location.reload()" title="Recarregar p√°gina">
                    <img id="header-logo" src="" alt="Logo" class="object-cover rounded-lg cursor-pointer" style="display: none; width: 55px; height: 55px;" onerror="this.style.display='none'" onclick="clearStorageAndReload()" title="Clique para limpar cache e recarregar">
                    <div>
                        <h1 id="header-company-name" class="text-base sm:text-2xl font-bold" style="color: var(--cor-primaria) !important;">Card√°pio Digital</h1>
                        <p id="header-slogan" class="text-xs sm:text-base" style="color: var(--cor-texto) !important;" >Slogan da Empresa</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="text-right cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors" onclick="openHoursModal()" id="hours-indicator" style="font-size: 0.85rem;">
                        <div class="flex items-center space-x-2">
                            <div id="status-dot" class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <div class="font-medium" style="color: var(--cor-secundaria) !important;" id="status-text">Aberto</div>
                        </div>
                        <div style="color: var(--cor-texto) !important;" id="hours-text">at√© 23h</div>
                    </div>
                </div>
            </div>
        </div>
     
    </header>

    <!-- Categories Navigation -->
    <nav class="category-nav fixed top-[89px] left-0 right-0 z-30 bg-white" style="border-bottom: 1px solid var(--cor-borda) !important;">
        <div class="max-w-4xl mx-auto px-4 py-3">
            <div class="relative flex items-center">
                <!-- Seta Esquerda (Desktop apenas) -->
                <button id="nav-arrow-left" class="hidden md:flex items-center justify-center w-8 h-8 rounded-full bg-white shadow-md border border-gray-200 hover:bg-gray-50 transition-all duration-200 mr-2 z-10 nav-arrow" style="opacity: 0; pointer-events: none;">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                
                <!-- Container das categorias -->
                <div class="flex space-x-2 overflow-x-auto scrollbar-hide flex-1" id="category-nav">
                    <!-- Categories will be populated dynamically from CSV data -->
                </div>
                
                <!-- Seta Direita (Desktop apenas) -->
                <button id="nav-arrow-right" class="hidden md:flex items-center justify-center w-8 h-8 rounded-full bg-white shadow-md border border-gray-200 hover:bg-gray-50 transition-all duration-200 ml-2 z-10 nav-arrow">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- Menu Content -->
    <main class="max-w-4xl mx-auto px-4 py-6 pb-4 mt-[80px]">
        <!-- Search -->
        <div class="mb-6">
            <div class="relative">
                <input type="text" id="search" placeholder="Buscar..." autocomplete="off" 
                       class="w-full pl-4 pr-20 py-3 rounded-lg focus:ring-2 focus:border-transparent" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important;">
                <div class="absolute right-2 top-2 flex space-x-2">
                    <button id="clear-search" onclick="clearSearch()" class="hidden rounded-full w-8 h-8 flex items-center justify-center transition-colors" style="background-color: var(--cor-fundo-secundario) !important; color: var(--cor-texto-secundario) !important;" title="Limpar busca" onmouseover="this.style.backgroundColor='var(--cor-borda)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <button id="search-btn" onclick="performSearch()" class="rounded-full w-8 h-8 flex items-center justify-center transition-colors" style="background-color: var(--cor-primaria) !important; color: white !important;" title="Pesquisar" onmouseover="this.style.backgroundColor='var(--cor-primaria-hover)'" onmouseout="this.style.backgroundColor='var(--cor-primaria)'">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Menu Sections -->
        <div id="menu-content">
            <!-- Sections will be populated here -->
        </div>
    </main>

    <!-- Google Review CTA -->
    <section id="google-reviews-section" class="py-12 mt-0" style="background: var(--cor-fundo) !important; display: none;">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <div class="bg-white rounded-2xl p-8 shadow-xl">
                <div class="text-6xl mb-4">‚≠ê</div>
                <h3 class="text-2xl font-bold mb-3" style="color: var(--cor-texto) !important;">Gostou da experi√™ncia?</h3>
                <p class="mb-6" style="color: var(--cor-texto-secundario) !important;">Sua avalia√ß√£o nos ajuda a melhorar e alcan√ßar mais pessoas!</p>
                <a id="google-reviews-link" href="" target="_blank" 
                   class="inline-flex items-center space-x-2 px-8 py-4 rounded-full font-bold text-lg transition-all transform hover:scale-105 shadow-lg" style="background-color: var(--cor-terciaria) !important; color: white !important;" onmouseover="this.style.backgroundColor='var(--cor-terciaria-hover)'" onmouseout="this.style.backgroundColor='var(--cor-terciaria)'">
                    <span>‚≠ê</span>
                    <span>Avaliar no Google</span>
                </a>
               
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-8" style="background-color: var(--cor-fundo) !important; border-top: 5px solid transparent !important; background-image: linear-gradient(var(--cor-fundo), var(--cor-fundo)), linear-gradient(45deg, var(--cor-primaria), var(--cor-secundaria), var(--cor-terciaria), var(--cor-secundaria), var(--cor-primaria)) !important; background-origin: border-box !important; background-clip: padding-box, border-box !important; background-size: 100% 100%, 400% 400% !important; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08) !important; position: relative; overflow: hidden;">
        <div class="max-w-4xl mx-auto px-4">
            <!-- Main Info -->
            <div class="text-center mb-6">
                <div class="mb-3">
                    <h3 id="footer-company-name" class="text-2xl font-bold" style="color: var(--cor-texto) !important; font-weight: 700; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">üçΩÔ∏è Card√°pio Digital</h3>
                </div>
                <p id="footer-address" class="mb-4 text-sm" style="color: var(--cor-texto-secundario) !important; font-weight: 500; opacity: 0.9;">Rua das Flores, 123 ‚Ä¢ Centro - Campinas/SP</p>
                
                <!-- Contact & Hours in compact format -->
                <div class="flex flex-wrap justify-center items-center gap-6 text-sm mb-6" style="color: var(--cor-texto-secundario) !important;">
                    <a id="footer-phone" href="" class="flex items-center space-x-2 transition-all duration-300" style="display: none; color: var(--cor-primaria) !important; text-decoration: none; font-weight: 500;" onmouseover="this.style.color='var(--cor-secundaria)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.color='var(--cor-primaria)'; this.style.transform='translateY(0)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: var(--cor-primaria) !important; transition: all 0.3s ease;">
                            <path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"/>
                        </svg>
                        <span style="color: var(--cor-primaria) !important; transition: color 0.3s ease;"></span>
                    </a>

                    <div id="footer-email" class="cursor-pointer transition-all duration-300" style="display: none; color: var(--cor-primaria) !important;" onclick="window.location.href='mailto:' + this.dataset.email" title="Enviar email" onmouseover="this.style.color='var(--cor-secundaria)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.color='var(--cor-primaria)'; this.style.transform='translateY(0)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: var(--cor-primaria) !important; transition: all 0.3s ease;">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                    </div>
                    
                    <div id="footer-qrcode" class="cursor-pointer transition-all duration-300" style="color: var(--cor-primaria) !important;" onclick="openQRCodeModal()" title="Ver QR Code do card√°pio" onmouseover="this.style.color='var(--cor-secundaria)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.color='var(--cor-primaria)'; this.style.transform='translateY(0)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16" style="color: var(--cor-primaria) !important; transition: all 0.3s ease;">
                            <path d="M2 2h2v2H2z"/>
                            <path d="M6 0v6H0V0zM5 1H1v4h4zM4 12H2v2h2z"/>
                            <path d="M6 10v6H0v-6zm-5 1v4h4v-4zm11-9h2v2h-2z"/>
                            <path d="M10 0v6h6V0zm5 1v4h-4V1zM8 1V0h1v2H8v2H7V1zm0 5V4h1v2zM6 8V7h1V6h1v2h1V7h5v1h-4v1H7V8zm0 0v1H2V8H1v1H0V7h3v1zm10 1h-1V7h1zm-1 0h-1v2h2v-1h-1zm-4 0h2v1h-1v1h-1zm2 3v-1h-1v1h-1v1H9v1h3v-2zm0 0h3v1h-2v1h-1zm-4-1v1h1v-2H7v1z"/>
                            <path d="M7 12h1v3h4v1H7zm9 2v2h-3v-1h2v-1z"/>
                        </svg>
                    </div>
                    <!-- Indicador de Status Aberto/Fechado -->
                    <div id="open-status-indicator" class="flex items-center space-x-2 mb-2 px-3 py-2 rounded-lg transition-all duration-300" style="background-color: var(--cor-fundo-secundario); border: 1px solid var(--cor-borda); display: none;">
                        <div id="status-dot" class="w-3 h-3 rounded-full transition-all duration-300" style="background-color: #10B981;"></div>
                        <span id="status-text" class="text-sm font-medium" style="color: var(--cor-texto);">Verificando status...</span>
                    </div>
                    
                    <div class="flex items-center space-x-2 cursor-pointer transition-all duration-300" onclick="openHoursModal()" title="Ver hor√°rios de funcionamento" onmouseover="this.style.transform='translateY(-2px)'; this.querySelector('span').style.color='var(--cor-primaria)'" onmouseout="this.style.transform='translateY(0)'; this.querySelector('span').style.color='var(--cor-primaria)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: var(--cor-primaria) !important; transition: all 0.3s ease;">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z"/>
                        </svg>
                        <span class="font-medium" style="color: var(--cor-primaria) !important; font-weight: 500; transition: color 0.3s ease; font-size: 0.9em;">Ver Hor√°rios</span>
                    </div>
                </div>
                
                <!-- Social Icons -->
                <div class="flex justify-center space-x-3">
                    <a id="footer-instagram" href="" target="_blank" style="display: none; background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white; padding: 0.75rem; border-radius: 50%; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'; this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.2)'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: white;">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.40s-.644-1.44-1.439-1.44z"/>
                        </svg>
                    </a>
                    <a id="footer-facebook" href="" target="_blank" style="display: none; background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white; padding: 0.75rem; border-radius: 50%; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'; this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.2)'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: white;">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                    </a>
                    <a id="footer-whatsapp" href="" target="_blank" style="display: none; background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white; padding: 0.75rem; border-radius: 50%; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'; this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.2)'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: white;">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893A11.821 11.821 0 0020.893 3.488"/>
                        </svg>
                    </a>
                    <a id="footer-email-link" href="" style="display: none; background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white; padding: 0.75rem; border-radius: 50%; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'; this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.2)'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: white;">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                    </a>
                    

                </div>
            </div>
            
            <!-- Vers√£o do Aplicativo (discreto, abaixo dos √≠cones sociais) -->
            <div id="footer-app-version" class="text-center mt-2" style="color: var(--cor-texto-secundario) !important; opacity: 0.55; font-size: 0.65rem;">
                <span>Vers√£o V4.0.1</span>
                
                <!-- <a href="#" onclick="openHelpModal(); return false;" title="Abrir atalhos (F1)" style="color: inherit; text-decoration: none;"
                   onmouseover="this.style.color='var(--cor-primaria)'; this.style.textDecoration='underline'"
                   onmouseout="this.style.color='var(--cor-texto-secundario)'; this.style.textDecoration='none'">
                    Atalhos
                </a> 
                <span aria-hidden="true" style="margin: 0 8px; opacity: 0.5;">‚Ä¢</span>
                <a href="#" onclick="clearStorageAndReload(); return false;" title="Limpar cache" style="color: inherit; text-decoration: none;"
                   onmouseover="this.style.color='var(--cor-primaria)'; this.style.textDecoration='underline'"
                   onmouseout="this.style.color='var(--cor-texto-secundario)'; this.style.textDecoration='none'">
                    Limpar cache
                </a>-->
            </div>

             <!-- Developer Credits -->
             <div id="footer-credits-container" class="border-t pt-6 text-center" style="border-color: rgba(200, 200, 200, 0.3) !important; margin-top: 2rem; padding-top: 1.5rem;">
                <p id="footer-credits" class="text-xs" style="color: var(--cor-texto-secundario) !important; font-weight: 300; opacity: 0.7; font-size: 0.75rem;">
                    <!-- Cr√©ditos ser√£o preenchidos dinamicamente via CSV -->
                    Desenvolvido com <span style="color: #e74c3c; font-size: 0.8rem;">‚ô•</span> por <a href="#" target="_blank" class="transition-all duration-300" style="color: var(--cor-primaria) !important; text-decoration: none; font-weight: 400; position: relative; font-size: 0.75rem;" onmouseover="this.style.color='var(--cor-secundaria)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.color='var(--cor-primaria)'; this.style.transform='translateY(0)'">Carregando...</a> <span style="color: var(--cor-texto-secundario); opacity: 0.5; font-size: 0.7rem;">üë®‚Äçüíª</span>
                </p>
                
       
            </div>
        </div>
    </footer>

    <!-- Share FAB -->
    <button id="share-fab" class="fixed left-4 text-white p-3 rounded-full shadow-lg z-50 transition-all duration-300" style="bottom: 92px; background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)) !important; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;" onclick="shareGeneral()" title="Compartilhar card√°pio" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-primaria))'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.3)'; this.querySelector('svg').style.animation='smoothSpin 0.6s ease-in'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 0, 0, 0.2)'; this.querySelector('svg').style.animation='none'">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition: all 0.3s ease;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
        </svg>
    </button>

    <!-- Cart FAB -->
    <button id="cart-fab" class="cart-fab text-white shadow-lg hidden" style="background-color: var(--cor-whatsapp) !important;" onclick="openCart()" onmouseover="this.style.backgroundColor='var(--cor-whatsapp-hover)'" onmouseout="this.style.backgroundColor='var(--cor-whatsapp)'">
        <div class="flex items-center space-x-4 px-5">
            <div class="relative">
                <svg class="w-9 h-9 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-top: 6px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m1.6 8L6 5H3m4 8a2 2 0 100 4 2 2 0 000-4zm10 0a2 2 0 100 4 2 2 0 000-4z"/>
                </svg>
                <div id="cart-count" class="absolute -top-2 -right-2 bg-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold border-2" style="color: green !important; border-color: green !important;">0</div>
            </div>
            <div class="text-left">
                <div class="text-xs opacity-90 font-medium">Ver carrinho</div>
                <div class="font-bold text-base" id="cart-total">R$ 0,00</div>
            </div>
        </div>
    </button>

    <!-- Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden z-50" onclick="closeModal(event)">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8">
            <div class="relative bg-white rounded-2xl w-full max-w-md slide-up max-h-[85vh] overflow-visible" onclick="event.stopPropagation()">
                <!-- Close Button positioned at modal edge -->
                <button onclick="closeModal()" class="absolute -top-3 -right-3 bg-white shadow-lg rounded-full p-2 text-gray-700 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200 z-20 w-10 h-10 flex items-center justify-center font-bold text-xl">
                    ‚úï
                </button>
                <div class="overflow-y-auto overflow-x-hidden max-h-[85vh] rounded-2xl">
                     <div id="modal-content">
                         <!-- Modal content will be populated here -->
                     </div>
                 </div>
             </div>
         </div>
     </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden z-50" onclick="closeCart(event)">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8">
            <div class="rounded-2xl w-full max-w-md slide-up" style="background-color: var(--cor-fundo) !important;" onclick="event.stopPropagation()">
                <div class="p-4">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <h3 class="text-xl font-bold">Seu Carrinho</h3>
                            <button onclick="clearCart()" class="text-xs px-2 py-1 rounded-md transition-colors" style="color: var(--cor-texto-secundario); background-color: var(--cor-fundo-secundario);" onmouseover="this.style.backgroundColor='var(--cor-borda)'; this.style.color='var(--cor-erro)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'; this.style.color='var(--cor-texto-secundario)'" title="Limpar carrinho">
                                üóëÔ∏è Limpar Carrinho
                            </button>
                        </div>
                        <button onclick="closeCart()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                    </div>
                    <div id="cart-items" class="space-y-3 mb-6 max-h-80 sm:max-h-96 overflow-y-auto" style="overflow-x: visible;">
                        <!-- Cart items will be populated here -->
                    </div>
                    <div class="border-t pt-4">
                        <!-- Contador de itens -->
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm" style="color: var(--cor-texto-secundario) !important;">Itens no carrinho:</span>
                            <span class="text-sm font-medium" style="color: var(--cor-texto) !important;" id="cart-modal-items-count">0 itens</span>
                        </div>
                        <!-- Total -->
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-lg font-bold">Total:</span>
                            <span class="text-xl font-bold" style="color: var(--cor-primaria) !important;" id="cart-modal-total">R$ 0,00</span>
                        </div>
                        <button id="proceed-to-checkout-btn" disabled class="w-full text-white py-3 rounded-lg font-medium transition-colors cursor-not-allowed" style="background-color: #9ca3af !important;">
                            Finalizar Pedido ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Lightbox Modal -->
    <div id="image-lightbox" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50" onclick="closeLightbox(event)">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="relative max-w-4xl max-h-[90vh] w-full">
                <button onclick="closeLightbox()" class="absolute -top-12 right-0 text-white text-2xl font-bold z-10 transition-colors" onmouseover="this.style.color='var(--cor-texto-secundario)'" onmouseout="this.style.color='white'">
                    ‚úï
                </button>
                <img id="lightbox-image" src="" alt="" class="w-full h-full object-contain rounded-lg">
                <div id="lightbox-title" class="absolute bottom-0 left-0 right-0 text-white p-4 rounded-b-lg" style="background-color: rgba(0,0,0,0.7) !important;">
                    <!-- Title will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Notes Modal -->
    <div id="edit-notes-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden z-50" onclick="closeEditNotes(event)">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl w-full max-w-md slide-up" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold">Editar Observa√ß√µes</h3>
                        <button onclick="closeEditNotes()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                    </div>
                    
                    <div id="edit-item-info" class="mb-4 p-3 rounded-lg" style="background-color: var(--cor-fundo-secundario) !important;">
                        <!-- Item info will be populated here -->
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">Observa√ß√µes</label>
                        <textarea id="edit-item-notes" class="w-full px-3 py-2 rounded-lg focus:ring-2 focus:border-transparent" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-secundaria) !important;" rows="3" placeholder="Digite suas observa√ß√µes para este item..."></textarea>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeEditNotes()" class="flex-1 py-3 rounded-lg font-medium transition-colors" style="background-color: var(--cor-fundo-secundario) !important; color: var(--cor-texto) !important;" onmouseover="this.style.backgroundColor='var(--cor-borda)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'">
                            Cancelar
                        </button>
                        <button onclick="saveItemNotes()" class="flex-1 text-white py-3 rounded-lg font-medium transition-colors" style="background-color: var(--cor-secundaria) !important;" onmouseover="this.style.backgroundColor='var(--cor-secundaria-hover)'" onmouseout="this.style.backgroundColor='var(--cor-secundaria)'">
                            Salvar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden z-50" onclick="closeCheckout(event)">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8">
            <div class="rounded-2xl w-full max-w-lg slide-up max-h-[85vh] overflow-y-auto" style="background-color: var(--cor-fundo) !important;" onclick="event.stopPropagation()">
                


                <!-- Step 2: Delivery Type -->
                <div id="checkout-step-2" class="checkout-step p-6 hidden">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold" style="background-color: var(--cor-primaria) !important; color: white !important;">1</div>
                            <h3 class="text-xl font-bold">Tipo de Recebimento</h3>
                        </div>
                        <button onclick="closeCheckout()" style="color: var(--cor-texto-secundario) !important;" onmouseover="this.style.color='var(--cor-texto)'" onmouseout="this.style.color='var(--cor-texto-secundario)'">‚úï</button>
                    </div>
                    
                    <div id="delivery-options" class="space-y-3 mb-6">
                        <label class="flex items-center p-4 rounded-lg cursor-pointer" style="border: 1px solid var(--cor-borda) !important; background-color: white !important;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                            <input type="radio" name="delivery-type" value="local" class="mr-3" onchange="handleDeliveryTypeChange()">
                            <div>
                                <div class="font-medium">üçΩÔ∏è Consumir no Local</div>
                                <div class="text-sm" style="color: var(--cor-texto) !important;">Comer no restaurante</div>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-4 rounded-lg cursor-pointer" style="border: 1px solid var(--cor-borda) !important; background-color: white !important;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                            <input type="radio" name="delivery-type" value="pickup" class="mr-3" onchange="handleDeliveryTypeChange()">
                            <div>
                                <div class="font-medium">ü•° Retirar no Balc√£o</div>
                                <div class="text-sm" style="color: var(--cor-texto) !important;">Buscar no restaurante</div>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-4 rounded-lg cursor-pointer" style="border: 1px solid var(--cor-borda) !important; background-color: white !important;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                            <input type="radio" name="delivery-type" value="delivery" class="mr-3" onchange="handleDeliveryTypeChange()">
                            <div>
                                <div class="font-medium">üõµ Delivery</div>
                                <div class="text-sm" style="color: var(--cor-texto) !important;">Entrega em casa</div>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-4 rounded-lg cursor-pointer" style="border: 1px solid var(--cor-borda) !important; background-color: white !important;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                            <input type="radio" name="delivery-type" value="default" class="mr-3" onchange="handleDeliveryTypeChange()">
                            <div>
                                <div class="font-medium">üìã Padr√£o</div>
                                <div class="text-sm" style="color: var(--cor-texto) !important;">Sem especifica√ß√£o</div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Dynamic fields based on delivery type -->
                    <div id="delivery-fields" class="mb-6">
                        <!-- Fields will be populated based on selection -->
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="backToCart()" class="flex-1 py-3 rounded-lg font-medium transition-colors" style="background-color: var(--cor-fundo-secundario) !important; color: var(--cor-texto) !important;" onmouseover="this.style.backgroundColor='var(--cor-borda)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'">
                            ‚Üê Voltar
                        </button>
                        <button onclick="nextStep(3)" id="step2-continue" class="flex-1 py-3 rounded-lg font-medium transition-colors" style="background-color: var(--cor-primaria) !important; color: white !important;" onmouseover="this.style.backgroundColor='var(--cor-primaria-hover)'" onmouseout="this.style.backgroundColor='var(--cor-primaria)'">
                            Continuar ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 3: Customer Info -->
                <div id="checkout-step-3" class="checkout-step p-6 hidden">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold" style="background-color: var(--cor-primaria) !important; color: white !important;">2</div>
                            <h3 class="text-xl font-bold">Finalizar Pedido</h3>
                        </div>
                        <button onclick="closeCheckout()" style="color: var(--cor-texto-secundario) !important;" onmouseover="this.style.color='var(--cor-texto)'" onmouseout="this.style.color='var(--cor-texto-secundario)'">‚úï</button>
                    </div>
                    
                    <!-- RESUMO DO PEDIDO - VERS√ÉO COMPACTA -->
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4 mb-4">
                        
                        <!-- T√≠tulo -->
                        <div class="flex items-center space-x-2 mb-3">
                            <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                            </svg>
                            <h3 class="text-sm font-semibold text-gray-800">Resumo do Pedido</h3>
                        </div>
                        
                        <!-- BREAKDOWN DETALHADO -->
                        <div class="space-y-2 mb-3">
                            
                            <!-- Subtotal Produtos -->
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Subtotal</span>
                                <span id="order-subtotal" class="text-sm font-medium text-gray-800">R$ 0,00</span>
                            </div>
                            
                            <!-- Frete (quando aplic√°vel) -->
                            <div id="delivery-row" class="flex justify-between items-center hidden">
                                <span class="text-sm text-gray-600">Frete</span>
                                <span id="order-delivery-fee" class="text-sm font-medium text-gray-800">R$ 0,00</span>
                            </div>
                            
                            <!-- Desconto (quando aplic√°vel) -->
                            <div id="discount-row" class="flex justify-between items-center hidden">
                                <span class="text-green-600 flex items-center space-x-1">
                                    <span class="text-xs">üí∏</span>
                                    <span id="discount-label" class="text-xs sm:text-sm">Desconto</span>
                                </span>
                                <span id="order-discount" class="text-xs sm:text-sm font-medium text-green-600">-R$ 0,00</span>
                            </div>
                            
                        </div>
                        
                        <!-- LINHA SEPARADORA -->
                        <div class="border-t border-gray-200 pt-3 mb-3">
                            <div class="flex justify-between items-center">
                                <span class="text-base font-semibold text-gray-800">Total</span>
                                <span id="checkout-order-total" class="text-xl font-bold" style="color: var(--cor-primaria) !important;">R$ 0,00</span>
                            </div>
                        </div>
                        
                        <!-- CAMPO DE CUPOM EXPANS√çVEL -->
                        <div class="border-t border-gray-200 pt-3">
                            
                            <!-- Bot√£o para expandir cupom -->
                            <div id="coupon-toggle-btn" class="cursor-pointer transition-all duration-200" onclick="toggleCouponField()">
                                <div class="flex items-center justify-center space-x-2 py-2 px-3 rounded-lg border border-dashed transition-all duration-200" style="border-color: var(--cor-primaria) !important; background-color: rgba(var(--cor-primaria-rgb), 0.05) !important;" onmouseover="this.style.backgroundColor='rgba(var(--cor-primaria-rgb), 0.1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.backgroundColor='rgba(var(--cor-primaria-rgb), 0.05)'; this.style.transform='translateY(0)'">
                                    <span class="text-xs font-medium" style="color: var(--cor-primaria) !important;">üéüÔ∏è Tenho um cupom de desconto</span>
                                    <svg id="coupon-arrow" class="w-3 h-3 transition-transform duration-200" style="color: var(--cor-primaria) !important;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- Campo expans√≠vel (inicialmente oculto) -->
                            <div id="coupon-field-container" class="overflow-hidden transition-all duration-300" style="max-height: 0; opacity: 0;">
                                <div class="pt-3">
                                    
                                    <div class="flex space-x-2">
                                        <!-- Input com bot√£o de limpar inline -->
                                        <div class="flex-1 relative">
                                            <input 
                                                type="text" 
                                                id="coupon-code" 
                                                class="w-full px-2 sm:px-3 py-2 pr-8 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent uppercase" 
                                                placeholder="C√≥digo do cupom"
                                                style="text-transform: uppercase;"
                                                oninput="this.value = this.value.toUpperCase(); toggleClearButton()"
                                                onkeypress="if(event.key==='Enter') applyCouponFromButton()">
                                            <!-- Bot√£o de limpar dentro do input -->
                                            <button 
                                                id="clear-coupon-btn"
                                                onclick="clearCouponInput()" 
                                                class="absolute right-2 top-1/2 transform -translate-y-1/2 w-5 h-5 rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-colors hidden"
                                                title="Limpar c√≥digo"
                                                type="button">
                                                <span class="text-xs font-bold">√ó</span>
                                            </button>
                                        </div>
                                        <button 
                                            onclick="applyCouponFromButton()" 
                                            class="px-3 sm:px-4 py-2 text-xs sm:text-sm text-white rounded-lg transition-colors whitespace-nowrap"
                                            style="background-color: var(--cor-primaria) !important;"
                                            onmouseover="this.style.backgroundColor='var(--cor-primaria-hover)'"
                                            onmouseout="this.style.backgroundColor='var(--cor-primaria)'">
                                            Aplicar
                                        </button>
                                    </div>
                                    
                                    <!-- Feedback do Cupom -->
                                    <div id="coupon-feedback" class="mt-2 text-xs hidden"></div>
                                </div>
                            </div>
                            
                        </div>
                        
                    </div>
                    
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">Nome *</label>
                            <input type="text" id="customer-name" class="w-full px-3 py-2 rounded-lg" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important;" placeholder="Seu nome completo" autocomplete="off" oninput="clearFieldError('customer-name')" onfocus="this.style.borderColor='var(--cor-primaria)'; this.style.outline='2px solid var(--cor-primaria)'; this.style.outlineOffset='2px'" onblur="this.style.borderColor='var(--cor-borda)'; this.style.outline='none'">
                        </div>
                        
                        <div id="whatsapp-field" class="hidden">
                            <label class="block text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">WhatsApp *</label>
                            <div class="flex space-x-2">
                                <select id="country-code" class="px-3 py-2 rounded-lg" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important; min-width: 120px;" onfocus="this.style.borderColor='var(--cor-primaria)'; this.style.outline='2px solid var(--cor-primaria)'; this.style.outlineOffset='2px'" onblur="this.style.borderColor='var(--cor-borda)'; this.style.outline='none'" onchange="updatePhonePlaceholder()">
                                    <option value="55" data-flag="üáßüá∑" data-format="(99) 9 9999-9999">üáßüá∑ +55</option>
                                    <option value="351" data-flag="üáµüáπ" data-format="999 999 999">üáµüáπ +351</option>
                                    <option value="244" data-flag="üá¶üá¥" data-format="999 999 999">üá¶üá¥ +244</option>
                                    <option value="258" data-flag="üá≤üáø" data-format="99 999 9999">üá≤üáø +258</option>
                                    <option value="238" data-flag="üá®üáª" data-format="999 99 99">üá®üáª +238</option>
                                    <option value="245" data-flag="üá¨üáº" data-format="999 9999">üá¨üáº +245</option>
                                    <option value="239" data-flag="üá∏üáπ" data-format="99 99999">üá∏üáπ +239</option>
                                    <option value="670" data-flag="üáπüá±" data-format="999 9999">üáπüá± +670</option>
                                    <option value="853" data-flag="üá≤üá¥" data-format="9999 9999">üá≤üá¥ +853</option>
                                    <option value="1" data-flag="üá∫üá∏" data-format="(999) 999-9999">üá∫üá∏ +1</option>
                                    <option value="54" data-flag="üá¶üá∑" data-format="9 9999-9999">üá¶üá∑ +54</option>
                                    <option value="56" data-flag="üá®üá±" data-format="9 9999 9999">üá®üá± +56</option>
                                    <option value="57" data-flag="üá®üá¥" data-format="999 999 9999">üá®üá¥ +57</option>
                                    <option value="51" data-flag="üáµüá™" data-format="999 999 999">üáµüá™ +51</option>
                                    <option value="598" data-flag="üá∫üáæ" data-format="9999 9999">üá∫üáæ +598</option>
                                    <option value="595" data-flag="üáµüáæ" data-format="999 999999">üáµüáæ +595</option>
                                    <option value="591" data-flag="üáßüá¥" data-format="9999 9999">üáßüá¥ +591</option>
                                    <option value="593" data-flag="üá™üá®" data-format="99 999 9999">üá™üá® +593</option>
                                    <option value="58" data-flag="üáªüá™" data-format="999-999-9999">üáªüá™ +58</option>
                                    <option value="592" data-flag="üá¨üáæ" data-format="999 9999">üá¨üáæ +592</option>
                                    <option value="597" data-flag="üá∏üá∑" data-format="999-9999">üá∏üá∑ +597</option>
                                    <option value="594" data-flag="üá¨üá´" data-format="999 99 99 99">üá¨üá´ +594</option>
                                    <option value="34" data-flag="üá™üá∏" data-format="999 99 99 99">üá™üá∏ +34</option>
                                    <option value="33" data-flag="üá´üá∑" data-format="99 99 99 99 99">üá´üá∑ +33</option>
                                    <option value="39" data-flag="üáÆüáπ" data-format="999 999 9999">üáÆüáπ +39</option>
                                    <option value="49" data-flag="üá©üá™" data-format="999 99999999">üá©üá™ +49</option>
                                    <option value="44" data-flag="üá¨üáß" data-format="9999 999999">üá¨üáß +44</option>
                                </select>
                                <input type="tel" id="customer-whatsapp" class="flex-1 px-3 py-2 rounded-lg" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important;" placeholder="(11) 9 9999-9999" autocomplete="off" oninput="formatWhatsAppWithCountry(this); clearFieldError('customer-whatsapp')" onfocus="this.style.borderColor='var(--cor-primaria)'; this.style.outline='2px solid var(--cor-primaria)'; this.style.outlineOffset='2px'" onblur="this.style.borderColor='var(--cor-borda)'; this.style.outline='none'" inputmode="numeric">
                            </div>
                        </div>
                        
                        <!-- Forma de Pagamento e Switcher de Troco - Layout responsivo -->
                        <div class="flex flex-col space-y-4">
                            <!-- Linha 1: Forma de Pagamento e Switcher (lado a lado no desktop) -->
                            <div class="flex flex-col space-y-4 md:flex-row md:space-y-0 md:space-x-4">
                                <!-- Forma de Pagamento (lado esquerdo) -->
                                <div class="w-full md:flex-1">
                                    <label class="block text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">Forma de Pagamento *</label>
                                    <select id="payment-method" class="w-full px-3 py-2 rounded-lg" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important;" onchange="clearFieldError('payment-method'); handlePaymentMethodChange()" onfocus="this.style.borderColor='var(--cor-primaria)'; this.style.outline='2px solid var(--cor-primaria)'; this.style.outlineOffset='2px'" onblur="this.style.borderColor='var(--cor-borda)'; this.style.outline='none'">
                                        <option value="">Selecione...</option>
                                        <!-- Options will be populated dynamically by setupPaymentMethods() from spreadsheet -->
                                    </select>
                                </div>
                                
                                <!-- Switcher "Precisa de troco?" (lado direito - s√≥ aparece quando for dinheiro) -->
                                <div id="change-toggle-container" class="w-full md:flex-1 hidden">
                                    <label class="block text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">Precisa de troco?</label>
                                    <div class="flex items-center space-x-3 h-10">
                                        <!-- Toggle Switch -->
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="change-toggle" class="sr-only peer" onchange="handleChangeToggle()">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        </label>
                                        <span class="text-sm" style="color: var(--cor-texto-secundario) !important;" id="change-toggle-label">N√£o</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Linha 2: Campo de Valor do Troco (aparece embaixo quando switcher ativado) -->
                            <div id="money-change" class="w-full hidden">
                                <label class="block text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">Valor para Troco</label>
                                <input type="tel" id="change-amount" class="w-full px-3 py-2 rounded-lg" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important;" placeholder="Ex: R$ 50,00" autocomplete="off" inputmode="numeric" onfocus="this.style.borderColor='var(--cor-primaria)'; this.style.outline='2px solid var(--cor-primaria)'; this.style.outlineOffset='2px'" onblur="this.style.borderColor='var(--cor-borda)'; this.style.outline='none'">
                                <p class="text-xs mt-1" style="color: var(--cor-texto-secundario) !important; font-size: 11px;">Informe o valor que voc√™ tem para receber o troco</p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">Observa√ß√µes</label>
                            <textarea id="order-notes" class="w-full px-3 py-2 rounded-lg" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important;" rows="3" placeholder="Alguma observa√ß√£o especial?" onfocus="focusOrderNotesField(this)" onblur="this.style.borderColor='var(--cor-borda)'; this.style.outline='none'"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="prevStep(2)" class="w-2/5 py-3 rounded-lg font-medium transition-colors" style="background-color: var(--cor-fundo-secundario) !important; color: var(--cor-texto) !important;" onmouseover="this.style.backgroundColor='var(--cor-borda)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'">
                            ‚Üê Voltar
                        </button>
                        <button id="finalize-order-btn" disabled class="w-3/5 py-3 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2 cursor-not-allowed" style="background-color: #9ca3af !important; color: white !important;">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                            </svg>
                            <span>Enviar Pedido</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hours Modal -->
    <div id="hours-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[1100] hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto" style="background-color: var(--cor-fundo) !important;">
                <div class="p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-bold" style="color: var(--cor-texto) !important;">Hor√°rios de Funcionamento</h2>
                        <button onclick="closeHoursModal()" style="color: var(--cor-texto) !important;" onmouseover="this.style.color='var(--cor-texto)'" onmouseout="this.style.color='var(--cor-texto-secundario)'">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Rel√≥gio com Timezone -->
                    <div class="mb-3 text-center p-2 rounded-lg" style="background-color: var(--cor-fundo-secundario); border: 1px solid var(--cor-primaria-clara);">
                        <div class="flex items-center justify-center space-x-1 mb-1">
                            <svg class="w-3 h-3" style="color: var(--cor-primaria);" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-xs font-medium" style="color: var(--cor-texto-secundario);">Hor√°rio Atual</span>
                        </div>
                        <div id="timezone-clock" class="text-lg font-bold" style="color: var(--cor-primaria); font-family: 'Courier New', monospace;">
                            --:--:--
                        </div>
                        <div id="timezone-info" class="text-xs" style="color: var(--cor-texto-secundario); opacity: 0.8;">
                            Carregando timezone...
                        </div>
                    </div>
                    
                    <div id="hours-content" class="space-y-1">
                        <!-- Hours content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Estabelecimento Fechado -->
    <div id="closed-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[1100] hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="rounded-lg max-w-md w-full" style="background-color: var(--cor-fundo) !important;">
                <div class="p-4 text-center">
                    <!-- √çcone de Fechado -->
                    <div class="text-4xl mb-3">üïí</div>
                    
                    <!-- T√≠tulo -->
                    <h2 class="text-lg font-bold mb-3" style="color: var(--cor-texto) !important;">
                        Estabelecimento Fechado
                    </h2>
                    
                    <!-- Mensagem -->
                    <p class="text-sm mb-4" style="color: var(--cor-texto-secundario) !important;">
                        N√£o estamos recebendo pedidos no momento.<br>
                        Volte no pr√≥ximo hor√°rio de funcionamento.
                    </p>
                    
                    <!-- Pr√≥ximo Hor√°rio -->
                    <div class="p-3 rounded-lg mb-4" style="background-color: var(--cor-fundo-secundario); border: 1px solid var(--cor-primaria-clara);">
                        <div class="flex items-center justify-center space-x-1 mb-1">
                            <svg class="w-3 h-3" style="color: var(--cor-primaria);" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-xs font-medium" style="color: var(--cor-texto-secundario);">Pr√≥ximo Atendimento</span>
                        </div>
                        <p class="font-bold text-sm" style="color: var(--cor-primaria);" id="next-open-time">
                            Carregando...
                        </p>
                    </div>
                    
                    <!-- Bot√µes -->
                    <div class="flex space-x-2">
                        <button onclick="closeClosedModal()" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-colors" style="background-color: var(--cor-fundo-secundario) !important; color: var(--cor-texto) !important;" onmouseover="this.style.backgroundColor='var(--cor-borda)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'">
                            Entendi
                        </button>
                        <button onclick="closeClosedModal(); openHoursModal();" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-colors" style="background-color: var(--cor-primaria) !important; color: white !important;" onmouseover="this.style.backgroundColor='var(--cor-primaria-escura)'" onmouseout="this.style.backgroundColor='var(--cor-primaria)'">
                            Ver Hor√°rios
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal QR Code -->
    <div id="qrcode-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto" style="background-color: var(--cor-fundo) !important;">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold" style="color: var(--cor-texto) !important;">üîó QR Code do Card√°pio</h2>
                        <button onclick="closeQRCodeModal()" style="color: var(--cor-texto) !important;" onmouseover="this.style.color='var(--cor-texto)'" onmouseout="this.style.color='var(--cor-texto-secundario)'">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="text-center space-y-4">
                        <!-- QR Code Container -->
                        <div id="qrcode-container" class="flex justify-center p-4 rounded-lg" style="background-color: var(--cor-fundo-secundario); border: 2px solid var(--cor-primaria-clara);">
                            <div id="qrcode-display" class="bg-white p-4 rounded-lg shadow-lg">
                                <!-- QR Code ser√° gerado aqui -->
                            </div>
                        </div>
                        
                        <!-- URL Display -->
                        <div class="p-3 rounded-lg" style="background-color: var(--cor-fundo-secundario); border: 1px solid var(--cor-primaria-clara);">
                            <p class="text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">üì± Link do Card√°pio:</p>
                            <div class="flex items-center space-x-2">
                                <input id="qrcode-url" type="text" readonly class="flex-1 p-2 text-sm rounded border" style="background-color: var(--cor-fundo); color: var(--cor-texto); border-color: var(--cor-primaria-clara);" />
                                <button onclick="copyQRCodeURL(event)" class="px-3 py-2 text-sm font-medium rounded transition-all duration-300" style="background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white;" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'">
                                    üìã Copiar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col space-y-3">
                            <button id="download-qr-button" onclick="downloadQRCode(event)" disabled class="w-full py-3 px-4 font-medium rounded-lg transition-all duration-300" style="background: linear-gradient(135deg, #ccc, #999); color: #666; cursor: not-allowed;">
                                ‚è≥ Aguarde o QR Code...
                            </button>
                        </div>
                        
                        <!-- Info -->
                        <div class="text-xs text-center" style="color: var(--cor-texto-secundario); opacity: 0.8;">
                            <p>üì± Escaneie com a c√¢mera do celular</p>
                            <p>üîó Ou compartilhe o link diretamente</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda com Atalhos -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto" style="background-color: var(--cor-fundo) !important; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                <div class="p-6">
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 rounded-full" style="background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria));">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M11,16H13V18H11V16M12.61,6.04C10.55,6.04 8.99,7.59 8.99,9.65H10.96C10.96,8.65 11.7,7.96 12.61,7.96C13.52,7.96 14.26,8.65 14.26,9.65C14.26,10.1 14.05,10.5 13.75,10.79L12.79,11.75C12.35,12.19 12.14,12.63 12.14,13.54H14.11C14.11,13.04 14.32,12.6 14.76,12.16L15.72,11.2C16.23,10.69 16.69,10.04 16.69,9.65C16.69,7.59 15.13,6.04 12.61,6.04Z"/>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold" style="color: var(--cor-texto) !important;">üõ†Ô∏è Ferramentas do Sistema</h2>
                        </div>
                        <button onclick="closeHelpModal()" class="p-2 rounded-full transition-all duration-300" style="color: var(--cor-texto-secundario) !important;" onmouseover="this.style.backgroundColor='var(--cor-fundo-secundario)'; this.style.color='var(--cor-texto)'" onmouseout="this.style.backgroundColor='transparent'; this.style.color='var(--cor-texto-secundario)'">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Descri√ß√£o -->
                    <div class="mb-6 p-4 rounded-lg" style="background-color: var(--cor-fundo-secundario); border-left: 4px solid var(--cor-primaria);">
                        <p class="text-sm" style="color: var(--cor-texto-secundario) !important;">Acesse as ferramentas de desenvolvimento do sistema.</p>
                    </div>
                    
                    <!-- Lista de Atalhos -->
                    <div class="space-y-3">
                        <!-- Gerador de M√∫ltiplos Pre√ßos -->
                        <div class="flex items-center justify-between p-3 rounded-lg transition-all duration-300" style="background-color: var(--cor-fundo-secundario); border: 1px solid var(--cor-primaria-clara);" onmouseover="this.style.backgroundColor='var(--cor-primaria-clara)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'; this.style.transform='translateY(0)'">
                            <div class="flex items-center space-x-3">
                                <div>
                                    <h3 class="font-semibold" style="color: var(--cor-texto) !important;">üí∞ Gerador de M√∫ltiplos Pre√ßos</h3>
                                    <p class="text-sm" style="color: var(--cor-texto-secundario) !important;">Ferramenta para criar m√∫ltiplos pre√ßo baseado em um pre√ßo √∫nico</p>
                                </div>
                            </div>
                            <a href="https://dantetesta.com.br/gerador-de-precos/" target="_blank" class="px-4 py-2 text-sm font-medium rounded-lg transition-all duration-300" style="background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white; text-decoration: none;" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='scale(1)'">
                                Abrir
                            </a>
                        </div>

                        <!-- Gerador de Varia√ß√µes -->
                        <div class="flex items-center justify-between p-3 rounded-lg transition-all duration-300" style="background-color: var(--cor-fundo-secundario); border: 1px solid var(--cor-primaria-clara);" onmouseover="this.style.backgroundColor='var(--cor-primaria-clara)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'; this.style.transform='translateY(0)'">
                            <div class="flex items-center space-x-3">
                                <div>
                                    <h3 class="font-semibold" style="color: var(--cor-texto) !important;">üîß Gerador de Varia√ß√µes</h3>
                                    <p class="text-sm" style="color: var(--cor-texto-secundario) !important;">Crie varia√ß√µes de produtos</p>
                                </div>
                            </div>
                            <button onclick="openVariationGenerator()" class="px-4 py-2 text-sm font-medium rounded-lg transition-all duration-300" style="background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white;" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='scale(1)'">
                                Abrir
                            </button>
                        </div>

                        <!-- Gerador de QR Code -->
                        <div class="flex items-center justify-between p-3 rounded-lg transition-all duration-300" style="background-color: var(--cor-fundo-secundario); border: 1px solid var(--cor-primaria-clara);" onmouseover="this.style.backgroundColor='var(--cor-primaria-clara)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'; this.style.transform='translateY(0)'">
                            <div class="flex items-center space-x-3">
                                <div>
                                    <h3 class="font-semibold" style="color: var(--cor-texto) !important;">üì± Gerador de QR Code</h3>
                                    <p class="text-sm" style="color: var(--cor-texto-secundario) !important;">Crie QR Codes personalizados</p>
                                </div>
                            </div>
                            <button onclick="openQRCodeGenerator()" class="px-4 py-2 text-sm font-medium rounded-lg transition-all duration-300" style="background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white;" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='scale(1)'">
                                Abrir
                            </button>
                        </div>

                        <!-- Gerador de Cores -->
                        <div class="flex items-center justify-between p-3 rounded-lg transition-all duration-300" style="background-color: var(--cor-fundo-secundario); border: 1px solid var(--cor-primaria-clara);" onmouseover="this.style.backgroundColor='var(--cor-primaria-clara)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'; this.style.transform='translateY(0)'">
                            <div class="flex items-center space-x-3">
                                <div>
                                    <h3 class="font-semibold" style="color: var(--cor-texto) !important;">üé® Gerador de Cores</h3>
                                    <p class="text-sm" style="color: var(--cor-texto-secundario) !important;">Crie paletas de cores personalizadas</p>
                                </div>
                            </div>
                            <button onclick="openColorGenerator()" class="px-4 py-2 text-sm font-medium rounded-lg transition-all duration-300" style="background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white;" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='scale(1)'">
                                Abrir
                            </button>
                        </div>

                        <!-- Limpar Cache -->
                        <div class="flex items-center justify-between p-3 rounded-lg transition-all duration-300" style="background-color: var(--cor-fundo-secundario); border: 1px solid var(--cor-primaria-clara);" onmouseover="this.style.backgroundColor='var(--cor-primaria-clara)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'; this.style.transform='translateY(0)'">
                            <div class="flex items-center space-x-3">
                                <div>
                                    <h3 class="font-semibold" style="color: var(--cor-texto) !important;">üßπ Limpar Cache</h3>
                                    <p class="text-sm" style="color: var(--cor-texto-secundario) !important;">Limpa o cache e recarrega os dados</p>
                                </div>
                            </div>
                            <button onclick="clearStorageAndReload()" class="px-4 py-2 text-sm font-medium rounded-lg transition-all duration-300" style="background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white;" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='scale(1)'">
                                Executar
                            </button>
                        </div>
                                </div>
                                <div>
                                    <h3 class="font-semibold" style="color: var(--cor-texto) !important;">‚ùå Fechar Lightbox</h3>
                                    <p class="text-sm" style="color: var(--cor-texto-secundario) !important;">Fecha a visualiza√ß√£o ampliada de imagens</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="mt-6 pt-4 border-t text-center" style="border-color: var(--cor-primaria-clara);">
                        <p class="text-xs" style="color: var(--cor-texto-secundario) !important; opacity: 0.8;">üí° Pressione <strong>F1</strong> a qualquer momento para ver esta ajuda</p>
                        <p id="help-modal-credits" class="text-xs mt-1" style="color: var(--cor-texto-secundario) !important; opacity: 0.6;">
                            <!-- Cr√©ditos ser√£o preenchidos dinamicamente via CSV -->
                            Desenvolvido por <a href="#" target="_blank" style="color: var(--cor-primaria); text-decoration: none;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">Carregando...</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for menu data
        let menuData = {};
        let categoriesData = [];
        let hoursData = [];
        let configData = {};
        let neighborhoodsData = []; // Dados dos bairros para taxa de delivery
        let currentDeliveryFee = null; // Taxa de delivery atual
        let isDataLoaded = false;
        
        // Vari√°vel global para armazenar o timezone configurado (vem do config.js)
        let globalTimezone = TIMEZONE;
        
        // Sistema de Cupons - Vari√°veis Globais
        let couponsData = []; // Dados dos cupons carregados da planilha
        let appliedCoupon = null; // Cupom atualmente aplicado
        let couponDiscount = 0; // Valor do desconto aplicado
        let couponTimeout = null; // Timeout para aplica√ß√£o autom√°tica

        // ===== FUN√á√ÉO UTILIT√ÅRIA PARA VERIFICA√á√ÉO DEFENSIVA DE DOM =====
        
        /**
         * Verifica se um elemento DOM existe e opcionalmente loga um aviso se n√£o existir
         * @param {string} elementId - ID do elemento a ser verificado
         * @param {string} functionName - Nome da fun√ß√£o que est√° fazendo a verifica√ß√£o (para log)
         * @returns {HTMLElement|null} - O elemento se existir, null caso contr√°rio
         */
        function safeGetElement(elementId, functionName = 'unknown') {
            const element = document.getElementById(elementId);
            if (!element) {
                if (typeof warnLog === 'function') {
                    warnLog(`‚ö†Ô∏è Element '${elementId}' not found in function '${functionName}'`);
                }
            }
            return element;
        }
        
        // CSV URLs - agora importadas do config.js
        // As URLs das planilhas est√£o definidas no arquivo config.js

        // Global configuration object
        let appConfig = {
            identidade_visual: {},
            cores: {},
            contato: {},
            horario: {},
            redes_sociais: {},
            seo: {},
            checkout: {},
            envio: {}
        };

        // Function to parse CSV data with proper handling of quoted fields and line breaks
        function parseCSV(csvText) {
            if (!csvText || csvText.trim().length === 0) return [];
            
            // Normalizar quebras de linha
            csvText = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            let i = 0;
            
            while (i < csvText.length) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Aspas duplas escapadas dentro de campo com aspas
                        currentField += '"';
                        i += 2; // Pular as duas aspas
                        continue;
                    } else {
                        // In√≠cio ou fim de campo com aspas
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Fim do campo
                    currentRow.push(currentField.trim());
                    currentField = '';
                } else if (char === '\n' && !inQuotes) {
                    // Fim da linha
                    currentRow.push(currentField.trim());
                    if (currentRow.some(field => field.length > 0)) {
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentField = '';
                } else {
                    // Caractere normal (incluindo quebras de linha dentro de aspas)
                    currentField += char;
                }
                
                i++;
            }
            
            // Adicionar √∫ltimo campo e linha se necess√°rio
            if (currentField.length > 0 || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                if (currentRow.some(field => field.length > 0)) {
                    rows.push(currentRow);
                }
            }
            
            if (rows.length === 0) return [];
            
            // Processar cabe√ßalhos
            const headers = rows[0].map(header => {
                let cleanHeader = header.replace(/^"|"$/g, '').trim();
                return cleanHeader;
            });
            
            // Processar dados
            const data = [];
            for (let rowIndex = 1; rowIndex < rows.length; rowIndex++) {
                const row = {};
                const values = rows[rowIndex];
                
                headers.forEach((header, colIndex) => {
                    let value = values[colIndex] || '';
                    
                    // Remover aspas externas se presentes
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.slice(1, -1);
                    }
                    
                    // Processar aspas duplas escapadas
                    value = value.replace(/""/g, '"');
                    
                    row[header] = value;
                });
                
                data.push(row);
            }
            
            return data;
        }

        // Function to load CSV data
        async function loadCSVData(url) {
            if (!url || url.trim() === '') {
                warnLog('URL de CSV vazia ou n√£o definida.');
                return [];
            }

            try {
                debugLog(`Carregando CSV de: ${url}`);
                const response = await fetchWithCacheBuster(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                infoLog(`‚úÖ CSV carregado com sucesso de: ${url}`);
                return parseCSV(csvText);
            } catch (error) {
                errorLog(`‚ùå Falha ao carregar CSV de ${url}:`, error);
                throw error; // Propaga o erro para ser tratado pelo chamador
            }
        }

        // Function to process configuration data
        function processConfigData(configItems) {
            const config = {
                identidade_visual: {},
                cores: {},
                contato: {},
                horario: {},
                redes_sociais: {},
                seo: {},
                checkout: {},
                envio: {},
                setup: {}
            };

            configItems.forEach(item => {
                const section = item.section;
                const key = item.key;
                const value = item.value;

                if (config[section]) {
                    config[section][key] = value;
                }
            });

            return config;
        }

        // Function to apply configuration to the page
        function applyConfiguration() {
            try {
                // Apply header configuration
                updateHeaderWithConfig();
                updateFooterWithConfig();
                
                // Apply SEO configuration
                if (appConfig.seo.titulo_pagina) {
                    document.title = appConfig.seo.titulo_pagina;
                }
                
                if (appConfig.seo.descricao_seo) {
                    let metaDescription = document.querySelector('meta[name="description"]');
                    if (!metaDescription) {
                        metaDescription = document.createElement('meta');
                        metaDescription.name = 'description';
                        document.head.appendChild(metaDescription);
                    }
                    metaDescription.content = appConfig.seo.descricao_seo;
                }

                if (appConfig.seo.palavras_chave) {
                    let metaKeywords = document.querySelector('meta[name="keywords"]');
                    if (!metaKeywords) {
                        metaKeywords = document.createElement('meta');
                        metaKeywords.name = 'keywords';
                        document.head.appendChild(metaKeywords);
                    }
                    metaKeywords.content = appConfig.seo.palavras_chave;
                }

                // Apply favicon
                if (appConfig.identidade_visual.favicon_url) {
                    let favicon = document.querySelector('link[rel="icon"]');
                    if (!favicon) {
                        favicon = document.createElement('link');
                        favicon.rel = 'icon';
                        document.head.appendChild(favicon);
                    }
                    // Process favicon URL to handle Google Drive, Dropbox and external links
                    favicon.href = processImageUrl(appConfig.identidade_visual.favicon_url);
                }

                /**
                 * Fun√ß√£o para calcular uma cor 20% mais escura
                 */
                function darkenColor(color, percent = 20) {
                    // Remove # se presente
                    color = color.replace('#', '');
                    
                    // Converte para RGB
                    const r = parseInt(color.substr(0, 2), 16);
                    const g = parseInt(color.substr(2, 2), 16);
                    const b = parseInt(color.substr(4, 2), 16);
                    
                    // Aplica o escurecimento
                    const factor = (100 - percent) / 100;
                    const newR = Math.round(r * factor);
                    const newG = Math.round(g * factor);
                    const newB = Math.round(b * factor);
                    
                    // Converte de volta para hex
                    return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
                }
                
                /**
                 * Aplica cores escuras automaticamente para hover dos bot√µes
                 */
                function applyDarkerColors() {
                    const root = document.documentElement;
                    
                    // Obter cores atuais
                    const primaryColor = getComputedStyle(root).getPropertyValue('--cor-primaria').trim();
                    const secondaryColor = getComputedStyle(root).getPropertyValue('--cor-secundaria').trim();
                    const tertiaryColor = getComputedStyle(root).getPropertyValue('--cor-terciaria').trim();
                    const whatsappColor = getComputedStyle(root).getPropertyValue('--cor-whatsapp').trim();
                    
                    // Calcular e aplicar cores escuras
                    if (primaryColor) {
                        const darkerPrimary = darkenColor(primaryColor, 20);
                        root.style.setProperty('--cor-primaria-hover', darkerPrimary, 'important');
                    }
                    
                    if (secondaryColor) {
                        const darkerSecondary = darkenColor(secondaryColor, 20);
                        root.style.setProperty('--cor-secundaria-hover', darkerSecondary, 'important');
                    }
                    
                    if (tertiaryColor) {
                        const darkerTertiary = darkenColor(tertiaryColor, 20);
                        root.style.setProperty('--cor-terciaria-hover', darkerTertiary, 'important');
                    }
                    
                    if (whatsappColor) {
                        const darkerWhatsapp = darkenColor(whatsappColor, 20);
                        root.style.setProperty('--cor-whatsapp-hover', darkerWhatsapp, 'important');
                    }
                    
                    debugLog('Cores de hover aplicadas:', {
                        primary: primaryColor + ' ‚Üí ' + darkenColor(primaryColor, 20),
                        secondary: secondaryColor + ' ‚Üí ' + darkenColor(secondaryColor, 20),
                        tertiary: tertiaryColor + ' ‚Üí ' + darkenColor(tertiaryColor, 20),
                        whatsapp: whatsappColor + ' ‚Üí ' + darkenColor(whatsappColor, 20)
                    });
                }

                // Apply colors as CSS custom properties with !important
                if (appConfig.cores) {
                    const root = document.documentElement;
                    
                    // Cores principais
                    if (appConfig.cores.cor_primaria) {
                        root.style.setProperty('--cor-primaria', appConfig.cores.cor_primaria, 'important');
                    }
                    if (appConfig.cores.cor_secundaria) {
                        root.style.setProperty('--cor-secundaria', appConfig.cores.cor_secundaria, 'important');
                    }
                    if (appConfig.cores.cor_terciaria) {
                        root.style.setProperty('--cor-terciaria', appConfig.cores.cor_terciaria, 'important');
                    }
                    
                    // Cores de fundo
                    if (appConfig.cores.cor_fundo) {
                        root.style.setProperty('--cor-fundo', appConfig.cores.cor_fundo, 'important');
                        // Tamb√©m aplicar ao body com !important
                        document.body.style.setProperty('background-color', appConfig.cores.cor_fundo, 'important');
                    }
                    
                    // Cores de texto
                    if (appConfig.cores.cor_texto) {
                        root.style.setProperty('--cor-texto', appConfig.cores.cor_texto, 'important');
                    }
                    if (appConfig.cores.cor_texto_secundario) {
                        root.style.setProperty('--cor-texto-secundario', appConfig.cores.cor_texto_secundario, 'important');
                    }
                    
                    // Cores escuras para gradientes
                    if (appConfig.cores.cor_primaria_escura) {
                        root.style.setProperty('--cor-primaria-escura', appConfig.cores.cor_primaria_escura, 'important');
                    }
                    if (appConfig.cores.cor_secundaria_escura) {
                        root.style.setProperty('--cor-secundaria-escura', appConfig.cores.cor_secundaria_escura, 'important');
                    }
                    if (appConfig.cores.cor_terciaria_escura) {
                        root.style.setProperty('--cor-terciaria-escura', appConfig.cores.cor_terciaria_escura, 'important');
                    }
                    
                    // Atualizar gradientes baseados nas cores principais
                    if (appConfig.cores.cor_primaria && appConfig.cores.cor_primaria_escura) {
                        root.style.setProperty('--gradiente-primario', 
                            `linear-gradient(135deg, ${appConfig.cores.cor_primaria}, ${appConfig.cores.cor_primaria_escura})`, 'important');
                    }
                    if (appConfig.cores.cor_secundaria && appConfig.cores.cor_secundaria_escura) {
                        root.style.setProperty('--gradiente-secundario', 
                            `linear-gradient(135deg, ${appConfig.cores.cor_secundaria}, ${appConfig.cores.cor_secundaria_escura})`, 'important');
                    }
                    if (appConfig.cores.cor_terciaria && appConfig.cores.cor_terciaria_escura) {
                        root.style.setProperty('--gradiente-terciario', 
                            `linear-gradient(135deg, ${appConfig.cores.cor_terciaria}, ${appConfig.cores.cor_terciaria_escura})`, 'important');
                    }
                }
                
                // Aplicar cores escuras automaticamente (20% mais escuro)
                applyDarkerColors();

                // Apply delivery options configuration
                setupDeliveryOptions();
                
                // Apply checkout mode configuration
                applyCheckoutMode();

                debugLog('Configuration applied successfully');
            } catch (error) {
                errorLog('Error applying configuration:', error);
            }
        }

        // Function to update header with config data
        function updateHeaderWithConfig() {
            const companyNameElement = document.getElementById('header-company-name');
            const sloganElement = document.getElementById('header-slogan');
            const logoElement = document.getElementById('header-logo');
            
            // Update company name
            if (companyNameElement) {
                companyNameElement.textContent = getCompanyName();
            }
            
            // Update slogan
            if (sloganElement) {
                sloganElement.textContent = getSlogan();
            }
            
            // Update logo
            if (logoElement) {
                const logoUrl = getLogoUrl();
                if (logoUrl) {
                    logoElement.src = processImageUrl(logoUrl);
                    logoElement.style.display = 'block';
                } else {
                    logoElement.style.display = 'none';
                }
            }
        }

        // Function to apply checkout mode configuration
        function applyCheckoutMode() {
            try {
                debugLog('üõçÔ∏è Applying checkout mode...');
                
                const checkoutConfig = getCheckoutConfig();
                const checkoutMode = checkoutConfig.checkout_mode;
                debugLog('üõçÔ∏è Checkout mode:', checkoutMode);
                
                // Get cart elements
                const cartFab = document.getElementById('cart-fab');
                const cartCount = document.getElementById('cart-count');
                
                // Determine if checkout should be enabled
                const isCheckoutEnabled = checkoutMode && checkoutMode.toLowerCase() === 'sim';
                
                if (cartFab) {
                    if (!isCheckoutEnabled) {
                        cartFab.style.display = 'none';
                        debugLog('üõçÔ∏è Cart FAB hidden - checkout disabled');
                    } else {
                        const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
                        cartFab.style.display = cartCount > 0 ? 'flex' : 'none';
                        debugLog('üõçÔ∏è Cart FAB will show when items added');
                    }
                }
                
                // Add CSS class to control add to cart buttons
                const body = document.body;
                if (isCheckoutEnabled) {
                    body.classList.remove('checkout-disabled');
                } else {
                    body.classList.add('checkout-disabled');
                }
                
                debugLog('üõçÔ∏è Checkout mode applied successfully');
            } catch (error) {
                errorLog('Error applying checkout mode:', error);
            }
        }

        // Function to setup delivery options based on configuration
        function setupDeliveryOptions() {
            try {
                debugLog('üîß Setting up delivery options...');
                
                const checkoutConfig = getCheckoutConfig();
                debugLog('‚úÖ Checkout config retrieved');
                
                const deliveryOptionsContainer = document.getElementById('delivery-options');
                if (!deliveryOptionsContainer) {
                    warnLog('‚ùå Delivery options container not found');
                    return;
                }
                
                // Get delivery option elements by finding inputs and their parent labels
                const localOption = deliveryOptionsContainer?.querySelector('input[value="local"]')?.closest('label');
                const pickupOption = deliveryOptionsContainer?.querySelector('input[value="pickup"]')?.closest('label');
                const deliveryOption = deliveryOptionsContainer?.querySelector('input[value="delivery"]')?.closest('label');
                const defaultOption = deliveryOptionsContainer?.querySelector('input[value="default"]')?.closest('label');
                
                debugLog('üéØ Delivery options available:', {
                    local: !!localOption,
                    pickup: !!pickupOption,
                    delivery: !!deliveryOption,
                    default: !!defaultOption
                });

                // Helper function to extract visibility and labels from CSV value
                function parseOptionConfig(csvValue) {
                    if (!csvValue || !csvValue.includes('/')) {
                        return { shouldShow: false, label1: '', label2: '' };
                    }
                    const parts = csvValue.split('/');
                    const visibility = parts[0] ? parts[0].trim().toLowerCase() : '';
                    return {
                        shouldShow: visibility === 'sim',
                        label1: parts[1] ? parts[1].trim() : '',
                        label2: parts[2] ? parts[2].trim() : ''
                    };
                }

                // Configure local option (step2_opc1)
                if (localOption) {
                    const config = parseOptionConfig(checkoutConfig.step2_opc1);
                    localOption.style.display = config.shouldShow ? 'flex' : 'none';
                    
                    if (config.shouldShow) {
                        const titleElement = localOption.querySelector('.font-medium');
                        const subtitleElement = localOption.querySelector('.text-sm');
                        
                        if (titleElement && config.label1) {
                            titleElement.textContent = `üçΩÔ∏è ${config.label1}`;
                        }
                        if (subtitleElement && config.label2) {
                            subtitleElement.textContent = config.label2;
                        }
                        debugLog(`üè† Local option labels updated: "${config.label1}" / "${config.label2}"`);
                    }
                    debugLog(`üè† Local option: ${config.shouldShow ? 'VISIBLE' : 'HIDDEN'} (${checkoutConfig.step2_opc1})`);
                }

                // Configure pickup option (step2_opc2)
                if (pickupOption) {
                    const config = parseOptionConfig(checkoutConfig.step2_opc2);
                    pickupOption.style.display = config.shouldShow ? 'flex' : 'none';
                    
                    if (config.shouldShow) {
                        const titleElement = pickupOption.querySelector('.font-medium');
                        const subtitleElement = pickupOption.querySelector('.text-sm');
                        
                        if (titleElement && config.label1) {
                            titleElement.textContent = `ü•° ${config.label1}`;
                        }
                        if (subtitleElement && config.label2) {
                            subtitleElement.textContent = config.label2;
                        }
                        debugLog(`ü•° Pickup option labels updated: "${config.label1}" / "${config.label2}"`);
                    }
                    debugLog(`ü•° Pickup option: ${config.shouldShow ? 'VISIBLE' : 'HIDDEN'} (${checkoutConfig.step2_opc2})`);
                }

                // Configure delivery option (step2_opc3)
                if (deliveryOption) {
                    const config = parseOptionConfig(checkoutConfig.step2_opc3);
                    deliveryOption.style.display = config.shouldShow ? 'flex' : 'none';
                    
                    if (config.shouldShow) {
                        const titleElement = deliveryOption.querySelector('.font-medium');
                        const subtitleElement = deliveryOption.querySelector('.text-sm');
                        
                        if (titleElement && config.label1) {
                            titleElement.textContent = `üõµ ${config.label1}`;
                        }
                        if (subtitleElement && config.label2) {
                            subtitleElement.textContent = config.label2;
                        }
                        debugLog(`üõµ Delivery option labels updated: "${config.label1}" / "${config.label2}"`);
                    }
                    debugLog(`üõµ Delivery option: ${config.shouldShow ? 'VISIBLE' : 'HIDDEN'} (${checkoutConfig.step2_opc3})`);
                }

                // Configure default option (step2_opc4)
                if (defaultOption) {
                    const config = parseOptionConfig(checkoutConfig.step2_opc4);
                    defaultOption.style.display = config.shouldShow ? 'flex' : 'none';
                    
                    if (config.shouldShow) {
                        const titleElement = defaultOption.querySelector('.font-medium');
                        const subtitleElement = defaultOption.querySelector('.text-sm');
                        
                        if (titleElement && config.label1) {
                            titleElement.textContent = `üìã ${config.label1}`;
                        }
                        if (subtitleElement && config.label2) {
                            subtitleElement.textContent = config.label2;
                        }
                        debugLog(`üìã Default option labels updated: "${config.label1}" / "${config.label2}"`);
                    }
                    debugLog(`üìã Default option: ${config.shouldShow ? 'VISIBLE' : 'HIDDEN'} (${checkoutConfig.step2_opc4})`);
                }

                debugLog('‚úÖ Delivery options configuration completed');

            } catch (error) {
                errorLog('‚ùå Error setting up delivery options:', error);
            }
        }

        // Function to update footer with configuration data
        function updateFooterWithConfig() {
            const contactInfo = getContactInfo();
            const socialMedia = getSocialMedia();
            
            // Update footer company name
            const footerCompanyNameElement = document.getElementById('footer-company-name');
            if (footerCompanyNameElement) {
                footerCompanyNameElement.textContent = getCompanyName();
            }
            
            // Update footer address
            const footerAddressElement = document.getElementById('footer-address');
            if (footerAddressElement && contactInfo.endereco) {
                footerAddressElement.textContent = contactInfo.endereco;
                footerAddressElement.style.display = 'block';
            } else if (footerAddressElement) {
                footerAddressElement.style.display = 'none';
            }
            
            // Update footer phone
            const footerPhoneElement = document.getElementById('footer-phone');
            if (footerPhoneElement && contactInfo.telefone) {
                footerPhoneElement.querySelector('span:last-child').textContent = contactInfo.telefone;
                footerPhoneElement.href = `tel:${contactInfo.telefone}`;
                footerPhoneElement.style.display = 'flex';
            } else if (footerPhoneElement) {
                footerPhoneElement.style.display = 'none';
            }
            

            
            // Update footer email
            const footerEmailElement = document.getElementById('footer-email');
            if (footerEmailElement && contactInfo.email) {
                footerEmailElement.dataset.email = contactInfo.email;
                footerEmailElement.style.display = 'block';
            } else if (footerEmailElement) {
                footerEmailElement.style.display = 'none';
            }
            
            // Update social media links
            const footerInstagramElement = document.getElementById('footer-instagram');
            if (footerInstagramElement && socialMedia.instagram) {
                footerInstagramElement.href = socialMedia.instagram;
                footerInstagramElement.style.display = 'block';
            } else if (footerInstagramElement) {
                footerInstagramElement.style.display = 'none';
            }
            
            const footerFacebookElement = document.getElementById('footer-facebook');
            if (footerFacebookElement && socialMedia.facebook) {
                footerFacebookElement.href = socialMedia.facebook;
                footerFacebookElement.style.display = 'block';
            } else if (footerFacebookElement) {
                footerFacebookElement.style.display = 'none';
            }
            
            const footerWhatsappElement = document.getElementById('footer-whatsapp');
            if (footerWhatsappElement && contactInfo.whatsapp) {
                const whatsappNumber = contactInfo.whatsapp.replace(/\D/g, '');
                footerWhatsappElement.href = `https://wa.me/${whatsappNumber}`;
                footerWhatsappElement.style.display = 'block';
            } else if (footerWhatsappElement) {
                footerWhatsappElement.style.display = 'none';
            }
            
            const footerEmailLinkElement = document.getElementById('footer-email-link');
            if (footerEmailLinkElement && contactInfo.email) {
                footerEmailLinkElement.href = `mailto:${contactInfo.email}`;
                footerEmailLinkElement.style.display = 'block';
            } else if (footerEmailLinkElement) {
                footerEmailLinkElement.style.display = 'none';
            }
            
            // Update Google Reviews section
            const googleReviewsSection = document.getElementById('google-reviews-section');
            const googleReviewsLink = document.getElementById('google-reviews-link');
            if (googleReviewsSection && googleReviewsLink && socialMedia.google) {
                googleReviewsLink.href = socialMedia.google;
                googleReviewsSection.style.display = 'block';
            } else if (googleReviewsSection) {
                googleReviewsSection.style.display = 'none';
            }
            
            // Update author credits dynamically
            updateAuthorCredits();
        }

        // Helper functions to access configuration data
        function getConfig(section, key, defaultValue = '') {
            return appConfig[section]?.[key] || defaultValue;
        }

        function getCompanyName() {
            return getConfig('identidade_visual', 'nome_empresa', 'Card√°pio Digital');
        }

        function getSlogan() {
            return getConfig('identidade_visual', 'slogan', 'Delivery');
        }

        function getLogoUrl() {
            return getConfig('identidade_visual', 'logo_url', '');
        }

        function getLogoMobileUrl() {
            return getConfig('identidade_visual', 'logo_mobile_url', '');
        }

        function getContactInfo() {
            return {
                endereco: getConfig('contato', 'endereco_completo', ''),
                telefone: getConfig('contato', 'telefone', ''),
                whatsapp: getConfig('contato', 'whatsapp', ''),
                email: getConfig('contato', 'email', '')
            };
        }

        function getSocialMedia() {
            return {
                instagram: getConfig('redes_sociais', 'instagram_url', ''),
                facebook: getConfig('redes_sociais', 'facebook_url', ''),
                google: getConfig('redes_sociais', 'google_negocio_url', '')
            };
        }

        function getCheckoutConfig() {
            return {
                step2_opc1: getConfig('checkout', 'step2_opc1', ''),
                step2_opc2: getConfig('checkout', 'step2_opc2', ''),
                step2_opc3: getConfig('checkout', 'step2_opc3', ''),
                step2_opc4: getConfig('checkout', 'step2_opc4', ''),
                step2_taxa_delivery: getConfig('checkout', 'step2_taxa_delivery', ''),
                step3_show_formas_pag: getConfig('checkout', 'step3_show_formas_pag', 'Sim'),
                step3_formas_pag: getConfig('checkout', 'step3_formas_pag', ''),
                step3_mesa_comanda: getConfig('checkout', 'step3_mesa_comanda', 'Sim'),
                step1_itens_obs: getConfig('checkout', 'step1_itens_obs', 'Sim'),
                checkout_mode: getConfig('checkout', 'checkout_mode', 'Sim'),
                checkout_currency: getConfig('checkout', 'checkout_currency', 'BRL'),
                step3_chave_pix: getConfig('checkout', 'step3_chave_pix', ''), // ‚úÖ CHAVE PIX
                only_bairro_mode: getConfig('checkout', 'only_bairro_mode', 'N√£o') // üîí MODO RESTRI√á√ÉO BAIRRO
            };
        }
        
        /**
         * Obt√©m configura√ß√µes de contato
         * @returns {Object} Configura√ß√µes de contato
         */
        function getContactConfig() {
            return {
                whatsapp: getConfig('contato', 'whatsapp', '5519998021956'),
                telefone: getConfig('contato', 'telefone', ''),
                email: getConfig('contato', 'email', ''),
                endereco: getConfig('contato', 'endereco', '')
            };
        }

        function getEnvioConfig() {
            return {
                whatsapp_web: getConfig('envio', 'whatsapp_web', 'Sim'),
                webhook_url: getConfig('envio', 'webhook_url', '')
            };
        }
        
        // ‚úÖ FUN√á√ïES PARA CHAVE PIX
        
        // Fun√ß√£o para validar CPF usando d√≠gitos verificadores
        function isValidCPF(cpf) {
            // Remove caracteres n√£o num√©ricos
            const cleanCPF = cpf.replace(/\D/g, '');
            
            // Verifica se tem 11 d√≠gitos
            if (cleanCPF.length !== 11) return false;
            
            // Verifica se todos os d√≠gitos s√£o iguais (CPFs inv√°lidos como 11111111111)
            if (/^(\d)\1{10}$/.test(cleanCPF)) return false;
            
            // Calcula o primeiro d√≠gito verificador
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                sum += parseInt(cleanCPF.charAt(i)) * (10 - i);
            }
            let remainder = sum % 11;
            let digit1 = remainder < 2 ? 0 : 11 - remainder;
            
            // Verifica o primeiro d√≠gito
            if (parseInt(cleanCPF.charAt(9)) !== digit1) return false;
            
            // Calcula o segundo d√≠gito verificador
            sum = 0;
            for (let i = 0; i < 10; i++) {
                sum += parseInt(cleanCPF.charAt(i)) * (11 - i);
            }
            remainder = sum % 11;
            let digit2 = remainder < 2 ? 0 : 11 - remainder;
            
            // Verifica o segundo d√≠gito
            return parseInt(cleanCPF.charAt(10)) === digit2;
        }
        
        function detectPixKeyType(pixKey) {
            if (!pixKey || pixKey.trim() === '') return 'empty';
            
            const cleanKey = pixKey.trim();
            
            // Email: formato de email (verificar primeiro para evitar conflitos)
            if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(cleanKey)) {
                return 'email';
            }
            
            // Telefone: formato +5511999999999 ou similar
            if (/^\+\d{10,15}$/.test(cleanKey)) {
                return 'telefone';
            }
            
            // Verificar se s√£o 11 d√≠gitos num√©ricos
            if (/^\d{11}$/.test(cleanKey)) {
                // ‚úÖ L√ìGICA MELHORADA: Usar valida√ß√£o de CPF
                if (isValidCPF(cleanKey)) {
                    return 'cpf';
                } else {
                    // Se n√£o √© um CPF v√°lido, assumir como telefone
                    return 'telefone';
                }
            }
            
            // CNPJ: 14 d√≠gitos num√©ricos
            if (/^\d{14}$/.test(cleanKey)) {
                return 'cnpj';
            }
            
            // Chave aleat√≥ria: formato UUID ou similar
            if (/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(cleanKey)) {
                return 'aleatoria';
            }
            
            // Se n√£o se encaixa em nenhum padr√£o conhecido, assumir como chave aleat√≥ria
            return 'aleatoria';
        }

        function formatPixKey(pixKey, type) {
            const cleanKey = pixKey.trim();
            
            switch (type) {
                case 'cpf':
                    // Formatar CPF: 000.000.000-00
                    return cleanKey.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                
                case 'cnpj':
                    // Formatar CNPJ: 00.000.000/0000-00
                    return cleanKey.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                
                case 'telefone':
                    // ‚úÖ FORMATA√á√ÉO INTELIGENTE DE TELEFONE
                    if (/^\d{11}$/.test(cleanKey)) {
                        // Formato celular: (19) 9 9999-9999
                        return cleanKey.replace(/(\d{2})(\d{1})(\d{4})(\d{4})/, '($1) $2 $3-$4');
                    } else if (/^\d{10}$/.test(cleanKey)) {
                        // Formato fixo: (19) 9999-9999
                        return cleanKey.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                    }
                    return cleanKey; // Para telefones com + ou outros formatos
                
                case 'email':
                case 'aleatoria':
                default:
                    return cleanKey;
            }
        }

        function getPixKeyIcon(type) {
            switch (type) {
                case 'cpf': return 'üë§';
                case 'cnpj': return 'üè¢';
                case 'email': return 'üìß';
                case 'telefone': return 'üì±';
                case 'aleatoria': return 'üîë';
                default: return 'üì±';
            }
        }

        function getPixKeyLabel(type) {
            switch (type) {
                case 'cpf': return 'CPF';
                case 'cnpj': return 'CNPJ';
                case 'email': return 'E-mail';
                case 'telefone': return 'Telefone';
                case 'aleatoria': return 'Chave Aleat√≥ria';
                default: return 'Chave PIX';
            }
        }

        function copyPixKey(pixKey) {
            const button = document.getElementById('copy-pix-btn');
            const originalText = button.innerHTML;
            const originalClass = button.className;
            
            // ‚úÖ FEEDBACK VISUAL IMEDIATO
            button.innerHTML = '‚úÖ Copiado!';
            button.className = button.className.replace('bg-blue-600', 'bg-green-600').replace('hover:bg-blue-700', 'hover:bg-green-700');
            button.disabled = true;
            
            if (navigator.clipboard && window.isSecureContext) {
                // M√©todo moderno
                navigator.clipboard.writeText(pixKey).then(() => {
                    // Sucesso - manter feedback visual
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.className = originalClass;
                        button.disabled = false;
                    }, 2000);
                }).catch(() => {
                    fallbackCopyPixKey(pixKey, button, originalText, originalClass);
                });
            } else {
                // Fallback para navegadores mais antigos
                fallbackCopyPixKey(pixKey, button, originalText, originalClass);
            }
        }

        function fallbackCopyPixKey(pixKey, button, originalText, originalClass) {
            const textArea = document.createElement('textarea');
            textArea.value = pixKey;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                // Sucesso - manter feedback visual
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.className = originalClass;
                    button.disabled = false;
                }, 2000);
            } catch (err) {
                // Erro - feedback visual de erro
                button.innerHTML = '‚ùå Erro';
                button.className = button.className.replace('bg-green-600', 'bg-red-600').replace('hover:bg-green-700', 'hover:bg-red-700');
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.className = originalClass;
                    button.disabled = false;
                }, 2000);
            }
            
            document.body.removeChild(textArea);
        }

        function showPixInfo() {
            const checkoutConfig = getCheckoutConfig();
            const pixKey = checkoutConfig.step3_chave_pix;
            let pixDiv = document.getElementById('pix-info');
            
            if (!pixDiv) {
                // Criar elemento se n√£o existir
                pixDiv = document.createElement('div');
                pixDiv.id = 'pix-info';
                pixDiv.className = 'mt-4 p-4 border rounded-lg transition-all duration-300';
                
                // ‚úÖ POSICIONAMENTO DEFINITIVO: Inserir ap√≥s o container flex do pagamento
                const paymentSelect = document.getElementById('payment-method');
                const paymentFieldDiv = paymentSelect.parentElement; // div com label e select (w-full md:flex-1)
                const flexContainer = paymentFieldDiv.parentElement; // div flex com payment e troco
                const checkoutContainer = flexContainer.parentElement; // container do checkout
                
                // Inserir ap√≥s o container flex inteiro (payment + troco)
                checkoutContainer.insertBefore(pixDiv, flexContainer.nextSibling);
            }
            
            if (pixKey && pixKey.trim() !== '') {
                const keyType = detectPixKeyType(pixKey);
                const formattedKey = formatPixKey(pixKey, keyType);
                const icon = getPixKeyIcon(keyType);
                const label = getPixKeyLabel(keyType);
                
                // ‚úÖ LAYOUT MELHORADO: Stack vertical em mobile, horizontal em desktop
                pixDiv.className = 'mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg transition-all duration-300';
                pixDiv.innerHTML = `
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div class="flex-1">
                            <h4 class="font-medium text-blue-800 flex items-center gap-2 mb-1">
                                ${icon} Chave PIX (${label})
                            </h4>
                            <p class="text-blue-700 font-mono text-sm break-all">${formattedKey}</p>
                        </div>
                        <button id="copy-pix-btn" onclick="copyPixKey('${pixKey}')" 
                                class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition-all duration-300 flex-shrink-0 self-start sm:self-center">
                            üìã Copiar
                        </button>
                    </div>
                    <p class="text-xs text-blue-600 mt-3">üí° Use esta chave para fazer o pagamento via PIX</p>
                `;
                
                debugLog('üì± Chave PIX detectada:', { pixKey, keyType, formattedKey });
            } else {
                // Mostrar mensagem para solicitar
                pixDiv.className = 'mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg transition-all duration-300';
                pixDiv.innerHTML = `
                    <div class="text-center">
                        <p class="text-yellow-700 flex items-center justify-center gap-2">
                            üí¨ Solicite a chave PIX no WhatsApp com o estabelecimento
                        </p>
                    </div>
                `;
                
                debugLog('üì± Chave PIX n√£o configurada - mostrando mensagem alternativa');
            }
            
            pixDiv.classList.remove('hidden');
        }
        
        function getAuthorInfo() {
            return {
                name: getConfig('setup', 'autor_name', ''),
                link: getConfig('setup', 'autor_link', '')
            };
        }
        
        /**
         * Atualiza os cr√©ditos do autor dinamicamente em todos os locais
         * Se n√£o configurado no CSV, oculta completamente os cr√©ditos
         */
        function updateAuthorCredits() {
            const authorInfo = getAuthorInfo();
            debugLog('üé® Verificando cr√©ditos do autor:', authorInfo);
            
            // Verificar se h√° dados de autor configurados
            const hasAuthorData = authorInfo.name.trim() !== '' && authorInfo.link.trim() !== '';
            
            // 1. Footer - mostrar ou ocultar o container inteiro
            const footerCreditsContainer = document.getElementById('footer-credits-container');
            if (footerCreditsContainer) {
                if (hasAuthorData) {
                    // Mostrar container e atualizar cr√©ditos
                    footerCreditsContainer.style.display = 'block';
                    const footerLink = footerCreditsContainer.querySelector('a');
                    if (footerLink) {
                        footerLink.textContent = authorInfo.name;
                        footerLink.href = authorInfo.link;
                        debugLog('‚úÖ Container de cr√©ditos do footer exibido:', authorInfo.name);
                    }
                } else {
                    // Ocultar container inteiro (sem borda, padding, etc.)
                    footerCreditsContainer.style.display = 'none';
                    debugLog('üôà Container de cr√©ditos do footer ocultado - sem linha vazia');
                }
            }
            
            // 2. Modal de ajuda - mostrar ou ocultar
            const helpModalCredits = document.getElementById('help-modal-credits');
            if (helpModalCredits) {
                if (hasAuthorData) {
                    // Mostrar e atualizar cr√©ditos
                    helpModalCredits.style.display = 'block';
                    const helpLink = helpModalCredits.querySelector('a');
                    if (helpLink) {
                        helpLink.textContent = authorInfo.name;
                        helpLink.href = authorInfo.link;
                        debugLog('‚úÖ Cr√©ditos do modal exibidos:', authorInfo.name);
                    }
                } else {
                    // Ocultar completamente
                    helpModalCredits.style.display = 'none';
                    debugLog('üôà Cr√©ditos do modal ocultados - dados n√£o configurados');
                }
            }
            
            debugLog('üéâ Sistema de cr√©ditos din√¢micos atualizado! Oculta se vazio.');
        }

        function getAppConfig() {
            return {
                nome_restaurante: getConfig('identidade_visual', 'nome_empresa', 'Card√°pio Digital')
            };
        }

        // Function to process menu items and organize by category
        function processMenuData(menuItems, categories) {
            const processedData = {};
            
            // Initialize categories
            categories.forEach(category => {
                if (category.status === 'Ativo') {
                    processedData[category.nome_categoria] = [];
                }
            });

            // Process menu items
            menuItems.forEach((item, index) => {
                if (item.status === 'Ativo') {
                    // Support multiple categories separated by comma or semicolon
                    const itemCategories = item.categoria
                        .split(/[,;]/) // Split by comma or semicolon
                        .map(cat => cat.trim()) // Remove whitespace
                        .filter(cat => cat && processedData[cat]); // Only valid active categories
                    
                    // Create the processed item once
                    const processedItem = {
                        id: index + 1,
                        nome: item.item,
                        sku: item.SKU,
                        descricao: item.descricao,
                        preco: item.preco, // Manter como string para suportar pre√ßos m√∫ltiplos
                        imagem: processImageUrl(item.foto_url),
                        disponivel: true,
                        classificacaoAdicional: item.classificacao_adicional,
                        observacoes: item.observacoes
                    };
                    
                    // Add the item to each valid category
                    itemCategories.forEach(categoryName => {
                        // Create a copy of the item for each category to avoid reference issues
                        const itemCopy = { ...processedItem };
                        processedData[categoryName].push(itemCopy);
                    });
                }
            });

            return processedData;
        }

        // Function to show preloader
        function showPreloader() {
            // Verificar se a vari√°vel PRELOADER_LOGO_URL existe e n√£o est√° vazia
            let logoURL = '';
            
            // Verifica√ß√£o rigorosa da vari√°vel do config.js
            if (typeof PRELOADER_LOGO_URL !== 'undefined' && PRELOADER_LOGO_URL && PRELOADER_LOGO_URL.trim() !== '') {
                logoURL = PRELOADER_LOGO_URL.trim();
                
                if (typeof debugLog === 'function') {
                    debugLog('üñºÔ∏è URL do logo encontrada no config.js:', logoURL);
                }
                
                // Processar URLs do Google Drive para formato direto
                if (logoURL.includes('drive.google.com/file/d/')) {
                    const fileId = logoURL.match(/\/d\/([a-zA-Z0-9-_]+)/)?.[1];
                    if (fileId) {
                        logoURL = `https://drive.google.com/thumbnail?id=${fileId}&sz=w300`;
                        if (typeof debugLog === 'function') {
                            debugLog('üîÑ URL do Google Drive processada:', logoURL);
                        }
                    }
                }
                
                // Processar URLs do Dropbox
                if (logoURL.includes('dropbox.com') && !logoURL.includes('?raw=1')) {
                    logoURL = logoURL.replace('?dl=0', '?raw=1').replace('?dl=1', '?raw=1');
                    if (!logoURL.includes('?raw=1')) {
                        logoURL += '?raw=1';
                    }
                    if (typeof debugLog === 'function') {
                        debugLog('üîÑ URL do Dropbox processada:', logoURL);
                    }
                }
            } else {
                if (typeof debugLog === 'function') {
                    debugLog('‚ùå PRELOADER_LOGO_URL n√£o definida, vazia ou comentada - logo ser√° omitido');
                }
            }
            
            // Gerar HTML do logo apenas se URL v√°lida existir
            const logoHTML = logoURL ? 
                `<div class="preloader-logo-container mb-4">
                    <img src="${logoURL}" alt="Logo" class="preloader-logo" 
                         style="max-width: 150px; max-height: 150px; object-fit: contain;" 
                         onerror="if (typeof warnLog === 'function') warnLog('‚ùå Logo do preloader falhou ao carregar:', '${logoURL}'); this.parentElement.style.display='none';" 
                         onload="if (typeof debugLog === 'function') debugLog('‚úÖ Logo do preloader carregado com sucesso'); this.style.opacity='1';">
                </div>` : '';
            
            const preloaderHTML = `
                <div id="preloader" class="fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);">
                    <div class="text-center">
                        ${logoHTML}
                        
                        <!-- Texto "Carregando" com efeito snake -->
                        <div class="loading-text mb-6">
                            <span class="loading-letter" style="animation-delay: 0s;">C</span>
                            <span class="loading-letter" style="animation-delay: 0.1s;">a</span>
                            <span class="loading-letter" style="animation-delay: 0.2s;">r</span>
                            <span class="loading-letter" style="animation-delay: 0.3s;">r</span>
                            <span class="loading-letter" style="animation-delay: 0.4s;">e</span>
                            <span class="loading-letter" style="animation-delay: 0.5s;">g</span>
                            <span class="loading-letter" style="animation-delay: 0.6s;">a</span>
                            <span class="loading-letter" style="animation-delay: 0.7s;">n</span>
                            <span class="loading-letter" style="animation-delay: 0.8s;">d</span>
                            <span class="loading-letter" style="animation-delay: 0.9s;">o</span>
                        </div>
                        
                        <!-- Barra de progresso minimalista -->
                        <div class="progress-container-minimal">
                            <div id="progress-bar" class="progress-fill-minimal"></div>
                        </div>
                        <div id="progress-percentage" class="progress-percentage">0%</div>
                    </div>
                </div>
                
                <style>
                /* Container do logo - centralizado */
                .preloader-logo-container {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }
                
                /* Logo do preloader - flat design */
                .preloader-logo {
                    animation: logoFloat 3s ease-in-out infinite;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    display: block;
                }
                
                @keyframes logoFloat {
                    0%, 100% { transform: translateY(0px); }
                    50% { transform: translateY(-5px); }
                }
                
                /* Texto com efeito de pulsa√ß√£o suave */
                .loading-text {
                    font-size: 14px;
                    font-weight: 300;
                    letter-spacing: 0.5px;
                    color: #333;
                    animation: textPulse 3s ease-in-out infinite;
                }
                
                .loading-letter {
                    display: inline-block;
                    animation: letterGlow 2s ease-in-out infinite;
                    transform-origin: center;
                }
                
                /* Pulsa√ß√£o suave do texto inteiro */
                @keyframes textPulse {
                    0%, 100% { 
                        transform: scale(1);
                        opacity: 0.8;
                    }
                    50% { 
                        transform: scale(1.05);
                        opacity: 1;
                    }
                }
                
                /* Efeito de brilho nas letras com tons da cor prim√°ria */
                @keyframes letterGlow {
                    0%, 100% { 
                        color: #666;
                        opacity: 0.7;
                    }
                    25% { 
                        color: ${PRELOADER_COLOR};
                        opacity: 1;
                    }
                    50% { 
                        color: #999;
                        opacity: 0.8;
                    }
                    75% { 
                        color: rgba(51, 51, 51, 0.9);
                        opacity: 0.9;
                    }
                }
                
                /* Barra de progresso minimalista - flat design */
                .progress-container-minimal {
                    width: 200px;
                    height: 2px;
                    background: rgba(0, 0, 0, 0.1);
                    border-radius: 2px;
                    margin: 0 auto;
                    overflow: hidden;
                    position: relative;
                }
                
                .progress-fill-minimal {
                    height: 4px;
                    width: 0%;
                    background: ${PRELOADER_COLOR};
                    border-radius: 2px;
                    transition: width 0.3s ease;
                    position: absolute;
                    top: -1px;
                }
                
                /* Porcentagem abaixo da barra */
                .progress-percentage {
                    font-size: 10px;
                    font-weight: 400;
                    color: #666;
                    text-align: center;
                    margin-top: 8px;
                    letter-spacing: 0.5px;
                }
                
                /* Responsividade */
                @media (max-width: 640px) {
                    .loading-text {
                        font-size: 12px;
                        letter-spacing: 0.3px;
                    }
                    
                    .progress-container-minimal {
                        width: 150px;
                    }
                    
                    .progress-text {
                        font-size: 9px;
                        margin-top: 6px;
                    }
                    
                    .preloader-logo {
                        max-width: 120px !important;
                        max-height: 120px !important;
                    }
                }
                </style>
            `;
            document.body.insertAdjacentHTML('beforeend', preloaderHTML);
            
            // Desabilitar scroll do body durante o preloader
            document.body.style.overflow = 'hidden';
            if (typeof debugLog === 'function') {
                debugLog('üö´ Scroll do body desabilitado durante preloader');
            }
        }

        // Function to update progress
        function updateProgress(percentage) {
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            
            if (progressPercentage) {
                progressPercentage.textContent = Math.round(percentage) + '%';
            }
            
            if (typeof debugLog === 'function') {
                debugLog('üìã Progresso atualizado:', Math.round(percentage) + '%');
            }
        }

        // Function to hide preloader
        function hidePreloader() {
            const preloader = document.getElementById('preloader');
            if (preloader) {
                preloader.style.opacity = '0';
                setTimeout(() => {
                    preloader.remove();
                    
                    // Reabilitar scroll do body
                    document.body.style.overflow = '';
                    
                    // Mostrar conte√∫do principal (anti-flash)
                    document.body.classList.add('loaded');
                    debugLog('‚úÖ Conte√∫do principal exibido (anti-flash)');
                    debugLog('‚úÖ Scroll enabled after preloader');
                    
                    // Mostrar toast da mesa ap√≥s carregamento completo
                    setTimeout(() => {
                        mostrarIndicadorMesaURL();
                    }, 500);
                }, 300);
            }
        }

        /**
         * Fun√ß√£o para adicionar par√¢metros anti-cache √†s URLs
         */
        function addCacheBuster(url) {
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}v=${Date.now()}&nocache=${Math.random()}`;
        }
        
        /**
         * Fun√ß√£o para fazer fetch com cache busting
         */
        // Fun√ß√£o de fetch simplificada que apenas adiciona um cache buster na URL
        function fetchWithCacheBuster(url, options = {}) {
            const cacheBustedUrl = addCacheBuster(url);
            return fetch(cacheBustedUrl, options);
        }
        
        // Fun√ß√£o para limpar localStorage e recarregar p√°gina
        function clearStorageAndReload() {
            try {
                if (confirm('üßπ Limpar Cache\n\nIsso vai:\n‚Ä¢ Limpar todos os dados salvos\n‚Ä¢ Limpar cache do navegador\n‚Ä¢ Recarregar a p√°gina\n\nDeseja continuar?')) {
                    debugLog('üßπ === LIMPEZA COMPLETA DE CACHE ===');
                    
                    // 1. Limpar localStorage
                    try {
                        if (typeof clearAllStorageData === 'function') {
                            clearAllStorageData();
                            debugLog('‚úÖ clearAllStorageData() executado');
                        } else {
                            localStorage.clear();
                            debugLog('‚úÖ localStorage.clear() executado');
                        }
                    } catch (e) {
                        errorLog('Erro ao limpar localStorage:', e);
                    }
                    
                    // 2. Limpar sessionStorage
                    try {
                        sessionStorage.clear();
                        debugLog('‚úÖ sessionStorage limpo');
                    } catch (e) {
                        errorLog('Erro ao limpar sessionStorage:', e);
                    }
                    
                    // 3. Limpar cache do navegador (se suportado)
                    try {
                        if ('caches' in window) {
                            caches.keys().then(function(names) {
                                for (let name of names) {
                                    caches.delete(name);
                                }
                                debugLog('‚úÖ Cache do navegador limpo');
                            });
                        }
                    } catch (e) {
                        warnLog('N√£o foi poss√≠vel limpar cache do navegador:', e);
                    }
                    
                    // 4. For√ßar recarregamento sem cache
                    debugLog('üîÑ Recarregando p√°gina sem cache...');
                    debugLog('=== FIM LIMPEZA CACHE ===');
                    
                    // For√ßar reload sem cache
                    window.location.reload(true);
                }
            } catch (e) {
                errorLog('Erro cr√≠tico ao limpar cache:', e);
                // For√ßar reload mesmo com erro
                window.location.reload(true);
            }
        }

        // Fun√ß√£o para mostrar erro de configura√ß√£o
        function showConfigurationError() {
            errorLog('üò´ Exibindo erro de configura√ß√£o - dados n√£o carregados');
            
            const errorHTML = `
                <div class="fixed inset-0 bg-white z-50 flex items-center justify-center">
                    <div class="text-center p-8 max-w-md mx-auto">
                        <div class="text-red-500 text-6xl mb-4">üòï</div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">Ops! Arquivo n√£o configurado</h2>
                        <p class="text-gray-600 mb-4">N√£o foi poss√≠vel carregar os dados do card√°pio. Verifique se as URLs da planilha est√£o configuradas corretamente.</p>
                        <button onclick="clearStorageAndReload()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Tentar Novamente
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', errorHTML);
        }

        // Function to load all data
        async function loadAllData() {
            try {
                showPreloader();
                updateProgress(5);
                
                // Inicializar sistema de localStorage
                if (typeof initializeStorageSystem === 'function') {
                    initializeStorageSystem();
                }

                // Load configuration data first
                infoLog('Loading configuration data...');
                // Para a configura√ß√£o, usamos o proxy diretamente para evitar CORS
                const proxyConfigUrl = `${WEB_APP_URL}?url=${encodeURIComponent(CONFIG_CSV_URL)}`;
                const configData = await loadCSVData(proxyConfigUrl); // Passa true para indicar que √© o arquivo de config
                appConfig = processConfigData(configData);
                debugLog('Configuration loaded:', Object.keys(appConfig).length, 'sections');
                
                // DEBUG: Log detalhado do appConfig carregado
                debugLog('üî† === DEBUG APP CONFIG CARREGADO ===');
                debugLog('appConfig completo:', appConfig);
                debugLog('appConfig.checkout:', appConfig.checkout);
                debugLog('orders_all_time:', appConfig?.checkout?.orders_all_time);
                debugLog('=== FIM DEBUG APP CONFIG ===');
                updateProgress(15);

                // Apply configuration to the page
                applyConfiguration();
                updateProgress(20);

                // Load categories data
                infoLog('Loading categories data...');
                categoriesData = await loadCSVData(CATEGORIES_CSV_URL);
                updateProgress(40);

                // Load menu items data
                infoLog('Loading menu items data...');
                const menuItems = await loadCSVData(MENU_CSV_URL);
                updateProgress(65);

                // Load hours data
                infoLog('Loading hours data...');
                hoursData = await loadCSVData(HOURS_CSV_URL);
                debugLog('Hours data loaded:', hoursData.length, 'entries');
                
                if (hoursData.length > 0) {
                    // Inicializar timezone global
                    debugLog('üöÄ Initializing global timezone...');
                    initializeGlobalTimezone();
                    
                    // Verificar se timezone foi configurado corretamente
                    if (globalTimezone) {
                        debugLog('‚úÖ Timezone system initialized:', globalTimezone);
                    } else {
                        warnLog('‚ùå Timezone system not configured properly');
                    }
                }
                updateProgress(80);

                // Load neighborhoods data for delivery fees
                debugLog('üè†Ô∏è Loading neighborhoods data...');
                try {
                    neighborhoodsData = await loadCSVData(NEIGHBORHOODS_CSV_URL);
                    // Process neighborhoods data - mapear para formato consistente
                    neighborhoodsData = neighborhoodsData.map(row => ({
                        // Tentar v√°rias possibilidades de nomes de colunas
                        bairro: (row.bairro || row.nome_bairro || row.Bairro || row.BAIRRO || '').trim().toLowerCase(),
                        taxa: parseFloat((row.taxa || row.valor_taxa || row.Taxa || row.TAXA || '0').toString().replace(',', '.')) || 0
                    })).filter(item => item.bairro); // Remove empty entries
                    
                    // Expor dados globalmente para acesso em outras fun√ß√µes
                    window.neighborhoodsData = neighborhoodsData;
                    
                    // Preparar lista para autocomplete
                    prepareNeighborhoodsAutocomplete();
                    
                    infoLog(`‚úÖ Neighborhoods loaded:`, neighborhoodsData.length, 'items');
                } catch (error) {
                    errorLog('‚ùå Error loading neighborhoods:', error.message);
                    neighborhoodsData = []; // Fallback to empty array
                }
                
                // Load coupons data
                debugLog('üéüÔ∏è Loading coupons data...');
                try {
                    couponsData = await loadCSVData(COUPONS_CSV_URL);
                    infoLog(`‚úÖ Coupons loaded:`, couponsData.length, 'items');
                } catch (error) {
                    errorLog('‚ùå Error loading coupons:', error.message);
                    couponsData = []; // Fallback to empty array
                }
                updateProgress(85);

                // Process and organize data
                debugLog('Processing and organizing data...');
                menuData = processMenuData(menuItems, categoriesData);
                updateProgress(95);

                // Update operating hours display
                updateOperatingHours();
                
                // Set up periodic updates for operating hours (every minute)
                setInterval(updateOperatingHours, 60000);

                // Mark data as loaded
                isDataLoaded = true;
                updateProgress(100);

                infoLog('Data loaded successfully:', { categoriesData, menuData });
                
                // Hide preloader and initialize app
                setTimeout(() => {
                    hidePreloader();
                    initializeApp();
                }, 500);

            } catch (error) {
                errorLog('Error loading data:', error);
                hidePreloader();
                
                // Mostrar erro de configura√ß√£o sem fallbacks
                showConfigurationError();
            }
        }

        // Function to initialize the app after data is loaded
        function initializeApp() {
            renderCategoryNavigation();
            renderMenu();
            setupEventListeners();
            toggleWhatsAppField(); // Show/hide WhatsApp field based on webhook status
            
            // Only detect country by IP if webhook is active (not using WhatsApp Web)
            if (isWebhookActive()) {
                detectCountryByIP(); // Detect country by IP and set default country code
            } else {
                debugLog('Skipping IP detection - WhatsApp Web mode active');
            }
            
            // Restaurar dados do usu√°rio do localStorage
            restoreUserDataFromStorage();
        }
        
        // Restaurar dados do usu√°rio do localStorage
        function restoreUserDataFromStorage() {
            debugLog('üîÑ Restaurando dados do usu√°rio do localStorage...');
            
            // Restaurar carrinho
            if (typeof loadCartFromStorage === 'function') {
                const cartRestored = loadCartFromStorage();
                if (cartRestored) {
                    updateCartUI(); // Atualizar UI do carrinho incluindo FAB
                    debugLog('üõçÔ∏è Carrinho restaurado e FAB atualizado');
                }
            }
            
            // Restaurar cupom
            if (typeof loadCouponFromStorage === 'function') {
                const couponRestored = loadCouponFromStorage();
                if (couponRestored) {
                    updateCheckoutOrderTotal();
                }
            }
            
            // Restaurar dados do formul√°rio
            if (typeof loadOrderDataFromStorage === 'function') {
                loadOrderDataFromStorage();
            }
            
            // Restaurar taxa de delivery
            if (typeof loadDeliveryFeeFromStorage === 'function') {
                loadDeliveryFeeFromStorage();
            }
            
            debugLog('‚úÖ Restaura√ß√£o de dados conclu√≠da');
        }

        let cart = [];
        let currentProduct = null;
        let currentStep = 1;
        let selectedVariations = {};
        let orderData = {
            deliveryType: '',
            tableNumber: '',
            address: {},
            customerName: '',
            paymentMethod: '',
            changeAmount: '',
            notes: ''
        };

        // Parse variations from classificacaoAdicional
        function parseVariations(classificacaoAdicional) {
            if (!classificacaoAdicional) return null;
            
            debugLog('üîç parseVariations chamada com:', classificacaoAdicional);
            
            // Detectar se √© o novo formato (m√∫ltiplas linhas com # ou Var:)
            const lines = classificacaoAdicional.split('\n').map(line => line.trim()).filter(line => line);
            debugLog('üìù Linhas detectadas:', lines);
            
            // Verificar se alguma linha tem o padr√£o do novo formato
            const hasNewFormatPattern = lines.some(line => 
                /^(#[^:]+:|~Var:\s*[^:]+:|Var:\s*[^:]+:)(radio|checkbox):/.test(line) ||
                /maxselect=\d+:/.test(line)
            );
            
            debugLog('üÜï Tem padr√£o novo formato?', hasNewFormatPattern);
            
            if (hasNewFormatPattern) {
                // Novo formato - m√∫ltiplas varia√ß√µes
                const variations = [];
                
                lines.forEach((line, lineIndex) => {
                    debugLog(`üìã Processando linha ${lineIndex}:`, line);
                    
                    // Padr√£o: [#|~Var:|Var:]Nome:tipo:op√ß√£o1 valor/op√ß√£o2 valor/... [limites]
                    // Novo padr√£o com limites: Nome:tipo:op√ß√µes [min-max] ou [max]
                    const match = line.match(/^(#?)(?:(~)Var:\s*|Var:\s*)?([^:]+):(radio|checkbox):(.+?)(?:\s*\[(\d+)(?:-(\d+))?\])?$/);
                    
                    if (match) {
                        const [, isRequired, isRemoval, name, type, optionsStr, minSelect, maxSelect] = match;
                        debugLog('‚úÖ Match encontrado:', { 
                            isRequired: !!isRequired, 
                            isRemoval: !!isRemoval, 
                            name, 
                            type, 
                            optionsStr,
                            minSelect: minSelect ? parseInt(minSelect) : undefined,
                            maxSelect: maxSelect ? parseInt(maxSelect) : (minSelect ? parseInt(minSelect) : undefined)
                        });
                        
                        // Parse das op√ß√µes
                        const options = optionsStr.split('/').map(optionStr => {
                            const trimmed = optionStr.trim();
                            
                            // Verificar se a primeira op√ß√£o cont√©m maxselect=X (formato da planilha)
                            let maxSelectFromOption = null;
                            let cleanedOption = trimmed;
                            
                            const maxSelectMatch = trimmed.match(/maxselect=(\d+):(.+)/);
                            if (maxSelectMatch) {
                                maxSelectFromOption = parseInt(maxSelectMatch[1]);
                                cleanedOption = maxSelectMatch[2];
                                debugLog('üé® Detectado maxselect na op√ß√£o:', maxSelectFromOption, 'para:', cleanedOption);
                            }
                            
                            // Padr√£o para pre√ßos: +X,XX, -X,XX, +0,00
                            const priceMatch = cleanedOption.match(/([+-])(\d+(?:[,.]\d{2})?)/);
                            
                            let name = cleanedOption;
                            let price = 0;
                            
                            if (priceMatch) {
                                const [fullMatch, sign, valueStr] = priceMatch;
                                name = cleanedOption.replace(fullMatch, '').trim();
                                price = parseFloat(valueStr.replace(',', '.'));
                                if (sign === '-') price = -price;
                            }
                            
                            return { name, price, maxSelectFromOption };
                        }).filter(option => option.name);
                        
                        // Limpar as op√ß√µes finais (remover maxSelectFromOption do objeto final)
                        const cleanOptions = options.map(opt => ({ name: opt.name, price: opt.price }));
                        
                        debugLog('üéØ Op√ß√µes parseadas:', options);
                        
                        // Processar limites de sele√ß√£o
                        let finalMinSelect = minSelect ? parseInt(minSelect) : undefined;
                        let finalMaxSelect = maxSelect ? parseInt(maxSelect) : (minSelect ? parseInt(minSelect) : undefined);
                        
                        // Verificar se alguma op√ß√£o tem maxselect definido (formato da planilha)
                        const optionWithMaxSelect = options.find(opt => opt.maxSelectFromOption);
                        if (optionWithMaxSelect && !finalMaxSelect) {
                            finalMaxSelect = optionWithMaxSelect.maxSelectFromOption;
                            debugLog('üé® Usando maxSelect da op√ß√£o:', finalMaxSelect, 'para varia√ß√£o:', name);
                        }
                        
                        // Valida√ß√£o: checkbox deve ter limite m√≠nimo de pelo menos 2 se especificado
                        if (type === 'checkbox' && finalMinSelect && finalMinSelect < 2) {
                            console.warn(`‚ö†Ô∏è Limite m√≠nimo para checkbox "${name}" ajustado de ${finalMinSelect} para 2`);
                            finalMinSelect = 2;
                        }
                        
                        variations.push({
                            name: name.trim(),
                            type: type,
                            required: !!isRequired,
                            isRemoval: !!isRemoval,
                            minSelect: finalMinSelect,
                            maxSelect: finalMaxSelect,
                            options: cleanOptions
                        });
                    } else {
                        debugLog('‚ùå Linha n√£o corresponde ao padr√£o:', line);
                    }
                });
                
                debugLog('üéâ Varia√ß√µes finais:', variations);
                
                return {
                    type: 'multiple_variations',
                    variations: variations
                };
            }
            
            // Verificar formato legado
            const isRequiredVariation = classificacaoAdicional.startsWith('#Var:');
            const isOptionalVariation = classificacaoAdicional.startsWith('Var:') && !isRequiredVariation;
            
            if (isRequiredVariation || isOptionalVariation) {
                debugLog('üìú Formato legado detectado');
                
                const variationsText = classificacaoAdicional.replace(/^#?Var:\s*/, '');
                
                const variations = variationsText.split('/').map(variation => {
                    const trimmed = variation.trim();
                    const priceMatch = trimmed.match(/\+(\d+(?:[,.]\d{2})?)/);
                    
                    let name = trimmed;
                    let price = 0;
                    
                    if (priceMatch) {
                        name = trimmed.replace(/\s*\+\d+(?:[,.]\d{2})?/, '').trim();
                        price = parseFloat(priceMatch[1].replace(',', '.'));
                    }
                    
                    return { name, price };
                }).filter(variation => variation.name);
                
                return {
                    type: 'variation',
                    required: isRequiredVariation,
                    options: variations
                };
            }
            
            // Texto informativo
            debugLog('‚ÑπÔ∏è Texto informativo detectado');
            return {
                type: 'info',
                text: classificacaoAdicional.trim()
            };
        }



        // Process image URL to handle different sources
        function processImageUrl(url) {
            if (!url || url.trim() === '') {
                console.warn('URL de imagem vazia ou inv√°lida:', url);
                return getPlaceholderImage();
            }
            
            try {
                // Handle Google Drive URLs
                if (url.includes('drive.google.com')) {
                    // If it's already a thumbnail URL, return as is
                    if (url.includes('thumbnail?id=')) {
                        return url;
                    }
                    
                    // Extract file ID from various Google Drive URL formats
                    let fileId = null;
                    
                    // Format: https://drive.google.com/file/d/FILE_ID/view
                    if (url.includes('/file/d/')) {
                        fileId = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/)?.[1];
                    }
                    // Format: https://drive.google.com/open?id=FILE_ID
                    else if (url.includes('open?id=')) {
                        fileId = url.match(/[?&]id=([a-zA-Z0-9_-]+)/)?.[1];
                    }
                    
                    if (fileId) {
                        const processedUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w300`;
                        debugLog('URL do Google Drive processada:', url, '->', processedUrl);
                        return processedUrl;
                    } else {
                        console.warn('N√£o foi poss√≠vel extrair ID do Google Drive:', url);
                        return getPlaceholderImage();
                    }
                }
                
                // Handle Dropbox URLs
                if (url.includes('dropbox.com')) {
                    let processedUrl = url;
                    // Convert Dropbox share URL to direct image URL
                    if (url.includes('?dl=0')) {
                        processedUrl = url.replace('?dl=0', '?raw=1');
                    }
                    else if (url.includes('?dl=1')) {
                        processedUrl = url.replace('?dl=1', '?raw=1');
                    }
                    else if (!url.includes('raw=1')) {
                        processedUrl = url + (url.includes('?') ? '&raw=1' : '?raw=1');
                    }
                    debugLog('URL do Dropbox processada:', url, '->', processedUrl);
                    return processedUrl;
                }
                
                // For other URLs (Unsplash, direct image URLs, etc.), return as is
                debugLog('URL externa mantida:', url);
                return url;
                
            } catch (error) {
                errorLog('Erro ao processar URL da imagem:', error, 'URL:', url);
                return getPlaceholderImage();
            }
        }
        
        // Generate placeholder image for fallback
        function getPlaceholderImage() {
            return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='80' viewBox='0 0 120 80'%3E%3Crect width='120' height='80' fill='%23f8f9fa'/%3E%3Ctext x='60' y='45' text-anchor='middle' fill='%23adb5bd' font-family='Arial' font-size='12'%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E";
        }

        // Render category navigation
        function renderCategoryNavigation() {
            const container = document.getElementById('category-nav');
            if (!container || !categoriesData.length) return;

            // Sort categories by order
            const sortedCategories = categoriesData
                .filter(cat => cat.status === 'Ativo')
                .sort((a, b) => parseInt(a.ordem) - parseInt(b.ordem));

            // Add search button (lupa) first
            let html = `
                <button class="category-item search-button" data-action="search" title="Buscar produtos">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
            `;

            // Add category buttons
            html += sortedCategories.map(category => `
                <button class="category-item px-4 py-2 rounded-full text-sm font-medium border border-gray-300 transition-colors" 
                        data-category="${category.nome_categoria}">
                    ${category.titulo_exibicao}
                </button>
            `).join('');

            container.innerHTML = html;
            
            // Add event listeners after creating the buttons
            setupCategoryClickListeners();
            
            // Setup navigation arrows
            setupNavigationArrows();
            
            // Ativar primeira categoria real por padr√£o
            if (sortedCategories.length > 0) {
                setTimeout(() => {
                    updateActiveCategory(sortedCategories[0].nome_categoria);
                }, 200);
            }
        }
        
        // Fun√ß√£o para controlar a visibilidade das setas de navega√ß√£o
        function updateNavigationArrows() {
            // S√≥ funciona no desktop
            if (window.innerWidth <= 768) return;
            
            const container = document.getElementById('category-nav');
            const leftArrow = document.getElementById('nav-arrow-left');
            const rightArrow = document.getElementById('nav-arrow-right');
            
            if (!container || !leftArrow || !rightArrow) return;
            
            const scrollLeft = container.scrollLeft;
            const scrollWidth = container.scrollWidth;
            const clientWidth = container.clientWidth;
            const maxScroll = scrollWidth - clientWidth;
            
            // Seta esquerda: vis√≠vel se n√£o estiver no in√≠cio
            if (scrollLeft <= 5) {
                leftArrow.style.opacity = '0';
                leftArrow.style.pointerEvents = 'none';
            } else {
                leftArrow.style.opacity = '1';
                leftArrow.style.pointerEvents = 'auto';
            }
            
            // Seta direita: vis√≠vel se n√£o estiver no final
            if (scrollLeft >= maxScroll - 5) {
                rightArrow.style.opacity = '0';
                rightArrow.style.pointerEvents = 'none';
            } else {
                rightArrow.style.opacity = '1';
                rightArrow.style.pointerEvents = 'auto';
            }
        }
        
        // Fun√ß√£o para rolar as categorias
        function scrollCategories(direction) {
            const container = document.getElementById('category-nav');
            if (!container) return;
            
            const scrollAmount = 200; // Quantidade de pixels para rolar
            const currentScroll = container.scrollLeft;
            
            if (direction === 'left') {
                container.scrollTo({
                    left: currentScroll - scrollAmount,
                    behavior: 'smooth'
                });
            } else {
                container.scrollTo({
                    left: currentScroll + scrollAmount,
                    behavior: 'smooth'
                });
            }
        }
        
        // Configurar event listeners das setas
        function setupNavigationArrows() {
            const leftArrow = document.getElementById('nav-arrow-left');
            const rightArrow = document.getElementById('nav-arrow-right');
            const container = document.getElementById('category-nav');
            
            if (!leftArrow || !rightArrow || !container) return;
            
            // Event listeners para as setas
            leftArrow.addEventListener('click', () => scrollCategories('left'));
            rightArrow.addEventListener('click', () => scrollCategories('right'));
            
            // Event listener para scroll do container
            container.addEventListener('scroll', updateNavigationArrows);
            
            // Event listener para resize da janela
            window.addEventListener('resize', updateNavigationArrows);
            
            // Atualizar setas inicialmente
            setTimeout(updateNavigationArrows, 100);
        }
        
        // Setup click listeners for category buttons
        function setupCategoryClickListeners() {
            const categoryButtons = document.querySelectorAll('.category-item');
            categoryButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Verificar se √© o bot√£o de busca
                    if (this.getAttribute('data-action') === 'search') {
                        const searchInput = document.getElementById('search');
                        if (searchInput) {
                            searchInput.focus();
                            searchInput.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }
                        return;
                    }
                    
                    // Bot√£o de categoria normal
                    const category = this.getAttribute('data-category');
                    if (category) {
                        scrollToCategory(category);
                    }
                });
            });
        }

        // Render menu sections
        function renderMenu() {
            const container = document.getElementById('menu-content');
            if (!container || !isDataLoaded) return;
            
            let html = '';

            // Sort categories by order and render
            const sortedCategories = categoriesData
                .filter(cat => cat.status === 'Ativo')
                .sort((a, b) => parseInt(a.ordem) - parseInt(b.ordem));

            sortedCategories.forEach(categoryInfo => {
                const categoryKey = categoryInfo.nome_categoria;
                const items = menuData[categoryKey] || [];
                
                if (items.length === 0) return;

                html += `
                    <section id="${categoryKey}" class="mb-8">
                        <div class="flex items-center justify-between mb-4 sticky top-[144px] py-2 z-10" style="background:var(--cor-fundo)">
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">${categoryInfo.titulo_exibicao}</h2>
                                <p class="text-sm text-gray-600">${categoryInfo.descricao}</p>
                            </div>
                            <button onclick="shareCategory('${categoryKey}')" class="p-1 rounded transition-colors" style="color: var(--cor-texto)" onmouseenter="this.style.color='var(--cor-terciaria-escura)'" onmouseleave="this.style.color='var(--cor-texto)'" title="Compartilhar categoria">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="space-y-3">
                            ${items.map(item => {
                                // Verificar se o item tem varia√ß√µes
                                const hasVariations = item.classificacaoAdicional && 
                                    (item.classificacaoAdicional.startsWith('#Var:') || 
                                     item.classificacaoAdicional.startsWith('Var:') ||
                                     item.classificacaoAdicional.startsWith('#'));
                                
                                // Verificar se o item tem pre√ßos m√∫ltiplos
                                const priceType = getPriceType(item.preco);
                                const needsModal = hasVariations || priceType === 'multiple';
                                
                                return `
                                <div class="food-card bg-white rounded-lg p-4 shadow-sm border border-gray-100 relative cursor-pointer hover:shadow-md transition-shadow duration-300" onclick="openProductModal(${item.id})">
                                    <div class="flex items-start space-x-4">
                                        <div class="flex-shrink-0">
                                            <img src="${processImageUrl(item.imagem)}" alt="${item.nome}" class="w-20 h-20 object-cover rounded-lg lazy-image" loading="lazy" onerror="errorLog('Erro ao carregar imagem do item:', this.src, 'Item:', '${item.nome}'); this.src='${getPlaceholderImage()}'" onload="this.classList.add('loaded'); debugLog('Imagem do item carregada:', this.src)" style="background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite;">
                                            <div class="text-xs text-gray-500 text-center mt-1 font-mono">${item.sku}</div>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-start justify-between">
                                                <h3 class="font-semibold text-gray-900 truncate pr-2">${item.nome}</h3>
                                            </div>
                                            <p class="text-sm text-gray-600 line-clamp-2 mt-1">${item.descricao}</p>
                                            <!-- Pre√ßo em linha pr√≥pria -->
                                            <div class="mt-3">
                                                <span class="text-base font-bold" style="color: var(--cor-primaria)">${getPriceDisplay(item.preco)}</span>
                                            </div>
                                            <!-- Bot√£o em linha pr√≥pria -->
                                            <div class="mt-3 flex justify-end items-center">
                                                ${needsModal ? `<span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-md flex items-center space-x-1 mr-8"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg><span>Op√ß√µes</span></span>` : ''}
                                                <button class="add-to-cart-btn text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300" 
                                                    style="background-color: var(--cor-primaria)"
                                                    onmouseenter="this.style.backgroundColor='var(--cor-primaria-escura)'" onmouseleave="this.style.backgroundColor='var(--cor-primaria)'"
                                                    onclick="event.stopPropagation(); ${needsModal ? 'openProductModal(' + item.id + ')' : 'addToCart(' + item.id + ')'}">
                                                    <div class="flex items-center space-x-1.5">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m1.6 8L6 5H3m4 8a2 2 0 100 4 2 2 0 000-4zm10 0a2 2 0 100 4 2 2 0 000-4z"/>
                                                        </svg>
                                                        <span>Add</span>
                                                    </div>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </section>
                `;
            });

            container.innerHTML = html;
        }

        // Open product modal
        function openProductModal(productId) {
            const product = findProductById(productId);
            if (!product) return;

            currentProduct = product;
            selectedVariations = {};
            const modal = document.getElementById('product-modal');
            
            // Hide cart FAB when modal opens
            document.getElementById('cart-fab').style.display = 'none';
            const content = document.getElementById('modal-content');
            
            const variations = parseVariations(product.classificacaoAdicional);
            let variationsHtml = '';
            
            if (variations) {
                if (variations.type === 'multiple_variations') {
                    // Novo formato - m√∫ltiplas varia√ß√µes
                    debugLog('üéØ Renderizando m√∫ltiplas varia√ß√µes:', variations.variations);
                    
                    variationsHtml = variations.variations.map((variation, variationIndex) => {
                        const inputType = variation.type;
                        const requiredText = variation.required ? ' *' : '';
                        const removalBadge = variation.isRemoval ? ' <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded ml-2">üö´ Remo√ß√£o</span>' : '';
                        const inputName = variation.type === 'radio' ? `variation-${variationIndex}` : `variation-${variationIndex}`;
                        
                        // Criar texto de limites de sele√ß√£o
                        let limitsText = '';
                        if (variation.type === 'checkbox') {
                            if (variation.minSelect && variation.maxSelect) {
                                if (variation.minSelect === variation.maxSelect) {
                                    limitsText = ` <span class="text-xs text-gray-500">(Selecione exatamente ${variation.minSelect})</span>`;
                                } else {
                                    limitsText = ` <span class="text-xs text-gray-500">(Selecione ${variation.minSelect}-${variation.maxSelect})</span>`;
                                }
                            } else if (variation.maxSelect) {
                                limitsText = ` <span class="text-xs text-gray-500">(M√°ximo ${variation.maxSelect})</span>`;
                            } else if (variation.minSelect) {
                                limitsText = ` <span class="text-xs text-gray-500">(M√≠nimo ${variation.minSelect})</span>`;
                            }
                        }
                        
                        return `
                            <div class="mb-6 border-t pt-4 variation-container" data-variation-index="${variationIndex}" data-variation-type="${variation.type}" data-min-select="${variation.minSelect || 0}" data-max-select="${variation.maxSelect || 0}">
                                <h4 class="font-medium text-gray-900 mb-3">${variation.name}${requiredText}${removalBadge}${limitsText}</h4>
                                <div class="space-y-2">
                                    ${variation.options.map((option, optionIndex) => {
                                        const uniqueId = `${variationIndex}-${optionIndex}`;
                                        const priceDisplay = option.price > 0 ? 
                                            `<span class="text-green-600 font-medium">+${formatCurrency(option.price)}</span>` : 
                                            option.price < 0 ? 
                                                `<span class="text-red-600 font-medium">${formatCurrency(option.price)}</span>` : 
                                                '';
                                        
                                        return `
                                            <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                                <div class="flex items-center">
                                                    <input type="${inputType}" 
                                                           name="${inputName}" 
                                                           value="${uniqueId}" 
                                                           id="variation-${uniqueId}"
                                                           onchange="handleMultipleVariationChange('${variationIndex}', '${optionIndex}', '${option.name}', ${option.price}, '${variation.type}', ${variation.required}, ${variation.isRemoval || false})" 
                                                           class="mr-3">
                                                    <span>${option.name}</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    ${priceDisplay}
                                                    ${inputType === 'radio' ? `<button type="button" onclick="clearVariationSelection('${inputName}', '${variationIndex}')" class="clear-variation-btn text-xs text-gray-400 hover:text-red-500 ml-2 px-2 py-1 rounded transition-colors" title="Limpar sele√ß√£o" style="display: none;">‚ùå</button>` : ''}
                                                </div>
                                            </label>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                } else if (variations.type === 'variation') {
                    // Formato legado - varia√ß√£o √∫nica
                    const inputType = variations.required ? 'radio' : 'checkbox';
                    const requiredText = variations.required ? ' *' : '';
                    
                    variationsHtml = `
                        <div class="mb-6 border-t pt-4">
                            <h4 class="font-medium text-gray-900 mb-3">Op√ß√µes${requiredText}</h4>
                            <div class="space-y-2">
                                ${variations.options.map((option, index) => `
                                    <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                        <div class="flex items-center">
                                            <input type="${inputType}" name="variation-${productId}" value="${index}" 
                                                   onchange="handleVariationChange(${index}, '${option.name}', ${option.price}, ${variations.required})" 
                                                   class="mr-3">
                                            <span>${option.name}</span>
                                        </div>
                                        ${option.price > 0 ? `<span class="text-green-600 font-medium">+${formatCurrency(option.price)}</span>` : ''}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (variations.type === 'info') {
                    // Texto informativo
                    variationsHtml = `
                        <div class="mb-6 border-t pt-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 mt-0.5 mr-2 flex-shrink-0" style="color: var(--cor-terciaria)" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <p class="text-sm text-blue-800">${variations.text}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            content.innerHTML = `
                <div class="relative">
                    <img src="${processImageUrl(product.imagem)}" alt="${product.nome}" class="w-full h-64 object-cover rounded-t-2xl sm:rounded-t-2xl cursor-pointer hover:opacity-90 transition-opacity lazy-image" loading="lazy" onerror="errorLog('Erro ao carregar imagem do modal:', this.src, 'Produto:', '${product.nome}'); this.src='${getPlaceholderImage()}'" onload="this.classList.add('loaded'); debugLog('Imagem do modal carregada:', this.src)" onclick="openLightbox('${processImageUrl(product.imagem)}', '${product.nome}')" style="background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite;">
                    <div class="absolute bottom-2 left-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-xs font-mono">
                        ${product.sku}
                    </div>

                </div>
                <div class="px-6 pt-6 pb-4">
                    <h3 class="text-xl font-bold text-gray-900 mb-2">${product.nome}</h3>
                    <p class="text-gray-600 mb-4">${product.descricao}</p>
                    ${product.observacoes && product.observacoes.trim() ? `
                        <div class="flex items-start space-x-2 mb-4 py-1 px-2 rounded" style="background-color: var(--cor-fundo-secundario);">
                            <svg class="w-4 h-4 mt-0.5 flex-shrink-0" style="color: var(--cor-primaria);" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <p class="text-sm" style="color: var(--cor-texto); line-height: 1.4;">${product.observacoes}</p>
                        </div>
                    ` : ''}
                    <div class="flex items-center justify-between mb-6">
                        <span class="text-2xl font-bold" style="color: var(--cor-primaria)"><span id="base-price">${getBasePriceDisplay(product.preco)}</span></span>
                    </div>
                    ${(() => {
                        const priceType = getPriceType(product.preco);
                        if (priceType === 'multiple') {
                            const prices = parseMultiplePrices(product.preco);
                            const dynamicLabel = getMultiplePricesLabel(product.preco);
                            return `
                                <div class="mb-6 border-t pt-4">
                                    <h4 class="text-lg font-semibold text-gray-900 mb-3">
                                        ${dynamicLabel} <span class="text-red-500">*</span>
                                    </h4>
                                    <div class="space-y-2">
                                        ${prices.map((priceOption, index) => `
                                            <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors base-price-option" data-price="${priceOption.price}" data-name="${priceOption.name}">
                                                <div class="flex items-center">
                                                    <input type="radio" name="base-price" value="${priceOption.price}" id="base-price-${index}" class="mr-3" onchange="updateBasePrice(${priceOption.price}, '${priceOption.name}')">
                                                    <span class="font-medium">${priceOption.name}</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <span class="font-bold" style="color: var(--cor-primaria)">${formatCurrency(priceOption.price)}</span>
                                                    <button type="button" onclick="clearBasePriceSelection()" class="clear-price-btn text-xs text-gray-400 hover:text-red-500 ml-2 px-2 py-1 rounded transition-colors" title="Limpar sele√ß√£o" style="display: none;">‚ùå</button>
                                                </div>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        return '';
                    })()}
                    ${variationsHtml}
                    ${(() => {
                        const checkoutConfig = getCheckoutConfig();
                        return checkoutConfig.step1_itens_obs === 'Sim' ? `
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                        <textarea id="product-notes" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="--tw-ring-color: var(--cor-primaria)" rows="2" placeholder="Alguma observa√ß√£o especial para este item?" onfocus="scrollToField(this)" onblur="resetModalScroll()"></textarea>
                    </div>` : '';
                    })()}
                </div>
                <div class="modal-footer">
                    <!-- Layout H√≠brido Minimalista -->
                    <div class="space-y-3">
                        <!-- Linha Superior: Quantidade e Subtotal Lado a Lado -->
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Coluna 1: Controles de Quantidade -->
                            <div class="text-center">
                                <div class="text-sm font-medium text-gray-700 mb-2">Quantidade</div>
                                <div class="flex items-center justify-center">
                                    <div class="flex items-center space-x-2 bg-gray-50 rounded-full px-3 py-2">
                                        <button onclick="changeQuantity(-1)" class="bg-white hover:bg-gray-100 rounded-full w-9 h-9 flex items-center justify-center text-gray-600 shadow-sm transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                            </svg>
                                        </button>
                                        <span id="modal-quantity" class="font-bold text-lg min-w-[2rem] text-center">1</span>
                                        <button onclick="changeQuantity(1)" class="bg-white hover:bg-gray-100 rounded-full w-9 h-9 flex items-center justify-center text-gray-600 shadow-sm transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Coluna 2: Subtotal -->
                            <div class="text-center px-6">
                                <div class="text-sm font-medium text-gray-700 mb-2">Subtotal</div>
                                <div class="py-2">
                                    <div class="font-bold text-lg" style="color: var(--cor-primaria)"><span id="modal-total">${formatCurrency(product.preco)}</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Linha Inferior: Bot√£o Adicionar Full Width com Padding Aumentado -->
                        <div class="px-6">
                            <button onclick="addToCartFromModal()" id="add-to-cart-btn" class="w-full text-white py-3 px-6 rounded-lg font-medium transition-colors text-base" style="background-color: var(--cor-primaria)" onmouseenter="this.style.backgroundColor='var(--cor-primaria-hover)'" onmouseleave="this.style.backgroundColor='var(--cor-primaria)'">
                                <div class="flex items-center justify-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m1.6 8L6 5H3m4 8a2 2 0 100 4 2 2 0 000-4zm10 0a2 2 0 000 4 2 2 0 000-4z"/>
                                    </svg>
                                    <span>Adicionar ao Carrinho</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
            
            // Reset scroll do modal para sempre come√ßar do topo
            const modalScrollContainer = modal.querySelector('.overflow-y-auto');
            if (modalScrollContainer) {
                modalScrollContainer.scrollTop = 0;
                if (typeof debugLog === 'function') {
                    debugLog('üìú Scroll do modal resetado para o topo');
                }
            }
            
            // Desabilitar scroll do body quando modal abre
            document.body.style.overflow = 'hidden';
            if (typeof debugLog === 'function') {
                debugLog('üö´ Scroll do body desabilitado durante modal');
            }
            
            // Inicializar c√°lculos do modal
            updateModalPricing();
            updateAddToCartButton();
            
            // Inicializar bot√µes de limpar sele√ß√£o
            setTimeout(toggleClearButtons, 200);
        }

        // Handle variation change (formato legado)
        function handleVariationChange(index, name, price, isRequired) {
            debugLog('üîß handleVariationChange chamada:', { index, name, price, isRequired });
            
            const variations = parseVariations(currentProduct.classificacaoAdicional);
            
            if (isRequired) {
                // Radio button - single selection
                selectedVariations = { [index]: { name, price } };
                debugLog('üîò Varia√ß√£o obrigat√≥ria selecionada:', selectedVariations);
            } else {
                // Checkbox - multiple selection
                const checkbox = event.target;
                if (checkbox.checked) {
                    selectedVariations[index] = { name, price };
                    debugLog('‚úÖ Varia√ß√£o opcional marcada:', selectedVariations);
                } else {
                    delete selectedVariations[index];
                    debugLog('‚ùå Varia√ß√£o opcional desmarcada:', selectedVariations);
                }
            }
            
            updateModalPricing();
            updateAddToCartButton();
        }

        // Handle multiple variation change (novo formato)
        function handleMultipleVariationChange(variationIndex, optionIndex, name, price, type, isRequired, isRemoval) {
            debugLog('üéØ handleMultipleVariationChange chamada:', { 
                variationIndex, optionIndex, name, price, type, isRequired, isRemoval 
            });
            
            const uniqueKey = `${variationIndex}-${optionIndex}`;
            const variations = parseVariations(currentProduct.classificacaoAdicional);
            
            if (type === 'radio') {
                // Radio button - limpar outras sele√ß√µes da mesma varia√ß√£o
                Object.keys(selectedVariations).forEach(key => {
                    if (key.startsWith(`${variationIndex}-`)) {
                        delete selectedVariations[key];
                    }
                });
                selectedVariations[uniqueKey] = { 
                    name, 
                    price, 
                    variationIndex: parseInt(variationIndex),
                    optionIndex: parseInt(optionIndex),
                    variationName: getCurrentVariationName(variationIndex),
                    isRemoval: isRemoval || false
                };
                debugLog('üîò Radio selecionado:', selectedVariations);
            } else if (type === 'checkbox') {
                // Checkbox - validar limites antes de processar
                const checkbox = event.target;
                
                if (checkbox.checked) {
                    // Verificar limite m√°ximo antes de adicionar
                    const currentVariation = variations?.variations?.[variationIndex];
                    if (currentVariation && currentVariation.maxSelect > 0) {
                        const currentSelections = Object.keys(selectedVariations).filter(key => 
                            key.startsWith(`${variationIndex}-`)
                        ).length;
                        
                        if (currentSelections >= currentVariation.maxSelect) {
                            checkbox.checked = false;
                            showNotification(`M√°ximo de ${currentVariation.maxSelect} op√ß√µes permitidas em "${currentVariation.name}"!`, 'warning', 3000);
                            return; // Parar execu√ß√£o aqui
                        }
                    }
                    
                    // Se passou na valida√ß√£o, adicionar sele√ß√£o
                    selectedVariations[uniqueKey] = { 
                        name, 
                        price, 
                        variationIndex: parseInt(variationIndex),
                        optionIndex: parseInt(optionIndex),
                        variationName: getCurrentVariationName(variationIndex),
                        isRemoval: isRemoval || false
                    };
                    debugLog('‚úÖ Checkbox marcado:', selectedVariations);
                } else {
                    delete selectedVariations[uniqueKey];
                    debugLog('‚ùå Checkbox desmarcado:', selectedVariations);
                }
            }
            
            updateModalPricing();
            updateAddToCartButton();
            
            // Atualizar visibilidade dos bot√µes de limpar
            setTimeout(toggleClearButtons, 100);
        }

        // Fun√ß√£o auxiliar para obter o nome da varia√ß√£o
        function getCurrentVariationName(variationIndex) {
            const variations = parseVariations(currentProduct.classificacaoAdicional);
            if (variations && variations.type === 'multiple_variations') {
                return variations.variations[variationIndex]?.name || '';
            }
            return '';
        }

        // Atualizar pre√ßo base selecionado
        function updateBasePrice(price, name) {
            if (!currentProduct) return;
            
            // Armazenar pre√ßo base selecionado
            currentProduct.selectedBasePrice = price;
            currentProduct.selectedBaseName = name;
            
            // Atualizar display do pre√ßo
            const basePriceElement = document.getElementById('base-price');
            if (basePriceElement) {
                basePriceElement.textContent = formatCurrency(price);
            }
            
            // Atualizar c√°lculos do modal
            updateModalPricing();
            updateAddToCartButton();
            
            if (typeof debugLog === 'function') {
                debugLog('üí∞ Pre√ßo base atualizado:', { price, name });
            }
            
            // Atualizar visibilidade dos bot√µes de limpar
            setTimeout(toggleClearButtons, 100);
        }

        // Update modal pricing
        function updateModalPricing() {
            const priceType = getPriceType(currentProduct.preco);
            let basePrice = 0;
            
            // Calcular pre√ßo base baseado no tipo
            if (priceType === 'multiple') {
                basePrice = currentProduct.selectedBasePrice || 0;
            } else if (priceType === 'fixed') {
                basePrice = parsePrice(currentProduct.preco);
            }
            // consultation = 0 (n√£o soma)
            
            // Calcular pre√ßo das varia√ß√µes com debug detalhado
            const variationPrices = Object.values(selectedVariations).map(v => ({ name: v.name, price: v.price }));
            const variationPrice = variationPrices.reduce((sum, variation) => sum + variation.price, 0);
            const totalPrice = basePrice + variationPrice;
            const quantity = parseInt(document.getElementById('modal-quantity').textContent);
            
            // Debug detalhado
            if (typeof debugLog === 'function') {
                debugLog('üìä Detalhes do c√°lculo:', {
                    basePrice,
                    selectedVariations,
                    variationPrices,
                    variationPrice,
                    totalPrice,
                    quantity,
                    finalPrice: totalPrice * quantity
                });
            }
            
            const modalTotalElement = document.getElementById('modal-total');
            if (modalTotalElement) {
                if (priceType === 'consultation') {
                    modalTotalElement.innerHTML = '<span style="color: var(--cor-secundaria); font-weight: bold;">üí¨ Consulte</span>';
                } else if (priceType === 'multiple' && !currentProduct.selectedBasePrice) {
                    // Aguardando sele√ß√£o de pre√ßo base
                    const dynamicLabel = getMultiplePricesLabel(currentProduct.preco);
                    modalTotalElement.innerHTML = `<span style="color: var(--cor-texto-secundario); font-style: italic; font-size: 0.6em;">Aguardando ${dynamicLabel.toLowerCase()}</span>`;
                } else {
                    modalTotalElement.textContent = formatCurrency(totalPrice * quantity);
                }
            }
        }

        // Update add to cart button
        function updateAddToCartButton() {
            const variations = parseVariations(currentProduct.classificacaoAdicional);
            const button = document.getElementById('add-to-cart-btn');
            const priceType = getPriceType(currentProduct.preco);
            
            // Verificar se pre√ßo base √© obrigat√≥rio para pre√ßos m√∫ltiplos
            if (priceType === 'multiple' && !currentProduct.selectedBasePrice) {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }
            
            if (variations) {
                if (variations.type === 'multiple_variations') {
                    // Novo formato - verificar varia√ß√µes obrigat√≥rias
                    const requiredVariations = variations.variations.filter(v => v.required);
                    let allRequiredSelected = true;
                    
                    for (const requiredVar of requiredVariations) {
                        const variationIndex = variations.variations.indexOf(requiredVar);
                        const hasSelectionForThisVariation = Object.keys(selectedVariations)
                            .some(key => key.startsWith(`${variationIndex}-`));
                        
                        if (!hasSelectionForThisVariation) {
                            allRequiredSelected = false;
                            break;
                        }
                    }
                    
                    button.disabled = !allRequiredSelected;
                    button.classList.toggle('opacity-50', !allRequiredSelected);
                    button.classList.toggle('cursor-not-allowed', !allRequiredSelected);
                    
                    debugLog('üîç Verifica√ß√£o m√∫ltiplas varia√ß√µes:', {
                        requiredVariations: requiredVariations.length,
                        allRequiredSelected,
                        selectedVariations
                    });
                    
                } else if (variations.type === 'variation' && variations.required) {
                    // Formato legado - varia√ß√£o √∫nica obrigat√≥ria
                    const hasSelection = Object.keys(selectedVariations).length > 0;
                    button.disabled = !hasSelection;
                    button.classList.toggle('opacity-50', !hasSelection);
                    button.classList.toggle('cursor-not-allowed', !hasSelection);
                } else {
                    // Sem varia√ß√µes obrigat√≥rias
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } else {
                // Sem varia√ß√µes
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Close modal
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('product-modal').classList.add('hidden');
            currentProduct = null;
            selectedVariations = {};
            
            // Clear product notes field
            const notesField = document.getElementById('product-notes');
            if (notesField) {
                notesField.value = '';
            }
            
            // Show cart FAB again when modal closes (if cart has items)
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (cartCount > 0) {
                document.getElementById('cart-fab').style.display = 'flex';
            }
            
            // Reabilitar scroll do body quando modal fecha
            document.body.style.overflow = '';
            debugLog('‚úÖ Scroll enabled after modal close');
        }

        // Change quantity in modal
        function changeQuantity(delta) {
            const quantityEl = document.getElementById('modal-quantity');
            let quantity = parseInt(quantityEl.textContent) + delta;
            
            if (quantity < 1) quantity = 1;
            
            quantityEl.textContent = quantity;
            updateModalPricing();
        }

        // Add to cart from modal
        function addToCartFromModal() {
            debugLog('=== IN√çCIO addToCartFromModal ===');
            
            // Verificar estado do bot√£o
            const button = document.getElementById('add-to-cart-btn');
            debugLog('üîò Estado do bot√£o:', {
                disabled: button.disabled,
                classList: Array.from(button.classList),
                style: button.style.cssText
            });
            
            debugLog('üõçÔ∏è Adding to cart from modal');
            debugLog('üì¶ Produto atual:', currentProduct);
            debugLog('üîß Varia√ß√µes selecionadas:', selectedVariations);
            
            const variations = parseVariations(currentProduct.classificacaoAdicional);
            debugLog('üìã Varia√ß√µes parseadas:', variations);
            
            // Validar todas as varia√ß√µes usando a nova fun√ß√£o de valida√ß√£o
            debugLog('üîç Validando todas as varia√ß√µes...');
            
            if (!validateAllVariations()) {
                debugLog('‚ùå Valida√ß√£o de varia√ß√µes falhou - BLOQUEANDO!');
                return;
            }
            
            debugLog('‚úÖ Valida√ß√£o de varia√ß√µes passou!');
            
            // Fallback para formato legado
            if (variations && variations.type === 'variation' && variations.required && Object.keys(selectedVariations).length === 0) {
                debugLog('‚ùå Varia√ß√£o obrigat√≥ria (formato legado) n√£o selecionada - BLOQUEANDO!');
                showNotification('Por favor, selecione uma op√ß√£o obrigat√≥ria', 'warning', 4000);
                return;
            }
            
            debugLog('‚úÖ Verifica√ß√£o de varia√ß√µes obrigat√≥rias passou!');
            
            const quantity = parseInt(document.getElementById('modal-quantity').textContent);
            const notesElement = document.getElementById('product-notes');
            const notes = notesElement ? notesElement.value.trim() : '';
            
            debugLog('üìä Quantidade:', quantity);
            debugLog('üìù Observa√ß√µes:', notes);
            debugLog('‚úÖ Chamando addToCart...');
            
            addToCart(currentProduct.id, quantity, selectedVariations, notes, true); // true = chamada do modal
            closeModal();
        }

        // Add to cart
        function addToCart(productId, quantity = 1, variations = {}, notes = '', fromModal = false) {
            if (typeof debugLog === 'function') {
                debugLog('üõçÔ∏è Adding to cart:', productId, 'qty:', quantity);
            }

            const numericProductId = parseInt(productId, 10);
            const product = findProductById(numericProductId);
            if (!product) {
                if (typeof debugLog === 'function') {
                    debugLog('‚ùå Produto n√£o encontrado:', productId);
                }
                return;
            }
            
            if (typeof debugLog === 'function') {
                debugLog('üì¶ Produto encontrado:', product);
            }

            // Check if product has ANY variations (required or optional) and none are provided
            const productVariations = parseVariations(product.classificacaoAdicional);
            if (typeof debugLog === 'function') {
                debugLog('üîç Varia√ß√µes do produto:', productVariations);
            }
            
            if (productVariations && (productVariations.type === 'variation' || productVariations.type === 'multiple_variations')) {
                // If no variations provided for a product with variations, open modal to show options
                // BUT only if the call is NOT from the modal itself
                if (Object.keys(variations).length === 0 && !fromModal) {
                    if (typeof debugLog === 'function') {
                        debugLog('üîÑ Abrindo modal - produto tem varia√ß√µes mas nenhuma foi fornecida');
                    }
                    openProductModal(productId);
                    return;
                } else if (fromModal) {
                    if (typeof debugLog === 'function') {
                        debugLog('üìù Chamada do modal - prosseguindo mesmo sem varia√ß√µes selecionadas');
                    }
                }
            }
            
            if (typeof debugLog === 'function') {
                debugLog('‚úÖ Prosseguindo para adicionar ao carrinho...');
            }

            // Calculate variation price
            const variationPrice = Object.values(variations).reduce((sum, variation) => sum + variation.price, 0);
            
            // Calcular pre√ßo total baseado no tipo de pre√ßo do produto
            let basePrice = 0;
            const priceType = getPriceType(product.preco);
            
            if (priceType === 'fixed') {
                basePrice = parsePrice(product.preco);
            } else if (priceType === 'multiple' && product.selectedBasePrice) {
                basePrice = product.selectedBasePrice;
            } else if (priceType === 'consultation') {
                basePrice = 0; // Pre√ßo de consulta n√£o tem valor num√©rico
            }
            
            const totalPrice = basePrice + variationPrice;
            
            // Create variation key for grouping similar items (include notes in key if present)
            const variationKey = Object.keys(variations).sort().join('-');
            const basePriceKey = (priceType === 'multiple' && product.selectedBaseName) ? `-base-${product.selectedBaseName.replace(/[^a-zA-Z0-9]/g, '')}` : '';
            const notesKey = notes ? `-notes-${btoa(notes).replace(/[^a-zA-Z0-9]/g, '')}` : '';
            const itemKey = `${productId}-${variationKey}${basePriceKey}${notesKey}`;
            
            const existingItem = cart.find(item => item.itemKey === itemKey);
            
            if (existingItem) {
                existingItem.quantity += quantity;
                
                // Salvar carrinho no localStorage
                if (typeof saveCartToStorage === 'function') {
                    saveCartToStorage();
                }
            } else {
                // Criar texto das varia√ß√µes baseado no formato
                let variationText = '';
                let removalText = '';
                
                // Adicionar nome do pre√ßo base selecionado para pre√ßos m√∫ltiplos
                const priceType = getPriceType(product.preco);
                if (priceType === 'multiple' && product.selectedBaseName) {
                    variationText = product.selectedBaseName;
                }
                if (Object.keys(variations).length > 0) {
                    if (productVariations && productVariations.type === 'multiple_variations') {
                        // Novo formato - separar adi√ß√µes e remo√ß√µes
                        const additionGroups = {};
                        const removalGroups = {};
                        
                        Object.values(variations).forEach(variation => {
                            const groupName = variation.variationName || 'Op√ß√µes';
                            const isRemoval = variation.isRemoval || false;
                            
                            if (isRemoval) {
                                if (!removalGroups[groupName]) {
                                    removalGroups[groupName] = [];
                                }
                                removalGroups[groupName].push(variation.name);
                            } else {
                                if (!additionGroups[groupName]) {
                                    additionGroups[groupName] = [];
                                }
                                additionGroups[groupName].push(variation.name);
                            }
                        });
                        
                        // Criar texto das adi√ß√µes
                        if (Object.keys(additionGroups).length > 0) {
                            const additionsText = Object.entries(additionGroups)
                                .map(([groupName, options]) => `${groupName}: ${options.join(', ')}`)
                                .join('\n     '); // Quebra linha + indenta√ß√£o para WhatsApp
                            
                            // Combinar pre√ßo base com adi√ß√µes
                            if (variationText) {
                                variationText += '\n     ' + additionsText;
                            } else {
                                variationText = additionsText;
                            }
                        }
                        
                        // Criar texto das remo√ß√µes
                        if (Object.keys(removalGroups).length > 0) {
                            removalText = Object.entries(removalGroups)
                                .map(([groupName, options]) => `${groupName}: ${options.join(', ')}`)
                                .join('\n     '); // Quebra linha + indenta√ß√£o para WhatsApp
                        }
                    } else {
                        // Formato legado
                        const variationNames = Object.values(variations).map(v => v.name);
                        const legacyVariationsText = variationNames.join(', ');
                        
                        // Combinar pre√ßo base com varia√ß√µes legadas
                        if (variationText && legacyVariationsText) {
                            variationText += ', ' + legacyVariationsText;
                        } else if (legacyVariationsText) {
                            variationText = legacyVariationsText;
                        }
                    }
                }
                
                cart.push({
                    ...product,
                    itemKey: itemKey,
                    quantity: quantity,
                    preco: totalPrice,
                    variations: variations,
                    variationText: variationText,
                    removalText: removalText,
                    notes: notes
                });
                
                // Salvar carrinho no localStorage
                if (typeof saveCartToStorage === 'function') {
                    saveCartToStorage();
                }
            }
            
            if (typeof debugLog === 'function') {
                debugLog('üéâ Produto adicionado ao carrinho!');
                debugLog('üõçÔ∏è Cart updated:', cart.length, 'items');
            }

            updateCartUI();
            showAddedToCartAnimation();
        }

        // Update cart UI
        function updateCartUI() {
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            // Calcular total apenas de itens com pre√ßo v√°lido (ignora consultas)
            const cartTotal = cart.reduce((sum, item) => {
                const itemPrice = parseFloat(item.preco);
                if (isNaN(itemPrice) || itemPrice <= 0) {
                    return sum; // Ignora itens de consulta ou sem pre√ßo
                }
                return sum + (itemPrice * item.quantity);
            }, 0);
            
            // Verificar se h√° itens com pre√ßo v√°lido
            const hasValidPriceItems = cart.some(item => {
                const itemPrice = parseFloat(item.preco);
                return !isNaN(itemPrice) && itemPrice > 0;
            });
            
            // Verificar se h√° itens de consulta
            const hasConsultationItems = cart.some(item => {
                const itemPrice = parseFloat(item.preco);
                return isNaN(itemPrice) || itemPrice <= 0;
            });
            
            document.getElementById('cart-count').textContent = cartCount;
            
            // Exibir total apenas se houver itens com pre√ßo v√°lido
            const cartTotalElement = document.getElementById('cart-total');
            const cartModalTotalElement = document.getElementById('cart-modal-total');
            
            if (hasValidPriceItems) {
                const totalText = hasConsultationItems ? 
                    `${formatCurrency(cartTotal)} + consultas` : 
                    formatCurrency(cartTotal);
                cartTotalElement.textContent = totalText;
                cartModalTotalElement.textContent = totalText;
            } else if (hasConsultationItems) {
                // Apenas itens de consulta
                cartTotalElement.textContent = 'üí¨ Consulte';
                cartModalTotalElement.textContent = 'üí¨ Consulte';
            } else {
                // Carrinho vazio
                cartTotalElement.textContent = formatCurrency(0);
                cartModalTotalElement.textContent = formatCurrency(0);
            }
            
            // Atualizar contador de itens no modal do carrinho
            const itemsCountElement = document.getElementById('cart-modal-items-count');
            if (itemsCountElement) {
                const itemText = cartCount === 1 ? 'item' : 'itens';
                itemsCountElement.textContent = `${cartCount} ${itemText}`;
            }
            
            // Check if checkout is enabled
            const checkoutConfig = getCheckoutConfig();
            const isCheckoutEnabled = checkoutConfig.checkout_mode && checkoutConfig.checkout_mode.toLowerCase() === 'sim';
            
            const cartFab = document.getElementById('cart-fab');
            if (cartCount > 0 && isCheckoutEnabled) {
                cartFab.classList.remove('hidden');
                // Only show if no modals are open
                const isModalOpen = !document.getElementById('product-modal').classList.contains('hidden') ||
                                   !document.getElementById('cart-modal').classList.contains('hidden') ||
                                   !document.getElementById('checkout-modal').classList.contains('hidden');
                cartFab.style.display = isModalOpen ? 'none' : 'flex';
            } else {
                cartFab.classList.add('hidden');
                cartFab.style.display = 'none';
            }
        }

        // Show added to cart animation
        function showAddedToCartAnimation() {
            const cartFab = document.getElementById('cart-fab');
            cartFab.classList.add('bounce');
            setTimeout(() => cartFab.classList.remove('bounce'), 600);
        }

        // Open cart
        async function openCart() {
            // VERIFICAR SE ESTABELECIMENTO EST√Å ABERTO
            const isOpen = await isCurrentlyOpen();
            
            if (!isOpen) {
                showClosedModal();
                return;
            }
            
            const modal = document.getElementById('cart-modal');
            const itemsContainer = document.getElementById('cart-items');
            
            // Hide cart FAB when cart modal opens
            document.getElementById('cart-fab').style.display = 'none';
            
            if (cart.length === 0) {
                itemsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Seu carrinho est√° vazio</p>';
            } else {
                itemsContainer.innerHTML = cart.map(item => {
                    // Verificar se o item tem pre√ßo v√°lido
                    const itemPrice = parseFloat(item.preco);
                    const hasValidPrice = !isNaN(itemPrice) && itemPrice > 0;
                    const itemSubtotal = hasValidPrice ? itemPrice * item.quantity : 0;
                    
                    return `
                    <div class="border border-gray-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow" style="background-color: white !important;">
                        <!-- Header com SKU e bot√£o de edi√ß√£o -->
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-xs text-gray-400 font-mono bg-gray-50 px-2 py-1 rounded">${item.sku}</div>
                            ${(() => {
                                const checkoutConfig = getCheckoutConfig();
                                return checkoutConfig.step1_itens_obs === 'Sim' ? `
                            <button onclick="editItemNotes('${item.itemKey}')" class="bg-blue-500 hover:bg-blue-600 text-white rounded-full w-7 h-7 flex items-center justify-center shadow-sm transition-all hover:scale-105" title="Editar observa√ß√µes">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>` : '';
                            })()
                            }
                        </div>
                        
                        <!-- Conte√∫do principal -->
                        <div class="flex items-start space-x-3">
                            <!-- Imagem -->
                            <div class="flex-shrink-0">
                                <img src="${processImageUrl(item.imagem)}" alt="${item.nome}" class="w-16 h-16 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity" onerror="this.src='${getPlaceholderImage()}'" onclick="openImageLightbox('${processImageUrl(item.imagem)}', '${item.nome}')">
                            </div>
                            
                            <!-- Informa√ß√µes do produto -->
                            <div class="flex-1 min-w-0">
                                <h4 class="font-semibold text-gray-900 text-base mb-1">${item.nome}</h4>
                                
                                <!-- Varia√ß√µes e observa√ß√µes -->
                                ${item.variationText ? `<div class="text-sm text-gray-600 mb-1">
                                    <span class="text-green-600 font-medium">‚úì</span> ${item.variationText}
                                </div>` : ''}
                                ${item.removalText ? `<div class="text-sm text-red-600 mb-1">
                                    <span class="font-medium">üö´</span> ${item.removalText}
                                </div>` : ''}
                                ${item.notes ? `<div class="text-sm italic bg-blue-50 text-blue-700 px-2 py-1 rounded mt-2">
                                    üìù ${item.notes}
                                </div>` : ''}
                            </div>
                        </div>
                        
                        <!-- Footer com pre√ßos e controles -->
                        <div class="flex items-center justify-between mt-4 pt-3 border-t border-gray-100">
                            <!-- Pre√ßos -->
                            <div class="flex flex-col">
                                ${hasValidPrice ? 
                                    `<div class="text-xs text-gray-500">${formatCurrency(itemPrice)} cada</div>
                                     <div class="font-bold text-lg" style="color: var(--cor-primaria)">${formatCurrency(itemSubtotal)}</div>` :
                                    `<div class="text-xs text-gray-500">Consulte o pre√ßo</div>
                                     <div class="font-bold text-lg" style="color: var(--cor-secundaria)">üí¨ Consulte</div>`
                                }
                            </div>
                            
                            <!-- Controles de quantidade -->
                            <div class="flex items-center space-x-3 bg-gray-50 rounded-full px-3 py-2">
                                <button onclick="updateCartQuantity('${item.itemKey}', -1)" class="bg-white hover:bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center text-gray-600 shadow-sm transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                    </svg>
                                </button>
                                <span class="font-bold text-lg min-w-[2rem] text-center">${item.quantity}</span>
                                <button onclick="updateCartQuantity('${item.itemKey}', 1)" class="bg-white hover:bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center text-gray-600 shadow-sm transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
            }
            
            // Bloquear scroll da p√°gina quando modal do carrinho abre
            document.body.style.overflow = 'hidden';
            if (typeof debugLog === 'function') {
                debugLog('üò´ Scroll disabled during cart modal');
            }
            
            modal.classList.remove('hidden');
        }

        // Close cart
        function closeCart(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('cart-modal').classList.add('hidden');
            
            // Reabilitar scroll do body quando modal do carrinho fecha
            document.body.style.overflow = '';
            debugLog('‚úÖ Scroll enabled after cart close');
            
            // Show cart FAB again when cart modal closes (if cart has items and checkout is enabled)
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const checkoutConfig = getCheckoutConfig();
            const isCheckoutEnabled = checkoutConfig.checkout_mode && checkoutConfig.checkout_mode.toLowerCase() === 'sim';
            
            if (cartCount > 0 && isCheckoutEnabled) {
                document.getElementById('cart-fab').style.display = 'flex';
            }
        }

        // Prevenir scroll durante checkout modal
        function preventScrollDuringCheckout(e) {
            const checkoutModal = document.getElementById('checkout-modal');
            if (checkoutModal && !checkoutModal.classList.contains('hidden')) {
                // Verificar se o scroll est√° acontecendo dentro do modal
                const modalContent = checkoutModal.querySelector('.overflow-y-auto');
                if (modalContent && modalContent.contains(e.target)) {
                    // Permitir scroll dentro do modal
                    return;
                }
                // Prevenir scroll fora do modal
                e.preventDefault();
                debugLog('üò´ Scroll prevented during checkout');
            }
        }

        // Limpar carrinho completamente (sem confirma√ß√£o)
        function clearCart() {
            // Verificar se carrinho j√° est√° vazio
            if (cart.length === 0) {
                showNotification('Carrinho j√° est√° vazio', 'info');
                return;
            }
            
            debugLog('üóëÔ∏è Limpando carrinho diretamente...');
            
            // Limpar array do carrinho
            cart.length = 0;
            
            // Limpar carrinho do localStorage
            if (typeof clearCartFromStorage === 'function') {
                clearCartFromStorage();
            }
            
            // Atualizar interface do carrinho
            const itemsContainer = document.getElementById('cart-items');
            if (itemsContainer) {
                itemsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Seu carrinho est√° vazio</p>';
            }
            
            // Atualizar FAB do carrinho (contador)
            const cartCountElement = document.getElementById('cart-count');
            if (cartCountElement) {
                cartCountElement.textContent = '0';
            }
            
            // Atualizar contador de itens no modal
            const itemsCountElement = document.getElementById('cart-modal-items-count');
            if (itemsCountElement) {
                itemsCountElement.textContent = '0 itens';
            }
            
            // Esconder FAB do carrinho
            document.getElementById('cart-fab').style.display = 'none';
            
            // Fechar modal do carrinho e reabilitar scroll
            document.getElementById('cart-modal').classList.add('hidden');
            document.body.style.overflow = '';
            debugLog('‚úÖ Cart modal closed and scroll enabled after clear');
            
            // Mostrar notifica√ß√£o
            showNotification('Carrinho limpo com sucesso!', 'success');
            
            debugLog('‚úÖ Carrinho limpo com sucesso');
        }

        // Reset Step 2 - Limpa completamente o estado do step 2
        function resetStep2() {
            debugLog('=== RESET STEP 2 ===');
            
            // 1. Desmarcar todos os radio buttons de tipo de entrega
            const deliveryRadios = document.querySelectorAll('input[name="delivery-type"]');
            deliveryRadios.forEach(radio => {
                radio.checked = false;
            });
            
            // 2. Limpar o orderData.deliveryType
            orderData.deliveryType = '';
            
            // 3. Limpar campos din√¢micos
            const fieldsContainer = document.getElementById('delivery-fields');
            if (fieldsContainer) {
                fieldsContainer.innerHTML = '';
            }
            
            // 4. Ocultar campos de endere√ßo
            const addressFields = document.getElementById('address-fields');
            if (addressFields) {
                addressFields.classList.add('hidden');
            }
            
            // 5. Limpar taxa de delivery
            clearDeliveryFee();
            
            // 6. Manter bot√£o continuar habilitado para valida√ß√£o
            const continueBtn = document.getElementById('step2-continue');
            if (continueBtn) {
                continueBtn.disabled = false; // Manter habilitado para mostrar erro de valida√ß√£o
            }
            
            // 7. Mostrar todas as op√ß√µes de delivery
            showAllDeliveryOptions();
            
            // 8. Ocultar bot√£o "outras op√ß√µes"
            hideOtherOptionsButton();
            
            // 9. Reset modo endere√ßo manual - sempre voltar para modo CEP
            const cepContainer = document.getElementById('cep-mode-container');
            const manualContainer = document.getElementById('manual-address-container');
            if (cepContainer && manualContainer) {
                cepContainer.classList.remove('hidden');
                manualContainer.classList.add('hidden');
                clearManualAddressFields();
            }
            
            // 10. Limpar timeout de busca por bairro
            if (typeof neighborhoodSearchTimeout !== 'undefined' && neighborhoodSearchTimeout) {
                clearTimeout(neighborhoodSearchTimeout);
                neighborhoodSearchTimeout = null;
                debugLog('Timeout de busca limpo');
            }
            
            debugLog('Step 2 resetado completamente');
        }

        // Proceed to checkout
        function proceedToCheckout() {
            if (cart.length === 0) return;
            
            closeCart();
            currentStep = 2;
            showStep(2);
            document.getElementById('checkout-modal').classList.remove('hidden');
            
            // Desabilitar scroll do body quando modal abre (seguindo padr√£o do modal produto)
            document.body.style.overflow = 'hidden';
            document.documentElement.style.overflow = 'hidden'; // Tamb√©m bloquear no html
            debugLog('üò´ Scroll do body desabilitado durante checkout modal');
            
            // Adicionar listener para prevenir scroll com mouse wheel
            document.addEventListener('wheel', preventScrollDuringCheckout, { passive: false });
            document.addEventListener('touchmove', preventScrollDuringCheckout, { passive: false });
            
            // RESET COMPLETO DO STEP 2 antes de configurar
            resetStep2();
            
            // Setup delivery options based on configuration
            setupDeliveryOptions();
            
            // ===== AUTOMA√á√ÉO MESA URL =====
            // Verificar se h√° par√¢metro mesa na URL e automatizar
            const mesaAutomatizada = autoMesaCheckout();
            if (mesaAutomatizada) {
                debugLog('ü™ë Checkout automatizado para mesa URL');
            }
            
            // Setup payment methods based on configuration
            setupPaymentMethods();
            
            // Hide cart FAB during checkout
            document.getElementById('cart-fab').style.display = 'none';
        }
        
        // Setup payment methods based on configuration
        function setupPaymentMethods() {
            const checkoutConfig = getCheckoutConfig();
            const paymentContainer = document.querySelector('#payment-method').parentElement;
            
            debugLog('üîç DEBUG setupPaymentMethods:', {
                step3_show_formas_pag: checkoutConfig.step3_show_formas_pag,
                deliveryType: orderData.deliveryType
            });
            
            // Check if payment methods should be shown
            if (checkoutConfig.step3_show_formas_pag !== 'Sim') {
                debugLog('‚ùå Payment field HIDDEN - step3_show_formas_pag !== Sim');
                paymentContainer.style.display = 'none';
                return;
            }
            
            // Define delivery types that should show payment methods
            const deliveryTypesWithPayment = ['pickup', 'delivery', 'default'];
            
            // Show payment field only for specific delivery types (pickup, delivery, default)
            if (deliveryTypesWithPayment.includes(orderData.deliveryType)) {
                debugLog('‚úÖ Payment field SHOWN - deliveryType:', orderData.deliveryType);
                paymentContainer.style.display = 'block';
            } else {
                debugLog('‚ùå Payment field HIDDEN - deliveryType not allowed:', orderData.deliveryType);
                paymentContainer.style.display = 'none';
                return;
            }
            
            // Get payment methods from configuration
            const paymentMethods = checkoutConfig.step3_formas_pag;
            debugLog('üìù Payment methods from config:', paymentMethods);
            
            if (paymentMethods && paymentMethods.trim() !== '') {
                // Parse payment methods from configuration
                const methodsList = paymentMethods.split(',').map(method => method.trim());
                debugLog('üìã Methods list:', methodsList);
                const paymentSelect = document.getElementById('payment-method');
                
                // Clear existing options except the first one ("Selecione...")
                paymentSelect.innerHTML = '<option value="">Selecione...</option>';
                
                // Add payment methods from configuration
                methodsList.forEach(method => {
                    const option = document.createElement('option');
                    
                    // Use payment method name as is from spreadsheet
                    option.value = method.toLowerCase().replace(/\s+/g, '-');
                    
                    // Add emoji based on method name
                    let emoji = 'üí≥'; // Default credit card emoji
                    if (method.toLowerCase().includes('dinheiro')) {
                        emoji = 'üíµ';
                    } else if (method.toLowerCase().includes('pix')) {
                        emoji = 'üì±';
                    } else if (method.toLowerCase().includes('cart√£o') || method.toLowerCase().includes('cartao')) {
                        emoji = 'üí≥';
                    } else if (method.toLowerCase().includes('alelo') || method.toLowerCase().includes('vale') || method.toLowerCase().includes('ticket')) {
                        emoji = 'üé´'; // Simpler ticket emoji
                    }
                    
                    option.textContent = `${emoji} ${method}`;
                    debugLog('‚úÖ Created option:', option.value, '=', option.textContent);
                    
                    paymentSelect.appendChild(option);
                });
            } else {
                // Se n√£o h√° m√©todos configurados, n√£o exibir op√ß√µes
                const paymentSelect = document.getElementById('payment-method');
                paymentSelect.innerHTML = `
                    <option value="">M√©todos de pagamento n√£o configurados</option>
                `;
                paymentSelect.disabled = true;
                debugLog('‚ö†Ô∏è M√©todos de pagamento n√£o configurados na planilha');
            }
        }

        // Close checkout
        function closeCheckout(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('checkout-modal').classList.add('hidden');
            currentStep = 2;
            
            // Reabilitar scroll do body quando modal fecha (seguindo padr√£o do modal produto)
            document.body.style.overflow = '';
            document.documentElement.style.overflow = '';
            debugLog('‚úÖ Scroll enabled after checkout close');
            
            // Remover listeners de scroll
            document.removeEventListener('wheel', preventScrollDuringCheckout);
            document.removeEventListener('touchmove', preventScrollDuringCheckout);
            
            // Show cart FAB again when checkout closes (if cart has items and checkout is enabled)
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const checkoutConfig = getCheckoutConfig();
            const isCheckoutEnabled = checkoutConfig.checkout_mode && checkoutConfig.checkout_mode.toLowerCase() === 'sim';
            
            if (cartCount > 0 && isCheckoutEnabled) {
                document.getElementById('cart-fab').style.display = 'flex';
            }
        }
        
        // Back to cart from checkout
        function backToCart() {
            // Fechar checkout
            document.getElementById('checkout-modal').classList.add('hidden');
            currentStep = 2;
            
            // Reabilitar scroll do body quando modal fecha (seguindo padr√£o do modal produto)
            document.body.style.overflow = '';
            document.documentElement.style.overflow = '';
            debugLog('‚úÖ Scroll enabled after back to cart');
            
            // Remover listeners de scroll
            document.removeEventListener('wheel', preventScrollDuringCheckout);
            document.removeEventListener('touchmove', preventScrollDuringCheckout);
            
            // Abrir carrinho
            setTimeout(() => {
                openCart();
            }, 100);
        }

        // Show specific step
        function showStep(step) {
            document.querySelectorAll('.checkout-step').forEach(el => el.classList.add('hidden'));
            document.getElementById(`checkout-step-${step}`).classList.remove('hidden');
            currentStep = step;
            
            // Sempre que voltar para steps anteriores ao resumo, resetar forma de pagamento
            if (step < 3) {
                if (typeof resetPaymentState === 'function') {
                    try { resetPaymentState(); } catch (e) { errorLog('resetPaymentState on showStep error:', e); }
                }
            }
            
            // Atualizar total do pedido no Step 3
            if (step === 3) {
                updateCheckoutOrderTotal();
                
                // Inicializar monitoramento do campo de bairro quando step 3 for mostrado
                setTimeout(() => {
                    iniciarMonitoramentoRedundanteBairro();
                }, 500); // Aguardar 500ms para garantir que os campos foram renderizados
            }
        }

        // Limpa estado e UI de forma de pagamento (quando usu√°rio volta do Step 3)
        function resetPaymentState() {
            try {
                // 1) Estado global
                if (!window.orderData) window.orderData = {};
                delete orderData.paymentMethod;      // 'pix' | 'dinheiro' | 'cartao' | ...
                delete orderData.needsChange;        // boolean
                delete orderData.changeFor;          // n√∫mero (legado)
                delete orderData.changeAmount;       // n√∫mero/texto (atual)
                delete orderData.paymentObservations; // string opcional

                // 2) Persist√™ncia local (se utilizada)
                try {
                    localStorage.removeItem('paymentMethod');
                    localStorage.removeItem('needsChange');
                    localStorage.removeItem('changeFor'); // legado
                    localStorage.removeItem('changeAmount');
                    localStorage.removeItem('paymentObservations');
                } catch (_) { /* noop */ }

                // 3) UI
                // Radios de forma de pagamento
                document.querySelectorAll('input[name="payment-method"]').forEach(el => {
                    el.checked = false;
                });

                // Select de forma de pagamento (id atual)
                const paymentSelect = document.getElementById('payment-method');
                if (paymentSelect) {
                    // Assumindo que a option padr√£o tem value "" (Selecionar)
                    paymentSelect.value = '';
                    // Disparar change para atualizar listeners
                    try { paymentSelect.dispatchEvent(new Event('change')); } catch (_) {}
                }

                // Troco (usar IDs reais)
                const changeToggleContainer = document.getElementById('change-toggle-container');
                const changeDiv = document.getElementById('money-change');
                const changeInput = document.getElementById('change-amount');
                const changeToggle = document.getElementById('change-toggle');
                const changeToggleLabel = document.getElementById('change-toggle-label');
                const pixInfo = document.getElementById('pix-info');

                if (changeInput) changeInput.value = '';
                if (changeToggle) changeToggle.checked = false;
                if (changeToggleLabel) {
                    changeToggleLabel.textContent = 'N√£o';
                    changeToggleLabel.style.color = 'var(--cor-texto-secundario)';
                }
                if (changeDiv) changeDiv.classList.add('hidden');
                if (changeToggleContainer) changeToggleContainer.classList.add('hidden');
                if (pixInfo) pixInfo.classList.add('hidden');

                // 4) Atualizar resumo/totais se necess√°rio
                if (typeof updateCheckoutOrderTotal === 'function') {
                    updateCheckoutOrderTotal();
                }

                debugLog('üîÅ Forma de pagamento resetada ao voltar de step');
            } catch (e) {
                errorLog('resetPaymentState error:', e);
            }
        }

        // Next step with enhanced validation
        function nextStep(step) {
            if (step === 3) {
                if (!validateStep2Enhanced()) {
                    return;
                }
                // Sincronizar taxa de delivery com o bairro atual antes de abrir o resumo
                if (typeof syncDeliveryFeeBeforeStep3 === 'function') {
                    try { syncDeliveryFeeBeforeStep3(); } catch (e) { errorLog('Erro ao sincronizar taxa antes do Step 3:', e); }
                }
                showStep(step);
            } else {
                showStep(step);
            }
        }

        // Sincroniza a taxa de delivery com base no bairro atual antes de exibir o Step 3 (resumo)
        function syncDeliveryFeeBeforeStep3() {
            try {
                if (!orderData) return;
                if (orderData.deliveryType !== 'delivery') return; // s√≥ aplica para delivery

                // Obter bairro atual dos campos (prioriza modo manual se vis√≠vel/preenchido)
                const manualNeighborhoodEl = document.getElementById('manual-neighborhood');
                const cepNeighborhoodEl = document.getElementById('neighborhood');
                const manualValue = manualNeighborhoodEl ? manualNeighborhoodEl.value.trim() : '';
                const cepValue = cepNeighborhoodEl ? cepNeighborhoodEl.value.trim() : '';
                const neighborhood = manualValue || cepValue || (orderData.address ? (orderData.address.neighborhood || '') : '');

                if (!neighborhood) {
                    // Se bairro vazio, limpar taxa
                    if (!orderData.address) orderData.address = {};
                    delete orderData.address.deliveryFee;
                    currentDeliveryFee = null;
                    return;
                }

                // Buscar taxa na planilha
                if (typeof findDeliveryFeeByNeighborhood === 'function') {
                    const feeRaw = findDeliveryFeeByNeighborhood(neighborhood);
                    const fee = typeof feeRaw === 'string' ? parseFloat(feeRaw.replace(/[^0-9.,]/g, '').replace(',', '.')) : feeRaw;
                    if (!isNaN(fee) && fee > 0) {
                        if (!orderData.address) orderData.address = {};
                        orderData.address.neighborhood = neighborhood;
                        orderData.address.deliveryFee = fee;
                        currentDeliveryFee = fee;
                        // Memoriza √∫ltima consulta
                        window.lastNeighborhoodFee = fee;
                        window.lastNeighborhoodName = neighborhood;
                        debugLog('üîÅ syncDeliveryFeeBeforeStep3 aplicou taxa:', neighborhood, fee);
                    } else {
                        if (!orderData.address) orderData.address = {};
                        delete orderData.address.deliveryFee;
                        currentDeliveryFee = null;
                        debugLog('üîÅ syncDeliveryFeeBeforeStep3: taxa n√£o encontrada para', neighborhood);
                    }
                }
            } catch (e) {
                errorLog('syncDeliveryFeeBeforeStep3 error:', e);
            }
        }
        
        // Enhanced Step 2 validation - validates all required fields
        function validateStep2Enhanced() {
            const deliveryType = document.querySelector('input[name="delivery-type"]:checked')?.value;
            
            // Clear any existing errors first
            clearAllFieldErrors();
            
            if (!deliveryType) {
                showToast('Por favor, selecione o tipo de recebimento', 'warning');
                return false;
            }
            
            // Update orderData with current selection
            orderData.deliveryType = deliveryType;
            
            let hasErrors = false;
            
            // Validate specific fields based on delivery type
            if (deliveryType === 'local') {
                // Check if mesa/comanda field should be validated based on configuration
                const checkoutConfig = getCheckoutConfig();
                const shouldShowMesaComanda = checkoutConfig.step3_mesa_comanda === 'Sim';
                
                if (shouldShowMesaComanda) {
                    const tableNumber = document.getElementById('table-number')?.value.trim();
                    if (!tableNumber) {
                        showFieldError('table-number', 'Informe o n√∫mero da mesa ou comanda');
                        hasErrors = true;
                    } else {
                        orderData.tableNumber = tableNumber;
                    }
                } else {
                    // If mesa/comanda is not required, clear any existing table number
                    orderData.tableNumber = '';
                }
            } else if (deliveryType === 'delivery') {
                // Valida√ß√£o endere√ßo manual (√∫nico modo dispon√≠vel)
                const street = document.getElementById('manual-street')?.value.trim();
                const number = document.getElementById('manual-number')?.value.trim();
                const neighborhood = document.getElementById('manual-neighborhood')?.value.trim();
                const city = document.getElementById('manual-city')?.value.trim();
                
                // Validar campos obrigat√≥rios do endere√ßo manual
                if (!street) {
                    showFieldError('manual-street', 'Endere√ßo √© obrigat√≥rio');
                    hasErrors = true;
                }
                if (!number) {
                    showFieldError('manual-number', 'N√∫mero √© obrigat√≥rio');
                    hasErrors = true;
                }
                if (!neighborhood) {
                    showFieldError('manual-neighborhood', 'Bairro √© obrigat√≥rio');
                    hasErrors = true;
                }
                if (!city) {
                    showFieldError('manual-city', 'Cidade √© obrigat√≥ria');
                    hasErrors = true;
                }
                
                // Se n√£o h√° erros, garantir que orderData est√° atualizado
                if (!hasErrors) {
                    updateManualAddressData();
                }
            }
            
            // üîí VALIDA√á√ÉO ADICIONAL: Modo de restri√ß√£o por bairro
            if (deliveryType === 'delivery' && !hasErrors) {
                const config = getCheckoutConfig();
                
                if (config.only_bairro_mode === 'Sim') {
                    // Pegar bairro do campo manual (√∫nico modo dispon√≠vel)
                    const neighborhoodToValidate = document.getElementById('manual-neighborhood')?.value.trim() || '';
                    
                    // Validar se o bairro est√° na lista de atendimento
                    if (neighborhoodToValidate && !validateNeighborhoodForDelivery(neighborhoodToValidate)) {
                        debugLog('‚ùå Valida√ß√£o falhou: Bairro n√£o atendido no modo de restri√ß√£o:', neighborhoodToValidate);
                        showToast('Desculpe, n√£o atendemos este bairro.', 'error');
                        return false;
                    }
                    
                    debugLog('‚úÖ Valida√ß√£o passou: Bairro v√°lido para entrega:', neighborhoodToValidate);
                }
            }
            
            // Show error toast if there are validation errors
            if (hasErrors) {
                showToast('Por favor, preencha todos os campos obrigat√≥rios', 'error');
                return false;
            }
            
            return true;
        }
        
        // Clear all field errors
        function clearAllFieldErrors() {
            const errorFields = [
                'table-number',
                'manual-street', 'manual-number', 'manual-neighborhood', 'manual-city'
            ];
            errorFields.forEach(fieldId => {
                clearFieldError(fieldId);
            });
        }

        // Previous step
        function prevStep(step) {
            showStep(step);
        }



        // Update cart quantity
        function updateCartQuantity(itemKey, delta) {
            const item = cart.find(item => item.itemKey === itemKey);
            if (!item) return;
            
            item.quantity += delta;
            
            if (item.quantity <= 0) {
                cart = cart.filter(item => item.itemKey !== itemKey);
            }
            
            // Salvar carrinho no localStorage
            if (typeof saveCartToStorage === 'function') {
                saveCartToStorage();
            }
            
            updateCartUI();
            
            // Refresh current view
            if (document.getElementById('cart-modal').classList.contains('hidden') === false) {
                openCart(); // Refresh cart display
            }
        }

        // Open image lightbox
        function openImageLightbox(imageSrc, itemName) {
            const lightbox = document.getElementById('image-lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const lightboxTitle = document.getElementById('lightbox-title');
            
            lightboxImage.src = imageSrc;
            lightboxImage.alt = itemName;
            lightboxTitle.textContent = itemName;
            
            lightbox.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        // Close image lightbox
        function closeLightbox(event) {
            if (event && event.target !== event.currentTarget && !event.target.closest('button')) return;
            
            const lightbox = document.getElementById('image-lightbox');
            lightbox.classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Edit item notes
        let currentEditingItemKey = null;
        
        function editItemNotes(itemKey) {
            const item = cart.find(item => item.itemKey === itemKey);
            if (!item) return;
            
            currentEditingItemKey = itemKey;
            
            // Populate item info
            const itemInfoDiv = document.getElementById('edit-item-info');
            itemInfoDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <img src="${processImageUrl(item.imagem)}" alt="${item.nome}" class="w-12 h-10 object-cover rounded" onerror="this.src='${getPlaceholderImage()}'">
                    </div>
                    <div class="flex-1">
                        <div class="text-xs text-gray-400 font-mono" style="font-size: 10px; margin-bottom: 2px;">${item.sku}</div>
                        <h4 class="font-medium text-sm">${item.nome}</h4>
                        ${item.variationText ? `<p class="text-xs text-gray-600">‚úì ${item.variationText}</p>` : ''}
                        ${item.removalText ? `<p class="text-xs text-red-600">üö´ Remover Ingredientes: ${item.removalText}</p>` : ''}
                        <p class="text-xs text-gray-500">Quantidade: ${item.quantity}x</p>
                    </div>
                </div>
            `;
            
            // Set current notes
            document.getElementById('edit-item-notes').value = item.notes || '';
            
            // Hide cart FAB and show modal
            document.getElementById('cart-fab').style.display = 'none';
            document.getElementById('edit-notes-modal').classList.remove('hidden');
            
            // Focus on textarea
            setTimeout(() => {
                document.getElementById('edit-item-notes').focus();
            }, 300);
        }
        
        function saveItemNotes() {
            if (!currentEditingItemKey) return;
            
            const item = cart.find(item => item.itemKey === currentEditingItemKey);
            if (!item) return;
            
            const newNotes = document.getElementById('edit-item-notes').value.trim();
            
            // If notes changed, we need to update the item
            if (item.notes !== newNotes) {
                // Remove old item
                cart = cart.filter(item => item.itemKey !== currentEditingItemKey);
                
                // Create new item key if notes changed (for proper grouping)
                const baseKey = currentEditingItemKey.replace(/-notes-[^-]*$/, '');
                const notesKey = newNotes ? `-notes-${btoa(newNotes).replace(/[^a-zA-Z0-9]/g, '')}` : '';
                const newItemKey = `${baseKey}${notesKey}`;
                
                // Check if item with same key already exists
                const existingItem = cart.find(existingItem => existingItem.itemKey === newItemKey);
                
                if (existingItem) {
                    // Merge quantities
                    existingItem.quantity += item.quantity;
                } else {
                    // Add updated item
                    item.itemKey = newItemKey;
                    item.notes = newNotes;
                    cart.push(item);
                }
            }
            
            updateCartUI();
            
            // Salvar carrinho atualizado no localStorage
            if (typeof saveCartToStorage === 'function') {
                saveCartToStorage();
                debugLog('üíæ Observa√ß√µes do item salvas no localStorage');
            }
            
            closeEditNotes();
            
            // Refresh cart display if it's open
            if (!document.getElementById('cart-modal').classList.contains('hidden')) {
                openCart();
            }
            
            showToast('Observa√ß√µes atualizadas com sucesso!', 'success', 2000);
        }
        
        function closeEditNotes(event) {
            if (event && event.target !== event.currentTarget) return;
            
            document.getElementById('edit-notes-modal').classList.add('hidden');
            currentEditingItemKey = null;
            
            // Show cart FAB again if cart has items
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (cartCount > 0) {
                document.getElementById('cart-fab').style.display = 'flex';
            }
        }

        // Handle delivery type change
        function handleDeliveryTypeChange() {
            const selectedType = document.querySelector('input[name="delivery-type"]:checked')?.value;
            const fieldsContainer = document.getElementById('delivery-fields');
            const continueBtn = document.getElementById('step2-continue');
            
            // Limpar taxa de delivery ao trocar tipo de entrega
            clearDeliveryFee();
            
            orderData.deliveryType = selectedType;
            
            if (!selectedType) {
                continueBtn.disabled = false; // Manter habilitado para mostrar erro de valida√ß√£o
                fieldsContainer.innerHTML = '';
                showAllDeliveryOptions();
                hideOtherOptionsButton();
                // Reset payment methods when no delivery type is selected
                setupPaymentMethods();
                return;
            }
            
            // Update payment methods visibility based on delivery type
            setupPaymentMethods();
            
            // Hide other options and show the "Mostrar outras op√ß√µes" button
            hideOtherDeliveryOptions(selectedType);
            showOtherOptionsButton();
            
            continueBtn.disabled = false;
            
            switch(selectedType) {
                case 'local':
                    // Check if mesa/comanda field should be shown based on configuration
                    const checkoutConfig = getCheckoutConfig();
                    const shouldShowMesaComanda = checkoutConfig.step3_mesa_comanda === 'Sim';
                    
                    if (shouldShowMesaComanda) {
                        fieldsContainer.innerHTML = `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero da Mesa/Comanda *</label>
                                <input type="tel" id="table-number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Ex: Mesa 5 ou Comanda 123" autocomplete="off" oninput="clearFieldError('table-number')" onchange="updateContinueButton()" onblur="updateContinueButton()" inputmode="numeric">
                            </div>
                        `;
                        continueBtn.disabled = true;
                        
                        // Foco autom√°tico no campo de mesa ap√≥s renderiza√ß√£o
                        setTimeout(() => {
                            const tableNumberField = document.getElementById('table-number');
                            if (tableNumberField) {
                                // Primeiro tenta preencher automaticamente da URL
                                const preenchido = preencheMesaAutomatica();
                                // Se n√£o preencheu automaticamente, foca no campo
                                if (!preenchido) {
                                    tableNumberField.focus();
                                }
                            }
                        }, 100);
                    } else {
                        // If mesa/comanda is not required, just clear the fields and enable continue
                        fieldsContainer.innerHTML = '';
                        continueBtn.disabled = false;
                    }
                    break;
                    
                case 'delivery':
            // Get delivery fee message from configuration
            const checkoutConfigDelivery = getCheckoutConfig();
            const deliveryFeeMessage = checkoutConfigDelivery.step2_taxa_delivery || 'Consulte taxa de entrega pelo WhatsApp com nosso atendente';
            
            fieldsContainer.innerHTML = `
                <div class="space-y-4">
                    <!-- Delivery Fee Alert - Oculto inicialmente, aparece apenas se bairro n√£o for encontrado -->
                    <div id="original-delivery-fee-alert" class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <svg class="w-5 h-5 text-amber-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-medium text-amber-800 mb-1">Consulte a Taxa de Entrega</h4>
                                <p class="text-sm text-amber-700">${deliveryFeeMessage}</p>
                            </div>
                      </div></div>
                    <!-- Modo Endere√ßo Manual (√önico) -->
                    <div id="manual-address-container">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Endere√ßo *</label>
                                <input type="text" id="manual-street" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Rua, Avenida, etc." autocomplete="street-address" oninput="clearFieldError('manual-street'); updateManualAddressData()" onchange="updateContinueButton()">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero *</label>
                                    <input type="number" inputmode="numeric" required id="manual-number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="123" autocomplete="off" oninput="clearFieldError('manual-number'); updateManualAddressData()" onchange="updateContinueButton()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Complemento</label>
                                    <input type="text" id="manual-complement" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Apto, Bloco, etc." autocomplete="off" oninput="updateManualAddressData()">
                                </div>
                            </div>
                            <div>
                              <label class="block text-sm font-medium text-gray-700 mb-2">Bairro *</label>
                                        <select id="manual-neighborhood" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" oninput="updateManualAddressData(); clearFieldError('manual-neighborhood');" onchange="searchNeighborhoodFeeForManualMode(this.value); updateContinueButton();">
                                            <option value="">Selecione o bairro...</option>
                                        </select>     
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cidade *</label>
                                <input type="text" id="manual-city" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Nome da cidade" autocomplete="address-level2" oninput="clearFieldError('manual-city'); updateManualAddressData()" onchange="updateContinueButton()">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            continueBtn.disabled = true;
            
            // Foco autom√°tico no primeiro campo de endere√ßo ap√≥s renderiza√ß√£o
            setTimeout(() => {
                const streetField = document.getElementById('manual-street');
                if (streetField) {
                    streetField.focus();
                }
            // Popular select de bairros
            populateNeighborhoodSelect();
            }, 100);
                    break;
                    
                case 'pickup':
                case 'default':
                    fieldsContainer.innerHTML = '';
                    continueBtn.disabled = false;
                    break;
            }
        }
        // Populate neighborhood select with available options
function populateNeighborhoodSelect() {
    const select = document.getElementById('manual-neighborhood');
    if (!select || !window.neighborhoodsData || window.neighborhoodsData.length === 0) {
        return;
    }
    
    // Limpar op√ß√µes existentes (manter apenas a primeira)
    select.innerHTML = '<option value="">Selecione o bairro...</option>';
    
    // Ordenar bairros alfabeticamente
    const sortedNeighborhoods = window.neighborhoodsData
        .filter(item => item.bairro && item.bairro.trim())
        .sort((a, b) => a.bairro.localeCompare(b.bairro));
    
    // Adicionar op√ß√µes
    sortedNeighborhoods.forEach(item => {
        const option = document.createElement('option');
        option.value = item.bairro;
        option.textContent = item.bairro;
        select.appendChild(option);
    });
    
    debugLog('Select de bairros populado com', sortedNeighborhoods.length, 'op√ß√µes');
}

        // Handle manual neighborhood change for delivery fee calculation
        function handleManualNeighborhoodChange() {
            const neighborhoodField = document.getElementById('manual-neighborhood');
            if (!neighborhoodField) return;
            
            const neighborhood = neighborhoodField.value.trim();
            
            // Limpar timeout anterior se existir
            if (window.manualNeighborhoodSearchTimeout) {
                clearTimeout(window.manualNeighborhoodSearchTimeout);
            }
            
            // Se campo estiver vazio, limpar taxa
            if (!neighborhood) {
                clearDeliveryFee();
                return;
            }
            
            // Aguardar 500ms ap√≥s o usu√°rio parar de digitar antes de buscar
            window.manualNeighborhoodSearchTimeout = setTimeout(() => {
                searchNeighborhoodFeeForManualMode(neighborhood);
            }, 500);
        }

        // Search neighborhood fee for manual address mode
        function searchNeighborhoodFeeForManualMode(neighborhood) {
            debugLog('=== BUSCANDO TAXA POR BAIRRO (MODO MANUAL) ===');
            debugLog('Bairro pesquisado:', neighborhood);
            
            // Verificar se dados est√£o dispon√≠veis
            if (!window.neighborhoodsData || window.neighborhoodsData.length === 0) {
                debugLog('Dados de bairros n√£o dispon√≠veis');
                displayDeliveryFee(null, neighborhood);
                return;
            }
            
            // Normalizar bairro para busca
            const normalizedNeighborhood = neighborhood.toLowerCase().trim();
            
            // Buscar taxa exata
            const found = window.neighborhoodsData.find(item => {
                const itemBairro = (item.bairro || '').toLowerCase().trim();
                return itemBairro === normalizedNeighborhood;
            });
            
            if (found && found.taxa !== undefined) {
                const fee = parseFloat(found.taxa) || 0;
                debugLog('‚úÖ Taxa encontrada:', fee, 'para bairro:', neighborhood);
                
                // Atualizar taxa global
                currentDeliveryFee = fee;
                
                // Salvar no orderData
                if (!window.orderData.address) window.orderData.address = {};
                window.orderData.address.deliveryFee = fee;
                
                // Exibir taxa na interface
                displayDeliveryFee(fee, neighborhood);
                
                // Atualizar total do checkout
                updateCheckoutOrderTotal();
                return;
            }
            
            debugLog('‚ùå Taxa n√£o encontrada para o bairro:', neighborhood);
            // Taxa n√£o encontrada - mostrar alerta para consultar
            displayDeliveryFee(null, neighborhood);
            
            // Limpar taxa nos dados do pedido
            if (window.orderData && window.orderData.address) {
                delete window.orderData.address.deliveryFee;
            }
            
            // Atualizar total do checkout (sem taxa)
            updateCheckoutOrderTotal();
        }



        // Update continue button state (no validation, just enable/disable)
        function updateContinueButton() {
            // Button is always enabled - validation happens on click
            const continueBtn = document.getElementById('step2-continue');
            if (continueBtn) {
                continueBtn.disabled = false;
            }
        }

        // Show all delivery options (only enabled ones from configuration)
        function showAllDeliveryOptions() {
            const deliveryOptions = document.getElementById('delivery-options');
            const checkoutConfig = getCheckoutConfig();
            
            // Helper function to check if option is enabled
            function isOptionEnabled(csvValue) {
                if (!csvValue || !csvValue.includes('/')) {
                    return false;
                }
                const parts = csvValue.split('/');
                const visibility = parts[0] ? parts[0].trim().toLowerCase() : '';
                return visibility === 'sim';
            }
            
            // Map of input values to their config keys
            const optionConfigMap = {
                'local': checkoutConfig.step2_opc1,
                'pickup': checkoutConfig.step2_opc2,
                'delivery': checkoutConfig.step2_opc3,
                'default': checkoutConfig.step2_opc4
            };
            
            deliveryOptions.querySelectorAll('label').forEach(label => {
                const input = label.querySelector('input[type="radio"]');
                if (input) {
                    const optionValue = input.value;
                    const configValue = optionConfigMap[optionValue];
                    
                    // Only show if option is enabled in configuration
                    if (isOptionEnabled(configValue)) {
                        label.style.display = 'flex';
                    } else {
                        label.style.display = 'none';
                    }
                }
            });
        }

        // Hide other delivery options (keep only selected)
        function hideOtherDeliveryOptions(selectedType) {
            const deliveryOptions = document.getElementById('delivery-options');
            deliveryOptions.querySelectorAll('label').forEach(label => {
                const input = label.querySelector('input[type="radio"]');
                if (input.value !== selectedType) {
                    label.style.display = 'none';
                }
            });
        }

        // Show "Outras op√ß√µes" button
        function showOtherOptionsButton() {
            const deliveryOptions = document.getElementById('delivery-options');
            let showOtherOptionsBtn = document.getElementById('show-other-options');
            
            if (!showOtherOptionsBtn) {
                showOtherOptionsBtn = document.createElement('button');
                showOtherOptionsBtn.id = 'show-other-options';
                showOtherOptionsBtn.type = 'button';
                showOtherOptionsBtn.className = 'text-sm font-medium mt-3 mb-1 py-2 px-4 rounded-md transition-all duration-200 flex items-center justify-center';
                showOtherOptionsBtn.style.backgroundColor = 'var(--cor-terciaria, #6B7280)';
                showOtherOptionsBtn.style.color = 'white';
                showOtherOptionsBtn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                showOtherOptionsBtn.style.width = 'auto';
                showOtherOptionsBtn.style.alignSelf = 'flex-start';
                showOtherOptionsBtn.onmouseenter = function() { 
                    // Escurecer 30% a cor terci√°ria
                    const corTerciaria = getComputedStyle(document.documentElement).getPropertyValue('--cor-terciaria').trim() || '#6B7280';
                    const corEscurecida = escurecerCor30Porcento(corTerciaria);
                    this.style.backgroundColor = corEscurecida;
                    this.style.transform = 'translateY(-1px)';
                    this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                };
                showOtherOptionsBtn.onmouseleave = function() { 
                    this.style.backgroundColor = 'var(--cor-terciaria, #6B7280)'; 
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                };
                showOtherOptionsBtn.innerHTML = '‚Ü©Ô∏è Mostrar outras op√ß√µes de entrega';
                showOtherOptionsBtn.onclick = toggleDeliveryOptions;
                deliveryOptions.appendChild(showOtherOptionsBtn);
            }
            
            showOtherOptionsBtn.style.display = 'block';
        }

        // Hide "Outras op√ß√µes" button
        function hideOtherOptionsButton() {
            const showOtherOptionsBtn = document.getElementById('show-other-options');
            if (showOtherOptionsBtn) {
                showOtherOptionsBtn.style.display = 'none';
            }
        }

        // Toggle delivery options visibility
        function toggleDeliveryOptions() {
            const showOtherOptionsBtn = document.getElementById('show-other-options');
            const deliveryOptions = document.getElementById('delivery-options');
            const fieldsContainer = document.getElementById('delivery-fields');
            const hiddenOptions = deliveryOptions.querySelectorAll('label[style*="display: none"]');
            
            if (hiddenOptions.length > 0) {
                // Show all options and hide the button
                showAllDeliveryOptions();
                hideOtherOptionsButton();
                
                // Limpar os campos espec√≠ficos (CEP ou mesa)
                fieldsContainer.innerHTML = '';
                
                // Desmarcar todos os radios
                document.querySelectorAll('input[name="delivery-type"]').forEach(radio => {
                    radio.checked = false;
                });
                
                // Atualizar orderData
                orderData.deliveryType = null;
            }
        }

        // Allow deselecting radio buttons
        function setupDeselectableRadios() {
            let lastChecked = null;
            
            document.addEventListener('click', function(e) {
                if (e.target.type === 'radio' && e.target.name === 'delivery-type') {
                    // If clicking the same radio that was already checked, uncheck it
                    if (lastChecked === e.target) {
                        e.target.checked = false;
                        lastChecked = null;
                        handleDeliveryTypeChange();
                    } else {
                        lastChecked = e.target;
                        handleDeliveryTypeChange();
                    }
                }
            });
        }

        /**
         * Limpa sele√ß√£o de varia√ß√£o espec√≠fica
         * @param {string} inputName - Nome do grupo de inputs
         * @param {string} variationIndex - √çndice da varia√ß√£o
         */
        function clearVariationSelection(inputName, variationIndex) {
            const radios = document.querySelectorAll(`input[name="${inputName}"]`);
            radios.forEach(radio => {
                radio.checked = false;
            });
            
            // Limpar do objeto selectedVariations
            // Para formato novo (chaves como "0-1", "0-2") e legado (chaves simples)
            if (selectedVariations) {
                // Limpar chave simples (formato legado)
                if (selectedVariations[variationIndex]) {
                    delete selectedVariations[variationIndex];
                }
                
                // Limpar chaves compostas (formato novo: variationIndex-optionIndex)
                Object.keys(selectedVariations).forEach(key => {
                    if (key.startsWith(`${variationIndex}-`)) {
                        delete selectedVariations[key];
                    }
                });
                
                debugLog('üßπ Varia√ß√µes limpas para √≠ndice:', variationIndex, 'Estado atual:', selectedVariations);
            }
            
            // Ocultar bot√µes de limpar dessa varia√ß√£o
            hideVariationClearButtons(inputName);
            
            // Atualizar pre√ßo do produto
            updateModalPricing();
            updateAddToCartButton();
            
            debugLog('üßπ Varia√ß√£o limpa:', inputName, '√çndice:', variationIndex);
        }

        /**
         * Limpa sele√ß√£o de pre√ßo base
         */
        function clearBasePriceSelection() {
            const radios = document.querySelectorAll('input[name="base-price"]');
            radios.forEach(radio => {
                radio.checked = false;
            });
            
            // Resetar pre√ßo base no produto atual
            if (currentProduct) {
                currentProduct.selectedBasePrice = null;
            }
            
            // Resetar display do pre√ßo base
            const basePriceElement = document.getElementById('base-price');
            if (basePriceElement && currentProduct) {
                basePriceElement.textContent = getBasePriceDisplay(currentProduct.preco);
            }
            
            // Ocultar bot√µes de limpar pre√ßo
            const clearBtns = document.querySelectorAll('.clear-price-btn');
            clearBtns.forEach(btn => btn.style.display = 'none');
            
            // Atualizar pre√ßo do produto
            updateModalPricing();
            updateAddToCartButton();
            
            debugLog('üßπ Pre√ßo base limpo');
        }

        /**
         * Mostra/oculta bot√µes de limpar baseado na sele√ß√£o
         */
        function toggleClearButtons() {
            // Para varia√ß√µes
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                if (radio.name.startsWith('variation-') || radio.name === 'base-price') {
                    const container = radio.closest('label');
                    const clearBtn = container.querySelector('.clear-variation-btn, .clear-price-btn');
                    
                    if (clearBtn) {
                        clearBtn.style.display = radio.checked ? 'inline-block' : 'none';
                    }
                }
            });
        }

        /**
         * Oculta bot√µes de limpar de uma varia√ß√£o espec√≠fica
         * @param {string} inputName - Nome do grupo de inputs
         */
        function hideVariationClearButtons(inputName) {
            const radios = document.querySelectorAll(`input[name="${inputName}"]`);
            radios.forEach(radio => {
                const container = radio.closest('label');
                const clearBtn = container.querySelector('.clear-variation-btn');
                if (clearBtn) clearBtn.style.display = 'none';
            });
        }

        // Show field error with enhanced visual feedback
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            // Clear any existing animations first
            field.classList.remove('shake', 'field-error');
            
            // Remove existing error message
            const existingError = field.parentNode.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // Force reflow to ensure classes are removed
            field.offsetHeight;
            
            // Add error styling with shake animation
            field.classList.add('field-error', 'shake');
            
            // Add error message with animation
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <span class="text-red-500">‚ö†Ô∏è</span>
                <span>${message}</span>
            `;
            field.parentNode.appendChild(errorDiv);
            
            // Focus on field with slight delay
            setTimeout(() => {
                if (typeof field.focus === 'function') {
                    field.focus();
                }
                try {
                    if (field instanceof HTMLInputElement || field instanceof HTMLTextAreaElement) {
                        if (typeof field.select === 'function') {
                            field.select();
                        }
                    }
                } catch (e) { /* noop */ }
            }, 100);
            
            // Remove shake animation after it completes (only once)
            setTimeout(() => {
                field.classList.remove('shake');
            }, 600);
        }

        // Clear field error with smooth transition
        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            // Remove all error-related classes and animations
            field.classList.remove('field-error', 'shake');
            
            // Remove error message with fade out
            const errorMessage = field.parentNode.querySelector('.error-message');
            if (errorMessage) {
                errorMessage.style.opacity = '0';
                errorMessage.style.transform = 'translateY(-5px)';
                setTimeout(() => {
                    if (errorMessage.parentNode) {
                        errorMessage.remove();
                    }
                }, 200);
            }
        }
        


        // Simple validation functions - only called when needed
        function validateTableNumber() {
            const tableNumber = document.getElementById('table-number')?.value.trim();
            if (!tableNumber) {
                showFieldError('table-number', 'Informe o n√∫mero da mesa ou comanda');
                return false;
            }
            return true;
        }
        
        function validateAddressNumber() {
            const number = document.getElementById('number')?.value.trim();
            if (!number) {
                showFieldError('number', 'N√∫mero do endere√ßo √© obrigat√≥rio');
                return false;
            }
            return true;
        }
        
        function validateCustomerName() {
            const name = document.getElementById('customer-name')?.value.trim();
            if (!name) {
                showFieldError('customer-name', 'Nome completo √© obrigat√≥rio');
                return false;
            }
            if (name.length < 2) {
                showFieldError('customer-name', 'Nome deve ter pelo menos 2 caracteres');
                return false;
            }
            return true;
        }
        
        function validatePaymentMethod() {
            const checkoutConfig = getCheckoutConfig();
            
            // Check if payment methods are enabled
            if (checkoutConfig.step3_show_formas_pag !== 'Sim') {
                return true; // Skip validation if payment methods are disabled
            }
            
            // Define delivery types that should validate payment methods
            const deliveryTypesWithPayment = ['pickup', 'delivery', 'default'];
            if (!deliveryTypesWithPayment.includes(orderData.deliveryType)) {
                return true; // Skip validation for delivery types without payment
            }
            
            const paymentMethod = document.getElementById('payment-method')?.value;
            if (!paymentMethod) {
                showFieldError('payment-method', 'Selecione a forma de pagamento');
                return false;
            }
            return true;
        }
        
        /**
         * Calcula o total do carrinho
         */
        function calculateCartTotal() {
            return cart.reduce((sum, item) => {
                const price = typeof parsePrice === 'function' ? parsePrice(item.preco) : parseFloat(String(item.preco).replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
                return price > 0 ? sum + (price * item.quantity) : sum;
            }, 0);
        }
        
        // Atualizar total do pedido no Step 3 (checkout) - MODIFICADO PARA CUPONS
        function updateCheckoutOrderTotal() {
            const totalElement = document.getElementById('checkout-order-total');
            if (totalElement) {
                const cartTotal = calculateCartTotal();
                const deliveryFee = (orderData && orderData.deliveryType === 'delivery')
                    ? ((orderData.address && typeof orderData.address.deliveryFee !== 'undefined')
                        ? orderData.address.deliveryFee
                        : (typeof currentDeliveryFee !== 'undefined' && currentDeliveryFee !== null ? currentDeliveryFee : 0))
                    : 0;
                let finalTotal = cartTotal + deliveryFee;
                
                // Aplicar desconto do cupom se houver
                if (appliedCoupon && couponDiscount > 0) {
                    finalTotal = Math.max(0, finalTotal - couponDiscount);
                }
                
                debugLog('=== ATUALIZANDO TOTAL DO CHECKOUT ===');
                debugLog('Subtotal carrinho:', formatCurrency(cartTotal));
                debugLog('Taxa de delivery:', formatCurrency(deliveryFee));
                debugLog('Desconto cupom:', formatCurrency(couponDiscount));
                debugLog('Total final:', formatCurrency(finalTotal));
                
                // Atualizar total final (sempre limpo)
                totalElement.textContent = formatCurrency(finalTotal);
                
                // Atualizar novo resumo limpo
                updateOrderSummary(cartTotal, deliveryFee);
            }
        }
        
        // ===== SISTEMA DE CUPONS =====
        
        /**
         * Verifica se todos os itens no carrinho s√£o do tipo "consulte pre√ßo"
         * @returns {boolean} True se todos os itens forem do tipo "consulte pre√ßo"
         */
        function hasOnlyConsultPriceItems() {
            // Se o carrinho estiver vazio, retorna false
            if (cart.length === 0) return false;
            
            // Verifica se todos os itens t√™m pre√ßo zero ou null/undefined
            return cart.every(item => {
                return item.preco === 0 || item.preco === null || item.preco === undefined || isNaN(item.preco);
            });
        }
        
        // Atualizar resumo do pedido - NOVA VERS√ÉO LIMPA
        function updateOrderSummary(cartTotal, deliveryFee) {
            // Elementos do novo layout
            const subtotalElement = document.getElementById('order-subtotal');
            const deliveryRow = document.getElementById('delivery-row');
            const deliveryFeeElement = document.getElementById('order-delivery-fee');
            const discountRow = document.getElementById('discount-row');
            const discountLabelElement = document.getElementById('discount-label');
            const discountElement = document.getElementById('order-discount');
            const orderSummaryBlock = document.querySelector('.bg-white.border.border-gray-200.rounded-lg.shadow-sm.p-4.mb-4');
            
            if (!subtotalElement) return;
            
            // Verifica se todos os produtos s√£o do tipo "consulte pre√ßo"
            const onlyConsultItems = hasOnlyConsultPriceItems();
            
            // Se todos os produtos forem do tipo "consulte pre√ßo", oculta o bloco de resumo
            if (onlyConsultItems && orderSummaryBlock) {
                orderSummaryBlock.classList.add('hidden');
                debugLog('Resumo do pedido ocultado: todos os produtos s√£o do tipo "consulte pre√ßo"');
                return;
            } else if (orderSummaryBlock) {
                orderSummaryBlock.classList.remove('hidden');
            }
            
            // 1. SUBTOTAL (sempre vis√≠vel)
            subtotalElement.textContent = formatCurrency(cartTotal);
            
            // 2. FRETE (apenas se houver)
            if (deliveryFee > 0) {
                deliveryRow.classList.remove('hidden');
                deliveryFeeElement.textContent = formatCurrency(deliveryFee);
            } else {
                deliveryRow.classList.add('hidden');
            }
            
            // 3. DESCONTO (apenas se houver cupom aplicado)
            if (appliedCoupon && couponDiscount > 0) {
                discountRow.classList.remove('hidden');
                
                // Obter valor do desconto do cupom
                const discountValue = appliedCoupon.valor_desconto || appliedCoupon.valor || '';
                const discountType = appliedCoupon.tipo_desconto || appliedCoupon.tipo || '';
                const couponCode = appliedCoupon.codigo_cupom || appliedCoupon.codigo;
                
                // Formatar valor do desconto (% ou R$)
                let discountPrefix = '';
                if (discountValue.toString().includes('%')) {
                    // Se cont√©m %, mostrar como percentual
                    discountPrefix = `${discountValue} `;
                } else {
                    // Se √© valor fixo, mostrar como moeda
                    const numericValue = parseFloat(discountValue.toString().replace(/[^0-9.,]/g, '').replace(',', '.'));
                    if (!isNaN(numericValue)) {
                        discountPrefix = `${formatCurrency(numericValue)} `;
                    }
                }
                
                // Definir label baseado no tipo de desconto
                let label = 'Desconto';
                
                switch (discountType.toLowerCase()) {
                    case 'produtos':
                        label = `${discountPrefix}Desconto (${couponCode})`;
                        break;
                    case 'frete':
                        label = `${discountPrefix}Desconto Frete (${couponCode})`;
                        break;
                    case 'total':
                        label = `${discountPrefix}Desconto Total (${couponCode})`;
                        break;
                    default:
                        label = `${discountPrefix}Desconto (${couponCode})`;
                        break;
                }
                
                discountLabelElement.textContent = label;
                discountElement.textContent = '-' + formatCurrency(couponDiscount);
            } else {
                discountRow.classList.add('hidden');
            }
        }
        
        // Aplicar cupom via bot√£o
        function applyCouponFromButton() {
            const couponInput = document.getElementById('coupon-code');
            if (!couponInput) return;
            
            const code = couponInput.value.trim().toUpperCase();
            if (!code) {
                showCouponFeedback('Digite um c√≥digo de cupom', 'error');
                return;
            }
            
            applyCoupon(code);
        }
        
        // Aplicar cupom automaticamente ao digitar (REMOVIDO - agora s√≥ via bot√£o)
        function applyCouponOnType(code) {
            // Fun√ß√£o mantida para compatibilidade, mas n√£o √© mais usada
            // Agora o cupom s√≥ √© aplicado via bot√£o
        }
        
        // Aplicar cupom
        function applyCoupon(code) {
            debugLog('üîç Validando cupom:', code);
            
            // Buscar cupom nos dados
            const coupon = couponsData.find(c => 
                (c.codigo_cupom || c.codigo || '').toString().toUpperCase() === code
            );
            
            if (!coupon) {
                showCouponFeedback('Cupom n√£o encontrado', 'error');
                return false;
            }
            
            // Validar datas
            if (!validateCouponDates(coupon)) {
                return false;
            }
            
            // Calcular desconto
            const discount = calculateCouponDiscount(coupon);
            
            // Tratar erros espec√≠ficos
            if (discount === -1) {
                showCouponFeedback('Cupom n√£o aplic√°vel: carrinho vazio', 'error');
                return false;
            } else if (discount === -2) {
                const discountType = coupon.tipo_desconto || coupon.tipo || '';
                if (discountType.toLowerCase() === 'frete') {
                    showCouponFeedback('Cupom de frete: selecione delivery primeiro', 'error');
                } else {
                    showCouponFeedback('Cupom n√£o aplic√°vel: sem taxa de delivery', 'error');
                }
                return false;
            } else if (discount <= 0) {
                showCouponFeedback('Cupom n√£o aplic√°vel', 'error');
                return false;
            }
            
            // Aplicar cupom
            appliedCoupon = coupon;
            couponDiscount = discount;
            
            // Salvar cupom no localStorage
            if (typeof saveCouponToStorage === 'function') {
                saveCouponToStorage();
            }
            
            debugLog('‚úÖ Cupom aplicado:', code, 'Desconto:', formatCurrency(discount));
            
            // Atualizar interface com feedback simples
            showCouponFeedback('‚úÖ Cupom aplicado com sucesso!', 'success');
            updateCheckoutOrderTotal();
            
            return true;
        }
        
        // Inicializar timezone global a partir do config.js
        function initializeGlobalTimezone() {
            debugLog('üåç =================================');
            debugLog('üåç INICIALIZANDO TIMEZONE GLOBAL');
            debugLog('üåç =================================');
            
            debugLog('üìä TIMEZONE CONFIGURADO NO CONFIG.JS:');
            debugLog('- TIMEZONE constante:', TIMEZONE);
            debugLog('- globalTimezone atual:', globalTimezone);
            
            // Validar se o timezone do config.js √© v√°lido
            try {
                debugLog('üß™ TESTANDO VALIDADE DO TIMEZONE...');
                const testDate = new Date().toLocaleString("en-US", {timeZone: TIMEZONE});
                debugLog('- Teste bem-sucedido! Data de teste:', testDate);
                
                globalTimezone = TIMEZONE;
                debugLog('‚úÖ ‚úÖ ‚úÖ TIMEZONE V√ÅLIDO CONFIGURADO! ‚úÖ ‚úÖ ‚úÖ');
                debugLog('- globalTimezone definido como:', globalTimezone);
            } catch (e) {
                errorLog('‚ùå ‚ùå ‚ùå TIMEZONE INV√ÅLIDO NO CONFIG.JS! ‚ùå ‚ùå ‚ùå');
                errorLog('- Timezone configurado:', TIMEZONE);
                errorLog('- Erro:', e.message);
                debugLog('üìù Edite o arquivo config.js e use um timezone v√°lido:');
                debugLog('   - America/Sao_Paulo (Brasil - SP, RJ, MG)');
                debugLog('   - America/Manaus (Brasil - AM, RR)');
                debugLog('   - America/Rio_Branco (Brasil - AC)');
                debugLog('   - America/Fortaleza (Brasil - CE, MA)');
            }
            
            debugLog('üåç RESULTADO FINAL:');
            debugLog('- globalTimezone:', globalTimezone);
            debugLog('- Tipo:', typeof globalTimezone);
            debugLog('üåç =================================');
        }
        
        // Obter o timezone configurado (agora usa vari√°vel global)
        function getConfiguredTimezone() {
            return globalTimezone;
        }
        
        // Fun√ß√£o para teste manual do timezone (use no console)
        window.testTimezone = function(timezone) {
            debugLog('üß™ TESTE MANUAL DE TIMEZONE:');
            debugLog('- Timezone a testar:', timezone);
            try {
                const testDate = new Date().toLocaleString("en-US", {timeZone: timezone});
                debugLog('‚úÖ Timezone v√°lido! Data de teste:', testDate);
                return true;
            } catch (e) {
                errorLog('‚ùå Timezone inv√°lido:', e.message);
                return false;
            }
        };
        
        // Fun√ß√£o para for√ßar timezone manualmente (use no console)
        window.forceTimezone = function(timezone) {
            debugLog('üîß FOR√áANDO TIMEZONE MANUALMENTE:');
            if (window.testTimezone(timezone)) {
                globalTimezone = timezone;
                debugLog('‚úÖ globalTimezone definido como:', globalTimezone);
                return true;
            }
            return false;
        };
        
        // Fun√ß√µes utilit√°rias para trabalhar com timezone global
        function getCurrentDateInTimezone() {
            const now = new Date();
            
            // Se globalTimezone n√£o estiver definido, usar data local
            if (!globalTimezone || globalTimezone === '') {
                warnLog('Timezone n√£o configurado, usando data local');
                return now;
            }
            
            try {
                // Usar Intl.DateTimeFormat para convers√£o mais robusta
                const formatter = new Intl.DateTimeFormat('en-CA', {
                    timeZone: globalTimezone,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                const parts = formatter.formatToParts(now);
                const timezoneString = `${parts.find(p => p.type === 'year').value}-${parts.find(p => p.type === 'month').value}-${parts.find(p => p.type === 'day').value}T${parts.find(p => p.type === 'hour').value}:${parts.find(p => p.type === 'minute').value}:${parts.find(p => p.type === 'second').value}`;
                
                return new Date(timezoneString);
            } catch (e) {
                errorLog('ERRO ao aplicar timezone:', globalTimezone, '- usando data local');
                return now;
            }
        }
        
        /**
         * ===== SISTEMA DE CONTROLE DE PEDIDOS POR HOR√ÅRIO =====
         * Controla se o estabelecimento aceita pedidos baseado no hor√°rio de funcionamento
         */
        
        /**
         * Verifica se o estabelecimento aceita pedidos 24 horas
         */
        function acceptsOrdersAllTime() {
            try {
                const result = appConfig?.checkout?.orders_all_time === 'Sim';
                return result;
            } catch (e) {
                errorLog('ERRO na fun√ß√£o acceptsOrdersAllTime:', e);
                return false;
            }
        }
        
        /**
         * Verifica se o estabelecimento est√° aberto no hor√°rio atual
         */
        async function isCurrentlyOpen() {
            // Se aceita pedidos 24h, sempre est√° aberto
            const ordersAllTime = acceptsOrdersAllTime();
            
            if (ordersAllTime) {
                debugLog('‚úÖ Pedidos 24h ativados - sempre aberto');
                return true;
            }
            
            try {
                const currentTime = getCurrentDateInTimezone();
                const dayOfWeek = getDayOfWeekInPortuguese(currentTime.getDay());
                const currentHour = currentTime.getHours();
                const currentMinute = currentTime.getMinutes();
                const currentTimeInMinutes = currentHour * 60 + currentMinute;
                
                const result = await checkIfOpenAtTime(dayOfWeek, currentTimeInMinutes);
                return result;
            } catch (e) {
                errorLog('Erro ao verificar hor√°rio:', e);
                return false;
            }
        }
        
        /**
         * Verifica se est√° aberto em um hor√°rio espec√≠fico
         */
        function checkIfOpenAtTime(dayOfWeek, timeInMinutes) {
            return new Promise(async (resolve) => {
                try {
                    const response = await fetch(HOURS_CSV_URL);
                    const csvText = await response.text();
                    const lines = csvText.trim().split('\n');
                    
                    // Procurar pelo dia da semana (come√ßando da linha 1, pois linha 0 √© cabe√ßalho)
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i];
                        if (!line || line.trim() === '') continue;
                        
                        const values = line.split(',').map(v => v.trim());
                        const csvDayName = values[0];
                        
                        if (csvDayName && csvDayName.toLowerCase() === dayOfWeek.toLowerCase()) {
                            // Verificar per√≠odos do dia (come√ßando do √≠ndice 1)
                            for (let j = 1; j < values.length; j++) {
                                const periodString = values[j];
                                
                                if (periodString && periodString.trim() !== '' && periodString.includes(' - ')) {
                                    const [startTime, endTime] = periodString.split(' - ').map(t => t.trim());
                                    
                                    if (startTime && endTime) {
                                        const startMinutes = timeStringToMinutes(startTime);
                                        const endMinutes = timeStringToMinutes(endTime);
                                        
                                        if (timeInMinutes >= startMinutes && timeInMinutes <= endMinutes) {
                                            debugLog(`‚úÖ ABERTO: ${dayOfWeek} ${Math.floor(timeInMinutes/60)}:${(timeInMinutes%60).toString().padStart(2,'0')} est√° no per√≠odo ${startTime}-${endTime}`);
                                            resolve(true);
                                            return;
                                        }
                                    }
                                }
                            }
                            break;
                        }
                    }
                    
                    debugLog(`üö´ FECHADO: ${dayOfWeek} ${Math.floor(timeInMinutes/60)}:${(timeInMinutes%60).toString().padStart(2,'0')} fora do hor√°rio`);
                    resolve(false);
                } catch (e) {
                    errorLog('ERRO ao verificar hor√°rios:', e);
                    resolve(false);
                }
            });
        }
        
        /**
         * Converte string de hor√°rio para minutos
         */
        function timeStringToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        /**
         * Encontra o pr√≥ximo hor√°rio de abertura
         */
        async function getNextOpenTime() {
            try {
                const response = await fetch(HOURS_CSV_URL);
                const csvText = await response.text();
                const lines = csvText.trim().split('\n');
                const currentTime = getCurrentDateInTimezone();
                const currentDay = currentTime.getDay();
                
                // Procurar pr√≥ximo hor√°rio nos pr√≥ximos 7 dias
                for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
                    const checkDay = (currentDay + dayOffset) % 7;
                    const dayName = getDayOfWeekInPortuguese(checkDay);
                    
                    for (let i = 2; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        const csvDayName = values[0]?.trim();
                        
                        if (csvDayName.toLowerCase() === dayName.toLowerCase()) {
                            // Pegar primeiro hor√°rio do dia
                            const firstStartTime = values[1]?.trim();
                            if (firstStartTime && firstStartTime !== '') {
                                const dayLabel = dayOffset === 0 ? 'Hoje' : 
                                               dayOffset === 1 ? 'Amanh√£' : dayName;
                                return `${dayLabel} √†s ${firstStartTime}`;
                            }
                            break;
                        }
                    }
                }
                
                return 'Consulte nossos hor√°rios';
            } catch (e) {
                errorLog('Erro ao calcular pr√≥ximo hor√°rio:', e);
                return 'Consulte nossos hor√°rios';
            }
        }
        
        function formatDateInTimezone(date, options = {}) {
            try {
                let formattedDate = date.toLocaleString('pt-BR', {
                    timeZone: globalTimezone,
                    ...options
                });
                
                // Se a op√ß√£o weekday ou month est√° presente, aplicar capitaliza√ß√£o
                if (options.weekday || options.month) {
                    // Capitalizar o dia da semana e o m√™s
                    formattedDate = formattedDate.replace(/\b([a-z√†-√ø]+)(-[a-z√†-√ø]+)?\b/gi, function(match) {
                        // Tratar palavras compostas com h√≠fen (ex: segunda-feira)
                        if (match.includes('-')) {
                            const parts = match.split('-');
                            return parts.map(part => 
                                part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
                            ).join('-');
                        }
                        
                        // Palavras simples
                        return match.charAt(0).toUpperCase() + match.slice(1).toLowerCase();
                    });
                }
                
                return formattedDate;
            } catch (e) {
                errorLog('‚ùå Erro ao formatar data com timezone:', globalTimezone, '- usando formato local');
                return date.toLocaleString('pt-BR', options);
            }
        }
        
        function getTimezoneInfo() {
            return {
                timezone: globalTimezone,
                isConfigured: true,
                currentTime: getCurrentDateInTimezone(),
                formatted: formatDateInTimezone(new Date())
            };
        }
        
        // Validar datas do cupom com timezone correto
        function validateCouponDates(coupon) {
            // Obter a data atual usando timezone global
            const timezone = getConfiguredTimezone();
            const timezoneDate = getCurrentDateInTimezone();
            
            debugLog('üîç Validando cupom:', coupon.codigo_cupom || coupon.codigo);
            debugLog('üìÖ Data atual (' + timezone + '):', formatDateInTimezone(timezoneDate));
            debugLog('üìÖ Per√≠odo do cupom:', coupon.data_inicio, 'at√©', coupon.data_fim);
            
            // Validar data de in√≠cio
            if (coupon.data_inicio && coupon.data_inicio !== '-' && coupon.data_inicio.trim()) {
                const startDate = parseCouponDate(coupon.data_inicio, timezone);
                debugLog('üìÖ Data de in√≠cio do cupom:', startDate ? startDate.toLocaleString() : 'inv√°lida');
                
                if (startDate && timezoneDate < startDate) {
                    debugLog('‚ùå Cupom ainda n√£o v√°lido. Ser√° v√°lido a partir de:', startDate.toLocaleString());
                    showCouponFeedback('Cupom ainda n√£o v√°lido. V√°lido a partir de ' + startDate.toLocaleDateString('pt-BR'), 'error');
                    return false;
                }
            }
            
            // Validar data de fim
            if (coupon.data_fim && coupon.data_fim !== '-' && coupon.data_fim.trim()) {
                const endDate = parseCouponDate(coupon.data_fim, timezone);
                debugLog('üìÖ Data de fim do cupom:', endDate ? endDate.toLocaleString() : 'inv√°lida');
                
                if (endDate && timezoneDate > endDate) {
                    debugLog('‚ùå Cupom expirado. Expirou em:', endDate.toLocaleString());
                    showCouponFeedback('Cupom expirado em ' + endDate.toLocaleDateString('pt-BR'), 'error');
                    return false;
                }
            }
            
            debugLog('‚úÖ Cupom v√°lido dentro do per√≠odo de validade');
            return true;
        }
        
        // Parsear data do cupom considerando o timezone
        function parseCouponDate(dateStr, timezone) {
            if (!dateStr || dateStr === '-' || dateStr.trim() === '') {
                return null;
            }
            
            try {
                // Limpar a string da data
                const cleanDateStr = dateStr.toString().trim();
                
                // Formato DD/MM/YYYY ou DD/MM/YYYY HH:MM
                const parts = cleanDateStr.split(' ');
                const datePart = parts[0];
                const timePart = parts[1] || '23:59'; // Se n√£o houver hor√°rio, assume fim do dia
                
                const dateParts = datePart.split('/');
                if (dateParts.length !== 3) {
                    errorLog('‚ùå Formato de data inv√°lido - deve ser DD/MM/YYYY:', dateStr);
                    return null;
                }
                
                const [day, month, year] = dateParts;
                const [hour, minute] = timePart.split(':');
                
                // Validar se os valores s√£o v√°lidos
                const dayNum = parseInt(day, 10);
                const monthNum = parseInt(month, 10);
                const yearNum = parseInt(year, 10);
                const hourNum = parseInt(hour, 10);
                const minuteNum = parseInt(minute, 10);
                
                if (isNaN(dayNum) || isNaN(monthNum) || isNaN(yearNum) || 
                    dayNum < 1 || dayNum > 31 || 
                    monthNum < 1 || monthNum > 12 || 
                    yearNum < 2000) {
                    errorLog('‚ùå Valores de data inv√°lidos:', { day: dayNum, month: monthNum, year: yearNum });
                    return null;
                }
                
                // Criar objeto Date usando o construtor padr√£o (ano, m√™s-1, dia, hora, minuto)
                // Nota: m√™s no JavaScript √© 0-indexado (0 = Janeiro, 11 = Dezembro)
                const date = new Date(yearNum, monthNum - 1, dayNum, hourNum || 23, minuteNum || 59);
                
                debugLog(`üîÑ Convertendo data: ${dateStr} ‚Üí ${date.toLocaleString('pt-BR')} (${timezone || 'local'})`);
                return date;
            } catch (e) {
                errorLog('‚ùå Erro ao parsear data do cupom:', dateStr, e);
                return null;
            }
        }
        
        // Calcular desconto do cupom
        function calculateCouponDiscount(coupon) {
            const cartTotal = calculateCartTotal();
            const deliveryFee = currentDeliveryFee || 0;
            const discountValue = coupon.valor_desconto || coupon.valor || '';
            const discountType = coupon.tipo_desconto || coupon.tipo || '';
            
            debugLog('üí∞ Calculando desconto do cupom:');
            debugLog('- Tipo:', discountType);
            debugLog('- Valor:', discountValue);
            debugLog('- Cart Total:', cartTotal);
            debugLog('- Delivery Fee:', deliveryFee);
            
            let baseValue = 0;
            
            // Determinar valor base para c√°lculo
            switch (discountType.toLowerCase()) {
                case 'produtos':
                    baseValue = cartTotal;
                    if (baseValue <= 0) {
                        debugLog('‚ùå Cupom de produtos: carrinho vazio');
                        return -1; // Indicador de erro espec√≠fico
                    }
                    break;
                case 'frete':
                    baseValue = deliveryFee;
                    if (baseValue <= 0) {
                        debugLog('‚ùå Cupom de frete: sem taxa de delivery definida');
                        return -2; // Indicador de erro espec√≠fico
                    }
                    break;
                case 'total':
                    baseValue = cartTotal + deliveryFee;
                    if (baseValue <= 0) {
                        debugLog('‚ùå Cupom de total: valores zerados');
                        return -1; // Indicador de erro espec√≠fico
                    }
                    break;
                default:
                    debugLog('‚ùå Tipo de desconto inv√°lido:', discountType);
                    return 0;
            }
            
            debugLog('- Base Value:', baseValue);
            
            // Calcular desconto
            let discount = 0;
            
            if (discountValue.toString().includes('%')) {
                // Desconto percentual
                const percentage = parseFloat(discountValue.replace('%', ''));
                discount = (baseValue * percentage) / 100;
                debugLog('- Desconto percentual:', percentage + '%', '=', discount);
            } else {
                // Desconto fixo
                discount = parseFloat(discountValue.toString().replace(',', '.')) || 0;
                debugLog('- Desconto fixo:', discount);
            }
            
            // Limitar desconto ao valor base
            const finalDiscount = Math.min(discount, baseValue);
            debugLog('- Desconto final:', finalDiscount);
            
            return finalDiscount;
        }
        
        // Mostrar feedback do cupom
        function showCouponFeedback(message, type) {
            const feedback = document.getElementById('coupon-feedback');
            if (!feedback) return;
            
            feedback.className = `mt-2 text-xs ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
            feedback.textContent = message;
            feedback.classList.remove('hidden');
            
            // Adicionar anima√ß√£o para chamar aten√ß√£o
            if (type === 'error') {
                feedback.classList.add('shake-animation');
                setTimeout(() => {
                    feedback.classList.remove('shake-animation');
                }, 500);
            }
            
            // Para erros de data, mostrar tamb√©m um toast
            if (message.includes('expirado') || message.includes('n√£o v√°lido')) {
                showToast(message, 'error');
            }
            
            // Ocultar ap√≥s 4 segundos se for erro
            if (type === 'error') {
                setTimeout(() => {
                    feedback.classList.add('hidden');
                }, 4000);
            }
        }
        

        
        // Controlar expans√£o do campo de cupom
        function toggleCouponField() {
            const container = document.getElementById('coupon-field-container');
            const arrow = document.getElementById('coupon-arrow');
            const toggleBtn = document.getElementById('coupon-toggle-btn');
            
            if (!container || !arrow) return;
            
            const isExpanded = container.style.maxHeight !== '0px' && container.style.maxHeight !== '';
            
            if (isExpanded) {
                // Contrair
                container.style.maxHeight = '0';
                container.style.opacity = '0';
                arrow.style.transform = 'rotate(0deg)';
                debugLog('üéüÔ∏è Campo de cupom contra√≠do');
            } else {
                // Expandir
                container.style.maxHeight = '200px';
                container.style.opacity = '1';
                arrow.style.transform = 'rotate(180deg)';
                
                // Focar no campo ap√≥s expans√£o
                setTimeout(() => {
                    const couponInput = document.getElementById('coupon-code');
                    if (couponInput) {
                        couponInput.focus();
                    }
                }, 300);
                
                debugLog('üéüÔ∏è Campo de cupom expandido');
            }
        }
        

        
        // Controlar visibilidade do bot√£o de limpar inline
        function toggleClearButton() {
            const couponInput = document.getElementById('coupon-code');
            const clearBtn = document.getElementById('clear-coupon-btn');
            
            if (!couponInput || !clearBtn) return;
            
            if (couponInput.value.trim().length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
        }
        
        // Limpar input e resetar cupom completamente
        function clearCouponInput() {
            const couponInput = document.getElementById('coupon-code');
            const clearBtn = document.getElementById('clear-coupon-btn');
            
            // Limpar o input
            if (couponInput) {
                couponInput.value = '';
                couponInput.focus();
            }
            
            // Esconder bot√£o de limpar
            if (clearBtn) {
                clearBtn.classList.add('hidden');
            }
            
            // Resetar cupom aplicado (usar fun√ß√£o existente)
            clearCoupon();
            
            // Atualizar resumo do pedido
            updateOrderSummary();
            
            debugLog('üéüÔ∏è Input limpo e cupom resetado completamente');
        }
        
        // Limpar cupom
        function clearCoupon() {
            appliedCoupon = null;
            couponDiscount = 0;
            
            // Limpar cupom do localStorage
            if (typeof clearCouponFromStorage === 'function') {
                clearCouponFromStorage();
            }
            
            // Limpar interface
            const feedback = document.getElementById('coupon-feedback');
            if (feedback) feedback.classList.add('hidden');
            
            // Contrair campo de cupom
            const container = document.getElementById('coupon-field-container');
            const arrow = document.getElementById('coupon-arrow');
            if (container && arrow) {
                container.style.maxHeight = '0';
                container.style.opacity = '0';
                arrow.style.transform = 'rotate(0deg)';
            }
            
            // Limpar campo de input
            const couponInput = document.getElementById('coupon-code');
            if (couponInput) {
                couponInput.value = '';
            }
            
            // Atualizar total e resumo
            updateCheckoutOrderTotal();
        }
        
        // Resetar sistema de cupons
        function resetCouponSystem() {
            debugLog('üîÑ Resetando sistema de cupons');
            
            // Limpar vari√°veis
            appliedCoupon = null;
            couponDiscount = 0;
            
            // Limpar timeout
            if (couponTimeout) {
                clearTimeout(couponTimeout);
                couponTimeout = null;
            }
            
            // Limpar campo de entrada
            const couponInput = document.getElementById('coupon-code');
            if (couponInput) couponInput.value = '';
            
            // Limpar interface
            clearCoupon();
        }
        
        // Adicionar informa√ß√µes do cupom √† mensagem do WhatsApp
        function addCouponInfoToWhatsAppMessage(message) {
            if (!appliedCoupon || couponDiscount <= 0) {
                return message;
            }
            
            const discountType = appliedCoupon.tipo_desconto || appliedCoupon.tipo || '';
            let typeText = '';
            
            switch (discountType.toLowerCase()) {
                case 'produtos':
                    typeText = 'nos produtos';
                    break;
                case 'frete':
                    typeText = 'no frete';
                    break;
                case 'total':
                    typeText = 'no total';
                    break;
            }
            
            const couponInfo = `\n\nüéüÔ∏è *Cupom Aplicado:*\n   ${appliedCoupon.codigo_cupom || appliedCoupon.codigo}\n   Desconto: ${formatCurrency(couponDiscount)} (${typeText})`;
            
            // Inserir antes do total final
            const totalIndex = message.lastIndexOf('üí∞ *Total:');
            if (totalIndex !== -1) {
                return message.slice(0, totalIndex) + couponInfo + '\n\n' + message.slice(totalIndex);
            }
            
            return message + couponInfo;
        }
        
        // Handle payment method change
        function handlePaymentMethodChange() {
            const paymentMethod = document.getElementById('payment-method').value;
            const changeToggleContainer = document.getElementById('change-toggle-container');
            const changeDiv = document.getElementById('money-change');
            const changeToggle = document.getElementById('change-toggle');
            const pixDiv = document.getElementById('pix-info');
            
            // SEMPRE resetar o campo de troco ao mudar forma de pagamento
            resetChangeAmountField();
            
            // Reset do estado do switcher
            if (changeToggle) {
                changeToggle.checked = false;
                // N√£o chamar handleChangeToggle() aqui pois j√° resetamos o campo acima
                const toggleLabel = document.getElementById('change-toggle-label');
                if (toggleLabel) {
                    toggleLabel.textContent = 'N√£o';
                    toggleLabel.style.color = 'var(--cor-texto-secundario)';
                }
            }
            
            if (paymentMethod === 'dinheiro') {
                // DINHEIRO: Mostrar switcher de troco
                changeToggleContainer.classList.remove('hidden');
                if (pixDiv) pixDiv.classList.add('hidden');
                debugLog('üíµ Dinheiro selecionado - switcher de troco dispon√≠vel (campo resetado)');
            } else if (paymentMethod === 'pix') {
                // PIX: Ocultar switcher e mostrar info do PIX
                changeToggleContainer.classList.add('hidden');
                changeDiv.classList.add('hidden');
                showPixInfo();
                debugLog('üì± PIX selecionado - mostrando informa√ß√µes da chave (campo de troco resetado)');
            } else {
                // OUTROS: Ocultar tudo relacionado a troco e PIX
                changeToggleContainer.classList.add('hidden');
                changeDiv.classList.add('hidden');
                if (pixDiv) pixDiv.classList.add('hidden');
                debugLog('üí≥ Outra forma de pagamento selecionada - ocultando troco e PIX (campo resetado)');
            }
        }
        
        /**
         * Limpa completamente o campo de troco
         */
        function resetChangeAmountField() {
            const changeInput = document.getElementById('change-amount');
            if (changeInput) {
                // Limpar o valor do campo
                changeInput.value = '';
                changeInput.placeholder = 'Ex: R$ 50,00';
                
                // Limpar erros de valida√ß√£o
                clearFieldError('change-amount');
                
                // Remover o feedback de c√°lculo do troco ("Troco: R$ X,XX")
                const existingFeedback = changeInput.parentNode.querySelector('.change-feedback');
                if (existingFeedback) {
                    existingFeedback.remove();
                    debugLog('üßπ Label de c√°lculo do troco removido');
                }
                
                debugLog('üßπ Campo de troco resetado completamente (input + label)');
            }
        }
        
        /**
         * Manipula o toggle do switcher de troco
         */
        function handleChangeToggle() {
            const toggle = document.getElementById('change-toggle');
            const changeDiv = document.getElementById('money-change');
            const toggleLabel = document.getElementById('change-toggle-label');
            
            // SEMPRE resetar o campo de troco ao mexer no switcher
            resetChangeAmountField();
            
            if (toggle.checked) {
                // Switcher LIGADO - mostrar campo de troco
                changeDiv.classList.remove('hidden');
                toggleLabel.textContent = 'Sim';
                toggleLabel.style.color = 'var(--cor-primaria)';
                setupChangeAmountField();
                debugLog('üí∞ Switcher de troco ATIVADO - campo de valor exibido e resetado');
            } else {
                // Switcher DESLIGADO - ocultar campo de troco
                changeDiv.classList.add('hidden');
                toggleLabel.textContent = 'N√£o';
                toggleLabel.style.color = 'var(--cor-texto-secundario)';
                debugLog('üí∞ Switcher de troco DESATIVADO - campo de valor oculto e resetado');
            }
        }
        
        /**
         * Configura o campo de troco com valida√ß√£o
         */
        function setupChangeAmountField() {
            debugLog('=== SETUP CHANGE AMOUNT FIELD ===');
            const changeInput = document.getElementById('change-amount');
            const total = calculateCartTotal();
            
            debugLog('Change input element:', changeInput);
            debugLog('Cart total:', total);
            debugLog('Cart contents:', cart);
            
            // Definir placeholder simples
            changeInput.placeholder = 'Ex: ' + formatCurrency(Math.ceil(total / 10) * 10 + 10);
            
            // Adicionar valida√ß√£o em tempo real com m√°scara da moeda atual
            changeInput.oninput = function() {
                formatMoney(this); // Aplicar m√°scara da moeda atual
                validateChangeAmount(this.value, total);
                clearFieldError('change-amount');
            };
            
            // Remover o oninput antigo do HTML que usava formatMoney gen√©rico
            changeInput.removeAttribute('oninput');
            
            // Focar no campo
            setTimeout(() => changeInput.focus(), 100);
        }
        
        /**
         * Valida o valor do troco em tempo real
         */
        function validateChangeAmount(changeValue, total) {
            const changeInput = document.getElementById('change-amount');
            const numericValue = parseFloat(changeValue.replace(/[^\d,]/g, '').replace(',', '.'));
            
            // Remover feedback anterior
            const existingFeedback = changeInput.parentNode.querySelector('.change-feedback');
            if (existingFeedback) existingFeedback.remove();
            
            if (!isNaN(numericValue) && numericValue > total) {
                const changeAmount = numericValue - total;
                
                // Criar feedback positivo
                const feedback = document.createElement('div');
                feedback.className = 'change-feedback text-sm mt-1 flex items-center space-x-2';
                feedback.style.color = 'var(--cor-sucesso)';
                feedback.innerHTML = `
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Troco: ${formatCurrency(changeAmount)}</span>
                `;
                
                changeInput.parentNode.appendChild(feedback);
            } else if (!isNaN(numericValue) && numericValue <= total) {
                // Criar feedback de erro
                const feedback = document.createElement('div');
                feedback.className = 'change-feedback text-sm mt-1 flex items-center space-x-2';
                feedback.style.color = 'var(--cor-erro)';
                feedback.innerHTML = `
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Valor deve ser maior que ${formatCurrency(total)}</span>
                `;
                
                changeInput.parentNode.appendChild(feedback);
            }
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData(); // This will load CSV data and then call initializeApp()
        });
        
        // Setup event listeners (called after data is loaded)
        function setupEventListeners() {
            setupSearch();
            setupScrollSpy();
            handleInitialHash();
            setupDeselectableRadios();
            setupKeyboardShortcuts();
            setupResizeHandler();
            setupFormStorageListeners();
        }
        
        // Setup resize handler melhorado - sem interferir no scroll do usu√°rio
        function setupResizeHandler() {
            let resizeTimeout;
            // ‚ùå REMOVIDO: Event listener de scroll que conflitava com scroll spy
            // O scroll spy j√° gerencia a detec√ß√£o de scroll adequadamente
            
            // Event listener de resize - SIMPLIFICADO para n√£o interferir com scroll spy
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    // Apenas atualizar setas de navega√ß√£o das categorias se necess√°rio
                    if (typeof updateNavigationArrows === 'function') {
                        updateNavigationArrows();
                    }
                    debugLog('üì± Resize handler executado - setas atualizadas');
                }, 300);
            });
        }
        
        // Setup listeners para salvar dados do formul√°rio no localStorage
        function setupFormStorageListeners() {
            // Listener para campos de texto
            document.addEventListener('input', function(e) {
                if (e.target.matches('#customer-name, #customer-whatsapp, #payment-method, #change-amount, #order-notes')) {
                    // Debounce para evitar muitas escritas
                    clearTimeout(window.formSaveTimeout);
                    window.formSaveTimeout = setTimeout(() => {
                        updateOrderDataFromForm();
                        if (typeof saveOrderDataToStorage === 'function') {
                            saveOrderDataToStorage();
                        }
                    }, 1000);
                }
            });
            
            // Listener para radio buttons
            document.addEventListener('change', function(e) {
                if (e.target.matches('input[name="delivery-type"]')) {
                    updateOrderDataFromForm();
                    if (typeof saveOrderDataToStorage === 'function') {
                        saveOrderDataToStorage();
                    }
                }
            });
            
            debugLog('üëÇ Listeners de formul√°rio para localStorage configurados');
        }
        
        // Atualizar dados do pedido a partir do formul√°rio
        function updateOrderDataFromForm() {
            try {
                const customerName = document.getElementById('customer-name')?.value || '';
                const whatsapp = document.getElementById('customer-whatsapp')?.value || '';
                const paymentMethod = document.getElementById('payment-method')?.value || '';
                const changeAmount = document.getElementById('change-amount')?.value || '';
                const notes = document.getElementById('order-notes')?.value || '';
                const deliveryType = document.querySelector('input[name="delivery-type"]:checked')?.value || '';
                
                orderData.customerName = customerName;
                orderData.whatsapp = whatsapp;
                orderData.paymentMethod = paymentMethod;
                orderData.changeAmount = changeAmount;
                orderData.notes = notes;
                orderData.deliveryType = deliveryType;
            } catch (e) {
                errorLog('Erro ao atualizar orderData:', e);
            }
        }
        
        // Configura atalhos de teclado
        function setupKeyboardShortcuts() {
            debugLog('üéπ Configurando atalhos de teclado...');
            
            document.addEventListener('keydown', function(e) {
                // Fechar lightbox ou modal com Escape
                if (e.key === 'Escape') {
                    const lightbox = document.getElementById('image-lightbox');
                    const helpModal = document.getElementById('help-modal');
                    
                    if (!lightbox.classList.contains('hidden')) {
                        closeLightbox();
                    } else if (!helpModal.classList.contains('hidden')) {
                        closeHelpModal();
                    }
                    return;
                }
                
                // Atalho F1 para abrir ajuda
                if (e.key === 'F1') {
                    e.preventDefault(); // Evita abrir o menu de ajuda padr√£o do navegador
                    const helpModal = document.getElementById('help-modal');
                    if (helpModal.classList.contains('hidden')) {
                        openHelpModal();
                    } else {
                        closeHelpModal();
                    }
                }
            });
            
            debugLog('‚úÖ Atalhos configurados: F1 (Ajuda), Escape (Fechar)');
        }
        
        /**
         * Abre o Gerador de Varia√ß√µes (Shift + V)
         */
        function openVariationGenerator() {
            debugLog('üîß Abrindo Gerador de Varia√ß√µes...');
            
            // Mostrar toast informativo
            showToast('üîß Abrindo Gerador de Varia√ß√µes', 'info', 2000);
            
            // Abrir em nova aba ap√≥s pequeno delay para mostrar o toast
            setTimeout(() => {
                window.open('https://dantetesta.com.br/gerador-de-variacoes/', '_blank');
                debugLog('‚úÖ Gerador de Varia√ß√µes aberto em nova aba');
            }, 500);
        }
        
        /**
         * Abre o Gerador de QR Code (Shift + Q)
         */
        function openQRCodeGenerator() {
            debugLog('üì± Abrindo Gerador de QR Code...');
            
            // Mostrar toast informativo
            showToast('üì± Abrindo Gerador de QR Code', 'info', 2000);
            
            // Abrir em nova aba ap√≥s pequeno delay para mostrar o toast
            setTimeout(() => {
                window.open('https://dantetesta.com.br/qrcode-generator/', '_blank');
                debugLog('‚úÖ Gerador de QR Code aberto em nova aba');
            }, 500);
        }
        
        /**
         * Abre o Gerador de Cores (Shift + C)
         */
        function openColorGenerator() {
            debugLog('üé® Abrindo Gerador de Cores...');
            
            // Mostrar toast informativo
            showToast('üé® Abrindo Gerador de Cores', 'info', 2000);
            
            // Abrir em nova aba ap√≥s pequeno delay para mostrar o toast
            setTimeout(() => {
                window.open('https://dantetesta.com.br/color-generator/', '_blank');
                debugLog('‚úÖ Gerador de Cores aberto em nova aba');
            }, 500);
        }
        
        /**
         * Abre o Modal de Ajuda com Atalhos (F1)
         */
        function openHelpModal() {
            debugLog('üí° Abrindo Modal de Ajuda...');
            
            const modal = document.getElementById('help-modal');
            if (modal) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                debugLog('‚úÖ Modal de Ajuda aberto');
            } else {
                errorLog('‚ùå Modal de ajuda n√£o encontrado');
            }
        }
        
        /**
         * Fecha o Modal de Ajuda
         */
        function closeHelpModal() {
            debugLog('‚ùå Fechando Modal de Ajuda...');
            
            const modal = document.getElementById('help-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
                debugLog('‚úÖ Modal de Ajuda fechado');
            }
        }

        // ====================================================================
        // SISTEMA DE TAXA DE DELIVERY POR BAIRRO - V3.3.4
        // ====================================================================

        /**
         * Busca a taxa de delivery para um bairro espec√≠fico
         * @param {string} neighborhood - Nome do bairro
         * @returns {number|null} - Valor da taxa ou null se n√£o encontrado
         */
        function findDeliveryFeeByNeighborhood(neighborhood) {
            // Usar dados globais se dispon√≠veis
            const dataSource = window.neighborhoodsData || neighborhoodsData;
            
            if (!neighborhood || !dataSource.length) {
                return null;
            }
            
            const normalizedNeighborhood = neighborhood.trim().toLowerCase();
            
            // üîí BUSCA EXATA APENAS - N√ÉO MAIS BUSCA PARCIAL
            let found = dataSource.find(item => {
                const itemBairro = (item.bairro || '').toLowerCase().trim();
                return itemBairro === normalizedNeighborhood;
            });
            
            if (found) {
                debugLog(`üí∞ Taxa encontrada para "${neighborhood}": R$ ${found.taxa}`);
                return found.taxa;
            }
            
            debugLog(`‚ùå Taxa n√£o encontrada para o bairro: "${neighborhood}"`);
            return null;
        }

        /**
         * Exibe a taxa de delivery na interface ou alerta para consultar
         * @param {number|null} fee - Valor da taxa ou null se n√£o encontrado
         * @param {string} neighborhood - Nome do bairro
         */
        function displayDeliveryFee(fee, neighborhood) {
            // Remove alertas anteriores se existirem
            const existingAlert = document.getElementById('delivery-fee-alert');
            const existingNotServedAlert = document.getElementById('neighborhood-not-served-alert');
            if (existingAlert) existingAlert.remove();
            if (existingNotServedAlert) existingNotServedAlert.remove();
            
            // Controlar visibilidade do alerta original
            const originalAlert = document.getElementById('original-delivery-fee-alert');
            
            // üîí Validar bairro para modo de restri√ß√£o
            const config = getCheckoutConfig();
            const isNeighborhoodValid = validateNeighborhoodForDelivery(neighborhood);
            
            let alertHtml = '';
            
            if (fee && fee > 0 && isNeighborhoodValid) {
                // Sincronizar estado com a taxa encontrada
                try {
                    if (!window.orderData) window.orderData = {};
                    if (!window.orderData.address) window.orderData.address = {};
                    window.orderData.address.neighborhood = neighborhood;
                    window.orderData.address.deliveryFee = fee;
                    window.currentDeliveryFee = fee;
                    // Memorizar √∫ltima consulta
                    window.lastNeighborhoodFee = fee;
                    window.lastNeighborhoodName = neighborhood;
                    debugLog('üîÑ Estado sincronizado em displayDeliveryFee:', {
                        neighborhood,
                        deliveryFee: fee
                    });
                    // Recalcular total/resumo imediatamente
                    if (typeof updateCheckoutOrderTotal === 'function') {
                        updateCheckoutOrderTotal();
                    }
                } catch (e) {
                    errorLog('Erro ao sincronizar taxa em displayDeliveryFee:', e);
                }
                // Taxa encontrada e bairro v√°lido - ocultar alerta original
                if (originalAlert) {
                    originalAlert.style.display = 'none';
                }
                // Taxa encontrada - mostrar valor calculado
                alertHtml = `
                    <div id="delivery-fee-alert" class="mt-4 p-4 rounded-lg border-l-4" style="background-color: #f0f9ff; border-color: var(--cor-primaria);">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="w-5 h-5 mt-0.5" style="color: var(--cor-primaria);" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-3 flex-1">
                                <h3 class="text-sm font-medium" style="color: var(--cor-primaria);">
                                    üöö Taxa de Delivery Calculada
                                </h3>
                                <div class="mt-2 text-sm" style="color: var(--cor-texto);">
                                    <p><strong>Bairro:</strong> ${neighborhood}</p>
                                    <p><strong>Taxa:</strong> <span class="font-bold" style="color: var(--cor-primaria);">${formatCurrency(fee)}</span></p>
                                    <p class="mt-1 text-xs" style="color: var(--cor-texto-secundario);">
                                        Esta taxa ser√° adicionada ao valor total do seu pedido.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Habilitar bot√£o continuar
                updateContinueButtonState(true, neighborhood);
                
            } else if (!isNeighborhoodValid && config.only_bairro_mode === 'Sim') {
                // Bairro n√£o atendido no modo de restri√ß√£o
                if (originalAlert) {
                    originalAlert.style.display = 'none';
                }
                
                // Mostrar mensagem de bairro n√£o atendido
                showNeighborhoodNotServedMessage(neighborhood);
                
                // Desabilitar bot√£o continuar
                updateContinueButtonState(false, neighborhood);
                
            } else {
                // Taxa n√£o encontrada mas bairro v√°lido (ou modo desativado) - mostrar alerta original
                if (originalAlert) {
                    originalAlert.style.display = 'block';
                }
                
                // Atualizar estado do bot√£o continuar
                updateContinueButtonState(isNeighborhoodValid, neighborhood);
            }
            
            // Inserir ap√≥s os campos de endere√ßo
            const addressFields = document.getElementById('manual-address-container');
            if (addressFields && alertHtml) {
                addressFields.insertAdjacentHTML('afterend', alertHtml);
            }
        }

        /**
         * Valida se o bairro est√° na lista de atendimento quando only_bairro_mode est√° ativo
         * @param {string} neighborhood - Nome do bairro a ser validado
         * @returns {boolean} - true se bairro √© v√°lido ou modo n√£o est√° ativo
         */
        function validateNeighborhoodForDelivery(neighborhood) {
            const config = getCheckoutConfig();
            
            // Se modo de restri√ß√£o n√£o est√° ativo, sempre permitir
            if (config.only_bairro_mode !== 'Sim') {
                debugLog('üîì Modo de restri√ß√£o por bairro DESATIVADO - permitindo qualquer bairro');
                return true;
            }
            
            debugLog('üîí Modo de restri√ß√£o por bairro ATIVADO - validando:', neighborhood);
            
            // Verificar se dados de bairros est√£o dispon√≠veis
            if (!window.neighborhoodsData || window.neighborhoodsData.length === 0) {
                debugLog('‚ùå Dados de bairros n√£o dispon√≠veis para valida√ß√£o');
                return false;
            }
            
            // Normalizar bairro para busca EXATA
            const normalizedNeighborhood = neighborhood.toLowerCase().trim();
            
            // üîí BUSCA EXATA APENAS - igual √† fun√ß√£o de busca de taxa
            const found = window.neighborhoodsData.find(item => {
                const itemBairro = (item.bairro || '').toLowerCase().trim();
                return itemBairro === normalizedNeighborhood;
            });
            
            const isValid = !!found;
            debugLog(isValid ? '‚úÖ Bairro V√ÅLIDO para entrega' : '‚ùå Bairro N√ÉO ATENDIDO', { bairro: neighborhood, encontrado: found });
            
            return isValid;
        }

        /**
         * Controla o estado do bot√£o continuar baseado na valida√ß√£o do bairro
         * @param {boolean} isValid - Se o bairro √© v√°lido
         * @param {string} neighborhood - Nome do bairro
         */
        function updateContinueButtonState(isValid, neighborhood = '') {
            const config = getCheckoutConfig();
            const continueButton = document.querySelector('button[onclick="nextStep(3)"]');
            
            if (!continueButton) {
                debugLog('‚ùå Bot√£o continuar n√£o encontrado');
                return;
            }
            
            // Se modo de restri√ß√£o n√£o est√° ativo, sempre habilitar
            if (config.only_bairro_mode !== 'Sim') {
                continueButton.disabled = false;
                continueButton.classList.remove('opacity-50', 'cursor-not-allowed');
                continueButton.classList.add('hover:opacity-90');
                return;
            }
            
            // Controlar estado do bot√£o baseado na valida√ß√£o
            if (isValid) {
                // Habilitar bot√£o
                continueButton.disabled = false;
                continueButton.classList.remove('opacity-50', 'cursor-not-allowed');
                continueButton.classList.add('hover:opacity-90');
                debugLog('‚úÖ Bot√£o continuar HABILITADO');
            } else {
                // Desabilitar bot√£o
                continueButton.disabled = true;
                continueButton.classList.add('opacity-50', 'cursor-not-allowed');
                continueButton.classList.remove('hover:opacity-90');
                debugLog('‚ùå Bot√£o continuar DESABILITADO');
            }
        }

        /**
         * Exibe mensagem de erro quando bairro n√£o √© atendido
         * @param {string} neighborhood - Nome do bairro
         */
        function showNeighborhoodNotServedMessage(neighborhood) {
            const contactConfig = getContactConfig();
            
            // Remove mensagem anterior se existir
            const existingMessage = document.getElementById('neighborhood-not-served-alert');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Criar mensagem de erro
            const whatsappNumber = contactConfig.whatsapp || '5519998021956';
            const formattedWhatsapp = formatPhoneForDisplay(whatsappNumber);
            
            const alertHtml = `
                <div id="neighborhood-not-served-alert" class="mt-4 p-4 rounded-lg border-l-4" style="background-color: #fef2f2; border-color: #ef4444;">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="w-5 h-5 mt-0.5" style="color: #ef4444;" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <h3 class="text-sm font-medium" style="color: #ef4444;">
                                ‚ö†Ô∏è Bairro n√£o atendido
                            </h3>
                            <div class="mt-2 text-sm" style="color: #7f1d1d;">
                                <p><strong>Bairro informado:</strong> ${neighborhood}</p>
                                <p class="mt-2">Infelizmente n√£o atendemos o seu bairro.</p>
                                <p class="mt-1">Entre em contato via WhatsApp para mais informa√ß√µes:</p>
                                <a href="https://wa.me/${whatsappNumber}" target="_blank" 
                                   class="inline-flex items-center mt-2 px-3 py-2 text-sm font-medium text-white rounded-md transition-colors"
                                   style="background-color: #25D366; hover:background-color: #128C7E;">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                                    </svg>
                                    üì± ${formattedWhatsapp}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Inserir ap√≥s os campos de endere√ßo
            const addressFields = document.getElementById('address-fields');
            if (addressFields) {
                addressFields.insertAdjacentHTML('afterend', alertHtml);
            }
        }

        /**
         * Remove a exibi√ß√£o da taxa de delivery
         */
        function clearDeliveryFee() {
            currentDeliveryFee = null;
            if (window.orderData && window.orderData.address) {
                delete window.orderData.address.deliveryFee;
            }
            const existingAlert = document.getElementById('delivery-fee-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // N√ÉO mostrar alerta original automaticamente
            // Ele s√≥ deve aparecer quando bairro n√£o for encontrado
            const originalAlert = document.getElementById('original-delivery-fee-alert');
            if (originalAlert) {
                originalAlert.style.display = 'none';
            }
            
            // Recalcular total do checkout/resumo ap√≥s limpar a taxa
            if (typeof updateCheckoutOrderTotal === 'function') {
                updateCheckoutOrderTotal();
            }
        }

        /**
         * Processa a taxa de delivery ap√≥s valida√ß√£o do CEP
         * @param {object} addressData - Dados do endere√ßo
         */
        function processDeliveryFeeAfterCEP(addressData) {
            if (!addressData || !addressData.neighborhood) {
                clearDeliveryFee();
                return;
            }
            
            // Buscar taxa para o bairro
            const fee = findDeliveryFeeByNeighborhood(addressData.neighborhood);
            
            if (fee !== null && fee > 0) {
                currentDeliveryFee = fee;
                
                // Salvar taxa de delivery no localStorage
                if (typeof saveDeliveryFeeToStorage === 'function') {
                    saveDeliveryFeeToStorage();
                }
                
                displayDeliveryFee(fee, addressData.neighborhood);
                
                // Adicionar taxa aos dados do pedido
                if (window.orderData && window.orderData.address) {
                    window.orderData.address.deliveryFee = fee;
                }
            } else {
                // Taxa n√£o encontrada - limpar taxa mas exibir alerta para consultar
                currentDeliveryFee = null;
                
                // Salvar taxa de delivery no localStorage
                if (typeof saveDeliveryFeeToStorage === 'function') {
                    saveDeliveryFeeToStorage();
                }
                if (window.orderData && window.orderData.address) {
                    delete window.orderData.address.deliveryFee;
                }
                // Exibir alerta para consultar taxa
                displayDeliveryFee(null, addressData.neighborhood);
            }
            
            // Atualizar total do checkout ap√≥s mudan√ßa na taxa de delivery
            if (typeof updateCheckoutOrderTotal === 'function') {
                updateCheckoutOrderTotal();
            }
        }

        /**
         * Atualiza os dados do endere√ßo quando editado manualmente
         */
        function updateAddressData() {
            if (!window.orderData || !window.orderData.address) {
                return;
            }
            
            // Atualizar dados do endere√ßo com valores dos campos
            const streetField = document.getElementById('street');
            const neighborhoodField = document.getElementById('neighborhood');
            const cityField = document.getElementById('city');
            
            if (streetField) {
                window.orderData.address.street = streetField.value;
            }
            if (neighborhoodField) {
                window.orderData.address.neighborhood = neighborhoodField.value;
            }
            if (cityField) {
                window.orderData.address.city = cityField.value;
            }
            
            debugLog('Dados do endere√ßo atualizados:', window.orderData.address);
        }
        
        // Vari√°vel para controlar o timeout de busca do bairro no modo CEP
        let cepNeighborhoodSearchTimeout = null;
        
        /**
         * Manipula mudan√ßas no campo de bairro para recalcular taxa de delivery
         * Vers√£o aprimorada com debounce e busca direta na planilha
         */
        function handleNeighborhoodChange() {
            const neighborhoodField = document.getElementById('neighborhood');
            if (!neighborhoodField || !window.orderData || !window.orderData.address) {
                return;
            }
            
            const neighborhood = neighborhoodField.value.trim();
            
            // Atualizar dados do endere√ßo
            window.orderData.address.neighborhood = neighborhood;
            
            // Limpar timeout anterior se existir
            if (cepNeighborhoodSearchTimeout) {
                clearTimeout(cepNeighborhoodSearchTimeout);
            }
            
            // Se estiver vazio, limpar taxa
            if (!neighborhood || neighborhood.length < 2) {
                clearDeliveryFee();
                if (window.orderData.address) {
                    delete window.orderData.address.deliveryFee;
                }
                updateCheckoutOrderTotal();
                
                // üîí Atualizar estado do bot√£o continuar para bairro vazio
                const config = getCheckoutConfig();
                if (config.only_bairro_mode === 'Sim') {
                    updateContinueButtonState(false, '');
                }
                return;
            }
            
            // Aguardar 500ms ap√≥s o usu√°rio parar de digitar antes de buscar
            cepNeighborhoodSearchTimeout = setTimeout(() => {
                searchNeighborhoodFeeForCEPMode(neighborhood);
                
                // üîí Atualizar estado do bot√£o continuar baseado na valida√ß√£o do bairro
                const isValid = validateNeighborhoodForDelivery(neighborhood);
                updateContinueButtonState(isValid, neighborhood);
            }, 500);
        }
        
        /**
         * Busca taxa de delivery por bairro no modo CEP
         * @param {string} neighborhood - Nome do bairro a ser pesquisado
         */
        function searchNeighborhoodFeeForCEPMode(neighborhood) {
            debugLog('=== BUSCANDO TAXA POR BAIRRO (MODO CEP) ===');
            debugLog('Bairro pesquisado:', neighborhood);
            
            // Verificar se dados est√£o dispon√≠veis
            if (!window.neighborhoodsData || window.neighborhoodsData.length === 0) {
                debugLog('Dados de bairros n√£o dispon√≠veis, tentando usar dados locais');
                
                // Fallback para dados locais
                if (typeof neighborhoodsData !== 'undefined' && neighborhoodsData.length > 0) {
                    window.neighborhoodsData = neighborhoodsData;
                    debugLog('Dados locais copiados para global:', neighborhoodsData.length, 'registros');
                } else {
                    debugLog('Nenhum dado de bairro dispon√≠vel');
                    displayDeliveryFee(null, neighborhood);
                    return;
                }
            }
            
            // Normalizar bairro para busca
            const normalizedNeighborhood = neighborhood.toLowerCase().trim();
            
            // üîí BUSCA EXATA APENAS - N√ÉO MAIS BUSCA PARCIAL
            let result = window.neighborhoodsData.find(item => {
                const itemBairro = (item.bairro || '').toLowerCase().trim();
                return itemBairro === normalizedNeighborhood;
            });
            
            debugLog('Busca exata por bairro:', { buscado: normalizedNeighborhood, encontrado: result });
            
            debugLog('Resultado da busca:', result);
            
            if (result && result.taxa) {
                const fee = parseFloat(result.taxa);
                
                if (!isNaN(fee) && fee > 0) {
                    debugLog('‚úÖ Taxa v√°lida encontrada:', fee);
                    
                    // Definir taxa global
                    currentDeliveryFee = fee;
                    
                    // Definir taxa no orderData
                    if (window.orderData && window.orderData.address) {
                        window.orderData.address.deliveryFee = fee;
                    }
                    
                    // Exibir taxa
                    displayDeliveryFee(fee, neighborhood);
                    
                    // Atualizar total do checkout
                    updateCheckoutOrderTotal();
                    return;
                }
            }
            
            debugLog('‚ùå Taxa n√£o encontrada para o bairro:', neighborhood);
            // Taxa n√£o encontrada - mostrar alerta para consultar
            displayDeliveryFee(null, neighborhood);
            
            // Limpar taxa nos dados do pedido
            if (window.orderData && window.orderData.address) {
                delete window.orderData.address.deliveryFee;
            }
            
            // Atualizar total do checkout (sem taxa)
            updateCheckoutOrderTotal();
        }

        // ====================================================================
        // SISTEMA REDUNDANTE DE BUSCA DE TAXA POR BAIRRO - V1.0
        // ====================================================================
        
        // Vari√°veis globais para controlar a busca de bairro
        let bairroSearchTimeout = null;
        let lastSearchedTerm = null; // Cache do √∫ltimo termo buscado
        let neighborhoodsList = []; // Lista de bairros para autocomplete
        let autocompleteContainer = null; // Container do autocomplete
        let spinnerTimeout = null; // Timeout para parar spinner automaticamente
        let lastInputValue = ''; // √öltimo valor do input para detectar mudan√ßas
        
        /**
         * Prepara lista de bairros para autocomplete (chamada durante preloader)
         */
        function prepareNeighborhoodsAutocomplete() {
            debugLog('üìã Preparando lista de bairros para autocomplete...');
            
            // Obter dados de bairros de qualquer fonte dispon√≠vel
            let dadosBairros = null;
            
            if (window.neighborhoodsData && Array.isArray(window.neighborhoodsData) && window.neighborhoodsData.length > 0) {
                dadosBairros = window.neighborhoodsData;
            } else if (typeof neighborhoodsData !== 'undefined' && Array.isArray(neighborhoodsData) && neighborhoodsData.length > 0) {
                dadosBairros = neighborhoodsData;
            } else if (window.localNeighborhoodsData && Array.isArray(window.localNeighborhoodsData) && window.localNeighborhoodsData.length > 0) {
                dadosBairros = window.localNeighborhoodsData;
            }
            
            if (!dadosBairros || dadosBairros.length === 0) {
                debugLog('‚ö†Ô∏è Nenhum dado de bairro dispon√≠vel para autocomplete');
                return;
            }
            
            // Extrair lista √∫nica de nomes de bairros
            neighborhoodsList = dadosBairros
                .map(item => {
                    const nome = item.bairro || item.neighborhood || '';
                    const taxa = parseFloat(item.taxa || item.fee || 0);
                    return {
                        nome: nome.trim(),
                        taxa: taxa,
                        normalizado: normalizarTexto(nome.toLowerCase())
                    };
                })
                .filter(item => item.nome && item.nome.length > 0)
                .sort((a, b) => a.nome.localeCompare(b.nome)); // Ordenar alfabeticamente
            
            // Remover duplicatas
            const nomesUnicos = new Set();
            neighborhoodsList = neighborhoodsList.filter(item => {
                if (nomesUnicos.has(item.normalizado)) {
                    return false;
                }
                nomesUnicos.add(item.normalizado);
                return true;
            });
            
            debugLog(`‚úÖ Lista de autocomplete preparada: ${neighborhoodsList.length} bairros`);
            debugLog('üìã Primeiros 5 bairros:', neighborhoodsList.slice(0, 5).map(b => b.nome));
            
            // Adicionar evento global para esconder autocomplete ao clicar fora
            if (!window.autocompleteEventAdded) {
                document.addEventListener('click', function(e) {
                    const field = document.getElementById('neighborhood');
                    const container = document.getElementById('neighborhood-autocomplete');
                    
                    if (field && container && 
                        !field.contains(e.target) && 
                        !container.contains(e.target)) {
                        hideNeighborhoodAutocomplete();
                    }
                });
                window.autocompleteEventAdded = true;
            }
        }
        
        /**
         * Verifica se o valor do input mudou e para o spinner se necess√°rio
         */
        function checkInputChangeAndStopSpinner() {
            const field = document.getElementById('neighborhood');
            if (!field) return;
            
            const currentValue = field.value;
            
            // Se o valor n√£o mudou e o spinner est√° ativo, par√°-lo
            if (currentValue === lastInputValue && field.classList.contains('neighborhood-loading')) {
                debugLog('üö´ Valor do input n√£o mudou, parando spinner por inatividade');
                hideNeighborhoodSpinner();
            }
        }
        
        /**
         * Fun√ß√£o REDUNDANTE para buscar taxa de entrega por bairro
         * Implementa debounce e busca mais precisa por termo completo
         */
        function buscarTaxaPorBairroRedundante(bairroDigitado, forceImmediate = false) {
            debugLog('üîç === BUSCA REDUNDANTE DE TAXA POR BAIRRO === üîç');
            debugLog('üè† Bairro digitado:', bairroDigitado);
            debugLog('‚ö° Busca imediata:', forceImmediate);
            
            // Limpar timeout anterior
            if (bairroSearchTimeout) {
                clearTimeout(bairroSearchTimeout);
                bairroSearchTimeout = null;
            }
            
            // Valida√ß√£o de entrada
            if (!bairroDigitado || typeof bairroDigitado !== 'string' || bairroDigitado.trim().length < 3) {
                debugLog('‚ö†Ô∏è Bairro inv√°lido ou muito curto (m√≠nimo 3 caracteres)');
                
                // Limpar spinner se campo inv√°lido
                hideNeighborhoodSpinner();
                
                // Mostrar autocomplete mesmo para termos curtos (‚â•2 caracteres)
                if (bairroDigitado && bairroDigitado.trim().length >= 2) {
                    showNeighborhoodAutocomplete(bairroDigitado.trim());
                } else {
                    hideNeighborhoodAutocomplete();
                }
                
                limparTaxaDeEntrega();
                return;
            }
            
            const bairro = bairroDigitado.trim();
            
            // Verificar se j√° buscamos este termo recentemente (evitar buscas repetidas)
            if (!forceImmediate && lastSearchedTerm === bairro.toLowerCase()) {
                debugLog('üíæ Cache: Termo j√° buscado recentemente, pulando busca:', bairro);
                
                // Mesmo com cache, mostrar autocomplete se dispon√≠vel
                if (bairro.length >= 2) {
                    showNeighborhoodAutocomplete(bairro);
                }
                return;
            }
            
            // Se n√£o for busca for√ßada, mostrar autocomplete e implementar debounce
            if (!forceImmediate) {
                debugLog('‚è±Ô∏è Mostrando autocomplete e implementando debounce de 800ms...');
                
                // Mostrar autocomplete imediatamente
                showNeighborhoodAutocomplete(bairro);
                
                // Mostrar spinner no campo
                showNeighborhoodSpinner();
                
                bairroSearchTimeout = setTimeout(() => {
                    debugLog('üöÄ Executando busca ap√≥s debounce...');
                    executarBuscaBairro(bairro);
                }, 800);
                return;
            }
            
            // Busca imediata
            executarBuscaBairro(bairro);
        }
        
        /**
         * Mostra spinner no campo de bairro com timeout autom√°tico
         */
        function showNeighborhoodSpinner() {
            const field = document.getElementById('neighborhood');
            if (!field) return;
            
            // Limpar timeout anterior se existir
            if (spinnerTimeout) {
                clearTimeout(spinnerTimeout);
            }
            
            // Adicionar classe de loading
            field.classList.add('neighborhood-loading');
            field.style.backgroundImage = 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'20\' height=\'20\' viewBox=\'0 0 24 24\'%3E%3Cpath fill=\'%23666\' d=\'M12,1A11,11,0,1,0,23,12,11,11,0,0,0,12,1Zm0,19a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z\' opacity=\'.25\'/%3E%3Cpath fill=\'%23666\' d=\'M12,4a8,8,0,0,1,7.89,6.7A1.53,1.53,0,0,0,21.38,12h0a1.5,1.5,0,0,0,1.48-1.75,11,11,0,0,0-21.72,0A1.5,1.5,0,0,0,2.62,12h0a1.53,1.53,0,0,0,1.49-1.3A8,8,0,0,1,12,4Z\'%3E%3CanimateTransform attributeName=\'transform\' dur=\'0.75s\' repeatCount=\'indefinite\' type=\'rotate\' values=\'0 12 12;360 12 12\'/%3E%3C/path%3E%3C/svg%3E")';
            field.style.backgroundRepeat = 'no-repeat';
            field.style.backgroundPosition = 'right 10px center';
            field.style.backgroundSize = '16px 16px';
            field.style.paddingRight = '35px';
            
            // Armazenar valor atual do input
            lastInputValue = field.value;
            
            // Configurar timeout para parar spinner automaticamente ap√≥s 5 segundos
            spinnerTimeout = setTimeout(() => {
                debugLog('‚è∞ Timeout: Parando spinner automaticamente ap√≥s 5 segundos');
                hideNeighborhoodSpinner();
            }, 5000);
            
            // Configurar verifica√ß√£o intermedi√°ria a cada 2 segundos
            setTimeout(() => {
                checkInputChangeAndStopSpinner();
            }, 2000);
            
            debugLog('üîÑ Spinner ativado no campo de bairro (timeout: 5s)');
        }
        
        /**
         * Remove spinner do campo de bairro
         */
        function hideNeighborhoodSpinner() {
            const field = document.getElementById('neighborhood');
            if (!field) return;
            
            // Limpar timeout se existir
            if (spinnerTimeout) {
                clearTimeout(spinnerTimeout);
                spinnerTimeout = null;
            }
            
            // Remover classe e estilos de loading
            field.classList.remove('neighborhood-loading');
            field.style.backgroundImage = '';
            field.style.backgroundRepeat = '';
            field.style.backgroundPosition = '';
            field.style.backgroundSize = '';
            field.style.paddingRight = '';
            
            debugLog('‚úÖ Spinner removido do campo de bairro');
        }
        
        /**
         * Mostra autocomplete de bairros
         */
        function showNeighborhoodAutocomplete(termo) {
            if (!termo || termo.length < 2 || neighborhoodsList.length === 0) {
                hideNeighborhoodAutocomplete();
                return;
            }
            
            const field = document.getElementById('neighborhood');
            if (!field) return;
            
            // Filtrar bairros que correspondem ao termo
            const termoNormalizado = normalizarTexto(termo.toLowerCase());
            const sugestoes = neighborhoodsList
                .filter(bairro => bairro.normalizado.includes(termoNormalizado))
                .slice(0, 8); // Limitar a 8 sugest√µes
            
            if (sugestoes.length === 0) {
                hideNeighborhoodAutocomplete();
                return;
            }
            
            // Criar container se n√£o existir
            if (!autocompleteContainer) {
                autocompleteContainer = document.createElement('div');
                autocompleteContainer.id = 'neighborhood-autocomplete';
                autocompleteContainer.style.cssText = `
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 1px solid #d1d5db;
                    border-top: none;
                    border-radius: 0 0 8px 8px;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    max-height: 200px;
                    overflow-y: auto;
                    z-index: 99999;
                    display: none;
                `;
                
                // Inserir ap√≥s o campo
                field.parentNode.style.position = 'relative';
                field.parentNode.style.overflow = 'visible';
                
                // Garantir que o modal tamb√©m tenha overflow visible
                const modal = field.closest('.modal-content, [id*="modal"], .fixed');
                if (modal) {
                    modal.style.overflow = 'visible';
                }
                
                field.parentNode.appendChild(autocompleteContainer);
            }
            
            // Gerar HTML das sugest√µes
            let html = '';
            sugestoes.forEach((bairro, index) => {
                const taxaFormatada = bairro.taxa > 0 ? `R$ ${bairro.taxa.toFixed(2)}` : 'Gr√°tis';
                html += `
                    <div class="autocomplete-item" 
                         data-neighborhood="${bairro.nome}" 
                         data-taxa="${bairro.taxa}"
                         style="
                             padding: 10px 12px;
                             cursor: pointer;
                             border-bottom: 1px solid #f3f4f6;
                             display: flex;
                             justify-content: space-between;
                             align-items: center;
                             transition: background-color 0.2s;
                         "
                         onmouseover="this.style.backgroundColor='#f9fafb'"
                         onmouseout="this.style.backgroundColor='white'"
                         onclick="selectNeighborhoodFromAutocomplete('${bairro.nome}', ${bairro.taxa})">
                        <span style="font-weight: 500; color: #374151;">${bairro.nome}</span>
                        <span style="font-size: 12px; color: #6b7280; font-weight: 600;">${taxaFormatada}</span>
                    </div>
                `;
            });
            
            autocompleteContainer.innerHTML = html;
            autocompleteContainer.style.display = 'block';
            
            debugLog(`üìù Autocomplete exibido: ${sugestoes.length} sugest√µes para "${termo}"`);
        }
        
        /**
         * Esconde autocomplete de bairros
         */
        function hideNeighborhoodAutocomplete() {
            if (autocompleteContainer) {
                autocompleteContainer.style.display = 'none';
            }
        }
        
        /**
         * Reseta o estado do sistema de busca (limpa cache e spinner)
         */
        function resetNeighborhoodSearchState() {
            // Limpar timeout de busca se existir
            if (bairroSearchTimeout) {
                clearTimeout(bairroSearchTimeout);
                bairroSearchTimeout = null;
            }
            
            // Limpar timeout do spinner se existir
            if (spinnerTimeout) {
                clearTimeout(spinnerTimeout);
                spinnerTimeout = null;
            }
            
            // Limpar cache
            lastSearchedTerm = null;
            lastInputValue = '';
            
            // Remover spinner
            hideNeighborhoodSpinner();
            
            debugLog('üîÑ Estado da busca de bairro resetado');
        }
        
        /**
         * Seleciona bairro do autocomplete
         */
        function selectNeighborhoodFromAutocomplete(nome, taxa) {
            const field = document.getElementById('neighborhood');
            if (!field) return;
            
            // Preencher campo
            field.value = nome;
            
            // Esconder autocomplete
            hideNeighborhoodAutocomplete();
            
            // Aplicar taxa imediatamente
            debugLog(`üéØ Bairro selecionado do autocomplete: ${nome} (Taxa: R$ ${taxa})`);
            aplicarTaxaEncontrada(taxa, nome);
            
            // Atualizar dados do endere√ßo
            updateAddressData();
            
            // Limpar campo de erro se existir
            clearFieldError('neighborhood');
        }
        
        /**
         * Executa a busca real do bairro na planilha
         */
        function executarBuscaBairro(bairro) {
            debugLog('üîç Executando busca para:', bairro);
            debugLog('üìã Bairro processado:', bairro);
            
            // Atualizar cache do termo buscado
            lastSearchedTerm = bairro.toLowerCase();
            
            // Verificar se temos dados dispon√≠veis (m√∫ltiplas fontes)
            let dadosBairros = null;
            
            // Fonte 1: window.neighborhoodsData
            if (window.neighborhoodsData && Array.isArray(window.neighborhoodsData) && window.neighborhoodsData.length > 0) {
                dadosBairros = window.neighborhoodsData;
                debugLog('‚úÖ Usando window.neighborhoodsData:', dadosBairros.length, 'registros');
            }
            // Fonte 2: neighborhoodsData global
            else if (typeof neighborhoodsData !== 'undefined' && Array.isArray(neighborhoodsData) && neighborhoodsData.length > 0) {
                dadosBairros = neighborhoodsData;
                window.neighborhoodsData = neighborhoodsData; // Copiar para window
                debugLog('‚úÖ Usando neighborhoodsData global:', dadosBairros.length, 'registros');
            }
            // Fonte 3: localNeighborhoodsData
            else if (window.localNeighborhoodsData && Array.isArray(window.localNeighborhoodsData) && window.localNeighborhoodsData.length > 0) {
                dadosBairros = window.localNeighborhoodsData;
                debugLog('‚úÖ Usando window.localNeighborhoodsData:', dadosBairros.length, 'registros');
            }
            else {
                errorLog('Nenhum dado de bairro dispon√≠vel!');
                exibirAlertaTaxaNaoEncontrada(bairro);
                
                // Remover spinner sempre
                hideNeighborhoodSpinner();
                return;
            }
            
            // Normalizar bairro para busca (remover acentos, mai√∫sculas, etc.)
            const bairroNormalizado = normalizarTexto(bairro.toLowerCase());
            debugLog('üîÑ Bairro normalizado:', bairroNormalizado);
            
            // BUSCA NIVEL 1: Busca exata (priorit√°ria)
            debugLog('üéØ Tentando busca EXATA...');
            let resultado = dadosBairros.find(item => {
                const itemBairro = normalizarTexto((item.bairro || item.neighborhood || '').toLowerCase());
                return itemBairro === bairroNormalizado;
            });
            
            // BUSCA NIVEL 2: Busca exata sem normaliza√ß√£o (caso especial)
            if (!resultado) {
                debugLog('üéØ Tentando busca EXATA sem normaliza√ß√£o...');
                resultado = dadosBairros.find(item => {
                    const itemBairro = (item.bairro || item.neighborhood || '').toLowerCase().trim();
                    return itemBairro === bairro.toLowerCase().trim();
                });
            }
            
            // BUSCA NIVEL 3: Busca parcial muito restritiva (apenas se o termo for muito similar)
            if (!resultado && bairro.length >= 5) {
                debugLog('üéØ Tentando busca PARCIAL restritiva...');
                resultado = dadosBairros.find(item => {
                    const itemBairro = normalizarTexto((item.bairro || item.neighborhood || '').toLowerCase());
                    // Apenas se o bairro digitado est√° contido no bairro da planilha E tem pelo menos 80% de similaridade
                    const similarity = calculateSimilarity(bairroNormalizado, itemBairro);
                    return (itemBairro.includes(bairroNormalizado) && similarity >= 0.8) || 
                           (bairroNormalizado.includes(itemBairro) && similarity >= 0.8);
                });
                
                if (resultado) {
                    debugLog('‚úÖ Encontrado por busca parcial restritiva');
                }
            }
            
            // Processar resultado
            if (resultado) {
                const taxa = parseFloat(resultado.taxa || resultado.fee || 0);
                
                if (!isNaN(taxa) && taxa > 0) {
                    debugLog('‚úÖ TAXA ENCONTRADA!', {
                        bairroOriginal: bairro,
                        bairroEncontrado: resultado.bairro || resultado.neighborhood,
                        taxa: taxa
                    });
                    
                    aplicarTaxaEncontrada(taxa, bairro);
                    
                    // Remover spinner ap√≥s sucesso
                    hideNeighborhoodSpinner();
                    return;
                } else {
                    errorLog('‚ö†Ô∏è Taxa inv√°lida encontrada:', resultado.taxa || resultado.fee);
                }
            }
            
            // Se chegou at√© aqui, n√£o encontrou
            debugLog('‚ùå Taxa n√£o encontrada para o bairro:', bairro);
            exibirAlertaTaxaNaoEncontrada(bairro);
            
            // Limpar cache para permitir novas buscas
            lastSearchedTerm = null;
            
            // Remover spinner sempre ao final
            hideNeighborhoodSpinner();
        }
        
        /**
         * Calcula a similaridade entre duas strings usando algoritmo de Levenshtein
         */
        function calculateSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;
            if (str1 === str2) return 1;
            
            const len1 = str1.length;
            const len2 = str2.length;
            
            // Matriz para algoritmo de Levenshtein
            const matrix = Array(len2 + 1).fill(null).map(() => Array(len1 + 1).fill(null));
            
            for (let i = 0; i <= len1; i++) matrix[0][i] = i;
            for (let j = 0; j <= len2; j++) matrix[j][0] = j;
            
            for (let j = 1; j <= len2; j++) {
                for (let i = 1; i <= len1; i++) {
                    const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(
                        matrix[j - 1][i] + 1,     // deletion
                        matrix[j][i - 1] + 1,     // insertion
                        matrix[j - 1][i - 1] + cost // substitution
                    );
                }
            }
            
            const distance = matrix[len2][len1];
            return 1 - distance / Math.max(len1, len2);
        }
        
        /**
         * Fun√ß√£o para normalizar texto (remover acentos, caracteres especiais)
         */
        function normalizarTexto(texto) {
            if (!texto) return '';
            
            return texto
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .replace(/[^a-z0-9\s]/g, '') // Remove caracteres especiais
                .replace(/\s+/g, ' ') // Normaliza espa√ßos
                .trim();
        }
        
        /**
         * Fun√ß√£o para aplicar taxa encontrada
         */
        function aplicarTaxaEncontrada(taxa, bairro) {
            debugLog('‚úÖ Aplicando taxa encontrada:', taxa);
            
            // Definir taxa global
            window.currentDeliveryFee = taxa;
            
            // Atualizar orderData
            if (window.orderData && window.orderData.address) {
                window.orderData.address.deliveryFee = taxa;
                debugLog('‚úÖ Taxa atualizada em orderData.address');
            }
            
            // Exibir taxa na interface
            displayDeliveryFee(taxa, bairro);
            
            // Atualizar total do pedido
            updateCheckoutOrderTotal();
            
            // Efeito visual no campo
            const campo = document.getElementById('neighborhood');
            if (campo) {
                campo.style.backgroundColor = '#dcfce7'; // Verde claro
                setTimeout(() => {
                    campo.style.backgroundColor = '';
                }, 1000);
            }
        }
        
        /**
         * Fun√ß√£o para exibir alerta quando taxa n√£o √© encontrada
         */
        function exibirAlertaTaxaNaoEncontrada(bairro) {
            debugLog('‚ö†Ô∏è Exibindo alerta de taxa n√£o encontrada');
            
            // Limpar taxa
            limparTaxaDeEntrega();
            
            // Exibir alerta
            displayDeliveryFee(null, bairro);
            
            // Efeito visual no campo
            const campo = document.getElementById('neighborhood');
            if (campo) {
                campo.style.backgroundColor = '#fef2f2'; // Vermelho claro
                setTimeout(() => {
                    campo.style.backgroundColor = '';
                }, 1000);
            }
        }
        
        /**
         * Fun√ß√£o para limpar taxa de entrega
         */
        function limparTaxaDeEntrega() {
            debugLog('üßπ Limpando taxa de entrega');
            
            // Limpar vari√°vel global
            window.currentDeliveryFee = null;
            
            // Limpar orderData
            if (window.orderData && window.orderData.address) {
                delete window.orderData.address.deliveryFee;
            }
            
            // Remover alerta da interface
            const alerta = document.getElementById('delivery-fee-alert');
            if (alerta) {
                alerta.remove();
            }
            
            // Atualizar total do pedido
            updateCheckoutOrderTotal();
        }
        
        /**
         * Fun√ß√£o REDUNDANTE de monitoramento do campo de bairro
         * Esta fun√ß√£o garante que SEMPRE que o usu√°rio digitar, a busca ser√° executada
         * AGORA: S√≥ executa quando o campo realmente existe (checkout aberto)
         */
        function iniciarMonitoramentoRedundanteBairro() {
            debugLog('üîÑ Iniciando monitoramento REDUNDANTE do campo de bairro');
            
            const campo = document.getElementById('neighborhood');
            if (!campo) {
                debugLog('‚ö†Ô∏è Campo de bairro n√£o encontrado - checkout n√£o est√° aberto');
                return; // N√ÉO tentar novamente automaticamente
            }
            
            debugLog('‚úÖ Campo de bairro encontrado, configurando eventos...');
            
            // Vari√°vel para debounce
            let timeoutBusca = null;
            
            // Fun√ß√£o de busca com debounce INTELIGENTE
            function executarBuscaComDebounce() {
                const valor = campo.value.trim();
                
                // Cancelar busca anterior
                if (timeoutBusca) {
                    clearTimeout(timeoutBusca);
                }
                
                // Se vazio ou muito curto, limpar
                if (!valor || valor.length < 3) {
                    if (valor.length === 0) {
                        limparTaxaDeEntrega();
                    }
                    return;
                }
                
                // Mostrar indicador visual de que est√° digitando
                campo.style.backgroundColor = '#f0f9ff'; // Azul muito claro
                
                // Agendar nova busca com tempo maior para palavra completa
                timeoutBusca = setTimeout(() => {
                    debugLog('üöÄ Executando busca para palavra completa:', valor);
                    
                    // Remover indicador visual
                    campo.style.backgroundColor = '';
                    
                    // Executar busca
                    buscarTaxaPorBairroRedundante(valor);
                }, 1200); // 1.2 segundos para garantir palavra completa
            }
            
            // Remover eventos anteriores
            campo.removeEventListener('input', executarBuscaComDebounce);
            campo.removeEventListener('change', executarBuscaComDebounce);
            campo.removeEventListener('blur', executarBuscaComDebounce);
            campo.removeEventListener('paste', executarBuscaComDebounce);
            
            // Adicionar apenas eventos que indicam fim da digita√ß√£o
            campo.addEventListener('input', executarBuscaComDebounce); // Com debounce longo
            campo.addEventListener('change', function() {
                // Busca imediata quando sai do campo
                if (timeoutBusca) clearTimeout(timeoutBusca);
                const valor = campo.value.trim();
                if (valor.length >= 3) {
                    debugLog('üöÄ Busca imediata por CHANGE:', valor);
                    buscarTaxaPorBairroRedundante(valor);
                }
            });
            campo.addEventListener('blur', function() {
                // Busca imediata quando perde o foco
                if (timeoutBusca) clearTimeout(timeoutBusca);
                const valor = campo.value.trim();
                if (valor.length >= 3) {
                    debugLog('üöÄ Busca imediata por BLUR:', valor);
                    buscarTaxaPorBairroRedundante(valor);
                }
            });
            campo.addEventListener('paste', function() {
                // Busca ap√≥s colar texto
                setTimeout(() => {
                    const valor = campo.value.trim();
                    if (valor.length >= 3) {
                        debugLog('üöÄ Busca imediata por PASTE:', valor);
                        buscarTaxaPorBairroRedundante(valor);
                    }
                }, 200);
            });
            
            // Sobrescrever atributo oninput apenas para updateAddressData
            campo.setAttribute('oninput', 'updateAddressData();');
            
            debugLog('‚úÖ Monitoramento redundante configurado com sucesso!');
            
            // Efeito visual para confirmar
            campo.style.border = '2px solid #10b981';
            setTimeout(() => {
                campo.style.border = '';
            }, 2000);
        }
        
        // REMOVIDO: Inicializa√ß√£o autom√°tica do monitoramento
        // Agora o monitoramento s√≥ √© iniciado quando o checkout √© aberto
        // document.addEventListener('DOMContentLoaded', function() {
        //     setTimeout(iniciarMonitoramentoRedundanteBairro, 2000);
        // });
        
        // Fun√ß√£o de teste global
        window.testarBuscaBairro = function(bairro) {
            debugLog('üß™ Testando busca para:', bairro);
            buscarTaxaPorBairroRedundante(bairro || 'Centro');
        };
        
        // ====================================================================
        // SISTEMA MODO ENDERE√áO MANUAL - "N√ÉO SEI MEU CEP" - V3.5
        // ====================================================================

        // Vari√°vel para controlar timeout de busca por bairro
        let neighborhoodSearchTimeout = null;



        /**
         * Atualiza os dados do endere√ßo manual
         */
        function updateManualAddressData() {
            const streetField = document.getElementById('manual-street');
            const numberField = document.getElementById('manual-number');
            const complementField = document.getElementById('manual-complement');
            const neighborhoodField = document.getElementById('manual-neighborhood');
            const cityField = document.getElementById('manual-city');
            
            if (!streetField || !numberField || !neighborhoodField || !cityField) {
                return;
            }
            
            // Inicializar orderData.address se n√£o existir (usar vari√°vel global consistente)
            if (!orderData) {
                orderData = {};
            }
            if (!orderData.address) {
                orderData.address = {};
            }
            
            // Preservar taxa de delivery existente
            const existingDeliveryFee = orderData.address.deliveryFee;
            
            // Construir endere√ßo completo
            const street = streetField.value.trim();
            const number = numberField.value.trim();
            const complement = complementField.value.trim();
            const neighborhood = neighborhoodField.value.trim();
            const city = cityField.value.trim();
            
            // Montar endere√ßo completo
            let fullAddress = street;
            if (number) fullAddress += `, ${number}`;
            if (complement) fullAddress += `, ${complement}`;
            
            // Atualizar dados do pedido
            orderData.address = {
                cep: '',
                street: fullAddress,
                neighborhood: neighborhood,
                city: city,
                state: '',
                isManual: true
            };
            
            // Restaurar taxa de delivery se existia
            if (existingDeliveryFee) {
                orderData.address.deliveryFee = existingDeliveryFee;
            }
            
            debugLog('DEBUG - Dados endere√ßo manual atualizados:', orderData.address);
        }

        /**
         * Busca taxa de delivery por bairro no modo manual (com debounce)
         */
        function searchNeighborhoodFee() {
            const neighborhoodField = document.getElementById('manual-neighborhood');
            if (!neighborhoodField) return;
            
            const neighborhood = neighborhoodField.value.trim();
            
            // Limpar timeout anterior
            if (neighborhoodSearchTimeout) {
                clearTimeout(neighborhoodSearchTimeout);
            }
            
            // Se menos de 3 caracteres, limpar taxa
            if (neighborhood.length < 3) {
                clearDeliveryFee();
                
                // üîí Atualizar estado do bot√£o continuar para bairro vazio
                const config = getCheckoutConfig();
                if (config.only_bairro_mode === 'Sim') {
                    updateContinueButtonState(false, '');
                }
                return;
            }
            
            // Aguardar 800ms ap√≥s o usu√°rio parar de digitar
            neighborhoodSearchTimeout = setTimeout(() => {
                performNeighborhoodSearch(neighborhood);
                
                // üîí Atualizar estado do bot√£o continuar baseado na valida√ß√£o do bairro
                const isValid = validateNeighborhoodForDelivery(neighborhood);
                updateContinueButtonState(isValid, neighborhood);
            }, 800);
        }

        /**
         * Executa a busca real por bairro
         */
        function performNeighborhoodSearch(neighborhood) {
            debugLog('=== BUSCANDO TAXA POR BAIRRO (MANUAL) ===');
            debugLog('Bairro pesquisado:', neighborhood);
            debugLog('window.neighborhoodsData existe?', !!window.neighborhoodsData);
            debugLog('Quantidade de registros:', window.neighborhoodsData ? window.neighborhoodsData.length : 0);
            
            // Verificar se dados est√£o dispon√≠veis
            if (!window.neighborhoodsData) {
                errorLog('ERRO: window.neighborhoodsData n√£o definido!');
                // Fallback para dados locais
                if (typeof neighborhoodsData !== 'undefined' && neighborhoodsData.length > 0) {
                    window.neighborhoodsData = neighborhoodsData;
                    debugLog('Dados locais copiados para global:', neighborhoodsData.length, 'registros');
                }
            }
            
            if (!window.neighborhoodsData || window.neighborhoodsData.length === 0) {
                debugLog('Dados de bairros n√£o dispon√≠veis');
                displayDeliveryFee(null, neighborhood);
                return;
            }
            
            // Log dos primeiros registros para debug
            debugLog('Primeiros 3 registros:', window.neighborhoodsData.slice(0, 3));
            
            // Normalizar bairro para busca
            const normalizedNeighborhood = neighborhood.toLowerCase();
            debugLog('Bairro normalizado para busca:', normalizedNeighborhood);
            
            // Buscar na planilha
            const result = window.neighborhoodsData.find(item => {
                const itemBairro = (item.bairro || '').toLowerCase();
                debugLog('Comparando:', normalizedNeighborhood, '===', itemBairro);
                return itemBairro === normalizedNeighborhood;
            });
            
            debugLog('Resultado da busca:', result);
            
            if (result && result.taxa) {
                const fee = parseFloat(result.taxa);
                debugLog('Taxa encontrada (raw):', result.taxa);
                debugLog('Taxa parseada:', fee);
                
                if (!isNaN(fee) && fee > 0) {
                    debugLog('‚úÖ Taxa v√°lida encontrada:', fee);
                    
                    // CORRE√á√ÉO: Definir taxa global (necess√°rio para c√°lculo do total)
                    currentDeliveryFee = fee;
                    
                    // Definir taxa no orderData
                    if (orderData && orderData.address) {
                        orderData.address.deliveryFee = fee;
                        debugLog('Taxa de delivery definida com sucesso:', fee);
                    }
                    
                    // Exibir taxa
                    displayDeliveryFee(fee, neighborhood);
                    
                    // CORRE√á√ÉO: Atualizar total do checkout
                    updateCheckoutOrderTotal();
                    
                    return;
                }
            }
            
            debugLog('‚ùå Taxa n√£o encontrada para o bairro:', neighborhood);
            // Taxa n√£o encontrada - mostrar alerta para consultar
            displayDeliveryFee(null, neighborhood);
        }

        /**
         * Limpa campos de endere√ßo do modo CEP
         */
        function clearAddressFields() {
            const fields = ['cep', 'street', 'number', 'complement', 'neighborhood', 'city'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                    clearFieldError(fieldId);
                }
            });
            
            // Ocultar campos de endere√ßo
            const addressFields = document.getElementById('address-fields');
            if (addressFields) {
                addressFields.classList.add('hidden');
            }
        }

        /**
         * Limpa campos de endere√ßo do modo manual
         */
        function clearManualAddressFields() {
            const fields = ['manual-street', 'manual-number', 'manual-complement', 'manual-neighborhood', 'manual-city'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                    clearFieldError(fieldId);
                }
            });
        }

        // Show toast notification
        function showToast(message, type = 'error', duration = 4000) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            });
            
            const icons = {
                error: '‚ö†Ô∏è',
                success: '‚úÖ',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            const toastDiv = document.createElement('div');
            toastDiv.className = `toast toast-${type}`;
            toastDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <span class="text-xl flex-shrink-0 mt-0.5">${icons[type]}</span>
                    <div class="flex-1">
                        <div class="font-semibold text-sm leading-tight">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.classList.add('toast-exit'); setTimeout(() => this.parentElement.parentElement.remove(), 300)" class="text-white/80 hover:text-white ml-2 flex-shrink-0">
                        <span class="text-lg">√ó</span>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toastDiv);
            
            // Auto remove
            setTimeout(() => {
                if (toastDiv.parentNode) {
                    toastDiv.classList.add('toast-exit');
                    setTimeout(() => toastDiv.remove(), 300);
                }
            }, duration);
        }
        
        // Show custom alert (legacy support)
        function showCustomAlert(message, type = 'error') {
            showToast(message, type);
        }

        // Format WhatsApp number with country-specific mask
        /**
         * Formata n√∫mero de telefone para exibi√ß√£o
         * @param {string} phoneNumber - N√∫mero de telefone (ex: 5519998021956)
         * @returns {string} - N√∫mero formatado (ex: +55 (19) 99802-1956)
         */
        function formatPhoneForDisplay(phoneNumber) {
            if (!phoneNumber) return '';
            
            // Remover caracteres n√£o num√©ricos
            const cleanNumber = phoneNumber.replace(/\D/g, '');
            
            // Se come√ßar com 55 (Brasil)
            if (cleanNumber.startsWith('55') && cleanNumber.length >= 13) {
                // Formato: 5519998021956 -> +55 (19) 99802-1956
                const countryCode = cleanNumber.substring(0, 2);
                const areaCode = cleanNumber.substring(2, 4);
                const firstPart = cleanNumber.substring(4, 9);
                const secondPart = cleanNumber.substring(9, 13);
                return `+${countryCode} (${areaCode}) ${firstPart}-${secondPart}`;
            }
            // Se come√ßar com 55 mas for menor (formato antigo)
            else if (cleanNumber.startsWith('55') && cleanNumber.length >= 12) {
                // Formato: 551998021956 -> +55 (19) 9802-1956
                const countryCode = cleanNumber.substring(0, 2);
                const areaCode = cleanNumber.substring(2, 4);
                const firstPart = cleanNumber.substring(4, 8);
                const secondPart = cleanNumber.substring(8, 12);
                return `+${countryCode} (${areaCode}) ${firstPart}-${secondPart}`;
            }
            // Se for n√∫mero brasileiro sem c√≥digo do pa√≠s
            else if (cleanNumber.length === 11) {
                // Formato: 19998021956 -> +55 (19) 99802-1956
                const areaCode = cleanNumber.substring(0, 2);
                const firstPart = cleanNumber.substring(2, 7);
                const secondPart = cleanNumber.substring(7, 11);
                return `+55 (${areaCode}) ${firstPart}-${secondPart}`;
            }
            // Se for n√∫mero brasileiro antigo sem c√≥digo do pa√≠s
            else if (cleanNumber.length === 10) {
                // Formato: 1998021956 -> +55 (19) 9802-1956
                const areaCode = cleanNumber.substring(0, 2);
                const firstPart = cleanNumber.substring(2, 6);
                const secondPart = cleanNumber.substring(6, 10);
                return `+55 (${areaCode}) ${firstPart}-${secondPart}`;
            }
            // Para outros formatos, retornar com + na frente
            else {
                return `+${cleanNumber}`;
            }
        }
        
        function formatWhatsAppWithCountry(input) {
            const countryCode = document.getElementById('country-code').value;
            const selectedOption = document.querySelector(`#country-code option[value="${countryCode}"]`);
            const format = selectedOption ? selectedOption.getAttribute('data-format') : '(99) 9 9999-9999';
            
            let value = input.value.replace(/\D/g, '');
            
            // Apply formatting based on country
            if (countryCode === '55') { // Brazil
                // Limit to 11 digits (DDD + 9 digits)
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }
                
                // Format: (99) 9 9999-9999
                if (value.length >= 11) {
                    value = value.replace(/(\d{2})(\d{1})(\d{4})(\d{4})/, '($1) $2 $3-$4');
                } else if (value.length >= 7) {
                    value = value.replace(/(\d{2})(\d{1})(\d{0,4})(\d{0,4})/, '($1) $2 $3-$4');
                } else if (value.length >= 3) {
                    value = value.replace(/(\d{2})(\d{0,1})(\d{0,4})/, '($1) $2 $3');
                } else if (value.length >= 1) {
                    value = value.replace(/(\d{0,2})/, '($1)');
                }
            } else if (countryCode === '1') { // US/Canada
                if (value.length > 10) {
                    value = value.substring(0, 10);
                }
                if (value.length >= 10) {
                    value = value.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
                } else if (value.length >= 6) {
                    value = value.replace(/(\d{3})(\d{0,3})(\d{0,4})/, '($1) $2-$3');
                } else if (value.length >= 3) {
                    value = value.replace(/(\d{0,3})(\d{0,3})/, '($1) $2');
                } else {
                    value = value.replace(/(\d{0,3})/, '($1)');
                }
            } else if (countryCode === '351') { // Portugal
                // Limit to 9 digits for Portugal
                if (value.length > 9) {
                    value = value.substring(0, 9);
                }
                
                // Format: 999 999 999
                if (value.length >= 9) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
                } else if (value.length >= 6) {
                    value = value.replace(/(\d{3})(\d{0,3})(\d{0,3})/, '$1 $2 $3');
                } else if (value.length >= 3) {
                    value = value.replace(/(\d{0,3})(\d{0,3})/, '$1 $2');
                }
            } else {
                // Generic formatting for other countries
                if (value.length > 15) {
                    value = value.substring(0, 15);
                }
            }
            
            input.value = value;
        }
        
        // Get minimum required length for WhatsApp validation based on country (formatted)
        function getMinWhatsAppLength(countryCode) {
            const countryLengths = {
                '55': 14,   // Brazil: (99) 9 9999-9999
                '1': 14,    // US/Canada: (999) 999-9999
                '351': 11,  // Portugal: 999 999 999
                '244': 11,  // Angola: 999 999 999
                '258': 12,  // Mozambique: 99 999 9999
                '238': 9,   // Cape Verde: 999 99 99
                '245': 8,   // Guinea-Bissau: 999 9999
                '239': 7,   // S√£o Tom√©: 99 99999
                '670': 8,   // East Timor: 999 9999
                '853': 9,   // Macau: 9999 9999
                '54': 12,   // Argentina: 9 9999-9999
                '56': 12,   // Chile: 9 9999 9999
                '57': 12,   // Colombia: 999 999 9999
                '51': 11,   // Peru: 999 999 999
                '598': 9,   // Uruguay: 9999 9999
                '595': 10,  // Paraguay: 999 999999
                '591': 9,   // Bolivia: 9999 9999
                '593': 12,  // Ecuador: 99 999 9999
                '58': 12,   // Venezuela: 999-999-9999
                '592': 8,   // Guyana: 999 9999
                '597': 8,   // Suriname: 999-9999
                '594': 12,  // French Guiana: 999 99 99 99
                '34': 12,   // Spain: 999 99 99 99
                '33': 14,   // France: 99 99 99 99 99
                '39': 12,   // Italy: 999 999 9999
                '49': 12,   // Germany: 999 99999999
                '44': 11    // UK: 9999 999999
            };
            return countryLengths[countryCode] || 8; // Default minimum length
        }
        
        // Get minimum required digits for WhatsApp validation based on country (digits only)
        function getMinWhatsAppDigits(countryCode) {
            const countryDigits = {
                '55': 11,   // Brazil: 11 digits
                '1': 10,    // US/Canada: 10 digits
                '351': 9,   // Portugal: 9 digits
                '244': 9,   // Angola: 9 digits
                '258': 9,   // Mozambique: 9 digits
                '238': 7,   // Cape Verde: 7 digits
                '245': 7,   // Guinea-Bissau: 7 digits
                '239': 7,   // S√£o Tom√©: 7 digits
                '670': 7,   // East Timor: 7 digits
                '853': 8,   // Macau: 8 digits
                '54': 10,   // Argentina: 10 digits
                '56': 9,    // Chile: 9 digits
                '57': 10,   // Colombia: 10 digits
                '51': 9,    // Peru: 9 digits
                '598': 8,   // Uruguay: 8 digits
                '595': 9,   // Paraguay: 9 digits
                '591': 8,   // Bolivia: 8 digits
                '593': 9,   // Ecuador: 9 digits
                '58': 10,   // Venezuela: 10 digits
                '592': 7,   // Guyana: 7 digits
                '597': 7,   // Suriname: 7 digits
                '594': 10,  // French Guiana: 10 digits
                '34': 9,    // Spain: 9 digits
                '33': 10,   // France: 10 digits
                '39': 10,   // Italy: 10 digits
                '49': 11,   // Germany: 11 digits
                '44': 10    // UK: 10 digits
            };
            return countryDigits[countryCode] || 7; // Default minimum digits
        }
        
        // Update phone placeholder based on selected country
        function updatePhonePlaceholder() {
            const countryCode = document.getElementById('country-code').value;
            const selectedOption = document.querySelector(`#country-code option[value="${countryCode}"]`);
            const format = selectedOption ? selectedOption.getAttribute('data-format') : '(99) 9 9999-9999';
            const phoneInput = document.getElementById('customer-whatsapp');
            
            phoneInput.placeholder = format;
            phoneInput.value = ''; // Clear current value when country changes
        }
        
        // Detect country by IP and set default country code
        async function detectCountryByIP() {
            // Lista de APIs que tentaremos, em ordem de prioridade
            const apiEndpoints = [
                {
                    url: 'https://ipinfo.io/json',
                    extractCode: (data) => {
                        // ipinfo.io retorna o c√≥digo do pa√≠s diretamente
                        const countryMapping = {
                            'BR': '55', 'PT': '351', 'AO': '244', 'MZ': '258', 'CV': '238',
                            'GW': '245', 'ST': '239', 'TL': '670', 'MO': '853',
                            'US': '1', 'CA': '1', 'AR': '54', 'CL': '56',
                            'CO': '57', 'PE': '51', 'UY': '598', 'PY': '595', 'BO': '591',
                            'EC': '593', 'VE': '58', 'GY': '592', 'SR': '597', 'GF': '594',
                            'ES': '34', 'FR': '33', 'IT': '39', 'DE': '49', 'GB': '44'
                        };
                        return countryMapping[data.country] || '55';
                    }
                },
                {
                    url: 'https://api.ipdata.co?api-key=test',
                    extractCode: (data) => {
                        // ipdata.co retorna o c√≥digo do pa√≠s e o c√≥digo de chamada
                        return data.calling_code || '55';
                    }
                },
                {
                    url: 'https://api.ipgeolocation.io/ipgeo?apiKey=API_KEY_FREE',
                    extractCode: (data) => {
                        // ipgeolocation.io retorna o c√≥digo de chamada
                        return data.calling_code?.replace('+', '') || '55';
                    }
                }
            ];
            
            let phoneCountryCode = '55'; // Valor padr√£o para Brasil
            let countryName = 'Brazil';
            let apiUsed = 'nenhuma';
            
            // Tenta cada API at√© uma funcionar
            for (const api of apiEndpoints) {
                try {
                    debugLog('Tentando API:', api.url);
                    const response = await fetch(api.url, { 
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        // Timeout de 3 segundos para n√£o travar o carregamento
                        signal: AbortSignal.timeout(3000)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        phoneCountryCode = api.extractCode(data);
                        countryName = data.country_name || data.country || 'Brazil';
                        apiUsed = api.url;
                        break; // Sai do loop se uma API funcionar
                    }
                } catch (error) {
                    debugLog('Erro ao acessar API:', api.url, error.message);
                    // Continua para a pr√≥xima API
                }
            }
            
            debugLog('Pa√≠s detectado:', countryName, 'C√≥digo telef√¥nico:', phoneCountryCode, 'API usada:', apiUsed);
            
            // Atualiza o seletor de pa√≠s
            const countrySelect = document.getElementById('country-code');
            if (countrySelect) {
                countrySelect.value = phoneCountryCode;
                updatePhonePlaceholder();
            }
        }
        
        // Check if webhook is active
        function isWebhookActive() {
            const envioConfig = getEnvioConfig();
            // Webhook is active when there's a webhook URL AND whatsapp_web is NOT 'Sim'
            // If whatsapp_web is 'Sim', we should use WhatsApp Web instead of webhook
            return envioConfig.webhook_url && envioConfig.webhook_url.trim() !== '' && envioConfig.whatsapp_web !== 'Sim';
        }
        
        // Show/hide WhatsApp field based on webhook status
        function toggleWhatsAppField() {
            const whatsappField = document.getElementById('whatsapp-field');
            
            // Verifica√ß√£o defensiva - elemento deve existir
            if (!whatsappField) {
                if (typeof warnLog === 'function') warnLog('‚ö†Ô∏è WhatsApp field element not found');
                return;
            }
            
            if (isWebhookActive()) {
                whatsappField.classList.remove('hidden');
            } else {
                whatsappField.classList.add('hidden');
            }
        }

        // Focus order notes field with auto-scroll to prevent keyboard covering
        function focusOrderNotesField(element) {
            // Apply visual focus styles
            element.style.borderColor = 'var(--cor-primaria)';
            element.style.outline = '2px solid var(--cor-primaria)';
            element.style.outlineOffset = '2px';
            
            // Auto-scroll within modal container with delay for mobile keyboard
            setTimeout(() => {
                // Find the modal container with overflow-y-auto
                const modalContainer = document.querySelector('#checkout-modal .overflow-y-auto');
                if (!modalContainer) {
                    if (typeof debugLog === 'function') debugLog('‚ùå Modal container not found');
                    return;
                }
                
                // Get element position relative to modal container
                const elementRect = element.getBoundingClientRect();
                const containerRect = modalContainer.getBoundingClientRect();
                const elementHeight = elementRect.height;
                const containerHeight = containerRect.height;
                
                // Calculate relative position within the modal
                const elementTopInModal = elementRect.top - containerRect.top + modalContainer.scrollTop;
                
                // Calculate position to center the field in visible area, accounting for mobile keyboard
                const viewportHeight = window.innerHeight;
                const keyboardHeight = viewportHeight * 0.4; // Estimate keyboard height (40% of viewport)
                const availableHeight = Math.min(containerHeight, viewportHeight - keyboardHeight);
                const targetScrollPosition = elementTopInModal - (availableHeight / 2) + (elementHeight / 2);
                
                // Smooth scroll within modal container
                modalContainer.scrollTo({
                    top: Math.max(0, targetScrollPosition),
                    behavior: 'smooth'
                });
                
                if (typeof debugLog === 'function') debugLog('üìù Order notes field focused and centered within modal');
            }, 300); // Delay to allow keyboard animation
        }

                // Finalize order with enhanced validation
                function finalizeOrder() {
            // Collect customer data
            const customerName = document.getElementById('customer-name').value.trim();
            const paymentMethod = document.getElementById('payment-method').value;
            const customerWhatsApp = document.getElementById('customer-whatsapp').value.trim();
            
            let hasErrors = false;
            
            clearFieldError('customer-name');
            clearFieldError('payment-method');
            clearFieldError('customer-whatsapp');
            
            if (!customerName || customerName.length < 2) {
                showFieldError('customer-name', customerName ? 'Nome deve ter pelo menos 2 caracteres' : 'Nome completo √© obrigat√≥rio');
                hasErrors = true;
            }
            
            if (isWebhookActive()) {
                const countryCodeSelect = document.getElementById('country-code');
                const selectedCountryCode = countryCodeSelect ? countryCodeSelect.value : '55';
                const digitsOnly = customerWhatsApp.replace(/\D/g, '');
                const minDigits = getMinWhatsAppDigits(selectedCountryCode);
                
                if (!customerWhatsApp || digitsOnly.length < minDigits) {
                    showFieldError('customer-whatsapp', 'WhatsApp √© obrigat√≥rio e deve ter formato v√°lido para o pa√≠s selecionado');
                    hasErrors = true;
                }
            }
            
            const checkoutConfig = getCheckoutConfig();
            if (checkoutConfig.step3_show_formas_pag === 'Sim' && orderData.deliveryType !== 'local') {
                if (!paymentMethod) {
                    showFieldError('payment-method', 'Selecione a forma de pagamento');
                    hasErrors = true;
                }
                
                if (paymentMethod === 'dinheiro') {
                    const changeAmountInput = document.getElementById('change-amount');
                    const changeValue = changeAmountInput?.value?.trim() || '';
                    clearFieldError('change-amount');
                    
                    if (changeValue) {
                        const numericChangeValue = parseFloat(changeValue.replace(/[^\d,]/g, '').replace(',', '.'));
                        const cartTotal = calculateCartTotal();
                        
                        if (isNaN(numericChangeValue) || numericChangeValue <= 0) {
                            showFieldError('change-amount', 'Valor inv√°lido para troco');
                            hasErrors = true;
                        } else if (numericChangeValue <= cartTotal) {
                            showFieldError('change-amount', `Valor deve ser maior que ${formatCurrency(cartTotal)}.`);
                            hasErrors = true;
                        }
                    }
                }
            }
            
            if (hasErrors) {
                showToast('Por favor, preencha todos os campos obrigat√≥rios', 'error');
                return;
            }
            
            if (appliedCoupon) {
                if (!validateCouponDates(appliedCoupon)) {
                    clearCoupon();
                    showToast('‚ö†Ô∏è Cupom expirou durante o checkout. Confirme o pedido novamente.', 'warning', 5000);
                    return;
                }
            }
            
            orderData.customerName = customerName;
            orderData.paymentMethod = paymentMethod;
            orderData.changeAmount = document.getElementById('change-amount')?.value || '';
            orderData.notes = document.getElementById('order-notes').value;
            if (customerWhatsApp) {
                const countryCodeSelect = document.getElementById('country-code');
                const selectedCountryCode = countryCodeSelect ? countryCodeSelect.value : '55';
                orderData.customerWhatsApp = selectedCountryCode + customerWhatsApp.replace(/\D/g, '');
            } else {
                orderData.customerWhatsApp = '';
            }
            
            showToast('Preparando seu pedido...', 'success', 2000);
            
            setTimeout(() => {
                const checkoutConfig = getCheckoutConfig();
                const restaurantName = checkoutConfig.restaurant_name || 'Seu Restaurante';
                const whatsappMessage = formatOrderMessage(restaurantName);

                if (typeof WEB_APP_URL !== 'undefined' && WEB_APP_URL.trim() !== '') {
                    sendToWebhook(whatsappMessage);
                } else {
                    sendToWhatsApp(whatsappMessage);
                }
            }, 1000);
        }
        async function sendToWebhook(whatsappMessage) {
            debugLog('üöÄ Enviando pedido para o Webhook (Google Sheets)...');

            const deliveryFeeElement = document.getElementById('delivery-fee-summary');
            const deliveryFeeText = deliveryFeeElement ? deliveryFeeElement.textContent : '0';
            const deliveryFee = parseFloat(deliveryFeeText.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;

            const cartTotal = calculateCartTotal();
            const finalTotal = cartTotal + deliveryFee - (appliedCoupon ? (appliedCoupon.desconto_valor || 0) : 0);

            const payload = {
                customerName: orderData.customerName,
                customerPhone: orderData.customerWhatsApp,
                customerAddress: `${orderData.deliveryType === 'delivery' ? `${orderData.address}, ${orderData.neighborhood}` : 'Retirada no local'}`,
                items: cart.map(item => `${item.name} (x${item.quantity})`).join(', '),
                total: formatCurrency(finalTotal),
                paymentMethod: orderData.paymentMethod
            };

            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: {'Content-Type': 'application/json'},
                    redirect: 'follow',
                    body: JSON.stringify(payload)
                });

                showToast('‚úÖ Pedido enviado com sucesso!', 'success', 4000);

                // Agora, envia a mensagem j√° formatada para o WhatsApp
                sendToWhatsApp(whatsappMessage);

                // Limpa o carrinho e fecha os modais ap√≥s um tempo
                setTimeout(() => {
                    const checkoutModal = document.getElementById('checkout-modal');
                    if (checkoutModal) {
                        checkoutModal.classList.add('hidden');
                    }
                    const cartModal = document.getElementById('cart-modal');
                    if (cartModal) {
                        cartModal.classList.remove('flex');
                        cartModal.classList.add('hidden');
                    }
                    clearCart();
                    // A atualiza√ß√£o da p√°gina foi removida conforme solicitado.
                }, 4000);

            } catch (error) {
                errorLog('‚ùå Erro ao enviar pedido para o Webhook:', error);
                showToast('Falha ao enviar o pedido. Tente novamente.', 'error', 5000);
            }
        }
        // Format money input
        // Currency configuration object
        const currencyConfig = {
            // Am√©ricas
            'BRL': { symbol: 'R$', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'USD': { symbol: '$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'CAD': { symbol: 'C$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'MXN': { symbol: '$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'ARS': { symbol: '$', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'CLP': { symbol: '$', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'COP': { symbol: '$', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'PEN': { symbol: 'S/', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'PYG': { symbol: '‚Ç≤', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'UYU': { symbol: '$U', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            
            // Europa
            'EUR': { symbol: '‚Ç¨', decimalSeparator: ',', thousandSeparator: '.', position: 'after' },
            'GBP': { symbol: '¬£', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'CHF': { symbol: 'CHF', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'SEK': { symbol: 'kr', decimalSeparator: ',', thousandSeparator: ' ', position: 'after' },
            'NOK': { symbol: 'kr', decimalSeparator: ',', thousandSeparator: ' ', position: 'after' },
            'DKK': { symbol: 'kr', decimalSeparator: ',', thousandSeparator: '.', position: 'after' },
            'PLN': { symbol: 'z≈Ç', decimalSeparator: ',', thousandSeparator: ' ', position: 'after' },
            'CZK': { symbol: 'Kƒç', decimalSeparator: ',', thousandSeparator: ' ', position: 'after' },
            'HUF': { symbol: 'Ft', decimalSeparator: ',', thousandSeparator: ' ', position: 'after' },
            'RUB': { symbol: '‚ÇΩ', decimalSeparator: ',', thousandSeparator: ' ', position: 'after' },
            'TRY': { symbol: '‚Ç∫', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'ILS': { symbol: '‚Ç™', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            
            // √Åsia & Oriente M√©dio
            'JPY': { symbol: '¬•', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'CNY': { symbol: '¬•', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'KRW': { symbol: '‚Ç©', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'INR': { symbol: '‚Çπ', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'IDR': { symbol: 'Rp', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'THB': { symbol: '‡∏ø', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'MYR': { symbol: 'RM', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'SGD': { symbol: 'S$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'AED': { symbol: 'ÿØ.ÿ•', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'SAR': { symbol: 'ÿ±.ÿ≥', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'KWD': { symbol: 'ÿØ.ŸÉ', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'AFN': { symbol: 'ÿã', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'BDT': { symbol: '‡ß≥', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'IRR': { symbol: 'Ô∑º', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'LKR': { symbol: 'Rs', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'TWD': { symbol: 'NT$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'VND': { symbol: '‚Ç´', decimalSeparator: ',', thousandSeparator: '.', position: 'after' },
            
            // √Åfrica
            'AOA': { symbol: 'Kz', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'ZAR': { symbol: 'R', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'NGN': { symbol: '‚Ç¶', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'EGP': { symbol: 'ÿ¨.ŸÖ', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'KES': { symbol: 'KSh', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'GHS': { symbol: '‚Çµ', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'MAD': { symbol: 'ÿØ.ŸÖ.', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'DZD': { symbol: 'ÿØ.ÿ¨', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'TND': { symbol: 'ÿØ.ÿ™', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            
            // Oceania
            'AUD': { symbol: 'A$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'NZD': { symbol: 'NZ$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'FJD': { symbol: 'FJ$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' }
        };

        // Get current currency from configuration
        function getCurrentCurrency() {
            const checkoutConfig = getCheckoutConfig();
            return checkoutConfig.checkout_currency || 'BRL';
        }

        // Get currency configuration
        function getCurrencyConfig() {
            const currency = getCurrentCurrency();
            return currencyConfig[currency] || currencyConfig['BRL'];
        }

        /**
         * Fun√ß√£o para escurecer uma cor em 30%
         * @param {string} cor - Cor em formato hexadecimal, RGB ou vari√°vel CSS
         * @returns {string} - Cor escurecida em formato hexadecimal
         */
        function escurecerCor30Porcento(cor) {
            // Se a cor estiver no formato var(--variavel), usar cor padr√£o
            if (cor.includes('var(')) {
                cor = '#6B7280'; // Cor terci√°ria padr√£o
            }
            
            // Remover espa√ßos e # se existir
            cor = cor.replace(/\s/g, '').replace('#', '');
            
            // Se a cor estiver em formato RGB, converter para hex
            if (cor.includes('rgb')) {
                const rgbMatch = cor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                if (rgbMatch) {
                    const r = parseInt(rgbMatch[1]);
                    const g = parseInt(rgbMatch[2]);
                    const b = parseInt(rgbMatch[3]);
                    cor = r.toString(16).padStart(2, '0') + 
                          g.toString(16).padStart(2, '0') + 
                          b.toString(16).padStart(2, '0');
                }
            }
            
            // Garantir que temos uma cor hex v√°lida
            if (cor.length !== 6) {
                cor = '6B7280'; // Fallback para cor terci√°ria
            }
            
            // Converter para RGB
            let r = parseInt(cor.substring(0, 2), 16);
            let g = parseInt(cor.substring(2, 4), 16);
            let b = parseInt(cor.substring(4, 6), 16);
            
            // Escurecer cada componente em 30%
            r = Math.floor(r * 0.7); // 30% mais escuro = multiplicar por 0.7
            g = Math.floor(g * 0.7);
            b = Math.floor(b * 0.7);
            
            // Garantir que os valores est√£o no intervalo v√°lido
            r = Math.max(0, Math.min(255, r));
            g = Math.max(0, Math.min(255, g));
            b = Math.max(0, Math.min(255, b));
            
            // Converter de volta para hexadecimal
            return '#' + 
                   r.toString(16).padStart(2, '0') + 
                   g.toString(16).padStart(2, '0') + 
                   b.toString(16).padStart(2, '0');
        }
        
        // Format currency value for display
        function formatCurrency(value) {
            const config = getCurrencyConfig();
            
            // Converter para n√∫mero se for string
            const numValue = typeof value === 'string' ? parseFloat(value) : value;
            
            // Separar parte inteira e decimal
            const [integerPart, decimalPart] = numValue.toFixed(2).split('.');
            
            // Aplicar separador de milhares na parte inteira
            const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, config.thousandSeparator);
            
            // Montar valor final com separador decimal correto
            const formattedValue = `${formattedInteger}${config.decimalSeparator}${decimalPart}`;
            
            if (config.position === 'before') {
                return `${config.symbol} ${formattedValue}`;
            } else {
                return `${formattedValue} ${config.symbol}`;
            }
        }

        function formatMoney(input) {
            const config = getCurrencyConfig();
            let value = input.value.replace(/\D/g, '');
            
            if (value === '') {
                input.value = '';
                return;
            }
            
            // Convert to number and format
            value = parseInt(value);
            value = (value / 100).toFixed(2);
            
            // Format with current currency
            const formattedValue = value.replace('.', config.decimalSeparator);
            if (config.position === 'before') {
                input.value = `${config.symbol} ${formattedValue}`;
            } else {
                input.value = `${formattedValue} ${config.symbol}`;
            }
        }

        // Get numeric value from formatted money
        function getNumericValue(formattedValue) {
            if (!formattedValue) return 0;
            const config = getCurrencyConfig();
            
            // Remove currency symbol and convert back to number
            let cleanValue = formattedValue.replace(config.symbol, '').trim();
            cleanValue = cleanValue.replace(config.decimalSeparator, '.');
            
            return parseFloat(cleanValue) || 0;
        }

        // ===== SISTEMA DE PRE√áOS M√öLTIPLOS - FUN√á√ïES AUXILIARES =====
        
        // Fun√ß√£o de parsing inteligente internacional
        function parsePrice(priceString) {
            try {
                if (!priceString || priceString === '' || priceString === null || priceString === undefined) return 0;
            
            const config = getCurrencyConfig();
            let cleanValue = priceString.toString().trim();
            
            // Remove s√≠mbolos de moeda
            cleanValue = cleanValue.replace(/[^\d.,\-\s]/g, '');
            
            // Detectar formato baseado na configura√ß√£o da moeda
            if (config.decimalSeparator === ',' && config.thousandSeparator === '.') {
                // Formato brasileiro/europeu: 1.500,50
                if (cleanValue.includes(',') && cleanValue.includes('.')) {
                    // Tem ambos: √∫ltimo √© decimal
                    const lastComma = cleanValue.lastIndexOf(',');
                    const lastDot = cleanValue.lastIndexOf('.');
                    
                    if (lastComma > lastDot) {
                        // V√≠rgula √© decimal: 1.500,50
                        cleanValue = cleanValue.replace(/\./g, '').replace(',', '.');
                    } else {
                        // Ponto √© decimal: 1,500.50 (formato misto)
                        cleanValue = cleanValue.replace(/,/g, '');
                    }
                } else if (cleanValue.includes(',')) {
                    // S√≥ v√≠rgula: pode ser decimal ou milhares
                    const parts = cleanValue.split(',');
                    if (parts.length === 2 && parts[1].length <= 2) {
                        // Provavelmente decimal: 15,50
                        cleanValue = cleanValue.replace(',', '.');
                    } else {
                        // Provavelmente milhares: 1,500
                        cleanValue = cleanValue.replace(/,/g, '');
                    }
                }
            } else {
                // Formato americano: 1,500.50
                if (cleanValue.includes(',') && cleanValue.includes('.')) {
                    const lastComma = cleanValue.lastIndexOf(',');
                    const lastDot = cleanValue.lastIndexOf('.');
                    
                    if (lastDot > lastComma) {
                        // Ponto √© decimal: 1,500.50
                        cleanValue = cleanValue.replace(/,/g, '');
                    } else {
                        // V√≠rgula √© decimal: 1.500,50 (formato misto)
                        cleanValue = cleanValue.replace(/\./g, '').replace(',', '.');
                    }
                } else if (cleanValue.includes('.')) {
                    // S√≥ ponto: pode ser decimal ou milhares
                    const parts = cleanValue.split('.');
                    if (parts.length === 2 && parts[1].length <= 2) {
                        // Provavelmente decimal: 15.50
                        // J√° est√° no formato correto
                    } else {
                        // Provavelmente milhares: 1.500
                        cleanValue = cleanValue.replace(/\./g, '');
                    }
                }
            }
            
            return parseFloat(cleanValue) || 0;
            } catch (error) {
                errorLog('Erro em parsePrice:', error, 'priceString:', priceString);
                return 0;
            }
        }
        
        // Detectar tipo de pre√ßo
        function getPriceType(priceField) {
            // Converter para string e validar
            if (!priceField || priceField === null || priceField === undefined) {
                return 'consultation';
            }
            
            const priceStr = String(priceField).trim();
            
            if (priceStr === '' || priceStr.toLowerCase().includes('consulte')) {
                return 'consultation';
            }
            
            // Detectar pre√ßos m√∫ltiplos (formato: Nome:Pre√ßo/Nome:Pre√ßo)
            // Aceita tanto ponto quanto v√≠rgula como decimal
            if (priceStr.includes('/') && priceStr.includes(':')) {
                return 'multiple';
            }
            
            return 'fixed';
        }
        

        
        // Parsing de pre√ßos m√∫ltiplos (formato: Label#Varia√ß√£o:Pre√ßo/Varia√ß√£o:Pre√ßo)
        function parseMultiplePrices(priceField) {
            if (!priceField || priceField.trim() === '') return [];
            
            if (typeof debugLog === 'function') {
                debugLog('üîç Parsing multiple prices:', priceField);
            }
            
            // Primeiro, verificar se h√° um hashtag (formato: "Label#Varia√ß√µes")
            let variationsString = priceField;
            if (priceField.includes('#')) {
                const hashtagParts = priceField.split('#');
                if (hashtagParts.length >= 2) {
                    // Pegar tudo ap√≥s o primeiro hashtag como as varia√ß√µes
                    variationsString = hashtagParts.slice(1).join('#');
                    
                    if (typeof debugLog === 'function') {
                        debugLog('üìã Label encontrado:', hashtagParts[0].trim());
                        debugLog('üéØ Varia√ß√µes extra√≠das:', variationsString);
                    }
                }
            }
            
            // Agora processar as varia√ß√µes (formato: Nome:Pre√ßo/Nome:Pre√ßo)
            const items = variationsString.split('/');
            
            const result = items.map(item => {
                const parts = item.split(':');
                
                if (parts.length !== 2) {
                    if (typeof warnLog === 'function') {
                        warnLog('‚ö†Ô∏è Formato inv√°lido para varia√ß√£o:', item);
                    }
                    return null;
                }
                
                const [name, price] = parts;
                const cleanName = name.trim();
                const cleanPrice = price.trim();
                const parsedPrice = parsePrice(cleanPrice);
                
                if (typeof debugLog === 'function') {
                    debugLog(`üìä Varia√ß√£o parsed: "${cleanName}" = ${parsedPrice}`);
                }
                
                return {
                    name: cleanName,
                    price: parsedPrice
                };
            }).filter(item => item !== null);
            
            if (typeof debugLog === 'function') {
                debugLog('‚úÖ Final parsed variations:', result);
            }
            
            return result;
        }
        
        // Extra√ß√£o do label din√¢mico (parte antes do hashtag)
        function getMultiplePricesLabel(priceField) {
            if (!priceField || priceField.trim() === '') return 'Selecione o tamanho';
            
            if (priceField.includes('#')) {
                const hashtagParts = priceField.split('#');
                if (hashtagParts.length >= 2) {
                    const label = hashtagParts[0].trim();
                    if (typeof debugLog === 'function') {
                        debugLog('üè∑Ô∏è Label extra√≠do:', label);
                    }
                    return label || 'Selecione o tamanho';
                }
            }
            
            // Fallback para formato antigo sem hashtag
            return 'Selecione o tamanho';
        }
        
        // Exibi√ß√£o de pre√ßo para o span base-price (apenas texto)
        function getBasePriceDisplay(priceField) {
            try {
                const type = getPriceType(priceField);
                
                switch(type) {
                    case 'consultation':
                        return 'üí¨ Consulte';
                        
                    case 'multiple':
                        const prices = parseMultiplePrices(priceField);
                        if (prices.length === 0) {
                            return 'üí¨ Consulte';
                        }
                        const values = prices.map(p => p.price);
                        const min = Math.min(...values);
                        const max = Math.max(...values);
                        return `${formatCurrency(min)} - ${formatCurrency(max)}`;
                        
                    case 'fixed':
                    default:
                        const price = parsePrice(priceField);
                        return formatCurrency(price);
                }
            } catch (error) {
                errorLog('Erro em getBasePriceDisplay:', error, 'priceField:', priceField);
                return 'üí¨ Consulte';
            }
        }

        
        // Exibi√ß√£o inteligente de pre√ßos
        function getPriceDisplay(priceField) {
            try {
                const type = getPriceType(priceField);
                
                switch(type) {
                    case 'consultation':
                        return '<span style="color: var(--cor-secundaria); font-weight: bold;">üí¨ Consulte</span>';
                        
                    case 'multiple':
                        const prices = parseMultiplePrices(priceField);
                        if (prices.length === 0) {
                            return '<span style="color: var(--cor-secundaria); font-weight: bold;">üí¨ Consulte</span>';
                        }
                        const values = prices.map(p => p.price);
                        const min = Math.min(...values);
                        const max = Math.max(...values);
                        return `${formatCurrency(min)} - ${formatCurrency(max)}`;
                        
                    case 'fixed':
                    default:
                        const price = parsePrice(priceField);
                        return formatCurrency(price);
                }
            } catch (error) {
                errorLog('Erro em getPriceDisplay:', error, 'priceField:', priceField);
                return '<span style="color: var(--cor-secundaria); font-weight: bold;">üí¨ Consulte</span>';
            }
        }

        function sendToWhatsApp(message) {
            // Verifica√ß√£o robusta para garantir que os dados de configura√ß√£o foram carregados.
            if (typeof allData === 'undefined' || !allData.config || !allData.config[0] || !allData.config[0].restaurant_phone_number) {
                errorLog('Falha no envio para o WhatsApp: a configura√ß√£o ainda n√£o foi carregada.');
                showToast('Aguarde! O card√°pio est√° carregando. Tente novamente em instantes.', 'warning');
                return;
            }

            const restaurantWhatsApp = allData.config[0].restaurant_phone_number;

            // Segunda verifica√ß√£o, apenas por seguran√ßa.
            if (!restaurantWhatsApp) {
                errorLog('ERRO CR√çTICO: N√∫mero do WhatsApp √© inv√°lido ou n√£o foi configurado na planilha.');
                showToast('Erro cr√≠tico: WhatsApp n√£o configurado.', 'error');
                return;
            }

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${restaurantWhatsApp}?text=${encodedMessage}`;

            window.open(whatsappUrl, '_blank');
        }
        
        // Format order message
        function formatOrderMessage(restaurantName) {
            if (typeof debugLog === 'function') {
                debugLog('=== DEBUG FORMAT ORDER MESSAGE ===');
                debugLog('restaurantName:', restaurantName);
                debugLog('orderData:', orderData);
                debugLog('cart:', cart);
                debugLog('===================================');
            }
            
            let message = `üîî *NOVO PEDIDO* üîî\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            
            // Customer info
            message += `üë§ *Cliente:* ${orderData.customerName}\n`;
            if (orderData.customerWhatsApp) {
                message += `üì± *WhatsApp:* ${orderData.customerWhatsApp}\n`;
            }
            
            // Delivery type
            const deliveryTypes = {
                'local': 'üçΩÔ∏è Consumir no Local',
                'pickup': 'ü•° Retirar no Balc√£o', 
                'delivery': 'üõµ Delivery',
                'default': 'üìã Padr√£o'
            };
            message += `üìç *Entrega:* ${deliveryTypes[orderData.deliveryType]}\n`;
            
            // Additional info based on delivery type
            if (orderData.deliveryType === 'local' && orderData.tableNumber) {
                message += `ü™ë *Mesa/Comanda:* ${orderData.tableNumber}\n`;
            }
            
            // Debug da condi√ß√£o de endere√ßo
            debugLog('DEBUG - Condi√ß√£o de endere√ßo:');
            debugLog('deliveryType:', orderData.deliveryType);
            debugLog('orderData.address:', orderData.address);
            debugLog('orderData.address.street:', orderData.address.street);
            debugLog('Condi√ß√£o atendida?', orderData.deliveryType === 'delivery' && orderData.address.street);
            
            if (orderData.deliveryType === 'delivery' && orderData.address.street) {
                message += `üè† *Endere√ßo:*\n`;
                
                // Verificar se √© endere√ßo manual ou autom√°tico
                debugLog('DEBUG - Verificando tipo de endere√ßo:');
                debugLog('isManual:', orderData.address.isManual);
                debugLog('deliveryFee:', orderData.address.deliveryFee);
                
                if (orderData.address.isManual) {
                    // Endere√ßo manual - formato diferenciado
                    message += `   ${orderData.address.street}\n`;
                    message += `   ${orderData.address.neighborhood}\n`;
                    message += `   ${orderData.address.city}\n`;
                    message += `   *Endere√ßo informado manualmente*\n`;
                } else {
                    // Endere√ßo autom√°tico via CEP - formato original
                    message += `   ${orderData.address.street}, ${orderData.address.number}`;
                    if (orderData.address.complement) {
                        message += ` - ${orderData.address.complement}`;
                    }
                    message += `\n   ${orderData.address.neighborhood}\n`;
                    message += `   ${orderData.address.city} - ${orderData.address.state}\n`;
                    message += `   CEP: ${orderData.address.cep}\n`;
                }
                
                // Adicionar taxa de delivery se existir (funciona para ambos os modos)
                debugLog('DEBUG - Verificando taxa de delivery:');
                debugLog('orderData.address:', orderData.address);
                debugLog('orderData.address.deliveryFee:', orderData.address.deliveryFee);
                debugLog('currentDeliveryFee:', currentDeliveryFee);
                
                // Usar orderData.address.deliveryFee ou currentDeliveryFee como fallback
                const deliveryFee = orderData.address.deliveryFee || currentDeliveryFee;
                debugLog('deliveryFee final:', deliveryFee);
                
                if (deliveryFee && deliveryFee > 0) {
                    message += `\nüöö *Taxa de Delivery:* ${formatCurrency(deliveryFee)} (${orderData.address.neighborhood})\n`;
                    debugLog('Taxa de delivery adicionada √† mensagem:', deliveryFee);
                } else {
                    debugLog('Taxa de delivery N√ÉO adicionada - nenhuma taxa encontrada');
                }
            }
            
            message += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            message += `üõçÔ∏è *ITENS DO PEDIDO:*\n\n`;
            
            // Items
            cart.forEach(item => {
                // Verificar se o item tem pre√ßo v√°lido
                const itemPrice = parseFloat(item.preco);
                const hasValidPrice = !isNaN(itemPrice) && itemPrice > 0;
                const itemSubtotal = hasValidPrice ? itemPrice * item.quantity : 0;
                
                message += `‚Ä¢ *${item.nome}* (${item.sku})\n`;
                if (item.variationText) {
                    // Melhorar formata√ß√£o das varia√ß√µes no WhatsApp - substituir pipes por quebras de linha
                    const formattedVariations = item.variationText.replace(/\s*\|\s*/g, '\n     ');
                    message += `  ‚îî ‚úì ${formattedVariations}\n`;
                }
                if (item.removalText) {
                    // Melhorar formata√ß√£o das remo√ß√µes no WhatsApp - substituir pipes por quebras de linha
                    const formattedRemovals = item.removalText.replace(/\s*\|\s*/g, '\n     ');
                    // Remover duplica√ß√£o do texto "Remover Ingredientes:" se j√° estiver presente
                    const cleanRemovals = formattedRemovals.replace(/^Remover Ingredientes:\s*/i, '');
                    message += `  ‚îî üö´ Remover Ingredientes: ${cleanRemovals}\n`;
                }
                if (item.notes) {
                    message += `  ‚îî Obs: ${item.notes}\n`;
                }
                
                // Exibir pre√ßo baseado na validade com formata√ß√£o melhorada
                if (hasValidPrice) {
                    message += `  ‚îî üìä Qtd: ${item.quantity}x\n`;
                    message += `  ‚îî üí∞ Unit√°rio: ${formatCurrency(itemPrice)}\n`;
                    message += `  ‚îî üßÆ Subtotal: ${formatCurrency(itemSubtotal)}\n\n\n`;
                } else {
                    message += `  ‚îî üìä Qtd: ${item.quantity}x\n`;
                    message += `  ‚îî üí∞ Pre√ßo: üí¨ Consulte\n\n\n`;
                }
            });
            
            // Total com breakdown detalhado - calcular apenas itens com pre√ßo v√°lido
            let subtotal = cart.reduce((sum, item) => {
                const itemPrice = parseFloat(item.preco);
                if (isNaN(itemPrice) || itemPrice <= 0) {
                    return sum; // Ignora itens de consulta
                }
                return sum + (itemPrice * item.quantity);
            }, 0);
            let total = subtotal;
            
            // Adicionar taxa de delivery ao total se existir
            debugLog('DEBUG - Calculando total com taxa:');
            debugLog('Subtotal produtos:', subtotal);
            debugLog('deliveryType:', orderData.deliveryType);
            debugLog('address:', orderData.address);
            
            // Usar orderData.address.deliveryFee ou currentDeliveryFee como fallback
            const totalDeliveryFee = (orderData.address && orderData.address.deliveryFee) || currentDeliveryFee;
            debugLog('totalDeliveryFee:', totalDeliveryFee);
            
            if (orderData.deliveryType === 'delivery' && totalDeliveryFee && totalDeliveryFee > 0) {
                total += totalDeliveryFee;
                debugLog('Taxa adicionada ao total:', totalDeliveryFee);
            }
            
            // Verificar se h√° itens de consulta e itens com pre√ßo
            const hasConsultationItems = cart.some(item => {
                const itemPrice = parseFloat(item.preco);
                return isNaN(itemPrice) || itemPrice <= 0;
            });
            
            const hasPricedItems = cart.some(item => {
                const itemPrice = parseFloat(item.preco);
                return !isNaN(itemPrice) && itemPrice > 0;
            });
            
            // ‚úÖ L√ìGICA: S√≥ mostrar resumo financeiro se houver itens com pre√ßo
            if (hasPricedItems) {
                message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                message += `üí∞ *RESUMO FINANCEIRO:*\n\n`;
                
                // Breakdown detalhado
                if (hasConsultationItems) {
                    message += `üíµ Subtotal produtos: ${formatCurrency(subtotal)} + itens para consulta\n`;
                } else {
                    message += `üíµ Subtotal produtos: ${formatCurrency(subtotal)}\n`;
                }
                
                if (orderData.deliveryType === 'delivery' && totalDeliveryFee && totalDeliveryFee > 0) {
                    message += `üöö Taxa de delivery: ${formatCurrency(totalDeliveryFee)}\n`;
                }
                
                // Mostrar total antes do desconto se houver cupom
                if (appliedCoupon && couponDiscount > 0) {
                    message += `Total: ${formatCurrency(total)}\n`;
                }
                
                // Adicionar informa√ß√µes do cupom se aplicado
                if (appliedCoupon && couponDiscount > 0) {
                    const discountType = appliedCoupon.tipo_desconto || appliedCoupon.tipo || '';
                    let typeText = '';
                    
                    switch (discountType.toLowerCase()) {
                        case 'produtos':
                            typeText = 'nos produtos';
                            break;
                        case 'frete':
                            typeText = 'no frete';
                            break;
                        case 'total':
                            typeText = 'no total';
                            break;
                    }
                    
                    message += `üéüÔ∏è Cupom ${appliedCoupon.codigo_cupom || appliedCoupon.codigo}: -${formatCurrency(couponDiscount)} (${typeText})\n`;
                    total = Math.max(0, total - couponDiscount);
                    debugLog('Desconto aplicado:', couponDiscount, 'Total final:', total);
                }
                
                message += `\nüí∞ *TOTAL FINAL: ${formatCurrency(total)}*\n`;
                message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            } else {
                // ‚úÖ TODOS OS ITENS S√ÉO DE CONSULTA - N√ÉO MOSTRAR RESUMO FINANCEIRO
                debugLog('üìù Todos os itens s√£o de consulta - resumo financeiro omitido');
                message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                message += `üí¨ *Valores para consulta no estabelecimento*\n`;
                message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            }
            
            // Payment info (only for pickup, delivery, default AND if payment field is enabled AND if there are priced items)
            const checkoutConfig = getCheckoutConfig();
            const deliveryTypesWithPayment = ['pickup', 'delivery', 'default'];
            if (deliveryTypesWithPayment.includes(orderData.deliveryType) && checkoutConfig.step3_show_formas_pag === 'Sim' && hasPricedItems) {
                // Get payment methods from spreadsheet configuration
                const configuredMethods = checkoutConfig.step3_formas_pag;
                const paymentMethods = {};
                
                if (configuredMethods && configuredMethods.trim() !== '') {
                    // Parse configured payment methods
                    const methodsList = configuredMethods.split(',').map(method => method.trim());
                    
                    // Create dynamic mapping with emojis
                    methodsList.forEach(method => {
                        const methodKey = method.toLowerCase().replace(/\s+/g, '-');
                        let emoji = 'üí≥'; // Default credit card emoji
                        
                        // Assign specific emojis based on method name
                        if (method.toLowerCase().includes('dinheiro')) {
                            emoji = 'üíµ';
                        } else if (method.toLowerCase().includes('pix')) {
                            emoji = 'üì±';
                        } else if (method.toLowerCase().includes('cart√£o') || method.toLowerCase().includes('cartao')) {
                            emoji = 'üí≥';
                        } else if (method.toLowerCase().includes('alelo') || method.toLowerCase().includes('vale') || method.toLowerCase().includes('ticket')) {
                            emoji = 'üé´'; // Simpler ticket emoji
                        }
                        
                        paymentMethods[methodKey] = `${emoji} ${method}`;
                    });
                }
                
                // S√≥ incluir se paymentMethod estiver definido
                if (orderData.paymentMethod && paymentMethods[orderData.paymentMethod]) {
                    message += `\nüí≥ *Pagamento:* ${paymentMethods[orderData.paymentMethod]}\n`;
                    
                    if (orderData.paymentMethod === 'dinheiro' && orderData.changeAmount) {
                        const changeValue = getNumericValue(orderData.changeAmount);
                        message += `üí∏ *Troco para:* ${formatCurrency(changeValue)}\n`;
                    }
                    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                }
            }
            
            // Notes
            if (orderData.notes) {
                message += `\nüìù *Observa√ß√µes:*\n${orderData.notes}\n`;
                message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            }
            
            message += `\n‚è∞ *Pedido realizado em:* ${new Date().toLocaleString('pt-BR')}\n`;
            message += `\n‚úÖ *Aguardando confirma√ß√£o do estabelecimento*`;
            
            return message;
        }
        
        // Format order message for thermal printing (no emojis, clean format)
        function formatOrderMessageThermal(restaurantName) {
            if (typeof debugLog === 'function') {
                debugLog('=== DEBUG FORMAT THERMAL MESSAGE ===');
                debugLog('restaurantName:', restaurantName);
                debugLog('orderData:', orderData);
                debugLog('cart:', cart);
                debugLog('=====================================');
            }
            
            let message = `NOVO PEDIDO\n`;
            message += `================================\n\n`;
            
            // Customer info
            message += `Cliente: ${orderData.customerName}\n`;
            if (orderData.customerWhatsApp) {
                message += `WhatsApp: ${orderData.customerWhatsApp}\n`;
            }
            
            // Delivery type
            const deliveryTypes = {
                'local': 'Consumir no Local',
                'pickup': 'Retirar no Balcao', 
                'delivery': 'Delivery',
                'default': 'Padrao'
            };
            message += `Entrega: ${deliveryTypes[orderData.deliveryType]}\n`;
            
            // Additional info based on delivery type
            if (orderData.deliveryType === 'local' && orderData.tableNumber) {
                message += `Mesa: ${orderData.tableNumber}\n`;
            }
            
            if (orderData.deliveryType === 'delivery' && orderData.address) {
                message += `Endereco: ${orderData.address}\n`;
            }
            
            message += `\n================================\n`;
            message += `ITENS DO PEDIDO:\n\n`;
            
            // Items
            let hasConsultationItems = false;
            cart.forEach(item => {
                const itemPrice = (typeof parsePrice === 'function') ? parsePrice(item.preco) : parseFloat(String(item.preco).replace(/[^0-9.,]/g, '').replace(',', '.'));
                const hasValidPrice = !isNaN(itemPrice) && itemPrice > 0;
                const itemSubtotal = hasValidPrice ? itemPrice * item.quantity : 0;
                
                if (!hasValidPrice) {
                    hasConsultationItems = true;
                }
                
                message += `- ${item.nome} (${item.sku})\n`;
                if (item.variationText) {
                    // Remove emojis e formata para impressao termica
                    const cleanVariations = item.variationText.replace(/\s*\|\s*/g, '\n  ');
                    message += `  Variacoes: ${cleanVariations}\n`;
                }
                if (item.removalText) {
                    // Remove emojis e duplicacao
                    const cleanRemovals = item.removalText.replace(/\s*\|\s*/g, '\n  ').replace(/^Remover Ingredientes:\s*/i, '');
                    message += `  Remover: ${cleanRemovals}\n`;
                }
                if (item.notes) {
                    message += `  Obs: ${item.notes}\n`;
                }
                
                // Pricing info
                if (hasValidPrice) {
                    message += `  Qtd: ${item.quantity}x\n`;
                    message += `  Unitario: ${formatCurrency(itemPrice)}\n`;
                    message += `  Subtotal: ${formatCurrency(itemSubtotal)}\n\n`;
                } else {
                    message += `  Qtd: ${item.quantity}x\n`;
                    message += `  Preco: Consulte\n\n`;
                }
            });
            
            // Financial summary
            // Usa o cupom aplicado globalmente, se existir
            const coupon = (typeof appliedCoupon !== 'undefined' && appliedCoupon) ? appliedCoupon : null;
            let couponDiscount = (typeof window.couponDiscount === 'number') ? window.couponDiscount : 0;
            if (coupon && (!couponDiscount || couponDiscount <= 0) && typeof calculateCouponDiscount === 'function') {
                try {
                    couponDiscount = calculateCouponDiscount(coupon) || 0;
                } catch (_) { /* noop */ }
            }
            
            // Calculate totals
            let subtotal = cart.reduce((sum, item) => {
                const price = (typeof parsePrice === 'function') ? parsePrice(item.preco) : parseFloat(String(item.preco).replace(/[^0-9.,]/g, '').replace(',', '.'));
                const hasValidPrice = !isNaN(price) && price > 0;
                return sum + (hasValidPrice ? price * item.quantity : 0);
            }, 0);
            
            const totalDeliveryFee = (orderData && orderData.deliveryType === 'delivery')
                ? ((orderData.address && typeof orderData.address.deliveryFee !== 'undefined')
                    ? orderData.address.deliveryFee
                    : (typeof currentDeliveryFee !== 'undefined' && currentDeliveryFee !== null ? currentDeliveryFee : 0))
                : 0;
            let total = subtotal + totalDeliveryFee - couponDiscount;
            
            if (subtotal > 0 || totalDeliveryFee > 0 || couponDiscount > 0) {
                message += `================================\n`;
                message += `RESUMO FINANCEIRO:\n\n`;
                
                if (hasConsultationItems) {
                    message += `Subtotal produtos: ${formatCurrency(subtotal)} + itens para consulta\n`;
                } else {
                    message += `Subtotal produtos: ${formatCurrency(subtotal)}\n`;
                }
                
                if (orderData.deliveryType === 'delivery' && totalDeliveryFee && totalDeliveryFee > 0) {
                    message += `Taxa de delivery: ${formatCurrency(totalDeliveryFee)}\n`;
                }
                
                if (coupon && couponDiscount > 0) {
                    message += `Total: ${formatCurrency(total)}\n`;
                    const discountType = coupon.tipo_desconto || coupon.tipo || '';
                    let typeText = '';
                    
                    switch (discountType.toLowerCase()) {
                        case 'produtos':
                            typeText = 'nos produtos';
                            break;
                        case 'frete':
                            typeText = 'no frete';
                            break;
                        case 'total':
                            typeText = 'no total';
                            break;
                        default:
                            typeText = 'aplicado';
                    }
                    
                    const couponCode = coupon.codigo_cupom || coupon.codigo || '';
                    message += `Cupom ${couponCode} (${typeText}): -${formatCurrency(couponDiscount)}\n`;
                }
                
                message += `--------------------------------\n`;
                message += `TOTAL FINAL: ${formatCurrency(total)}\n`;
            }
            
            // Payment method
            const paymentMethods = {
                'dinheiro': 'Dinheiro',
                'cartao': 'Cartao',
                'pix': 'PIX',
                'default': 'Nao informado'
            };
            message += `\nForma de pagamento: ${paymentMethods[orderData.paymentMethod] || paymentMethods.default}\n`;
            
            if (orderData.paymentMethod === 'dinheiro' && orderData.changeAmount) {
                message += `Troco para: ${formatCurrency(orderData.changeAmount)}\n`;
                const changeValue = orderData.changeAmount - total;
                if (changeValue > 0) {
                    message += `Valor do troco: ${formatCurrency(changeValue)}\n`;
                }
            }
            
            // Notes
            if (orderData.notes) {
                message += `\nObservacoes: ${orderData.notes}\n`;
            }
            
            message += `\nPedido realizado em: ${new Date().toLocaleString('pt-BR')}\n`;
            message += `\nAguardando confirmacao do estabelecimento`;
            
            return message;
        }
        
        // Send via WhatsApp Web (cross-platform)
        function sendViaWhatsAppWeb(phoneNumber, message) {
            debugLog('=== DEBUG WHATSAPP WEB ===');
            debugLog('phoneNumber:', phoneNumber);
            debugLog('message length:', message.length);
            debugLog('message preview:', message.substring(0, 100) + '...');
            
            // Use standard encodeURIComponent which properly handles emojis
            const encodedMessage = encodeURIComponent(message);
            debugLog('encodedMessage length:', encodedMessage.length);
            
            // Use api.whatsapp.com like ref.html for better compatibility
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}`;
            debugLog('whatsappUrl:', whatsappUrl.substring(0, 150) + '...');
            
            // Show success message
            showCustomAlert('Pedido enviado com sucesso! Redirecionando para WhatsApp...', 'success');
            
            // Reset completo do sistema ap√≥s prepara√ß√£o do WhatsApp
            resetSystemAfterOrder();
            debugLog('Sistema resetado completamente ap√≥s envio');
            
            // Delay to show success message, then open WhatsApp
            setTimeout(() => {
                debugLog('Attempting to open WhatsApp...');
                try {
                    // Try to open in new window with fallback like ref.html
                    debugLog('Trying to open in new window...');
                    const newWindow = window.open(whatsappUrl, '_blank');
                    debugLog('New window result:', newWindow);
                    
                    if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                        // If failed to open in new window, try same window
                        debugLog('Fallback: Opening in same window');
                        window.location.href = whatsappUrl;
                    } else {
                        debugLog('Successfully opened WhatsApp in new window');
                    }
                } catch (error) {
                    errorLog('Error opening window:', error);
                    // Fallback to wa.me if api.whatsapp.com fails
                    try {
                        const waUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                        debugLog('Trying alternative method:', waUrl);
                        window.location.href = waUrl;
                    } catch (fallbackError) {
                        errorLog('Fallback method failed:', fallbackError);
                        showCustomAlert('N√£o foi poss√≠vel abrir o WhatsApp. Tente novamente.', 'error');
                    }
                }
            }, 1500);
        }
        
        /**
         * Reset completo do sistema ap√≥s envio do pedido
         */
        function resetSystemAfterOrder() {
            debugLog('=== RESET COMPLETO DO SISTEMA ===');
            
            // 1. Limpar carrinho (mem√≥ria e localStorage)
            cart = [];
            clearCartFromStorage(); // Limpa o localStorage do carrinho
            updateCartUI();
            
            // 2. Reset orderData
            orderData = {
                customerName: '',
                customerWhatsApp: '',
                deliveryType: '',
                address: {},
                tableNumber: '',
                paymentMethod: '',
                changeAmount: '',
                notes: ''
            };
            
            // 3. Reset taxa de delivery
            currentDeliveryFee = null;
            clearDeliveryFee();
            
            // 4. Reset todos os radio buttons
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.checked = false;
            });
            
            // 5. Reset todos os campos de input
            const inputs = document.querySelectorAll('input[type="text"], input[type="tel"], textarea');
            inputs.forEach(input => {
                input.value = '';
            });
            
            // 6. Ocultar campos de endere√ßo
            const addressFields = document.getElementById('address-fields');
            if (addressFields) {
                addressFields.classList.add('hidden');
            }
            
            // 7. Reset step atual para step 1
            currentStep = 1;
            
            // 8. Reset sistema de cupons
            resetCouponSystem();
            
            // 9. Fechar checkout
            closeCheckout();
            
            debugLog('Sistema resetado completamente');
            debugLog('orderData ap√≥s reset:', orderData);
            debugLog('cart ap√≥s reset:', cart);
            debugLog('currentDeliveryFee ap√≥s reset:', currentDeliveryFee);
        }
        
        // Send via Webhook
        function sendViaWebhook(message, webhookUrl) {
            debugLog('=== DEBUG WEBHOOK ===');
            debugLog('appConfig completo:', appConfig);
            debugLog('envio config:', appConfig.envio);
            debugLog('webhook_url da config:', appConfig.envio?.webhook_url);
            debugLog('webhookUrl recebido como par√¢metro:', webhookUrl);
            debugLog('=====================');
            
            if (!webhookUrl || webhookUrl.trim() === '') {
                showCustomAlert('Erro: URL do webhook n√£o configurada. Verifique as configura√ß√µes.', 'error');
                return;
            }
            
            debugLog('Enviando webhook para:', webhookUrl);
            debugLog('Dados do pedido:', orderData);
            debugLog('Carrinho:', cart);
            
            // Gerar mensagem formatada para impress√£o t√©rmica (sem emojis)
            const thermalContactInfo = getContactInfo();
            const thermalRestaurantName = thermalContactInfo.nome || 'Restaurante';
            const thermalMessage = formatOrderMessageThermal(thermalRestaurantName);
            debugLog('Mensagem t√©rmica gerada:', thermalMessage.substring(0, 100) + '...');
            
            // ‚úÖ EXTRAIR PAR√ÇMETROS DA URL DO WEBHOOK
            let webhookParams = {};
            let cleanWebhookUrl = webhookUrl;
            
            try {
                const url = new URL(webhookUrl);
                cleanWebhookUrl = `${url.protocol}//${url.host}${url.pathname}`; // URL sem par√¢metros
                
                // Extrair todos os par√¢metros da query string
                url.searchParams.forEach((value, key) => {
                    webhookParams[key] = value;
                });
                
                debugLog('üîó URL limpa do webhook:', cleanWebhookUrl);
                debugLog('üìù Par√¢metros extra√≠dos:', webhookParams);
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao extrair par√¢metros da URL:', error);
                // Se der erro, usa a URL original
                cleanWebhookUrl = webhookUrl;
            }
            
            // Get admin WhatsApp from configuration
            const contactInfo = getContactInfo();
            const adminWhatsApp = contactInfo.whatsapp || '';
            
            // Calculate totals robustly using parsePrice() and include delivery fee and coupon
            debugLog('=== C√ÅLCULO DE TOTAIS PARA WEBHOOK (com cupom e taxa) ===');
            const subtotalProducts = cart.reduce((sum, item) => {
                const priceNum = parsePrice(item.preco);
                return priceNum > 0 ? sum + (priceNum * item.quantity) : sum;
            }, 0);
            const deliveryFee = (orderData.deliveryType === 'delivery')
                ? (((orderData.address && orderData.address.deliveryFee) || currentDeliveryFee || 0))
                : 0;
            const totalBeforeDiscount = subtotalProducts + deliveryFee;
            const hasCoupon = !!appliedCoupon && (couponDiscount || 0) > 0;
            const totalFinal = Math.max(0, totalBeforeDiscount - (hasCoupon ? (couponDiscount || 0) : 0));
            debugLog('Subtotal produtos (num):', subtotalProducts);
            debugLog('Taxa de entrega (num):', deliveryFee);
            debugLog('Total antes do desconto (num):', totalBeforeDiscount);
            debugLog('Cupom aplicado?', hasCoupon, 'Desconto (num):', (couponDiscount || 0));
            debugLog('Total final (num):', totalFinal);
            
            // Prepare order data for webhook with specific fields
            const orderPayload = {
                // Main requested fields
                whatsapp_admin: adminWhatsApp,
                whatsapp_customer: orderData.customerWhatsApp || '',
                customer_name: orderData.customerName,
                timestamp: new Date().toISOString(),
                total: totalFinal,
                whatsapp_message: message,
                formatted_message: message,
                thermal_message: thermalMessage,  // Nova mensagem sem emojis para impress√£o t√©rmica
                
                // ‚úÖ PAR√ÇMETROS EXTRA√çDOS DA URL DO WEBHOOK
                webhook_params: webhookParams,
                
                // ‚úÖ RESUMO DAS VARIA√á√ïES
                has_variations: cart.some(item => item.variationText || item.removalText),
                has_removals: cart.some(item => item.removalText),
                total_items_with_variations: cart.filter(item => item.variationText || item.removalText).length,
                
                // ‚úÖ TOTAIS COMPLETOS (num√©rico e formatado)
                totals: {
                    subtotal_products_numeric: subtotalProducts,
                    subtotal_products_formatted: formatCurrency(subtotalProducts),
                    delivery_fee_numeric: deliveryFee,
                    delivery_fee_formatted: formatCurrency(deliveryFee),
                    total_before_discount_numeric: totalBeforeDiscount,
                    total_before_discount_formatted: formatCurrency(totalBeforeDiscount),
                    total_final_numeric: totalFinal,
                    total_final_formatted: formatCurrency(totalFinal)
                },
                
                // ‚úÖ INFORMA√á√ïES DO CUPOM (se houver)
                coupon_applied: hasCoupon,
                coupon: hasCoupon ? {
                    code: (appliedCoupon?.codigo_cupom || appliedCoupon?.codigo || null),
                    type: ((appliedCoupon?.tipo_desconto || appliedCoupon?.tipo || '') || '').toLowerCase() || null,
                    discount_numeric: (couponDiscount || 0),
                    discount_formatted: formatCurrency(couponDiscount || 0),
                    applies_to: ((appliedCoupon?.tipo_desconto || appliedCoupon?.tipo || '') || '').toLowerCase() || null
                } : null,
                
                // Additional order details
                customer: {
                    name: orderData.customerName,
                    delivery_type: orderData.deliveryType,
                    table_number: orderData.tableNumber || null,
                    address: orderData.address || null,
                    payment_method: orderData.paymentMethod,
                    change_amount: orderData.changeAmount || null,
                    notes: orderData.notes || null
                },
                items: cart.map(item => ({
                    id: item.id,
                    name: item.nome,
                    sku: item.sku,
                    price: item.preco,
                    price_numeric: parsePrice(item.preco),
                    quantity: item.quantity,
                    subtotal: parsePrice(item.preco) > 0 ? parsePrice(item.preco) * item.quantity : 0,
                    subtotal_numeric: parsePrice(item.preco) > 0 ? parsePrice(item.preco) * item.quantity : 0,
                    
                    // ‚úÖ VARIA√á√ïES COMPLETAS - NOVO FORMATO
                    variations_text: item.variationText || null,        // Texto das adi√ß√µes
                    removal_text: item.removalText || null,             // Texto das remo√ß√µes
                    variations_detailed: item.variations || null,       // Objeto completo das varia√ß√µes
                    
                    // ‚úÖ COMPATIBILIDADE COM FORMATO ANTIGO
                    variations: item.variationText || null,             // Mantido para compatibilidade
                    
                    notes: item.notes || null
                })),
                currency: getCurrentCurrency()
            };
            
            debugLog('Payload do webhook:', JSON.stringify(orderPayload, null, 2));
            
            // Log espec√≠fico para verificar se webhook_params est√° presente no payload
            debugLog('üîç Verifica√ß√£o webhook_params:', {
                presente: 'webhook_params' in orderPayload,
                tipo: typeof orderPayload.webhook_params,
                conte√∫do: orderPayload.webhook_params,
                json: JSON.stringify(orderPayload.webhook_params)
            });
            
            // ‚úÖ LOGS ESPEC√çFICOS DOS PAR√ÇMETROS
            if (Object.keys(webhookParams).length > 0) {
                debugLog('=== PAR√ÇMETROS DA URL ===');
                Object.entries(webhookParams).forEach(([key, value]) => {
                    debugLog(`üîë ${key}: ${value}`);
                });
                debugLog('========================');
            } else {
                debugLog('üìù Nenhum par√¢metro encontrado na URL do webhook');
            }
            
            // ‚úÖ LOGS ESPEC√çFICOS DAS VARIA√á√ïES
            debugLog('=== RESUMO DAS VARIA√á√ïES ===');
            debugLog('üìä Tem varia√ß√µes:', orderPayload.has_variations);
            debugLog('üö´ Tem remo√ß√µes:', orderPayload.has_removals);
            debugLog('üìù Itens com varia√ß√µes:', orderPayload.total_items_with_variations);
            
            orderPayload.items.forEach((item, index) => {
                if (item.variations_text || item.removal_text) {
                    debugLog(`üçΩÔ∏è Item ${index + 1}: ${item.name}`);
                    if (item.variations_text) debugLog('  ‚ûï Adi√ß√µes:', item.variations_text);
                    if (item.removal_text) debugLog('  üö´ Remo√ß√µes:', item.removal_text);
                    if (item.variations_detailed) debugLog('  üîç Detalhado:', item.variations_detailed);
                }
            });
            debugLog('================================');
            
            // Show loading message
            showCustomAlert('Enviando pedido...', 'info');
            
            // Baseado na resposta do servidor, vamos usar diretamente o m√©todo GET
            // j√° que o servidor est√° configurado apenas para aceitar requisi√ß√µes GET
            
            function sendGetRequest() {
                debugLog('üì§ ENVIANDO REQUISI√á√ÉO GET DIRETAMENTE:');
                
                // Encode payload as URL parameters for GET request
                const params = new URLSearchParams();
                params.append('data', JSON.stringify(orderPayload));
                
                // Adicionar par√¢metros principais diretamente na URL para facilitar acesso no servidor
                params.append('whatsapp_admin', adminWhatsApp);
                params.append('whatsapp_customer', orderData.customerWhatsApp || '');
                params.append('customer_name', orderData.customerName);
                params.append('timestamp', new Date().toISOString());
                params.append('total', totalFinal);
                params.append('total_final', totalFinal);
                params.append('total_before_discount', totalBeforeDiscount);
                params.append('subtotal_products', subtotalProducts);
                params.append('delivery_fee', deliveryFee);

                // Par√¢metros auxiliares do cupom
                if (hasCoupon) {
                    params.append('coupon_code', (appliedCoupon?.codigo_cupom || appliedCoupon?.codigo || ''));
                    params.append('coupon_type', ((appliedCoupon?.tipo_desconto || appliedCoupon?.tipo || '') || '').toLowerCase());
                    params.append('coupon_discount', (couponDiscount || 0));
                }
                params.append('message', message); // ‚úÖ MENSAGEM COMO VARI√ÅVEL SEPARADA
                
                debugLog('üìù Mensagem adicionada como vari√°vel separada:', message.substring(0, 100) + '...');
                
                // Adicionar par√¢metros da URL do webhook diretamente na query string
                // para garantir que eles sejam acess√≠veis mesmo se o servidor n√£o processar o campo webhook_params
                if (Object.keys(webhookParams).length > 0) {
                    debugLog('üîë Adicionando par√¢metros da URL diretamente na query string:');
                    Object.entries(webhookParams).forEach(([key, value]) => {
                        params.append(key, value);
                        debugLog(`  ‚úîÔ∏è ${key}: ${value}`);
                    });
                }
                
                const getUrl = `${cleanWebhookUrl}?${params.toString()}`;
                debugLog('üìç URL GET completa:', getUrl);
                
                // Verificar se webhook_params est√° no JSON da URL
                try {
                    const dataParam = params.get('data');
                    const parsedData = JSON.parse(dataParam);
                    debugLog('  ‚úîÔ∏è Payload em data:', parsedData);
                    debugLog('  ‚úîÔ∏è webhook_params presente:', 'webhook_params' in parsedData);
                    debugLog('  ‚úîÔ∏è Conte√∫do de webhook_params:', parsedData.webhook_params);
                } catch (e) {
                    errorLog('  ‚ùå Erro ao analisar JSON em data:', e);
                }
                
                return fetch(getUrl, {
                    method: 'GET',
                    mode: 'no-cors', // Isso ajuda com problemas de CORS
                    cache: 'no-cache',
                    keepalive: true
                });
            }
            
            // Enviar diretamente via GET
            sendGetRequest()
            .then(response => {
                debugLog('üì¨ Resposta do webhook GET:', response);
                debugLog('‚ÑπÔ∏è Modo no-cors: n√£o √© poss√≠vel ler o status da resposta');
                
                // Com o modo no-cors, n√£o podemos ler a resposta
                // Mas se chegamos aqui sem erro, a requisi√ß√£o foi enviada
                // Vamos adicionar um log de debug para confirmar
                debugLog('üö® DEBUG: Requisi√ß√£o GET enviada para:', cleanWebhookUrl);
                debugLog('üö® DEBUG: Payload completo enviado:', orderPayload);
                debugLog('üö® DEBUG: webhook_params enviado:', orderPayload.webhook_params);
                debugLog('üö® DEBUG: Par√¢metros adicionados diretamente √† URL:');
                debugLog('  ‚úîÔ∏è whatsapp_admin:', adminWhatsApp);
                debugLog('  ‚úîÔ∏è whatsapp_customer:', orderData.customerWhatsApp || '');
                debugLog('  ‚úîÔ∏è customer_name:', orderData.customerName);
                debugLog('  ‚úîÔ∏è total:', typeof totalFinal !== 'undefined' ? totalFinal : '(indispon√≠vel)');
                debugLog('  ‚úîÔ∏è message: [MENSAGEM COMPLETA ENVIADA COMO VARI√ÅVEL SEPARADA]');
                Object.entries(webhookParams).forEach(([key, value]) => {
                    debugLog(`  ‚úîÔ∏è ${key}: ${value}`);
                });
                
                // Vamos aguardar um momento e mostrar sucesso
                setTimeout(() => {
                    showCustomAlert('Pedido enviado com sucesso!', 'success');
                    // Reset completo do sistema
                    resetSystemAfterOrder();
                }, 1000); // Aguarda 1 segundo para dar tempo do webhook processar
            })
            .catch(error => {
                errorLog('Erro no envio via GET:', error);
                
                // Mostrar erro apenas se for um erro real de rede
                const isFailedToFetch = error?.name === 'TypeError' && error?.message?.includes('Failed to fetch');
                const isAbort = error?.message?.includes('ERR_ABORTED') || error?.name === 'AbortError';
                if (isFailedToFetch) {
                    showCustomAlert('Erro de conex√£o: N√£o foi poss√≠vel enviar o pedido. Verifique a URL do webhook.', 'error');
                } else if (!isAbort) {
                    showCustomAlert(`Erro ao enviar pedido: ${error.message}`, 'error');
                }
            });
        }

        // Scroll to category
        function scrollToCategory(category) {
            
            // Wait for data to be loaded and DOM to be ready
            if (!isDataLoaded) {
                setTimeout(() => scrollToCategory(category), 200);
                return;
            }
            
            // Desabilitar scroll spy temporariamente para evitar conflitos
            disableScrollSpyTemporarily();
            
            // Update active category immediately for better UX
            updateActiveCategory(category);
            
            // Perform scroll without additional delay
            requestAnimationFrame(() => {
                // Function to perform the scroll with multiple fallback strategies
                function performScroll() {
                    // Strategy 1: Try exact ID match
                    let section = document.getElementById(category);
                    
                    // Strategy 2: If not found, try to find by data-category in sections
                    if (!section) {
                        section = document.querySelector(`section[data-category="${category}"]`);
                    }
                    
                    // Strategy 3: Try to find section containing items with matching category
                    if (!section) {
                        const categoryItem = document.querySelector(`[data-category="${category}"]`);
                        if (categoryItem) {
                            // Look for a section that might contain this category's items
                            const allSections = document.querySelectorAll('section[id]');
                            for (const sec of allSections) {
                                if (sec.id === category || sec.id.includes(category) || category.includes(sec.id)) {
                                    section = sec;
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (section) {
                        const offset = 150; // Account for sticky headers
                        const elementPosition = section.offsetTop - offset;
                        window.scrollTo({ 
                            top: Math.max(0, elementPosition), 
                            behavior: 'smooth' 
                        });
                        return true;
                    }
                    return false;
                }
                
                // Try immediate scroll
                if (performScroll()) {
                    return;
                }
                
                // If section not found, try multiple retries
                let retryCount = 0;
                const maxRetries = 5;
                
                function retryScroll() {
                    if (retryCount >= maxRetries) {
                        // Final fallback: scroll to first section if category exists in menu
                        const firstSection = document.querySelector('section[id]');
                        if (firstSection) {
                            window.scrollTo({ top: firstSection.offsetTop - 150, behavior: 'smooth' });
                        }
                        return;
                    }
                    
                    retryCount++;
                    const delay = retryCount * 200; // 200ms, 400ms, 600ms, etc.
                    
                    setTimeout(() => {
                        if (!performScroll()) {
                            retryScroll();
                        }
                    }, delay);
                }
                
                retryScroll();
            }, 100); // Initial delay to ensure DOM rendering
        }

        // SCROLL SPY DEFINITIVO - T√©cnica tradicional e confi√°vel
        let scrollSpyEnabled = true;
        let scrollSpyTimeout = null;
        let currentActiveCategory = null;
        
        function setupScrollSpy() {
            // Event listener de scroll otimizado
            let ticking = false;
            
            function updateScrollSpy() {
                // üîç DEBUG: Verificar se scroll spy est√° habilitado
                if (!scrollSpyEnabled) {
                    debugLog('üö´ updateScrollSpy: BLOQUEADO (scrollSpyEnabled = false)');
                    ticking = false;
                    return;
                }
                
                debugLog('üîç updateScrollSpy: EXECUTANDO (scrollSpyEnabled = true)');
                
                // Calcular offset do header + menu
                const header = document.querySelector('header');
                const nav = document.getElementById('category-nav');
                const headerHeight = header ? header.offsetHeight : 0;
                const navHeight = nav ? nav.offsetHeight : 0;
                const totalOffset = headerHeight + navHeight + 20; // 20px margem
                
                const scrollPosition = window.scrollY + totalOffset;
                debugLog('üìç Posi√ß√£o do scroll:', scrollPosition);
                
                // Pegar todas as se√ß√µes ativas
                const sections = categoriesData
                    .filter(cat => cat.status === 'Ativo')
                    .map(cat => {
                        const element = document.getElementById(cat.nome_categoria);
                        if (element) {
                            return {
                                name: cat.nome_categoria,
                                element: element,
                                top: element.offsetTop,
                                bottom: element.offsetTop + element.offsetHeight
                            };
                        }
                        return null;
                    })
                    .filter(section => section !== null)
                    .sort((a, b) => a.top - b.top);
                
                if (sections.length === 0) return;
                
                let activeSection = null;
                
                // Se estiver no topo da p√°gina, ativar primeira se√ß√£o
                if (window.scrollY < 100) {
                    activeSection = sections[0].name;
                } else {
                    // Encontrar a se√ß√£o ativa baseada na posi√ß√£o do scroll
                    for (let i = sections.length - 1; i >= 0; i--) {
                        if (scrollPosition >= sections[i].top) {
                            activeSection = sections[i].name;
                            break;
                        }
                    }
                    
                    // Se n√£o encontrou nenhuma, usar a primeira
                    if (!activeSection) {
                        activeSection = sections[0].name;
                    }
                }
                
                // üîç DEBUG: Verificar detec√ß√£o de categoria ativa
                debugLog('üéØ Categoria detectada pelo scroll:', activeSection);
                debugLog('üìè Categoria atual armazenada:', currentActiveCategory);
                debugLog('‚öñÔ∏è Compara√ß√£o (activeSection !== currentActiveCategory):', activeSection !== currentActiveCategory);
                
                // S√≥ atualizar se mudou
                if (activeSection && activeSection !== currentActiveCategory) {
                    debugLog('‚úÖ MUDOU! Atualizando categoria de', currentActiveCategory, 'para', activeSection);
                    currentActiveCategory = activeSection;
                    updateActiveCategory(activeSection);
                } else {
                    debugLog('üö´ N√ÉO MUDOU - mantendo categoria atual:', currentActiveCategory);
                }
                
                ticking = false;
            }
            
            function onScroll() {
                debugLog('üìú onScroll chamada - ticking:', ticking);
                if (!ticking) {
                    requestAnimationFrame(updateScrollSpy);
                    ticking = true;
                }
            }
            
            // Adicionar event listener
            window.addEventListener('scroll', onScroll, { passive: true });
            
            // Executar uma vez para definir estado inicial
            setTimeout(updateScrollSpy, 100);
        }
        
        // Desabilitar scroll spy temporariamente ap√≥s cliques
        function disableScrollSpyTemporarily() {
            debugLog('üö´ Scroll spy DESABILITADO temporariamente');
            scrollSpyEnabled = false;
            if (scrollSpyTimeout) {
                clearTimeout(scrollSpyTimeout);
                debugLog('‚è∞ Timeout anterior cancelado');
            }
            scrollSpyTimeout = setTimeout(() => {
                scrollSpyEnabled = true;
                debugLog('‚úÖ Scroll spy REABILITADO ap√≥s 1.5s');
                debugLog('üîÑ Estado atual scrollSpyEnabled:', scrollSpyEnabled);
            }, 1500); // 1.5 segundos
            debugLog('‚è±Ô∏è Novo timeout de 1.5s iniciado');
        }

        // Atualizar categoria ativa - VERS√ÉO CORRIGIDA
        function updateActiveCategory(category) {
            // ‚úÖ CORRE√á√ÉO CR√çTICA: Atualizar vari√°vel de controle do scroll spy
            // Isso resolve o bug onde scroll spy "trava" ap√≥s clicar em categoria
            currentActiveCategory = category;
            
            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Adicionar classe active no bot√£o correspondente
            const activeButton = document.querySelector(`[data-category="${category}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
                
                // Centralizar bot√£o ativo no scroll horizontal
                activeButton.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'center'
                });
            }
            
            // üêõ DEBUG: Log para verificar se categoria foi atualizada corretamente
            debugLog('üéØ Categoria ativa sincronizada:', category);
        }

        // Fun√ß√£o removida - agora usamos scrollIntoView nativo

        // Setup search
        function setupSearch() {
            const searchInput = document.getElementById('search');
            const clearBtn = document.getElementById('clear-search');
            
            // Verifica√ß√£o defensiva - elementos devem existir
            if (!searchInput) {
                if (typeof warnLog === 'function') warnLog('‚ö†Ô∏è Search input element not found');
                return;
            }
            
            if (!clearBtn) {
                if (typeof warnLog === 'function') warnLog('‚ö†Ô∏è Clear search button element not found');
                return;
            }
            
            // Search on input
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Show/hide clear button
                if (query.length > 0) {
                    clearBtn.classList.remove('hidden');
                } else {
                    clearBtn.classList.add('hidden');
                }
                
                performSearchWithQuery(query);
            });
            
            // Search on Enter key
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch();
                }
            });
            
            if (typeof debugLog === 'function') debugLog('‚úÖ Search functionality initialized');
        }
        
        // Perform search
        function performSearch() {
            const searchInput = document.getElementById('search');
            
            // Verifica√ß√£o defensiva - elemento deve existir
            if (!searchInput) {
                if (typeof warnLog === 'function') warnLog('‚ö†Ô∏è Search input element not found in performSearch');
                return;
            }
            
            const query = searchInput.value.trim().toLowerCase();
            
            if (query.length === 0) {
                showToast('Digite algo para pesquisar', 'warning', 2000);
                searchInput.focus();
                return;
            }
            
            performSearchWithQuery(query);
            
            // Show feedback
            const results = document.querySelectorAll('.food-card:not([style*="display: none"])').length;
            if (results === 0) {
                showToast('Nenhum prato encontrado para sua busca', 'warning', 3000);
            } else {
                showToast(`${results} prato${results > 1 ? 's' : ''} encontrado${results > 1 ? 's' : ''}`, 'success', 2000);
            }
        }
        
        // Perform search with query
        function performSearchWithQuery(query) {
            const searchQuery = query.toLowerCase().trim();
            const cards = document.querySelectorAll('.food-card');
            
            if (cards.length === 0) {
                console.warn('Nenhum card encontrado para busca');
                return;
            }
            
            let visibleCount = 0;
            cards.forEach(card => {
                try {
                    // Buscar por m√∫ltiplos seletores para maior compatibilidade
                    const nameElement = card.querySelector('h3') || card.querySelector('.font-semibold');
                    const descElement = card.querySelector('p') || card.querySelector('.description');
                    const skuElement = card.querySelector('.text-xs') || card.querySelector('.font-mono');
                    
                    let shouldShow = false;
                    
                    // Se query est√° vazia, mostrar todos
                    if (searchQuery === '') {
                        shouldShow = true;
                    } else {
                        // Buscar no nome
                        if (nameElement && nameElement.textContent.toLowerCase().includes(searchQuery)) {
                            shouldShow = true;
                        }
                        
                        // Buscar na descri√ß√£o
                        if (!shouldShow && descElement && descElement.textContent.toLowerCase().includes(searchQuery)) {
                            shouldShow = true;
                        }
                        
                        // Buscar no SKU
                        if (!shouldShow && skuElement && skuElement.textContent.toLowerCase().includes(searchQuery)) {
                            shouldShow = true;
                        }
                        
                        // Buscar em todo o texto do card como fallback
                        if (!shouldShow && card.textContent.toLowerCase().includes(searchQuery)) {
                            shouldShow = true;
                        }
                    }
                    
                    // Aplicar visibilidade
                    if (shouldShow) {
                        card.style.display = 'block';
                        card.style.opacity = '1';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                        card.style.opacity = '0';
                    }
                    
                } catch (error) {
                    errorLog('Erro ao processar card na busca:', error);
                    // Em caso de erro, manter o card vis√≠vel
                    card.style.display = 'block';
                    card.style.opacity = '1';
                }
            });
            
            // Ocultar categorias vazias
            hideEmptyCategories(searchQuery);
            
            // Atualizar contadores e feedback visual
            updateSearchResults(visibleCount, searchQuery);
        }
        
        // Hide empty categories during search
        function hideEmptyCategories(searchQuery) {
            const sections = document.querySelectorAll('section[id]:not(#google-reviews-section)');
            
            sections.forEach(section => {
                try {
                    // Encontrar todos os cards vis√≠veis nesta se√ß√£o
                    const visibleCards = section.querySelectorAll('.food-card[style*="display: block"], .food-card:not([style*="display: none"])');
                    
                    // Se n√£o h√° query de busca, mostrar todas as se√ß√µes
                    if (!searchQuery || searchQuery.trim() === '') {
                        section.style.display = 'block';
                        section.style.opacity = '1';
                    } else {
                        // Se h√° query mas nenhum card vis√≠vel, ocultar a se√ß√£o
                        if (visibleCards.length === 0) {
                            section.style.display = 'none';
                            section.style.opacity = '0';
                        } else {
                            section.style.display = 'block';
                            section.style.opacity = '1';
                        }
                    }
                } catch (error) {
                    if (typeof errorLog === 'function') errorLog('Erro ao processar se√ß√£o na busca:', error);
                    // Em caso de erro, manter a se√ß√£o vis√≠vel
                    section.style.display = 'block';
                    section.style.opacity = '1';
                }
            });
        }
        
        // Update search results feedback
        function updateSearchResults(visibleCount, query) {
            if (query && query.length > 0) {
                if (visibleCount === 0) {
                    showToast('Nenhum prato encontrado para sua busca', 'warning', 3000);
                } else {
                    showToast(`${visibleCount} prato${visibleCount > 1 ? 's' : ''} encontrado${visibleCount > 1 ? 's' : ''}`, 'success', 2000);
                }
            }
        }
        
        // Clear search
        function clearSearch() {
            const searchInput = document.getElementById('search');
            const clearBtn = document.getElementById('clear-search');
            
            // Verifica√ß√£o defensiva - elementos devem existir
            if (!searchInput) {
                if (typeof warnLog === 'function') warnLog('‚ö†Ô∏è Search input element not found in clearSearch');
                return;
            }
            
            if (!clearBtn) {
                if (typeof warnLog === 'function') warnLog('‚ö†Ô∏è Clear search button element not found in clearSearch');
                return;
            }
            
            searchInput.value = '';
            clearBtn.classList.add('hidden');
            
            // Show all items with improved reset
            document.querySelectorAll('.food-card').forEach(card => {
                card.style.display = 'block';
                card.style.opacity = '1';
            });
            
            // Mostrar todas as categorias
            hideEmptyCategories('');
            
            showToast('Busca limpa! Mostrando todos os pratos', 'success', 2000);
            searchInput.focus();
        }

        // Find product by ID
        function findProductById(id) {
            for (const category of Object.values(menuData)) {
                const product = category.find(item => item.id === id);
                if (product) return product;
            }
            return null;
        }

        // Share general page
        function shareGeneral() {
            const url = window.location.href.split('#')[0];
            const companyName = getCompanyName();
            const slogan = getSlogan();
            const text = `üçΩÔ∏è Confira o card√°pio do ${companyName} - ${slogan}!`;
            const shareText = `${text}\n${url}`;
            
            navigator.clipboard.writeText(shareText).then(() => {
                showToast('üìã Link do card√°pio copiado! Cole e compartilhe com seus amigos', 'success', 3000);
            }).catch(() => {
                // Fallback se clipboard n√£o funcionar
                showToast('‚ùå N√£o foi poss√≠vel copiar automaticamente', 'error', 2000);
                setTimeout(() => {
                    prompt('Copie o link manualmente:', url);
                }, 500);
            });
        }

        // Share specific category
        function shareCategory(category) {
            // Get category display name from dynamic data
            const categoryData = categoriesData.find(cat => cat.nome_categoria === category);
            const categoryName = categoryData ? categoryData.titulo_exibicao : category;
            const companyName = getCompanyName();
            
            const url = `${window.location.href.split('#')[0]}#${category}`;
            const text = `üçΩÔ∏è Confira ${categoryName} do ${companyName}!`;
            const shareText = `${text}\n${url}`;
            
            navigator.clipboard.writeText(shareText).then(() => {
                showToast(`üìã Link de ${categoryName} copiado! Compartilhe!`, 'success', 3000);
            }).catch(() => {
                // Fallback se clipboard n√£o funcionar
                showToast('‚ùå N√£o foi poss√≠vel copiar automaticamente', 'error', 2000);
                setTimeout(() => {
                    prompt('Copie o link da categoria:', url);
                }, 500);
            });
        }

        // Handle initial hash navigation
        function handleInitialHash() {
            const hash = window.location.hash.substring(1);
            if (hash && categoriesData) {
                const validCategories = categoriesData
                    .filter(cat => cat.status === 'Ativo')
                    .map(cat => cat.nome_categoria);
                
                if (validCategories.includes(hash)) {
                    setTimeout(() => {
                        scrollToCategory(hash);
                    }, 1000); // Increased delay to ensure data is loaded
                }
            }
        }

        // Scroll field to center when focused (mobile keyboard fix)
        function scrollToField(field) {
            // Apply visual focus styles
            field.style.borderColor = 'var(--cor-primaria)';
            field.style.outline = '2px solid var(--cor-primaria)';
            field.style.outlineOffset = '2px';
            
            setTimeout(() => {
                // Find the modal container with overflow-y-auto
                const modalContainer = document.querySelector('#product-modal .overflow-y-auto');
                if (!modalContainer) {
                    if (typeof debugLog === 'function') debugLog('‚ùå Product modal container not found');
                    return;
                }
                
                // Get field position relative to modal container
                const fieldRect = field.getBoundingClientRect();
                const containerRect = modalContainer.getBoundingClientRect();
                const fieldHeight = fieldRect.height;
                const containerHeight = containerRect.height;
                
                // Calculate relative position within the modal
                const fieldTopInModal = fieldRect.top - containerRect.top + modalContainer.scrollTop;
                
                // Calculate position to center the field in visible area, accounting for mobile keyboard
                const viewportHeight = window.innerHeight;
                const keyboardHeight = viewportHeight * 0.4; // Estimate keyboard height (40% of viewport)
                const availableHeight = Math.min(containerHeight, viewportHeight - keyboardHeight);
                const targetScrollPosition = fieldTopInModal - (availableHeight / 2) + (fieldHeight / 2);
                
                // Smooth scroll within modal container
                modalContainer.scrollTo({
                    top: Math.max(0, targetScrollPosition),
                    behavior: 'smooth'
                });
                
                if (typeof debugLog === 'function') debugLog('üìù Product notes field focused and centered within modal');
            }, 300); // Delay to allow keyboard to appear
        }

        // Reset modal scroll when field loses focus
        function resetModalScroll() {
            // Reset visual styles
            const field = document.getElementById('product-notes');
            if (field) {
                field.style.borderColor = '';
                field.style.outline = 'none';
            }
            
            setTimeout(() => {
                const modalContainer = document.querySelector('#product-modal .overflow-y-auto');
                if (!modalContainer) return;
                
                // Smooth scroll back to top of modal
                modalContainer.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
                if (typeof debugLog === 'function') debugLog('üîÑ Product modal scroll reset');
            }, 100);
        }

        // Open lightbox
        function openLightbox(imageSrc, title) {
            const lightbox = document.getElementById('image-lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const lightboxTitle = document.getElementById('lightbox-title');
            
            lightboxImage.src = imageSrc;
            lightboxTitle.textContent = title;
            
            lightbox.classList.remove('hidden');
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        // Close lightbox
        function closeLightbox(event) {
            if (event && event.target !== event.currentTarget && !event.target.closest('button')) {
                return;
            }
            
            const lightbox = document.getElementById('image-lightbox');
            lightbox.classList.add('hidden');
            
            // Restore body scroll
            document.body.style.overflow = '';
        }

        // Close lightbox on ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const lightbox = document.getElementById('image-lightbox');
                if (!lightbox.classList.contains('hidden')) {
                    closeLightbox();
                }
            }
        });

        // Operating Hours Functions
        async function updateOperatingHours() {
            try {
                // Fetch CSV data directly for real-time updates
                const response = await fetch(HOURS_CSV_URL);
                const csvText = await response.text();
                
                // Parse CSV manually
                const lines = csvText.trim().split('\n');
                
                // Usar timezone global do config.js
                const timezone = globalTimezone;
                debugLog('üï∞Ô∏è Timezone usado para hor√°rios:', timezone);
                
                const headers = lines[0].split(','); // Use first line as headers
                
                // Get current time using global timezone functions
                const timezoneDate = getCurrentDateInTimezone();
                const dayOfWeek = getDayOfWeekInPortuguese(timezoneDate.getDay());
                const currentTime = timezoneDate.getHours() * 60 + timezoneDate.getMinutes(); // Convert to minutes
                
                debugLog('- Data/hora atual:', formatDateInTimezone(timezoneDate));
                debugLog('- Dia da semana:', dayOfWeek);
                debugLog('- Hor√°rio em minutos:', currentTime);
                
                // Find today's schedule from CSV data
                let todaySchedule = null;
                debugLog('- Procurando cronograma para:', dayOfWeek);
                
                for (let i = 1; i < lines.length; i++) { // Mudan√ßa: come√ßar da linha 1
                    const values = lines[i].split(',');
                    const dayName = values[0];
                    debugLog(`  - Linha ${i}: ${dayName} (comparando com ${dayOfWeek})`);
                    
                    if (dayName && dayName.toLowerCase().trim() === dayOfWeek.toLowerCase()) {
                        todaySchedule = {
                            day: dayName,
                            period1: values[1],
                            period2: values[2],
                            period3: values[3]
                        };
                        debugLog('- Cronograma encontrado:', todaySchedule);
                        break;
                    }
                }
                
                if (!todaySchedule) {
                    errorLog('‚ùå Nenhum cronograma encontrado para hoje:', dayOfWeek);
                    return;
                }
                
                debugLog('üîç Verificando se est√° aberto...');
                const isOpen = checkIfOpenFromPeriods(todaySchedule, currentTime);
                const nextCloseTime = getNextCloseTimeFromPeriods(todaySchedule, currentTime);
                
                debugLog('- Status:', isOpen ? 'ABERTO' : 'FECHADO');
                debugLog('- Pr√≥ximo fechamento:', nextCloseTime || 'N/A');
                
                // Update status indicator
                const statusText = document.getElementById('status-text');
                const hoursText = document.getElementById('hours-text');
                const statusDot = document.getElementById('status-dot');
                
                if (statusText && hoursText && statusDot) {
                    statusText.textContent = isOpen ? 'Aberto' : 'Fechado';
                    statusText.className = 'font-medium';
                    statusText.style.color = isOpen ? 'var(--cor-sucesso)' : 'var(--cor-erro)';
                    
                    statusDot.className = 'w-2 h-2 rounded-full';
                    statusDot.style.backgroundColor = isOpen ? 'var(--cor-sucesso)' : 'var(--cor-erro)';
                    
                    if (isOpen && nextCloseTime) {
                        hoursText.textContent = `at√© ${nextCloseTime}`;
                    } else if (!isOpen) {
                        const nextOpenTime = getNextOpenTimeFromPeriods(todaySchedule, currentTime);
                        if (nextOpenTime) {
                            hoursText.textContent = `Abre √†s ${nextOpenTime}`;
                        } else {
                            hoursText.textContent = 'Hoje';
                        }
                    } else {
                        hoursText.textContent = dayOfWeek;
                    }
                }
                
            } catch (error) {
                errorLog('Error updating operating hours:', error);
                // Fallback to static display
                const statusText = document.getElementById('status-text');
                const hoursText = document.getElementById('hours-text');
                const statusDot = document.getElementById('status-dot');
                
                if (statusText && hoursText && statusDot) {
                    statusText.textContent = 'Aberto';
                    statusText.className = 'font-medium';
                    statusText.style.color = 'var(--cor-sucesso)';
                    statusDot.className = 'w-2 h-2 rounded-full';
                    statusDot.style.backgroundColor = 'var(--cor-sucesso)';
                    hoursText.textContent = 'at√© 23h';
                }
            }
        }

        function getDayOfWeekInPortuguese(dayIndex) {
            const days = [
                'domingo', 'segunda-feira', 'ter√ßa-feira', 'quarta-feira',
                'quinta-feira', 'sexta-feira', 's√°bado'
            ];
            return days[dayIndex];
        }

        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function checkIfOpen(schedule, currentTime) {
            // Get time periods - new format with Per√≠odo 1, 2, 3
            const periods = [
                schedule['Per√≠odo 1'] || schedule['Per√≠odo 1 '] || schedule[' Per√≠odo 1'] || schedule[' Per√≠odo 1 '],
                schedule['Per√≠odo 2'] || schedule['Per√≠odo 2 '] || schedule[' Per√≠odo 2'] || schedule[' Per√≠odo 2 '],
                schedule['Per√≠odo 3'] || schedule['Per√≠odo 3 '] || schedule[' Per√≠odo 3'] || schedule[' Per√≠odo 3 ']
            ];
            
            // Check all periods
            for (const periodTime of periods) {
                if (periodTime && periodTime.trim() && periodTime.trim() !== '') {
                    // Parse time range (e.g., "8:00 - 12:00")
                    const timeRange = periodTime.split(' - ');
                    if (timeRange.length === 2) {
                        const startTime = timeToMinutes(timeRange[0].trim());
                        let endTime = timeToMinutes(timeRange[1].trim());
                        
                        // Handle midnight crossing (00:00)
                        if (endTime === 0) endTime = 24 * 60; // 24:00 in minutes
                        
                        if (currentTime >= startTime && currentTime < endTime) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }
        
        function checkIfOpenFromPeriods(schedule, currentTime) {
            // Get time periods from CSV format
            const periods = [schedule.period1, schedule.period2, schedule.period3];
            
            // Check all periods
            for (const periodTime of periods) {
                if (periodTime && periodTime.trim() && periodTime.trim() !== '') {
                    // Parse time range (e.g., "8:00-12:00")
                    const timeRange = periodTime.split('-');
                    if (timeRange.length === 2) {
                        const startTime = timeToMinutes(timeRange[0].trim());
                        let endTime = timeToMinutes(timeRange[1].trim());
                        
                        // Handle midnight crossing (00:00)
                        if (endTime === 0) endTime = 24 * 60; // 24:00 in minutes
                        
                        if (currentTime >= startTime && currentTime < endTime) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        function getNextCloseTime(schedule, now) {
            if (!schedule) return null; // Adicione esta linha

            // Get time periods - new format with Per√≠odo 1, 2, 3
            const periods = [
                schedule['Per√≠odo 1'] || schedule['Per√≠odo 1 '] || schedule[' Per√≠odo 1'] || schedule[' Per√≠odo 1 '],
                schedule['Per√≠odo 2'] || schedule['Per√≠odo 2 '] || schedule[' Per√≠odo 2'] || schedule[' Per√≠odo 2 '],
                schedule['Per√≠odo 3'] || schedule['Per√≠odo 3 '] || schedule[' Per√≠odo 3'] || schedule[' Per√≠odo 3 ']
            ];
            
            // Check all periods to find which one we're in
            for (const periodTime of periods) {
                if (periodTime && periodTime.trim() && periodTime.trim() !== '') {
                    // Parse time range (e.g., "8:00 - 12:00")
                    const timeRange = periodTime.split(' - ');
                    if (timeRange.length === 2) {
                        const startTime = timeToMinutes(timeRange[0].trim());
                        let endTime = timeToMinutes(timeRange[1].trim());
                        
                        // Handle midnight crossing
                        if (endTime === 0) {
                            return '00h';
                        }
                        
                        if (now >= startTime && now < endTime) {
                            return timeRange[1].trim();
                        }
                    }
                }
            }
            
            return null; // Not found in any period
        }

        function getNextOpenTime(schedule, now) {
            if (!schedule) return null;

            // Encontra o valor de uma chave, ignorando espa√ßos em branco
            const findValue = (key) => {
                const trimmedKey = key.trim();
                for (const scheduleKey in schedule) {
                    if (scheduleKey.trim() === trimmedKey) {
                        return schedule[scheduleKey];
                    }
                }
                return undefined;
            };

            const periods = [
                findValue('Per√≠odo 1'),
                findValue('Per√≠odo 2'),
                findValue('Per√≠odo 3')
            ];

            let nextOpenTime = Infinity;

            for (const periodTime of periods) {
                if (periodTime && periodTime.trim() !== '') {
                    const timeRange = periodTime.split(' - ');
                    if (timeRange.length === 2) {
                        const startTime = timeToMinutes(timeRange[0].trim());
                        if (startTime > now && startTime < nextOpenTime) {
                            nextOpenTime = startTime;
                        }
                    }
                }
            }

            if (nextOpenTime === Infinity) {
                return null;
            }

            const hours = Math.floor(nextOpenTime / 60);
            const minutes = nextOpenTime % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        function getNextCloseTimeFromPeriods(schedule, currentTime) {
            // Get time periods from CSV format
            const periods = [schedule.period1, schedule.period2, schedule.period3];
            
            // Check all periods to find which one we're in
            for (const periodTime of periods) {
                if (periodTime && periodTime.trim() && periodTime.trim() !== '') {
                    // Parse time range (e.g., "8:00-12:00")
                    const timeRange = periodTime.split('-');
                    if (timeRange.length === 2) {
                        const startTime = timeToMinutes(timeRange[0].trim());
                        let endTime = timeToMinutes(timeRange[1].trim());
                        
                        // Handle midnight crossing
                        if (endTime === 0) {
                            return '00h';
                        }
                        
                        if (currentTime >= startTime && currentTime < endTime) {
                            const hours = Math.floor(endTime / 60);
                            const minutes = endTime % 60;
                            if (minutes === 0) {
                                return `${hours}h`;
                            } else {
                                return `${hours}h${minutes.toString().padStart(2, '0')}`;
                            }
                        }
                    }
                }
            }
            return null;
        }
        
        function getNextOpenTimeFromPeriods(schedule, currentTime) {
            // Get time periods from CSV format
            const periods = [schedule.period1, schedule.period2, schedule.period3];
            
            // Find the next opening time
            for (const periodTime of periods) {
                if (periodTime && periodTime.trim() && periodTime.trim() !== '') {
                    // Parse time range (e.g., "8:00-12:00")
                    const timeRange = periodTime.split('-');
                    if (timeRange.length === 2) {
                        const startTime = timeToMinutes(timeRange[0].trim());
                        const endTime = timeToMinutes(timeRange[1].trim());
                        
                        // If current time is before this period starts
                        if (currentTime < startTime) {
                            const hours = Math.floor(startTime / 60);
                            const minutes = startTime % 60;
                            if (minutes === 0) {
                                return `${hours}h`;
                            } else {
                                return `${hours}h${minutes.toString().padStart(2, '0')}`;
                            }
                        }
                    }
                }
            }
            return null;
        }

        async function openHoursModal() {
            debugLog('Opening hours modal...');
            const modal = document.getElementById('hours-modal');
            const content = document.getElementById('hours-content');
            
            // Show loading state
            content.innerHTML = '<p style="color: var(--cor-texto)">Carregando hor√°rios...</p>';
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            try {
                // Fetch CSV data directly
                const response = await fetch(HOURS_CSV_URL);
                const csvText = await response.text();
                
                debugLog('CSV loaded successfully:', csvText.substring(0, 200));
                
                // Parse CSV manually
                const lines = csvText.trim().split('\n');
                
                debugLog('üìä Total de linhas no CSV:', lines.length);
                debugLog('üìä Primeiras 3 linhas:', lines.slice(0, 3));
                
                // Extract timezone from first line
                let timezone = 'America/Sao_Paulo'; // Default timezone
                if (lines[0] && lines[0].includes('Time Zone')) {
                    const timezoneLine = lines[0].split(',');
                    if (timezoneLine.length > 1 && timezoneLine[1].trim()) {
                        timezone = timezoneLine[1].trim();
                    }
                }
                
                debugLog('üåç Timezone detectado:', timezone);
                
                // Identificar linha de cabe√ßalho
                let headerLineIndex = 1;
                let dataStartIndex = 2;
                
                // Verificar se a linha 1 cont√©m cabe√ßalhos ou dados
                if (lines[1]) {
                    const firstLineValues = lines[1].split(',');
                    const firstValue = firstLineValues[0]?.trim().toLowerCase();
                    
                    // Se a primeira coluna cont√©m "dia" ou "day" ou "per√≠odo", √© cabe√ßalho
                    if (firstValue && (firstValue.includes('dia') || firstValue.includes('day') || firstValue.includes('per√≠odo'))) {
                        headerLineIndex = 1;
                        dataStartIndex = 2;
                        debugLog('üìã Cabe√ßalhos encontrados na linha 1');
                    } else {
                        // Se n√£o, os dados come√ßam na linha 1
                        headerLineIndex = -1; // Sem cabe√ßalho
                        dataStartIndex = 1;
                        debugLog('üìã Dados come√ßam na linha 1 (sem cabe√ßalho)');
                    }
                }
                
                const headers = headerLineIndex >= 0 ? lines[headerLineIndex].split(',') : [];
                debugLog('üìã Cabe√ßalhos:', headers);
                
                let html = '';
                
                // Process each day (starting from dataStartIndex)
                debugLog('üîÑ Processando dias a partir da linha:', dataStartIndex);
                for (let i = dataStartIndex; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const dayName = values[0]?.trim();
                    
                    debugLog(`üìÖ Linha ${i}: ${dayName} - Valores:`, values);
                    
                    if (!dayName || dayName === '') {
                        debugLog(`‚ö†Ô∏è Pulando linha ${i}: nome do dia vazio`);
                        continue;
                    }
                    
                    // Verificar se n√£o √© uma linha de cabe√ßalho perdida
                    const dayNameLower = dayName.toLowerCase();
                    if (dayNameLower.includes('dia') || dayNameLower.includes('day') || dayNameLower.includes('per√≠odo')) {
                        debugLog(`‚ö†Ô∏è Pulando linha ${i}: parece ser cabe√ßalho - ${dayName}`);
                        continue;
                    }
                    
                    html += `
                        <div class="border-b pb-1 last:border-b-0" style="border-color: var(--cor-borda)">
                            <h3 class="font-medium mb-0.5 capitalize text-sm" style="color: var(--cor-texto)">${dayName}</h3>
                            <div class="space-y-0 text-xs" style="color: var(--cor-texto)">
                    `;
                    
                    let hasAnyPeriod = false;
                    
                    // Get current day for status indicator using timezone
                     const today = new Date();
                     const timezoneToday = new Date(today.toLocaleString("en-US", {timeZone: timezone}));
                     const currentDayIndex = timezoneToday.getDay(); // 0 = Sunday, 1 = Monday, etc.
                     const dayNames = ['Domingo', 'Segunda-Feira', 'Ter√ßa-Feira', 'Quarta-Feira', 'Quinta-Feira', 'Sexta-Feira', 'S√°bado'];
                     const isToday = dayNames[currentDayIndex].toLowerCase() === dayName.toLowerCase();
                     
                     // Check each period (columns 1, 2, 3 for Per√≠odo 1, 2, 3)
                     const periods = [];
                     for (let j = 1; j <= 3; j++) {
                         const periodTime = values[j];
                         if (periodTime && periodTime.trim() !== '') {
                             periods.push(periodTime.trim());
                         }
                     }
                     
                     if (periods.length > 0) {
                         hasAnyPeriod = true;
                         const periodsText = periods.join(' ‚Ä¢ ');
                         
                         // For today, check if currently open using the same logic as updateOperatingHours
                         let statusColor = 'var(--cor-sucesso)';
                         if (isToday) {
                             const currentTime = timezoneToday.getHours() * 60 + timezoneToday.getMinutes();
                             const todaySchedule = {
                                 period1: values[1],
                                 period2: values[2],
                                 period3: values[3]
                             };
                             const isCurrentlyOpen = checkIfOpenFromPeriods(todaySchedule, currentTime);
                             statusColor = isCurrentlyOpen ? 'var(--cor-sucesso)' : 'var(--cor-erro)';
                         }
                         
                         html += `<div class="flex justify-between items-center">
                                     <span>${periodsText}</span>
                                     ${isToday ? `<span class="w-2 h-2 rounded-full ml-2" style="background-color: ${statusColor}"></span>` : ''}
                                 </div>`;
                     }
                    
                    if (!hasAnyPeriod) {
                         html += `<div class="flex justify-between items-center">
                                     <span style="color: var(--cor-texto-secundario)">Fechado</span>
                                     ${isToday ? '<span class="w-2 h-2 rounded-full ml-2" style="background-color: var(--cor-erro)"></span>' : ''}
                                 </div>`;
                     }
                    
                    html += `</div></div>`;
                }
                
                debugLog('‚úÖ Processamento conclu√≠do. Total de dias processados:', (html.match(/<h3 class="font-semibold/g) || []).length);
                
                content.innerHTML = html;
                
                // Iniciar rel√≥gio do timezone
                startTimezoneClock();
                
            } catch (error) {
                errorLog('Error loading hours:', error);
                content.innerHTML = '<p style="color: var(--cor-erro)">Erro ao carregar hor√°rios. Tente novamente.</p>';
                
                // Iniciar rel√≥gio mesmo com erro
                startTimezoneClock();
            }
        }

        function closeHoursModal() {
            const modal = document.getElementById('hours-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            
            // Parar rel√≥gio do timezone
            stopTimezoneClock();
        }
        
        /**
         * ===== FUN√á√ïES MODAL ESTABELECIMENTO FECHADO =====
         */
        
        /**
         * Mostra modal de estabelecimento fechado
         */
        async function showClosedModal() {
            const modal = document.getElementById('closed-modal');
            const nextOpenTimeElement = document.getElementById('next-open-time');
            
            // Mostrar modal
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Carregar pr√≥ximo hor√°rio
            try {
                const nextTime = await getNextOpenTime();
                nextOpenTimeElement.textContent = nextTime;
            } catch (e) {
                nextOpenTimeElement.textContent = 'Consulte nossos hor√°rios';
            }
            
            debugLog('üö´ Modal de estabelecimento fechado exibido');
        }
        
        /**
         * Fecha modal de estabelecimento fechado
         */
        function closeClosedModal() {
            const modal = document.getElementById('closed-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            
            debugLog('‚úÖ Modal de estabelecimento fechado fechado');
        }
        
        /**
         * Verifica se o checkout est√° aberto
         */
        function isCheckoutOpen() {
            const cartModal = document.getElementById('cart-modal');
            const checkoutModal = document.getElementById('checkout-modal');
            return !cartModal.classList.contains('hidden') || !checkoutModal.classList.contains('hidden');
        }
        
        /**
         * Fecha checkout se estiver aberto
         */
        function closeCheckoutIfOpen() {
            const cartModal = document.getElementById('cart-modal');
            const checkoutModal = document.getElementById('checkout-modal');
            
            if (!cartModal.classList.contains('hidden')) {
                closeCart();
            }
            
            if (!checkoutModal.classList.contains('hidden')) {
                closeCheckout();
            }
        }
        
        async function checkOperatingHoursStatus() {
            try {
                await fetchAndProcessOperatingHours();
                // ... (c√≥digo existente da fun√ß√£o) ...

                // Adicione esta linha no final do bloco 'try'
                scheduleNextStatusUpdate(); // Inicia o ciclo de atualiza√ß√£o inteligente

            } catch (error) {
                errorLog('Erro cr√≠tico ao verificar hor√°rios de funcionamento:', error);
                // ... (c√≥digo existente do catch) ...
            }
        }
        

        
           /**
         * Atualiza o indicador de status (aberto/fechado) e o texto de hor√°rio na interface.
         * Utiliza o novo sistema de hor√°rios para obter as informa√ß√µes.
         */
         function updateOpenStatusIndicator() {
            try {
                const now = new Date();
                const nowInMinutes = now.getHours() * 60 + now.getMinutes();
                const dayOfWeek = now.getDay();
                const dayName = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'][dayOfWeek];

                const scheduleToday = operatingHours.find(d => d.Dia.trim().toLowerCase() === dayName.toLowerCase());
                const parsedPeriods = getParsedPeriods(scheduleToday);

                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                const hoursText = document.getElementById('hours-text');

                if (checkIfOpen(parsedPeriods, nowInMinutes)) {
                    // ABERTO
                    statusDot.style.backgroundColor = '#28a745'; // Verde
                    statusText.textContent = 'Aberto';
                    const nextClose = getNextCloseTime(parsedPeriods, nowInMinutes);
                    hoursText.textContent = nextClose ? `Fecha √†s ${nextClose}` : '';
                } else {
                    // FECHADO
                    statusDot.style.backgroundColor = '#dc3545'; // Vermelho
                    statusText.textContent = 'Fechado';
                    const nextOpen = getNextOpenTime(parsedPeriods, nowInMinutes);
                    hoursText.textContent = nextOpen ? `Abre √†s ${nextOpen}` : 'Fechado o dia todo';
                }
            } catch (error) {
                errorLog('‚ùå Erro ao atualizar indicador de status:', error);
            }
        }
        /**
         * =========================================================================
         * GERENCIADOR DE ATUALIZA√á√ÉO DE STATUS (VERS√ÉO FINAL)
         * =========================================================================
         * Este sistema unificado analisa o status de funcionamento e agenda a 
         * pr√≥xima atualiza√ß√£o de forma inteligente e precisa.
         */

         let statusUpdateTimeout = null;

/**
 * Fun√ß√£o central que obt√©m o status de funcionamento atual e futuro.
 * @returns {object} Um objeto com { isOpen, nextChangeTime, isAlwaysClosed }
 */
function getOperatingStatusInfo() {
    const now = new Date();
    const nowInMinutes = now.getHours() * 60 + now.getMinutes();
    const dayOfWeek = now.getDay();
    const dayName = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'][dayOfWeek];

    const scheduleToday = operatingHours.find(d => d.Dia.trim().toLowerCase() === dayName.toLowerCase());
    const parsedPeriods = getParsedPeriods(scheduleToday);

    if (!parsedPeriods) {
        return { isOpen: false, nextChangeTime: null, isAlwaysClosed: true };
    }

    const isOpen = checkIfOpen(parsedPeriods, nowInMinutes);
    let nextChangeTime = null;

    if (isOpen) {
        const currentPeriod = parsedPeriods.find(p => nowInMinutes >= p.start && nowInMinutes < p.end);
        if (currentPeriod) nextChangeTime = currentPeriod.end;
    } else {
        const nextPeriod = parsedPeriods.find(p => p.start > nowInMinutes);
        if (nextPeriod) nextChangeTime = nextPeriod.start;
    }

    return { isOpen, nextChangeTime, isAlwaysClosed: false };
}

/**
 * Atualiza a interface (DOM) com base nas informa√ß√µes de status.
 */
function updateStatusIndicatorUI() {
    const { isOpen, nextChangeTime, isAlwaysClosed } = getOperatingStatusInfo();
    
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const hoursText = document.getElementById('hours-text');

    if (isOpen) {
        statusDot.style.backgroundColor = '#28a745'; // Verde
        statusText.textContent = 'Aberto';
        const closeTime = nextChangeTime ? `${Math.floor(nextChangeTime / 60) % 24}`.padStart(2, '0') + ':' + `${nextChangeTime % 60}`.padStart(2, '0') : '';
        hoursText.textContent = closeTime ? `Fecha √†s ${closeTime}` : '';
    } else {
        statusDot.style.backgroundColor = '#dc3545'; // Vermelho
        statusText.textContent = 'Fechado';
        if (isAlwaysClosed) {
            hoursText.textContent = 'Fechado o dia todo';
        } else {
            const openTime = nextChangeTime ? `${Math.floor(nextChangeTime / 60)}`.padStart(2, '0') + ':' + `${nextChangeTime % 60}`.padStart(2, '0') : '';
            hoursText.textContent = openTime ? `Abre √†s ${openTime}` : 'N√£o abre mais hoje';
        }
    }
}

/**
 * Agenda a pr√≥xima atualiza√ß√£o de status no momento exato da mudan√ßa.
 */
function scheduleNextStatusUpdate() {
    if (statusUpdateTimeout) clearTimeout(statusUpdateTimeout);

    updateStatusIndicatorUI(); // Atualiza a UI imediatamente

    const { nextChangeTime } = getOperatingStatusInfo();
    const now = new Date();
    let timeoutMs;

    if (nextChangeTime !== null) {
        // Agenda para o pr√≥ximo evento de hoje
        const nowInMinutes = now.getHours() * 60 + now.getMinutes();
        const minutesUntilChange = nextChangeTime - nowInMinutes;
        const secondsUntilChange = (minutesUntilChange * 60) - now.getSeconds();
        timeoutMs = (secondsUntilChange * 1000) + 1000; // Adiciona 1s de margem
        debugLog(`Pr√≥xima atualiza√ß√£o agendada em ${Math.round(timeoutMs / 60000)} min.`);
    } else {
        // Agenda para o in√≠cio do pr√≥ximo dia
        const tomorrow = new Date();
        tomorrow.setDate(now.getDate() + 1);
        tomorrow.setHours(0, 0, 1, 0); // 00:00:01
        timeoutMs = tomorrow.getTime() - now.getTime();
        debugLog('Nenhuma outra mudan√ßa hoje. Agendando para amanh√£.');
    }

    // Fallback para garantir que o agendamento seja v√°lido
    if (timeoutMs <= 1000) timeoutMs = 60 * 60 * 1000; // 1 hora

    statusUpdateTimeout = setTimeout(scheduleNextStatusUpdate, timeoutMs);
}
        // ===== FUN√á√ïES REL√ìGIO TIMEZONE =====
        
        let timezoneClockInterval = null;
        
        // Atualizar rel√≥gio do timezone
        function updateTimezoneClock() {
            try {
                const clockElement = document.getElementById('timezone-clock');
                const infoElement = document.getElementById('timezone-info');
                
                if (clockElement && infoElement) {
                    // Obter data/hora atual no timezone configurado
                    const currentDate = getCurrentDateInTimezone();
                    
                    // Formatar hora (HH:MM:SS)
                    const timeString = formatDateInTimezone(currentDate, {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                    
                    // Formatar data completa
                    const dateString = formatDateInTimezone(currentDate, {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    // Atualizar elementos
                    clockElement.textContent = timeString;
                    infoElement.textContent = `${dateString} (${globalTimezone})`;
                }
            } catch (error) {
                errorLog('Erro ao atualizar rel√≥gio:', error);
                const clockElement = document.getElementById('timezone-clock');
                const infoElement = document.getElementById('timezone-info');
                
                if (clockElement && infoElement) {
                    clockElement.textContent = '--:--:--';
                    infoElement.textContent = 'Erro no timezone';
                }
            }
        }
        
        // Iniciar rel√≥gio quando modal abrir
        function startTimezoneClock() {
            debugLog('üï∞Ô∏è Iniciando rel√≥gio do timezone...');
            
            // Atualizar imediatamente
            updateTimezoneClock();
            
            // Atualizar a cada segundo
            if (timezoneClockInterval) {
                clearInterval(timezoneClockInterval);
            }
            timezoneClockInterval = setInterval(updateTimezoneClock, 1000);
        }
        
        // Parar rel√≥gio quando modal fechar
        function stopTimezoneClock() {
            debugLog('üï∞Ô∏è Parando rel√≥gio do timezone...');
            
            if (timezoneClockInterval) {
                clearInterval(timezoneClockInterval);
                timezoneClockInterval = null;
            }
        }
        // ===== FUN√á√ïES QR CODE =====
        
        // Vari√°vel global para armazenar o QR Code gerado
        let generatedQRCode = null;
        
        /**
         * Habilita o bot√£o de download ap√≥s QR Code estar pronto
         */
        function enableDownloadButton() {
            const downloadButton = document.getElementById('download-qr-button');
            if (downloadButton) {
                downloadButton.disabled = false;
                downloadButton.textContent = 'üíæ Baixar QR Code PNG';
                downloadButton.style.background = 'linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))';
                downloadButton.style.color = 'white';
                downloadButton.style.cursor = 'pointer';
                downloadButton.onmouseover = function() {
                    this.style.background = 'linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))';
                };
                downloadButton.onmouseout = function() {
                    this.style.background = 'linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))';
                };
            }
        }
        
        /**
         * Desabilita o bot√£o de download
         */
        function disableDownloadButton() {
            const downloadButton = document.getElementById('download-qr-button');
            if (downloadButton) {
                downloadButton.disabled = true;
                downloadButton.textContent = '‚è≥ Aguarde o QR Code...';
                downloadButton.style.background = 'linear-gradient(135deg, #ccc, #999)';
                downloadButton.style.color = '#666';
                downloadButton.style.cursor = 'not-allowed';
                downloadButton.onmouseover = null;
                downloadButton.onmouseout = null;
            }
        }
        
        /**
         * Abre o modal do QR Code e gera o c√≥digo (vers√£o simplificada)
         */
        async function openQRCodeModal() {
            const modal = document.getElementById('qrcode-modal');
            const qrcodeDisplay = document.getElementById('qrcode-display');
            const urlInput = document.getElementById('qrcode-url');
            const currentURL = window.location.href;
            
            // Configurar URL no input
            urlInput.value = currentURL;
            
            // Desabilitar bot√£o de download inicialmente
            disableDownloadButton();
            
            // Mostrar modal
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Mostrar loading
            qrcodeDisplay.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                    <p>Gerando QR Code...</p>
                </div>
            `;
            
            try {
                debugLog('üåê Gerando QR Code via API online...');
                
                // Usar sempre API online para simplicidade e confiabilidade
                const encodedURL = encodeURIComponent(currentURL);
                const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodedURL}&format=png&margin=20&bgcolor=FFFFFF&color=000000`;
                
                // Armazenar URL da API para download direto
                window.currentQRCodeURL = qrApiUrl;
                
                // Criar imagem para exibi√ß√£o
                const img = document.createElement('img');
                img.src = qrApiUrl;
                img.alt = 'QR Code do Card√°pio';
                img.style.width = '200px';
                img.style.height = '200px';
                img.style.border = '2px solid #ddd';
                img.style.borderRadius = '8px';
                img.style.display = 'block';
                img.style.margin = '0 auto';
                
                // Aguardar carregamento
                await new Promise((resolve, reject) => {
                    img.onload = () => {
                        debugLog('‚úÖ QR Code carregado via API!');
                        resolve();
                    };
                    img.onerror = () => {
                        errorLog('‚ùå Erro ao carregar QR Code');
                        reject(new Error('Falha ao carregar QR Code'));
                    };
                    
                    // Timeout de 15 segundos
                    setTimeout(() => {
                        reject(new Error('Timeout ao carregar QR Code'));
                    }, 15000);
                });
                
                // Limpar e mostrar QR Code
                qrcodeDisplay.innerHTML = '';
                qrcodeDisplay.appendChild(img);
                
                // Habilitar bot√£o de download
                enableDownloadButton();
                
                debugLog('‚úÖ QR Code gerado e pronto para download!');
                debugLog('üîó URL da API:', qrApiUrl);
                
            } catch (error) {
                errorLog('‚ùå Erro ao gerar QR Code:', error);
                
                // Manter bot√£o desabilitado
                disableDownloadButton();
                
                // Mostrar erro com fallback
                qrcodeDisplay.innerHTML = `
                    <div style="color: #e74c3c; font-size: 14px; text-align: center; padding: 20px;">
                        <p style="margin-bottom: 10px;">‚ùå Erro ao gerar QR Code</p>
                        <p style="font-size: 12px; opacity: 0.8; margin-bottom: 15px;">Verifique sua conex√£o com a internet</p>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; word-break: break-all; font-size: 11px; color: #333;">
                            ${currentURL}
                        </div>
                        <p style="font-size: 11px; margin-top: 10px; opacity: 0.6;">Copie o link acima para acessar o card√°pio</p>
                    </div>
                `;
            }
        }
        
        /**
         * Fecha o modal do QR Code
         */
        function closeQRCodeModal() {
            debugLog('üîó Fechando modal QR Code...');
            
            const modal = document.getElementById('qrcode-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            
            // Limpar QR Code gerado
            generatedQRCode = null;
        }
        
        /**
         * Copia a URL do card√°pio para a √°rea de transfer√™ncia
         */
        async function copyQRCodeURL(event) {
            const urlInput = document.getElementById('qrcode-url');
            const url = urlInput.value;
            
            try {
                await navigator.clipboard.writeText(url);
                
                // Feedback visual
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copiado!';
                button.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))';
                }, 2000);
                
                debugLog('‚úÖ URL copiada para √°rea de transfer√™ncia');
                
            } catch (error) {
                errorLog('‚ùå Erro ao copiar URL:', error);
                
                // Fallback para navegadores mais antigos
                urlInput.select();
                urlInput.setSelectionRange(0, 99999);
                document.execCommand('copy');
                
                // Feedback visual
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copiado!';
                button.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))';
                }, 2000);
            }
        }
        
        /**
         * Faz download do QR Code (vers√£o simplificada)
         */
        function downloadQRCode(event) {
            const button = event.target;
            
            // Verificar se o bot√£o est√° habilitado
            if (button.disabled) {
                debugLog('‚ö†Ô∏è Bot√£o ainda desabilitado');
                return;
            }
            
            const originalText = button.textContent;
            
            try {
                // Feedback visual
                button.textContent = 'üíæ Baixando...';
                button.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
                
                // Verificar se temos a URL da API
                if (!window.currentQRCodeURL) {
                    throw new Error('URL do QR Code n√£o encontrada');
                }
                
                // M√©todo 1: Download direto via link
                const filename = 'qrcode-cardapio.png';
                
                // M√©todo mais robusto para for√ßar download
                try {
                    // Tentar fetch para for√ßar download
                    fetch(window.currentQRCodeURL)
                        .then(response => response.blob())
                        .then(blob => {
                            // Criar URL do blob
                            const blobUrl = window.URL.createObjectURL(blob);
                            
                            // Criar link para download
                            const link = document.createElement('a');
                            link.href = blobUrl;
                            link.download = filename;
                            link.style.display = 'none';
                            
                            // Adicionar, clicar e remover
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            // Limpar URL do blob ap√≥s delay
                            setTimeout(() => {
                                window.URL.revokeObjectURL(blobUrl);
                            }, 1000);
                        })
                        .catch(() => {
                            // Fallback: m√©todo tradicional
                            const link = document.createElement('a');
                            link.href = window.currentQRCodeURL;
                            link.download = filename;
                            link.style.display = 'none';
                            
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        });
                } catch (fetchError) {
                    // Fallback final: m√©todo simples
                    const link = document.createElement('a');
                    link.href = window.currentQRCodeURL;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                
                // Feedback de sucesso
                button.textContent = '‚úÖ Baixado!';
                button.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))';
                }, 2000);
                
                debugLog('‚úÖ Download iniciado!');
                debugLog('üìÅ Arquivo:', filename);
                debugLog('üîó URL:', window.currentQRCodeURL);
                
            } catch (error) {
                errorLog('‚ùå Erro ao baixar QR Code:', error);
                
                // Feedback visual de erro
                button.textContent = '‚ùå Erro no download';
                button.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))';
                }, 2000);
            }
        }

        // ===== SISTEMA DE MESA VIA URL =====
        
        function getURLParameter(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function getMesaFromURL() {
            const mesa = getURLParameter('mesa');
            if (mesa && mesa.trim()) {
                debugLog('ü™ë Mesa detectada na URL:', mesa);
                return mesa.trim();
            }
            return null;
        }

        function preencheMesaAutomatica() {
            const mesaURL = getMesaFromURL();
            const campoMesa = document.getElementById('table-number');
            
            if (mesaURL && campoMesa) {
                campoMesa.value = mesaURL;
                
                // Focar no campo para habilitar o bot√£o continuar
                campoMesa.focus();
                campoMesa.blur(); // Simular sa√≠da do foco para disparar valida√ß√£o
                
                campoMesa.style.background = 'linear-gradient(135deg, #e8f5e9, #f1f8e9)';
                campoMesa.style.borderColor = 'var(--cor-sucesso)';
                
                const parent = campoMesa.parentNode;
                const successIcon = document.createElement('div');
                successIcon.className = 'mesa-auto-success';
                successIcon.innerHTML = '<div style="display: flex; align-items: center; margin-top: 4px; color: var(--cor-sucesso); font-size: 12px;"><svg style="width: 14px; height: 14px; margin-right: 4px;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Mesa preenchida automaticamente</div>';
                parent.appendChild(successIcon);
                
                setTimeout(() => {
                    campoMesa.style.background = '';
                    campoMesa.style.borderColor = '';
                    const successEl = parent.querySelector('.mesa-auto-success');
                    if (successEl) successEl.remove();
                }, 3000);
                
                debugLog('‚úÖ Campo mesa preenchido automaticamente:', mesaURL);
                return true;
            }
            return false;
        }

        function mostrarIndicadorMesaURL() {
            const mesaURL = getMesaFromURL();
            if (mesaURL) {
                showToastMesa(mesaURL);
            }
        }

        function showToastMesa(numeroMesa) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            });
            
            const toastDiv = document.createElement('div');
            toastDiv.className = 'toast toast-success';
            toastDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="font-semibold text-sm text-white">Mesa ${numeroMesa} detectada</div>
                    <button onclick="this.parentElement.parentElement.classList.add('toast-exit'); setTimeout(() => this.parentElement.parentElement.remove(), 300)" class="text-white/80 hover:text-white ml-4 flex-shrink-0">
                        <span class="text-lg">√ó</span>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toastDiv);
            
            // Auto remove
            setTimeout(() => {
                if (toastDiv.parentNode) {
                    toastDiv.classList.add('toast-exit');
                    setTimeout(() => toastDiv.remove(), 300);
                }
            }, 3500);
        }

        // ===== AUTOMA√á√ÉO MESA URL - CHECKOUT DIRETO =====
        function autoMesaCheckout() {
            const mesaURL = getMesaFromURL();
            if (!mesaURL) return false;
            
            debugLog('ü™ë Automa√ß√£o Mesa URL ativada:', mesaURL);
            
            // 1. Ocultar todas as op√ß√µes de entrega
            const deliveryOptions = document.getElementById('delivery-options');
            if (deliveryOptions) {
                const allOptions = deliveryOptions.querySelectorAll('label');
                allOptions.forEach(option => {
                    option.style.display = 'none';
                });
            }
            
            // 2. Mostrar apenas a op√ß√£o "Consumo no Local"
            const localOption = deliveryOptions?.querySelector('input[value="local"]')?.closest('label');
            if (localOption) {
                localOption.style.display = 'flex';
                
                // 3. Selecionar automaticamente "Consumo no Local"
                const localRadio = localOption.querySelector('input[value="local"]');
                if (localRadio) {
                    localRadio.checked = true;
                    localRadio.dispatchEvent(new Event('change'));
                    debugLog('‚úÖ "Consumo no Local" selecionado automaticamente');
                }
            }
            
            // 4. Aguardar um pouco para os campos aparecerem
            setTimeout(() => {
                // 5. Preencher campo da mesa
                const campoMesa = document.getElementById('table-number');
                if (campoMesa) {
                    campoMesa.value = mesaURL;
                    
                    // 6. Focar no campo (cursor piscando + teclado mobile)
                    campoMesa.focus();
                    
                    // 7. Disparar eventos para valida√ß√£o
                    campoMesa.dispatchEvent(new Event('input'));
                    campoMesa.dispatchEvent(new Event('change'));
                    
                    debugLog('‚úÖ Campo mesa preenchido e focado:', mesaURL);
                }
            }, 100);
            
            return true;
        }

        // Toast da mesa ser√° mostrado ap√≥s o carregamento completo do card√°pio

    </script>

    <!-- Notification Element -->
    <div id="notification" class="notification hidden">
        <span></span>
        <button class="notification-close" onclick="closeNotification()">√ó</button>
    </div>

    <style>
        /* Estilos para notifica√ß√µes */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-weight: 500;
            font-size: 14px;
            line-height: 1.4;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.success {
            background-color: #10b981;
            color: white;
        }

        .notification.error {
            background-color: #ef4444;
            color: white;
        }

        .notification.warning {
            background-color: #f59e0b;
            color: white;
        }

        .notification.info {
            background-color: #3b82f6;
            color: white;
        }

        .notification-close {
            background: none;
            border: none;
            color: inherit;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .notification-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Responsividade para mobile */
        @media (max-width: 640px) {
            .notification {
                left: 20px;
                right: 20px;
                max-width: none;
                transform: translateY(-100%);
            }

            .notification.show {
                transform: translateY(0);
            }
        }
    </style>

    <script>
        // Fun√ß√£o para mostrar notifica√ß√µes
        function showNotification(message, type = 'info', duration = 4000) {
            const notification = document.getElementById('notification');
            
            // Escapar HTML para evitar XSS
            const escapedMessage = message.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
            
            notification.innerHTML = `
                <span>${escapedMessage}</span>
                <button class="notification-close" onclick="closeNotification()">√ó</button>
            `;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            // Limpar timeout anterior se existir
            if (notification.timeoutId) {
                clearTimeout(notification.timeoutId);
            }
            
            // Definir novo timeout
            notification.timeoutId = setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }
        
        // Fun√ß√£o para fechar notifica√ß√£o
        function closeNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }
        
        // Fun√ß√£o para verificar limites de sele√ß√£o
        function checkSelectionLimit(input, variationData) {
            if (!variationData || variationData.type !== 'checkbox') {
                return true;
            }
            
            const maxSelect = variationData.maxSelect;
            if (!maxSelect || maxSelect <= 0) {
                return true;
            }
            
            // Encontrar o container da varia√ß√£o
            const variationContainer = input.closest('.variation-container');
            if (!variationContainer) {
                return true;
            }
            
            const checkedInputs = variationContainer.querySelectorAll('input[type="checkbox"]:checked');
            
            if (input.checked && checkedInputs.length > maxSelect) {
                input.checked = false;
                showNotification(`M√°ximo de ${maxSelect} op√ß√µes permitidas!`, 'warning', 3000);
                return false;
            }
            
            return true;
        }
        
        // Fun√ß√£o para verificar sele√ß√µes m√≠nimas obrigat√≥rias
        function checkMinimumSelections(variationData) {
            if (!variationData || variationData.type !== 'checkbox') {
                return true;
            }
            
            const minSelect = variationData.minSelect;
            if (!minSelect || minSelect <= 0) {
                return true;
            }
            
            // Contar sele√ß√µes atuais para esta varia√ß√£o
            const variationIndex = variationData.index;
            const selectedCount = Object.keys(selectedVariations).filter(key => 
                key.startsWith(`${variationIndex}-`)
            ).length;
            
            if (selectedCount < minSelect) {
                showNotification(`Selecione pelo menos ${minSelect} op√ß√µes em "${variationData.name}"!`, 'warning', 4000);
                return false;
            }
            
            return true;
        }
        
        // Fun√ß√£o para validar todas as varia√ß√µes antes de adicionar ao carrinho
        function validateAllVariations() {
            const variations = parseVariations(currentProduct.classificacaoAdicional);
            if (!variations || variations.type !== 'multiple_variations') {
                return true;
            }
            
            let isValid = true;
            
            // Verificar varia√ß√µes obrigat√≥rias
            const requiredVariations = variations.variations.filter(v => v.required);
            for (const requiredVar of requiredVariations) {
                const variationIndex = variations.variations.indexOf(requiredVar);
                const hasSelectionForThisVariation = Object.keys(selectedVariations)
                    .some(key => key.startsWith(`${variationIndex}-`));
                
                if (!hasSelectionForThisVariation) {
                    showNotification(`Selecione uma op√ß√£o em "${requiredVar.name}"!`, 'warning', 4000);
                    isValid = false;
                    break;
                }
            }
            
            // Verificar sele√ß√µes m√≠nimas para checkboxes
            if (isValid) {
                for (let i = 0; i < variations.variations.length; i++) {
                    const variation = variations.variations[i];
                    if (variation.type === 'checkbox' && variation.minSelect > 0) {
                        const selectedCount = Object.keys(selectedVariations).filter(key => 
                            key.startsWith(`${i}-`)
                        ).length;
                        
                        if (selectedCount > 0 && selectedCount < variation.minSelect) {
                            showNotification(`Selecione pelo menos ${variation.minSelect} op√ß√µes em "${variation.name}"!`, 'warning', 4000);
                            isValid = false;
                            break;
                        }
                    }
                }
            }
            
            return isValid;
        }
        
        // Fun√ß√£o para validar todas as varia√ß√µes antes de adicionar ao carrinho
        function validateAllVariations() {
            const variations = document.querySelectorAll('[data-variation-name]');
            
            for (const variation of variations) {
                const variationName = variation.dataset.variationName;
                const variationData = {
                    name: variationName,
                    type: variation.dataset.variationType || 'radio',
                    required: variation.dataset.variationRequired === 'true',
                    min: parseInt(variation.dataset.variationMin) || 0,
                    max: parseInt(variation.dataset.variationMax) || 999
                };
                
                // Verificar sele√ß√µes m√≠nimas para varia√ß√µes obrigat√≥rias
                if (variationData.required) {
                    const isValid = checkMinimumSelections(variationData);
                    if (!isValid) {
                        showToast(`Por favor, selecione pelo menos uma op√ß√£o em "${variationName}"`, 'error');
                        return false;
                    }
                }
                
                // Verificar limites para varia√ß√µes checkbox
                if (variationData.type === 'checkbox') {
                    const selectedOptions = variation.querySelectorAll('input[type="checkbox"]:checked');
                    
                    if (selectedOptions.length < variationData.min) {
                        showToast(`Selecione pelo menos ${variationData.min} op√ß√µes em "${variationName}"`, 'error');
                        return false;
                    }
                    
                    if (selectedOptions.length > variationData.max) {
                        showToast(`Selecione no m√°ximo ${variationData.max} op√ß√µes em "${variationName}"`, 'error');
                        return false;
                    }
                }
            }
            
            return true;
        }




        /**
 * ====================================================================
 * SISTEMA DE LOCALSTORAGE - CARD√ÅPIO SHEETS V3.8.0
 * ====================================================================
 * 
 * Sistema robusto de persist√™ncia de dados usando localStorage
 * para manter carrinho, cupons, dados do formul√°rio e configura√ß√µes
 * entre sess√µes do usu√°rio.
 * 
 * Funcionalidades:
 * - Persist√™ncia de carrinho com varia√ß√µes e notas
 * - Persist√™ncia de cupons aplicados
 * - Persist√™ncia de dados do formul√°rio de checkout
 * - Persist√™ncia de taxa de delivery
 * - Sistema de versionamento e expira√ß√£o
 * - Limpeza autom√°tica de dados expirados
 * - Logs detalhados para debug
 * - Fallbacks para compatibilidade
 * 
 * Desenvolvido por Dante Testa - dantetesta.com.br
 */

(function() {
    'use strict';
    
    // ===== CONFIGURA√á√ïES DO SISTEMA =====
    const STORAGE_CONFIG = {
        VERSION: '3.8.0',
        EXPIRATION_DAYS: 30, // Dados expiram em 30 dias
        KEYS: {
            CART: 'cardapio_cart_v2',
            COUPON: 'cardapio_coupon_v2',
            ORDER_DATA: 'cardapio_order_data_v2',
            DELIVERY_FEE: 'cardapio_delivery_fee_v2',
            CSV_CACHE: 'cardapio_csv_cache_v2'
        },
        DEBUG: true // Ser√° sobrescrito pelo DEBUG_MODE do config.js
    };
    
    // ===== UTILIT√ÅRIOS =====
    
    /**
     * Log de debug personalizado
     */
    function storageLog(message, ...args) {
        if (STORAGE_CONFIG.DEBUG && typeof debugLog === 'function') {
            debugLog('üíæ [localStorage]', message, ...args);
        } else if (STORAGE_CONFIG.DEBUG) {
            debugLog('üíæ [localStorage]', message, ...args);
        }
    }
    
    /**
     * Log de erro personalizado
     */
    function storageError(message, ...args) {
        if (typeof errorLog === 'function') {
            errorLog('‚ùå [localStorage]', message, ...args);
        } else {
            console.error('‚ùå [localStorage]', message, ...args);
        }
    }
    
    /**
     * Verificar se localStorage est√° dispon√≠vel
     */
    function isLocalStorageAvailable() {
        try {
            const test = '__localStorage_test__';
            localStorage.setItem(test, test);
            localStorage.removeItem(test);
            return true;
        } catch (e) {
            return false;
        }
    }
    
    /**
     * Criar timestamp de expira√ß√£o
     */
    function createExpirationTimestamp() {
        return Date.now() + (STORAGE_CONFIG.EXPIRATION_DAYS * 24 * 60 * 60 * 1000);
    }
    
    /**
     * Verificar se dados expiraram
     */
    function isExpired(timestamp) {
        return Date.now() > timestamp;
    }
    
    /**
     * Salvar dados no localStorage com versionamento e expira√ß√£o
     */
    function saveToStorage(key, data) {
        if (!isLocalStorageAvailable()) {
            storageError('localStorage n√£o dispon√≠vel');
            return false;
        }
        
        try {
            const storageData = {
                version: STORAGE_CONFIG.VERSION,
                timestamp: Date.now(),
                expires: createExpirationTimestamp(),
                data: data
            };
            
            localStorage.setItem(key, JSON.stringify(storageData));
            storageLog(`Dados salvos: ${key}`, data);
            return true;
        } catch (e) {
            storageError(`Erro ao salvar ${key}:`, e);
            return false;
        }
    }
    
    /**
     * Carregar dados do localStorage com verifica√ß√£o de vers√£o e expira√ß√£o
     */
    function loadFromStorage(key) {
        if (!isLocalStorageAvailable()) {
            return null;
        }
        
        try {
            const stored = localStorage.getItem(key);
            if (!stored) {
                return null;
            }
            
            const storageData = JSON.parse(stored);
            
            // Verificar expira√ß√£o
            if (storageData.expires && isExpired(storageData.expires)) {
                storageLog(`Dados expirados removidos: ${key}`);
                localStorage.removeItem(key);
                return null;
            }
            
            // Verificar vers√£o (opcional - pode ser usado para migra√ß√£o futura)
            if (storageData.version !== STORAGE_CONFIG.VERSION) {
                storageLog(`Vers√£o diferente detectada para ${key}: ${storageData.version} -> ${STORAGE_CONFIG.VERSION}`);
            }
            
            storageLog(`Dados carregados: ${key}`, storageData.data);
            return storageData.data;
        } catch (e) {
            storageError(`Erro ao carregar ${key}:`, e);
            localStorage.removeItem(key); // Remove dados corrompidos
            return null;
        }
    }
    
    /**
     * Remover dados espec√≠ficos do localStorage
     */
    function removeFromStorage(key) {
        if (!isLocalStorageAvailable()) {
            return false;
        }
        
        try {
            localStorage.removeItem(key);
            storageLog(`Dados removidos: ${key}`);
            return true;
        } catch (e) {
            storageError(`Erro ao remover ${key}:`, e);
            return false;
        }
    }
    
    // ===== FUN√á√ïES ESPEC√çFICAS DO CARRINHO =====
    
    /**
     * Salvar carrinho no localStorage
     */
    window.saveCartToStorage = function() {
        if (typeof cart !== 'undefined' && Array.isArray(cart)) {
            const success = saveToStorage(STORAGE_CONFIG.KEYS.CART, cart);
            if (success) {
                storageLog(`üõí Carrinho salvo: ${cart.length} itens`);
            }
            return success;
        }
        return false;
    };
    
    /**
     * Carregar carrinho do localStorage
     */
    window.loadCartFromStorage = function() {
        const cartData = loadFromStorage(STORAGE_CONFIG.KEYS.CART);
        if (cartData && Array.isArray(cartData) && cartData.length > 0) {
            if (typeof cart !== 'undefined') {
                cart.length = 0; // Limpar carrinho atual
                cart.push(...cartData); // Adicionar itens restaurados
                storageLog(`üõç Carrinho restaurado: ${cart.length} itens`);
                return cart.length > 0; // Retorna true apenas se realmente restaurou itens
            }
        }
        storageLog('üõç Nenhum item no carrinho para restaurar');
        return false;
    };
    
    /**
     * Limpar carrinho do localStorage
     */
    window.clearCartFromStorage = function() {
        const success = removeFromStorage(STORAGE_CONFIG.KEYS.CART);
        if (success) {
            storageLog('üõí Carrinho limpo do localStorage');
        }
        return success;
    };
    
    // ===== FUN√á√ïES ESPEC√çFICAS DE CUPONS =====
    
    /**
     * Salvar cupom no localStorage
     */
    window.saveCouponToStorage = function() {
        if (typeof appliedCoupon !== 'undefined' && typeof couponDiscount !== 'undefined') {
            const couponData = {
                appliedCoupon: appliedCoupon,
                couponDiscount: couponDiscount
            };
            const success = saveToStorage(STORAGE_CONFIG.KEYS.COUPON, couponData);
            if (success && appliedCoupon) {
                storageLog(`üéüÔ∏è Cupom salvo: ${appliedCoupon.codigo} (${couponDiscount})`);
            }
            return success;
        }
        return false;
    };
    
    /**
     * Carregar cupom do localStorage
     */
    window.loadCouponFromStorage = function() {
        const couponData = loadFromStorage(STORAGE_CONFIG.KEYS.COUPON);
        if (couponData && couponData.appliedCoupon) {
            if (typeof appliedCoupon !== 'undefined' && typeof couponDiscount !== 'undefined') {
                appliedCoupon = couponData.appliedCoupon;
                couponDiscount = couponData.couponDiscount || 0;
                storageLog(`üéüÔ∏è Cupom restaurado: ${appliedCoupon.codigo} (${couponDiscount})`);
                return true;
            }
        }
        return false;
    };
    
    /**
     * Limpar cupom do localStorage
     */
    window.clearCouponFromStorage = function() {
        const success = removeFromStorage(STORAGE_CONFIG.KEYS.COUPON);
        if (success) {
            storageLog('üéüÔ∏è Cupom limpo do localStorage');
        }
        return success;
    };
    
    // ===== FUN√á√ïES ESPEC√çFICAS DE DADOS DO PEDIDO =====
    
    /**
     * Salvar dados do pedido no localStorage
     */
    window.saveOrderDataToStorage = function() {
        if (typeof orderData !== 'undefined' && orderData) {
            const success = saveToStorage(STORAGE_CONFIG.KEYS.ORDER_DATA, orderData);
            if (success) {
                storageLog('üìù Dados do pedido salvos', orderData);
            }
            return success;
        }
        return false;
    };
    
    /**
     * Carregar dados do pedido do localStorage
     */
    window.loadOrderDataFromStorage = function() {
        const savedOrderData = loadFromStorage(STORAGE_CONFIG.KEYS.ORDER_DATA);
        if (savedOrderData && typeof orderData !== 'undefined') {
            // Mesclar dados salvos com dados atuais
            Object.assign(orderData, savedOrderData);
            
            // Preencher campos do formul√°rio
            fillFormFields(savedOrderData);
            
            storageLog('üìù Dados do pedido restaurados', savedOrderData);
            return true;
        }
        return false;
    };
    
    /**
     * Preencher campos do formul√°rio com dados salvos
     */
    function fillFormFields(data) {
        try {
            if (data.customerName) {
                const nameField = document.getElementById('customer-name');
                if (nameField) nameField.value = data.customerName;
            }
            
            if (data.whatsapp) {
                const whatsappField = document.getElementById('customer-whatsapp');
                if (whatsappField) whatsappField.value = data.whatsapp;
            }
            
            if (data.paymentMethod) {
                const paymentField = document.getElementById('payment-method');
                if (paymentField) paymentField.value = data.paymentMethod;
            }
            
            if (data.changeAmount) {
                const changeField = document.getElementById('change-amount');
                if (changeField) changeField.value = data.changeAmount;
            }
            
            if (data.notes) {
                const notesField = document.getElementById('order-notes');
                if (notesField) notesField.value = data.notes;
            }
            
            if (data.deliveryType) {
                const deliveryRadio = document.querySelector(`input[name="delivery-type"][value="${data.deliveryType}"]`);
                if (deliveryRadio) deliveryRadio.checked = true;
            }
            
            storageLog('üìù Campos do formul√°rio preenchidos');
        } catch (e) {
            storageError('Erro ao preencher campos do formul√°rio:', e);
        }
    }
    
    /**
     * Limpar dados do pedido do localStorage
     */
    window.clearOrderDataFromStorage = function() {
        const success = removeFromStorage(STORAGE_CONFIG.KEYS.ORDER_DATA);
        if (success) {
            storageLog('üìù Dados do pedido limpos do localStorage');
        }
        return success;
    };
    
    // ===== FUN√á√ïES ESPEC√çFICAS DE TAXA DE DELIVERY =====
    
    /**
     * Salvar taxa de delivery no localStorage
     */
    window.saveDeliveryFeeToStorage = function() {
        if (typeof currentDeliveryFee !== 'undefined') {
            const success = saveToStorage(STORAGE_CONFIG.KEYS.DELIVERY_FEE, currentDeliveryFee);
            if (success) {
                storageLog(`üöö Taxa de delivery salva: ${currentDeliveryFee}`);
            }
            return success;
        }
        return false;
    };
    
    /**
     * Carregar taxa de delivery do localStorage
     */
    window.loadDeliveryFeeFromStorage = function() {
        const savedFee = loadFromStorage(STORAGE_CONFIG.KEYS.DELIVERY_FEE);
        if (savedFee !== null && typeof currentDeliveryFee !== 'undefined') {
            currentDeliveryFee = savedFee;
            storageLog(`üöö Taxa de delivery restaurada: ${savedFee}`);
            return true;
        }
        return false;
    };
    
    /**
     * Limpar taxa de delivery do localStorage
     */
    window.clearDeliveryFeeFromStorage = function() {
        const success = removeFromStorage(STORAGE_CONFIG.KEYS.DELIVERY_FEE);
        if (success) {
            storageLog('üöö Taxa de delivery limpa do localStorage');
        }
        return success;
    };
    
    // ===== FUN√á√ïES DE CACHE CSV (OPCIONAL) =====
    
    /**
     * Salvar cache de CSV no localStorage
     */
    window.saveCsvCacheToStorage = function(csvData) {
        if (csvData) {
            const success = saveToStorage(STORAGE_CONFIG.KEYS.CSV_CACHE, csvData);
            if (success) {
                storageLog('üìä Cache CSV salvo');
            }
            return success;
        }
        return false;
    };
    
    /**
     * Carregar cache de CSV do localStorage
     */
    window.loadCsvCacheFromStorage = function() {
        const cachedData = loadFromStorage(STORAGE_CONFIG.KEYS.CSV_CACHE);
        if (cachedData) {
            storageLog('üìä Cache CSV carregado');
            return cachedData;
        }
        return null;
    };
    
    // ===== FUN√á√ïES DE LIMPEZA GERAL =====
    
    /**
     * Limpar todos os dados do sistema localStorage
     */
    window.clearAllStorageData = function() {
        let cleared = 0;
        
        Object.values(STORAGE_CONFIG.KEYS).forEach(key => {
            if (removeFromStorage(key)) {
                cleared++;
            }
        });
        
        storageLog(`üßπ Limpeza completa: ${cleared} chaves removidas`);
        return cleared > 0;
    };
    
    /**
     * Limpar dados expirados automaticamente
     */
    function cleanExpiredData() {
        let cleaned = 0;
        
        Object.values(STORAGE_CONFIG.KEYS).forEach(key => {
            try {
                const stored = localStorage.getItem(key);
                if (stored) {
                    const storageData = JSON.parse(stored);
                    if (storageData.expires && isExpired(storageData.expires)) {
                        localStorage.removeItem(key);
                        cleaned++;
                        storageLog(`üßπ Dados expirados removidos: ${key}`);
                    }
                }
            } catch (e) {
                // Remove dados corrompidos
                localStorage.removeItem(key);
                cleaned++;
                storageLog(`üßπ Dados corrompidos removidos: ${key}`);
            }
        });
        
        if (cleaned > 0) {
            storageLog(`üßπ Limpeza autom√°tica: ${cleaned} itens removidos`);
        }
        
        return cleaned;
    }
    
    /**
     * Obter estat√≠sticas do localStorage
     */
    window.getStorageStats = function() {
        const stats = {
            available: isLocalStorageAvailable(),
            keys: {},
            totalSize: 0
        };
        
        if (stats.available) {
            Object.entries(STORAGE_CONFIG.KEYS).forEach(([name, key]) => {
                const data = localStorage.getItem(key);
                stats.keys[name] = {
                    exists: !!data,
                    size: data ? data.length : 0
                };
                stats.totalSize += stats.keys[name].size;
            });
        }
        
        return stats;
    };
    
    // ===== INICIALIZA√á√ÉO DO SISTEMA =====
    
    /**
     * Inicializar sistema de localStorage
     */
    window.initializeStorageSystem = function() {
        storageLog('üöÄ Inicializando sistema de localStorage...');
        
        // Verificar disponibilidade
        if (!isLocalStorageAvailable()) {
            storageError('localStorage n√£o est√° dispon√≠vel neste navegador');
            return false;
        }
        
        // Sincronizar configura√ß√£o de debug
        if (typeof DEBUG_MODE !== 'undefined') {
            STORAGE_CONFIG.DEBUG = DEBUG_MODE;
        }
        
        // Limpeza autom√°tica de dados expirados
        cleanExpiredData();
        
        // Log de estat√≠sticas
        const stats = window.getStorageStats();
        storageLog('üìä Estat√≠sticas do localStorage:', stats);
        
        storageLog('‚úÖ Sistema de localStorage inicializado com sucesso');
        return true;
    };
    
    // ===== AUTO-INICIALIZA√á√ÉO =====
    
    // Aguardar DOM estar pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            // Aguardar um pouco mais para garantir que outras vari√°veis estejam dispon√≠veis
            setTimeout(() => {
                if (typeof initializeStorageSystem === 'function') {
                    initializeStorageSystem();
                }
            }, 100);
        });
    } else {
        // DOM j√° est√° pronto
        setTimeout(() => {
            if (typeof initializeStorageSystem === 'function') {
                initializeStorageSystem();
            }
        }, 100);
    }
    
    storageLog('üì¶ Sistema de localStorage carregado');
    
})();

    </script>



<!-- ====================================================================
     SISTEMA DE TRADU√á√ÉO AUTOM√ÅTICA - GTRANSLATE
     ====================================================================
     Configurado dinamicamente atrav√©s das vari√°veis TRADUCAO e LANGS
     definidas no arquivo config.js
     ==================================================================== -->
<div id="gtranslate_wrapper"></div>

<script>
debugLog('üîç === DEBUG SISTEMA DE TRADU√á√ÉO ===');
debugLog('TRADUCAO definida?', typeof TRADUCAO !== 'undefined');
debugLog('TRADUCAO valor:', TRADUCAO);
debugLog('LANGS definida?', typeof LANGS !== 'undefined');
debugLog('LANGS valor:', LANGS);
debugLog('BANDEIRAS definida?', typeof BANDEIRAS !== 'undefined');
debugLog('BANDEIRAS valor:', BANDEIRAS);

// Verificar se o sistema de tradu√ß√£o est√° habilitado
if (typeof TRADUCAO !== 'undefined' && TRADUCAO === true) {
    infoLog('‚úÖ Condi√ß√£o de tradu√ß√£o atendida - carregando GTranslate');
    
    // Carregar script do GTranslate apenas se habilitado
    const gtranslateScript = document.createElement('script');
    gtranslateScript.src = 'https://cdn.gtranslate.net/widgets/latest/float.js';
    gtranslateScript.defer = true;
    
    // Adicionar listeners para debug
    gtranslateScript.onload = function() {
        infoLog('‚úÖ Script GTranslate carregado com sucesso');
    };
    gtranslateScript.onerror = function() {
        errorLog('‚ùå Erro ao carregar script GTranslate');
    };
    
    document.head.appendChild(gtranslateScript);
    debugLog('üì¶ Script GTranslate adicionado ao DOM');
    
    // Configurar GTranslate com base nas vari√°veis do config.js
    window.gtranslateSettings = {
        default_language: typeof LANGS !== 'undefined' && LANGS.length > 0 ? LANGS[0] : "pt",
        native_language_names: true, // Mostrar nomes dos idiomas em suas l√≠nguas nativas
        detect_browser_language: true, // Detectar idioma do navegador automaticamente
        languages: typeof LANGS !== 'undefined' && LANGS.length > 0 ? LANGS : ["pt", "en", "es"],
        wrapper_selector: "#gtranslate_wrapper",
        float: "right",
        flag_style: "3d", // Estilo das bandeiras: "3d", "default", "round"
        switcher_type: "flags", // Tipo do seletor: "flags", "dropdown", "popup"
        switcher_open_direction: "bottom", // Dire√ß√£o de abertura: "bottom", "top"
        alt_flags: BANDEIRAS // üåé Bandeiras definidas no config.js
    };
    
    debugLog('‚öôÔ∏è Configura√ß√µes GTranslate definidas:');
    debugLog('- default_language:', window.gtranslateSettings.default_language);
    debugLog('- languages:', window.gtranslateSettings.languages);
    debugLog('- alt_flags:', window.gtranslateSettings.alt_flags);
    infoLog('üåê Sistema de tradu√ß√£o habilitado');
    infoLog('üìã Idiomas dispon√≠veis:', window.gtranslateSettings.languages);
    infoLog('üéØ Idioma padr√£o:', window.gtranslateSettings.default_language);
} else {
    infoLog('üö´ Sistema de tradu√ß√£o desabilitado via config.js');
    // Ocultar o wrapper se tradu√ß√£o estiver desabilitada
    const wrapper = document.getElementById('gtranslate_wrapper');
    if (wrapper) {
        wrapper.style.display = 'none';
    }
}

// ====================================================================
// POSICIONAMENTO DIN√ÇMICO DO BOT√ÉO DE COMPARTILHAMENTO
// ====================================================================
/**
 * Ajusta a posi√ß√£o do bot√£o de compartilhamento baseado no status da tradu√ß√£o:
 * - TRADUCAO = true: bottom: 92px (posi√ß√£o original)
 * - TRADUCAO = false: bottom: 30px (mesma altura do carrinho)
 */
function adjustShareButtonPosition() {
    debugLog('üîç === DEBUG POSICIONAMENTO BOT√ÉO COMPARTILHAMENTO ===');
    debugLog('TRADUCAO definida?', typeof TRADUCAO !== 'undefined');
    debugLog('TRADUCAO valor:', TRADUCAO);
    
    const shareButton = document.getElementById('share-fab');
    debugLog('Bot√£o compartilhamento encontrado?', !!shareButton);
    
    if (shareButton) {
        // Verificar se tradu√ß√£o est√° habilitada
        const translationEnabled = typeof TRADUCAO !== 'undefined' && TRADUCAO === true;
        debugLog('Tradu√ß√£o habilitada?', translationEnabled);
        
        if (translationEnabled) {
            // Tradu√ß√£o habilitada: manter posi√ß√£o original (92px)
            shareButton.style.bottom = '92px';
            infoLog('‚úÖ Bot√£o compartilhamento: posi√ß√£o 92px (tradu√ß√£o ativa)');
            debugLog('Posi√ß√£o aplicada:', shareButton.style.bottom);
        } else {
            // Tradu√ß√£o desabilitada: alinhar com carrinho (30px)
            shareButton.style.bottom = '30px';
            infoLog('‚úÖ Bot√£o compartilhamento: posi√ß√£o 30px (tradu√ß√£o desabilitada)');
            debugLog('Posi√ß√£o aplicada:', shareButton.style.bottom);
        }
    } else {
        warnLog('‚ùå Bot√£o compartilhamento n√£o encontrado no DOM');
    }
    debugLog('=== FIM DEBUG POSICIONAMENTO ===');
}

// Executar ajuste de posicionamento ap√≥s DOM carregado
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(adjustShareButtonPosition, 500);
    });
} else {
    // DOM j√° carregado, executar com delay para garantir que elementos estejam dispon√≠veis
    setTimeout(adjustShareButtonPosition, 500);
}
</script>


</body>
</html>
